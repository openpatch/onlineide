import { AdminMenuItem } from "./AdminMenuItem.js";
import { ajax } from "../communication/AjaxHelper.js";
export class ExportImportMI extends AdminMenuItem {
    constructor() {
        super(...arguments);
        this.schoolGridName = "schoolsGridForImport";
        this.schoolDataList = [];
    }
    checkPermission(user) {
        return user.is_admin;
    }
    getButtonIdentifier() {
        return "Schulen Exportieren/Importieren";
    }
    onMenuButtonPressed($mainHeading, $tableLeft, $tableRight, $mainFooter) {
        let that = this;
        if (this.schoolGrid != null) {
            this.schoolGrid.render();
        }
        else {
            $tableLeft.w2grid({
                name: this.schoolGridName,
                header: 'Schulen',
                // selectType: "cell",
                multiSelect: true,
                show: {
                    header: true,
                    toolbar: true,
                    toolbarAdd: true,
                    toolbarDelete: true,
                    footer: true,
                    selectColumn: true,
                    toolbarSearch: false
                },
                recid: "id",
                columns: [
                    { field: 'id', caption: 'ID', size: '20px', sortable: true, hidden: true },
                    { field: 'name', caption: 'Bezeichnung', size: '30%', sortable: true, resizable: true, editable: { type: 'text' } },
                    { field: 'kuerzel', caption: 'KÃ¼rzel', size: '10%', sortable: true, resizable: true, editable: { type: 'text', maxlength: "10" } },
                    { field: 'numberOfClasses', caption: 'Klassen', size: '30%', sortable: true, resizable: true },
                    { field: 'numberOfUsers', caption: 'User', size: '30%', sortable: true, resizable: true },
                ],
                searches: [
                    { field: 'name', label: 'Bezeichnung', type: 'text' }
                ],
                sortData: [{ field: 'name', direction: 'asc' }, { field: 'kuerzel', direction: 'asc' },
                    { field: 'numberOfClasses', direction: 'asc' }, { field: 'numberOfUsers', direction: 'asc' }],
                onSelect: (event) => { event.done(() => { that.onChangeSelection(event); }); },
                onUnSelect: (event) => { event.done(() => { that.onChangeSelection(event); }); },
                onAdd: (event) => { that.onAddSchool(); },
                onChange: (event) => { that.onUpdateSchool(event); },
                onDelete: (event) => { that.onDeleteSchools(event); },
            });
            this.schoolGrid = w2ui[this.schoolGridName];
        }
        this.loadTablesFromSchoolObject();
        $tableRight.empty();
        $tableRight.append(jQuery(`
        <div id="jo_exportschools">
        <div>
            <a href="exportSchools"><b>Markierte Schulen exportieren</b></a>
        </div>
        <div style="margin-top: 10px">
            <b>Schulen importieren:</b>
            <form action="servlet/importSchools" method="POST" enctype="multipart/form-data">
                <input type="file" name="files" multiple>
                <input id="jo_upload_school_button" type="button" value="Upload">
              </form>
        </div>
        <div class="jo_importSchoolsLoggingDiv"></div>
    </div>
        `));
        jQuery('#jo_upload_school_button').on('click', () => {
            let loggingDiv = jQuery('.jo_importSchoolsLoggingDiv');
            loggingDiv.empty();
            loggingDiv.append(jQuery('<div style="color: green; font-weight: bold; margin-bottom: 5px;">Die Daten werden hochgeladen. Bitte warten...</div>'));
            jQuery.ajax({
                url: 'servlet/importSchools',
                type: 'POST',
                data: new FormData(jQuery('#jo_exportschools form')[0]),
                processData: false,
                enctype: 'multipart/form-data',
                contentType: false,
                cache: false
            }).done(function (response) {
                console.log(response);
                let fetchLog = () => {
                    let request = { type: response.messageType };
                    ajax("getMessages", request, (response) => {
                        if (response.messages.length > 0) {
                            let done = false;
                            for (let message of response.messages) {
                                loggingDiv.append(jQuery('<div>' + message.text + "</div>"));
                                loggingDiv[0].scrollTop = loggingDiv[0].scrollHeight;
                                done = done || message.done;
                                if (message.text.indexOf("abgeschlossen!") >= 0) {
                                    that.loadTablesFromSchoolObject();
                                }
                            }
                            if (done) {
                                that.loadTablesFromSchoolObject();
                            }
                            else {
                                setTimeout(fetchLog, 1000);
                            }
                        }
                        else {
                            setTimeout(fetchLog, 1000);
                        }
                    });
                };
                fetchLog();
            }).fail(function () {
                console.log("An error occurred, the files couldn't be sent!");
            });
        });
    }
    onDeleteSchools(event) {
        if (!event.force || event.isStopped)
            return;
        let recIds = this.schoolGrid.getSelection();
        //@ts-ignore
        // recIds = <any>this.schoolGrid.getSelection().map((str) => str.recid).filter((value, index, array) => array.indexOf(value) === index);
        // let selectedSchools: SchoolData[] = <SchoolData[]>this.schoolGrid.records.filter(
        //     (cd: SchoolData) => recIds.indexOf(cd.id) >= 0);
        let that = this;
        let deleteOneSchool = () => {
            if (recIds.length > 0) {
                let id = recIds.pop();
                let request = {
                    type: "delete",
                    data: null,
                    id: id,
                };
                ajax("CRUDSchool", request, (response) => {
                    this.schoolGrid.remove("" + id);
                    this.schoolGrid.refresh();
                    deleteOneSchool();
                }, () => {
                    this.schoolGrid.refresh();
                });
            }
        };
        deleteOneSchool();
    }
    onUpdateSchool(event) {
        let data = this.schoolGrid.records[event.index];
        let field = this.schoolGrid.columns[event.column]["field"];
        data[field] = event.value_new;
        let request = {
            type: "update",
            data: data,
        };
        ajax("CRUDSchool", request, (response) => {
            // console.log(data);
            delete data["w2ui"]["changes"];
            this.schoolGrid.refreshCell(data["recid"], field);
        }, () => {
            data[field] = event.value_original;
            this.schoolGrid.refresh();
        });
    }
    onAddSchool() {
        let request = {
            type: "create",
            data: {
                id: -1,
                name: "Name der Schule",
                kuerzel: "kuerzel",
                classes: [],
                usersWithoutClass: []
            },
        };
        ajax("CRUDSchool", request, (response) => {
            let cd = request.data;
            cd.id = response.id;
            this.schoolGrid.add(cd);
            this.schoolGrid.editField(cd.id + "", 1, undefined, { keyCode: 13 });
            this.selectTextInCell();
        });
    }
    onChangeSelection(event) {
        let recIds = this.schoolGrid.getSelection();
        if (recIds.length == 0) {
            return;
        }
        jQuery('#jo_exportschools a').attr('href', 'servlet/exportSchools?ids=' + recIds.join(','));
    }
    loadTablesFromSchoolObject() {
        let userData = this.administration.userData;
        let school_id = userData.schule_id;
        if (userData.is_admin)
            school_id = null;
        let request = { school_id: school_id };
        ajax("getSchoolData", request, (data) => {
            this.schoolDataList = data.schoolData;
            this.schoolGrid.clear();
            for (let school of this.schoolDataList) {
                school["numberOfClasses"] = school.classes.length;
                let n = 0;
                school.classes.forEach(c => n += c.students.length);
                n += school.usersWithoutClass.length;
                school["numberOfUsers"] = n;
            }
            this.schoolGrid.add(this.schoolDataList);
            this.schoolGrid.refresh();
        }, (error) => {
            w2alert('Fehler beim Holen der Daten: ' + error);
            debugger;
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXhwb3J0SW1wb3J0TUkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L2FkbWluaXN0cmF0aW9uL0V4cG9ydEltcG9ydE1JLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVuRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFNdEQsTUFBTSxPQUFPLGNBQWUsU0FBUSxhQUFhO0lBQWpEOztRQUVJLG1CQUFjLEdBQUcsc0JBQXNCLENBQUM7UUFJeEMsbUJBQWMsR0FBaUIsRUFBRSxDQUFDO0lBaVF0QyxDQUFDO0lBL1BHLGVBQWUsQ0FBQyxJQUFjO1FBQzFCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBRUQsbUJBQW1CO1FBQ2YsT0FBTyxpQ0FBaUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsbUJBQW1CLENBQUMsWUFBaUMsRUFBRSxVQUErQixFQUNsRixXQUFnQyxFQUFFLFdBQWdDO1FBQ2xFLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUVoQixJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDNUI7YUFBTTtZQUNILFVBQVUsQ0FBQyxNQUFNLENBQUM7Z0JBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxjQUFjO2dCQUN6QixNQUFNLEVBQUUsU0FBUztnQkFDakIsc0JBQXNCO2dCQUN0QixXQUFXLEVBQUUsSUFBSTtnQkFDakIsSUFBSSxFQUFFO29CQUNGLE1BQU0sRUFBRSxJQUFJO29CQUNaLE9BQU8sRUFBRSxJQUFJO29CQUNiLFVBQVUsRUFBRSxJQUFJO29CQUNoQixhQUFhLEVBQUUsSUFBSTtvQkFDbkIsTUFBTSxFQUFFLElBQUk7b0JBQ1osWUFBWSxFQUFFLElBQUk7b0JBQ2xCLGFBQWEsRUFB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QUUsQ0FBQztRQUM5QixDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNULE9BQU8sQ0FBQywrQkFBK0IsR0FBRyxLQUFLLENBQUMsQ0FBQztZQUNqRCxRQUFRLENBQUM7UUFDYixDQUFDLENBQUMsQ0FBQztJQUdQLENBQUM7Q0FJSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFkbWluTWVudUl0ZW0gfSBmcm9tIFwiLi9BZG1pbk1lbnVJdGVtLmpzXCI7XHJcbmltcG9ydCB7IFVzZXJEYXRhLCBDUlVEVXNlclJlcXVlc3QsIENSVURTY2hvb2xSZXF1ZXN0LCBDUlVEUmVzcG9uc2UsIFNjaG9vbERhdGEsIEdldFNjaG9vbERhdGFSZXF1ZXN0LCBHZXRTY2hvb2xEYXRhUmVzcG9uc2UsIEltcG9ydFNjaG9vbHNSZXNwb25zZSwgR2V0TWVzc2FnZXNSZXNwb25zZSwgR2V0TWVzc2FnZXNSZXF1ZXN0IH0gZnJvbSBcIi4uL2NvbW11bmljYXRpb24vRGF0YS5qc1wiO1xyXG5pbXBvcnQgeyBhamF4IH0gZnJvbSBcIi4uL2NvbW11bmljYXRpb24vQWpheEhlbHBlci5qc1wiO1xyXG5pbXBvcnQgeyBQYXNzd29yZFBvcHVwIH0gZnJvbSBcIi4vUGFzc3dvcmRQb3B1cC5qc1wiO1xyXG5cclxuZGVjbGFyZSB2YXIgdzJwcm9tcHQ6IGFueTtcclxuZGVjbGFyZSB2YXIgdzJhbGVydDogYW55O1xyXG5cclxuZXhwb3J0IGNsYXNzIEV4cG9ydEltcG9ydE1JIGV4dGVuZHMgQWRtaW5NZW51SXRlbSB7XHJcblxyXG4gICAgc2Nob29sR3JpZE5hbWUgPSBcInNjaG9vbHNHcmlkRm9ySW1wb3J0XCI7XHJcblxyXG4gICAgc2Nob29sR3JpZDogVzJVSS5XMkdyaWQ7XHJcblxyXG4gICAgc2Nob29sRGF0YUxpc3Q6IFNjaG9vbERhdGFbXSA9IFtdO1xyXG5cclxuICAgIGNoZWNrUGVybWlzc2lvbih1c2VyOiBVc2VyRGF0YSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB1c2VyLmlzX2FkbWluO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEJ1dHRvbklkZW50aWZpZXIoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gXCJTY2h1bGVuIEV4cG9ydGllcmVuL0ltcG9ydGllcmVuXCI7XHJcbiAgICB9XHJcblxyXG4gICAgb25NZW51QnV0dG9uUHJlc3NlZCgkbWFpbkhlYWRpbmc6IEpRdWVyeTxIVE1MRWxlbWVudD4sICR0YWJsZUxlZnQ6IEpRdWVyeTxIVE1MRWxlbWVudD4sXHJcbiAgICAgICAgJHRhYmxlUmlnaHQ6IEpRdWVyeTxIVE1MRWxlbWVudD4sICRtYWluRm9vdGVyOiBKUXVlcnk8SFRNTEVsZW1lbnQ+KSB7XHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5zY2hvb2xHcmlkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5zY2hvb2xHcmlkLnJlbmRlcigpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICR0YWJsZUxlZnQudzJncmlkKHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMuc2Nob29sR3JpZE5hbWUsXHJcbiAgICAgICAgICAgICAgICBoZWFkZXI6ICdTY2h1bGVuJyxcclxuICAgICAgICAgICAgICAgIC8vIHNlbGVjdFR5cGU6IFwiY2VsbFwiLFxyXG4gICAgICAgICAgICAgICAgbXVsdGlTZWxlY3Q6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIHRvb2xiYXI6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdG9vbGJhckFkZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICB0b29sYmFyRGVsZXRlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIGZvb3RlcjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RDb2x1bW46IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdG9vbGJhclNlYXJjaDogZmFsc2VcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICByZWNpZDogXCJpZFwiLFxyXG4gICAgICAgICAgICAgICAgY29sdW1uczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHsgZmllbGQ6ICdpZCcsIGNhcHRpb246ICdJRCcsIHNpemU6ICcyMHB4Jywgc29ydGFibGU6IHRydWUsIGhpZGRlbjogdHJ1ZSB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgZmllbGQ6ICduYW1lJywgY2FwdGlvbjogJ0JlemVpY2hudW5nJywgc2l6ZTogJzMwJScsIHNvcnRhYmxlOiB0cnVlLCByZXNpemFibGU6IHRydWUsIGVkaXRhYmxlOiB7IHR5cGU6ICd0ZXh0JyB9IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgeyBmaWVsZDogJ2t1ZXJ6ZWwnLCBjYXB0aW9uOiAnS8O8cnplbCcsIHNpemU6ICcxMCUnLCBzb3J0YWJsZTogdHJ1ZSwgcmVzaXphYmxlOiB0cnVlLCBlZGl0YWJsZTogeyB0eXBlOiAndGV4dCcsIG1heGxlbmd0aDogXCIxMFwiIH0gfSxcclxuICAgICAgICAgICAgICAgICAgICB7IGZpZWxkOiAnbnVtYmVyT2ZDbGFzc2VzJywgY2FwdGlvbjogJ0tsYXNzZW4nLCBzaXplOiAnMzAlJywgc29ydGFibGU6IHRydWUsIHJlc2l6YWJsZTogdHJ1ZSB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgZmllbGQ6ICdudW1iZXJPZlVzZXJzJywgY2FwdGlvbjogJ1VzZXInLCBzaXplOiAnMzAlJywgc29ydGFibGU6IHRydWUsIHJlc2l6YWJsZTogdHJ1ZSB9LFxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIHNlYXJjaGVzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgeyBmaWVsZDogJ25hbWUnLCBsYWJlbDogJ0JlemVpY2hudW5nJywgdHlwZTogJ3RleHQnIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICBzb3J0RGF0YTogW3sgZmllbGQ6ICduYW1lJywgZGlyZWN0aW9uOiAnYXNjJyB9LCB7IGZpZWxkOiAna3VlcnplbCcsIGRpcmVjdGlvbjogJ2FzYycgfSxcclxuICAgICAgICAgICAgICAgIHsgZmllbGQ6ICdudW1iZXJPZkNsYXNzZXMnLCBkaXJlY3Rpb246ICdhc2MnIH0sIHsgZmllbGQ6ICdudW1iZXJPZlVzZXJzJywgZGlyZWN0aW9uOiAnYXNjJyB9XSxcclxuICAgICAgICAgICAgICAgIG9uU2VsZWN0OiAoZXZlbnQpID0+IHsgZXZlbnQuZG9uZSgoKSA9PiB7IHRoYXQub25DaGFuZ2VTZWxlY3Rpb24oZXZlbnQpIH0pIH0sXHJcbiAgICAgICAgICAgICAgICBvblVuU2VsZWN0OiAoZXZlbnQpID0+IHsgZXZlbnQuZG9uZSgoKSA9PiB7IHRoYXQub25DaGFuZ2VTZWxlY3Rpb24oZXZlbnQpIH0pIH0sXHJcbiAgICAgICAgICAgICAgICBvbkFkZDogKGV2ZW50KSA9PiB7IHRoYXQub25BZGRTY2hvb2woKSB9LFxyXG4gICAgICAgICAgICAgICAgb25DaGFuZ2U6IChldmVudCkgPT4geyB0aGF0Lm9uVXBkYXRlU2Nob29sKGV2ZW50KSB9LFxyXG4gICAgICAgICAgICAgICAgb25EZWxldGU6IChldmVudCkgPT4geyB0aGF0Lm9uRGVsZXRlU2Nob29scyhldmVudCkgfSxcclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2Nob29sR3JpZCA9IHcydWlbdGhpcy5zY2hvb2xHcmlkTmFtZV07XHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHRoaXMubG9hZFRhYmxlc0Zyb21TY2hvb2xPYmplY3QoKTtcclxuXHJcbiAgICAgICAgJHRhYmxlUmlnaHQuZW1wdHkoKTtcclxuXHJcbiAgICAgICAgJHRhYmxlUmlnaHQuYXBwZW5kKGpRdWVyeShgXHJcbiAgICAgICAgPGRpdiBpZD1cImpvX2V4cG9ydHNjaG9vbHNcIj5cclxuICAgICAgICA8ZGl2PlxyXG4gICAgICAgICAgICA8YSBocmVmPVwiZXhwb3J0U2Nob29sc1wiPjxiPk1hcmtpZXJ0ZSBTY2h1bGVuIGV4cG9ydGllcmVuPC9iPjwvYT5cclxuICAgICAgICA8L2Rpdj5cclxuICAgICAgICA8ZGl2IHN0eWxlPVwibWFyZ2luLXRvcDogMTBweFwiPlxyXG4gICAgICAgICAgICA8Yj5TY2h1bGVuIGltcG9ydGllcmVuOjwvYj5cclxuICAgICAgICAgICAgPGZvcm0gYWN0aW9uPVwic2VydmxldC9pbXBvcnRTY2hvb2xzXCIgbWV0aG9kPVwiUE9TVFwiIGVuY3R5cGU9XCJtdWx0aXBhcnQvZm9ybS1kYXRhXCI+XHJcbiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT1cImZpbGVcIiBuYW1lPVwiZmlsZXNcIiBtdWx0aXBsZT5cclxuICAgICAgICAgICAgICAgIDxpbnB1dCBpZD1cImpvX3VwbG9hZF9zY2hvb2xfYnV0dG9uXCIgdHlwZT1cImJ1dHRvblwiIHZhbHVlPVwiVXBsb2FkXCI+XHJcbiAgICAgICAgICAgICAgPC9mb3JtPlxyXG4gICAgICAgIDwvZGl2PlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJqb19pbXBvcnRTY2hvb2xzTG9nZ2luZ0RpdlwiPjwvZGl2PlxyXG4gICAgPC9kaXY+XHJcbiAgICAgICAgYCkpXHJcblxyXG5cclxuICAgICAgICBqUXVlcnkoJyNqb191cGxvYWRfc2Nob29sX2J1dHRvbicpLm9uKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgbGV0IGxvZ2dpbmdEaXYgPSBqUXVlcnkoJy5qb19pbXBvcnRTY2hvb2xzTG9nZ2luZ0RpdicpO1xyXG4gICAgICAgICAgICBsb2dnaW5nRGl2LmVtcHR5KCk7XHJcbiAgICAgICAgICAgIGxvZ2dpbmdEaXYuYXBwZW5kKGpRdWVyeSgnPGRpdiBzdHlsZT1cImNvbG9yOiBncmVlbjsgZm9udC13ZWlnaHQ6IGJvbGQ7IG1hcmdpbi1ib3R0b206IDVweDtcIj5EaWUgRGF0ZW4gd2VyZGVuIGhvY2hnZWxhZGVuLiBCaXR0ZSB3YXJ0ZW4uLi48L2Rpdj4nKSk7XHJcblxyXG4gICAgICAgICAgICBqUXVlcnkuYWpheCh7XHJcbiAgICAgICAgICAgICAgICB1cmw6ICdzZXJ2bGV0L2ltcG9ydFNjaG9vbHMnLCBcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdQT1NUJyxcclxuICAgICAgICAgICAgICAgIGRhdGE6IG5ldyBGb3JtRGF0YSg8SFRNTEZvcm1FbGVtZW50PmpRdWVyeSgnI2pvX2V4cG9ydHNjaG9vbHMgZm9ybScpWzBdKSwgLy8gVGhlIGZvcm0gd2l0aCB0aGUgZmlsZSBpbnB1dHMuXHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBlbmN0eXBlOiAnbXVsdGlwYXJ0L2Zvcm0tZGF0YScsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UgICAgICAgXHJcbiAgICAgICAgICAgICAgfSkuZG9uZShmdW5jdGlvbihyZXNwb25zZTogSW1wb3J0U2Nob29sc1Jlc3BvbnNlKXtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIGxldCBmZXRjaExvZyA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcmVxdWVzdDogR2V0TWVzc2FnZXNSZXF1ZXN0ID0ge3R5cGU6IHJlc3BvbnNlLm1lc3NhZ2VUeXBlfVxyXG4gICAgICAgICAgICAgICAgICAgIGFqYXgoXCJnZXRNZXNzYWdlc1wiLCByZXF1ZXN0LCAocmVzcG9uc2U6IEdldE1lc3NhZ2VzUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVzcG9uc2UubWVzc2FnZXMubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZG9uZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBtZXNzYWdlIG9mIHJlc3BvbnNlLm1lc3NhZ2VzKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nRGl2LmFwcGVuZChqUXVlcnkoJzxkaXY+JyArIG1lc3NhZ2UudGV4dCArIFwiPC9kaXY+XCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nRGl2WzBdLnNjcm9sbFRvcCA9IGxvZ2dpbmdEaXZbMF0uc2Nyb2xsSGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUgPSBkb25lIHx8IG1lc3NhZ2UuZG9uZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtZXNzYWdlLnRleHQuaW5kZXhPZihcImFiZ2VzY2hsb3NzZW4hXCIpID49IDApe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmxvYWRUYWJsZXNGcm9tU2Nob29sT2JqZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmxvYWRUYWJsZXNGcm9tU2Nob29sT2JqZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZmV0Y2hMb2csIDEwMDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZmV0Y2hMb2csIDEwMDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBmZXRjaExvZygpO1xyXG5cclxuICAgICAgICAgICAgfSkuZmFpbChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJBbiBlcnJvciBvY2N1cnJlZCwgdGhlIGZpbGVzIGNvdWxkbid0IGJlIHNlbnQhXCIpO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBvbkRlbGV0ZVNjaG9vbHMoZXZlbnQ6IGFueSkge1xyXG4gICAgICAgIGlmICghZXZlbnQuZm9yY2UgfHwgZXZlbnQuaXNTdG9wcGVkKSByZXR1cm47XHJcblxyXG4gICAgICAgIGxldCByZWNJZHM6IG51bWJlcltdID0gPG51bWJlcltdPnRoaXMuc2Nob29sR3JpZC5nZXRTZWxlY3Rpb24oKTtcclxuXHJcblxyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIC8vIHJlY0lkcyA9IDxhbnk+dGhpcy5zY2hvb2xHcmlkLmdldFNlbGVjdGlvbigpLm1hcCgoc3RyKSA9PiBzdHIucmVjaWQpLmZpbHRlcigodmFsdWUsIGluZGV4LCBhcnJheSkgPT4gYXJyYXkuaW5kZXhPZih2YWx1ZSkgPT09IGluZGV4KTtcclxuXHJcbiAgICAgICAgLy8gbGV0IHNlbGVjdGVkU2Nob29sczogU2Nob29sRGF0YVtdID0gPFNjaG9vbERhdGFbXT50aGlzLnNjaG9vbEdyaWQucmVjb3Jkcy5maWx0ZXIoXHJcbiAgICAgICAgLy8gICAgIChjZDogU2Nob29sRGF0YSkgPT4gcmVjSWRzLmluZGV4T2YoY2QuaWQpID49IDApO1xyXG5cclxuICAgIGxldCB0aGF0ID0gdGhpcztcclxuXHJcbiAgICBsZXQgZGVsZXRlT25lU2Nob29sID0gKCkgPT4ge1xyXG5cclxuICAgICAgICBpZihyZWNJZHMubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgIGxldCBpZCA9IHJlY0lkcy5wb3AoKTtcclxuICAgICAgICAgICAgbGV0IHJlcXVlc3Q6IENSVURTY2hvb2xSZXF1ZXN0ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJkZWxldGVcIixcclxuICAgICAgICAgICAgICAgIGRhdGE6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBpZDogaWQsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAgICAgYWpheChcIkNSVURTY2hvb2xcIiwgcmVxdWVzdCwgKHJlc3BvbnNlOiBDUlVEUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2Nob29sR3JpZC5yZW1vdmUoXCJcIiArIGlkKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2Nob29sR3JpZC5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICBkZWxldGVPbmVTY2hvb2woKTtcclxuICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zY2hvb2xHcmlkLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlT25lU2Nob29sKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG9uVXBkYXRlU2Nob29sKGV2ZW50OiBhbnkpIHtcclxuXHJcbiAgICAgICAgbGV0IGRhdGE6IFNjaG9vbERhdGEgPSA8U2Nob29sRGF0YT50aGlzLnNjaG9vbEdyaWQucmVjb3Jkc1tldmVudC5pbmRleF07XHJcbiAgICAgICAgbGV0IGZpZWxkID0gdGhpcy5zY2hvb2xHcmlkLmNvbHVtbnNbZXZlbnQuY29sdW1uXVtcImZpZWxkXCJdO1xyXG4gICAgICAgIGRhdGFbZmllbGRdID0gZXZlbnQudmFsdWVfbmV3O1xyXG5cclxuICAgICAgICBsZXQgcmVxdWVzdDogQ1JVRFNjaG9vbFJlcXVlc3QgPSB7XHJcbiAgICAgICAgICAgIHR5cGU6IFwidXBkYXRlXCIsXHJcbiAgICAgICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhamF4KFwiQ1JVRFNjaG9vbFwiLCByZXF1ZXN0LCAocmVzcG9uc2U6IENSVURSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgZGVsZXRlIGRhdGFbXCJ3MnVpXCJdW1wiY2hhbmdlc1wiXTtcclxuICAgICAgICAgICAgdGhpcy5zY2hvb2xHcmlkLnJlZnJlc2hDZWxsKGRhdGFbXCJyZWNpZFwiXSwgZmllbGQpO1xyXG4gICAgICAgIH0sICgpID0+IHsgIFxyXG4gICAgICAgICAgICBkYXRhW2ZpZWxkXSA9IGV2ZW50LnZhbHVlX29yaWdpbmFsO1xyXG4gICAgICAgICAgICB0aGlzLnNjaG9vbEdyaWQucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQWRkU2Nob29sKCkge1xyXG4gICAgICAgIGxldCByZXF1ZXN0OiBDUlVEU2Nob29sUmVxdWVzdCA9IHtcclxuICAgICAgICAgICAgdHlwZTogXCJjcmVhdGVcIixcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgaWQ6IC0xLFxyXG4gICAgICAgICAgICAgICAgbmFtZTogXCJOYW1lIGRlciBTY2h1bGVcIixcclxuICAgICAgICAgICAgICAgIGt1ZXJ6ZWw6IFwia3VlcnplbFwiLFxyXG4gICAgICAgICAgICAgICAgY2xhc3NlczogW10sXHJcbiAgICAgICAgICAgICAgICB1c2Vyc1dpdGhvdXRDbGFzczogW11cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBhamF4KFwiQ1JVRFNjaG9vbFwiLCByZXF1ZXN0LCAocmVzcG9uc2U6IENSVURSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgY2Q6IFNjaG9vbERhdGEgPSByZXF1ZXN0LmRhdGE7XHJcbiAgICAgICAgICAgIGNkLmlkID0gcmVzcG9uc2UuaWQ7XHJcbiAgICAgICAgICAgIHRoaXMuc2Nob29sR3JpZC5hZGQoY2QpO1xyXG4gICAgICAgICAgICB0aGlzLnNjaG9vbEdyaWQuZWRpdEZpZWxkKGNkLmlkICsgXCJcIiwgMSwgdW5kZWZpbmVkLCB7IGtleUNvZGU6IDEzIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RUZXh0SW5DZWxsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25DaGFuZ2VTZWxlY3Rpb24oZXZlbnQ6IGFueSkge1xyXG5cclxuICAgICAgICBsZXQgcmVjSWRzOiBudW1iZXJbXSA9IDxudW1iZXJbXT50aGlzLnNjaG9vbEdyaWQuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgICAgaWYgKHJlY0lkcy5sZW5ndGggPT0gMCl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9IFxyXG5cclxuICAgICAgICBqUXVlcnkoJyNqb19leHBvcnRzY2hvb2xzIGEnKS5hdHRyKCdocmVmJywgJ3NlcnZsZXQvZXhwb3J0U2Nob29scz9pZHM9JyArIHJlY0lkcy5qb2luKCcsJykpO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIGxvYWRUYWJsZXNGcm9tU2Nob29sT2JqZWN0KCkge1xyXG5cclxuICAgICAgICBsZXQgdXNlckRhdGEgPSB0aGlzLmFkbWluaXN0cmF0aW9uLnVzZXJEYXRhO1xyXG4gICAgICAgIGxldCBzY2hvb2xfaWQgPSB1c2VyRGF0YS5zY2h1bGVfaWQ7XHJcbiAgICAgICAgaWYgKHVzZXJEYXRhLmlzX2FkbWluKSBzY2hvb2xfaWQgPSBudWxsO1xyXG5cclxuICAgICAgICBsZXQgcmVxdWVzdDogR2V0U2Nob29sRGF0YVJlcXVlc3QgPSB7IHNjaG9vbF9pZDogc2Nob29sX2lkIH07XHJcblxyXG4gICAgICAgIGFqYXgoXCJnZXRTY2hvb2xEYXRhXCIsIHJlcXVlc3QsIChkYXRhOiBHZXRTY2hvb2xEYXRhUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zY2hvb2xEYXRhTGlzdCA9IGRhdGEuc2Nob29sRGF0YTtcclxuICAgICAgICAgICAgdGhpcy5zY2hvb2xHcmlkLmNsZWFyKCk7XHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBzY2hvb2wgb2YgdGhpcy5zY2hvb2xEYXRhTGlzdCkge1xyXG4gICAgICAgICAgICAgICAgc2Nob29sW1wibnVtYmVyT2ZDbGFzc2VzXCJdID0gc2Nob29sLmNsYXNzZXMubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgbGV0IG4gPSAwO1xyXG4gICAgICAgICAgICAgICAgc2Nob29sLmNsYXNzZXMuZm9yRWFjaChjID0+IG4gKz0gYy5zdHVkZW50cy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgbiArPSBzY2hvb2wudXNlcnNXaXRob3V0Q2xhc3MubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgc2Nob29sW1wibnVtYmVyT2ZVc2Vyc1wiXSA9IG47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2Nob29sR3JpZC5hZGQodGhpcy5zY2hvb2xEYXRhTGlzdCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNjaG9vbEdyaWQucmVmcmVzaCgpO1xyXG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICB3MmFsZXJ0KCdGZWhsZXIgYmVpbSBIb2xlbiBkZXIgRGF0ZW46ICcgKyBlcnJvcik7XHJcbiAgICAgICAgICAgIGRlYnVnZ2VyO1xyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG5cclxuXHJcbn0iXX0=