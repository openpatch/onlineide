import { convertPxToNumber } from "../../tools/HtmlTools.js";
export class SpeedControl {
    // <div id="speedcontrol-outer" title="Geschwindigkeitsregler" draggable="false">
    //     <div id="speedcontrol-bar" draggable="false"></div>
    //     <div id="speedcontrol-grip" draggable="false">
    //         <div id="speedcontrol-display">100 Schritte/s</div>
    //     </div>
    // </div>
    constructor($container) {
        this.position = 0;
        this.gripWidth = 10;
        this.overallWidth = 100;
        this.$outer = jQuery('<div class="jo_speedcontrol-outer" title="Geschwindigkeitsregler" draggable="false"></div>');
        this.$bar = jQuery('<div class="jo_speedcontrol-bar" draggable="false"></div>');
        this.$grip = jQuery('<div class="jo_speedcontrol-grip" draggable="false"></div>');
        this.$display = jQuery('<div class="jo_speedcontrol-display" draggable="false">100 Schritte/s</div>');
        this.$grip.append(this.$display);
        this.$outer.append(this.$bar, this.$grip);
        $container.append(this.$outer);
    }
    setInterpreter(i) {
        this.interpreter = i;
    }
    initGUI() {
        let mousedownX;
        let oldPosition;
        let that = this;
        that.overallWidth = convertPxToNumber(this.$outer.css('width'));
        that.gripWidth = convertPxToNumber(that.$grip.css('width'));
        that.xMax = that.overallWidth - that.gripWidth;
        let mousePointer = window.PointerEvent ? "pointer" : "mouse";
        that.$outer.on(mousePointer + 'down', (e) => {
            let x = e.pageX - that.$outer.offset().left - 4;
            that.setSpeed(x);
            that.$grip.css('left', x + 'px');
            //@ts-ignore
            that.$grip.trigger(mousePointer + 'down', [e.clientX]);
            // jQuery('#speedcontrol-display').show();
            // jQuery(document).on('mouseup.speedcontrol1', () => {
            //     jQuery(document).off('mouseup.speedcontrol1');
            //     jQuery('#speedcontrol-display').hide();
            // });
        });
        this.$grip.on(mousePointer + 'down', (e, x) => {
            if (x == null)
                x = e.clientX;
            mousedownX = x;
            oldPosition = that.position;
            jQuery('.joe_controlPanel_top').css("z-index", "1000");
            that.$display.show();
            jQuery(document).on(mousePointer + 'move.speedcontrol', (e) => {
                let deltaX = e.clientX - mousedownX;
                that.setSpeed(oldPosition + deltaX);
            });
            jQuery(document).on(mousePointer + 'up.speedcontrol', () => {
                jQuery(document).off(mousePointer + 'up.speedcontrol');
                jQuery(document).off(mousePointer + 'move.speedcontrol');
                that.$display.hide();
                jQuery('.joe_controlPanel_top').css("z-index", "0");
            });
            e.stopPropagation();
        });
    }
    setSpeedInStepsPerSecond(stepsPerSecond) {
        let intervalBorders = [1, 10, 100, 1000, 10000, 100000, this.interpreter.maxStepsPerSecond];
        if (stepsPerSecond == "max")
            stepsPerSecond = this.interpreter.maxStepsPerSecond;
        stepsPerSecond = Math.min(stepsPerSecond, this.interpreter.maxStepsPerSecond);
        stepsPerSecond = Math.max(stepsPerSecond, 1);
        for (let i = 0; i < intervalBorders.length - 1; i++) {
            let left = intervalBorders[i];
            let right = intervalBorders[i + 1];
            if (stepsPerSecond >= left && stepsPerSecond <= right) {
                let gripIntervalLength = this.xMax / (intervalBorders.length - 1);
                let gripPosition = Math.round(gripIntervalLength * i + gripIntervalLength * (stepsPerSecond - left) / (right - left));
                this.$grip.css('left', gripPosition + 'px');
                this.position = gripPosition;
                break;
            }
        }
        this.setInterpreterSpeed(stepsPerSecond);
    }
    setSpeed(newPosition) {
        if (newPosition < 0) {
            newPosition = 0;
        }
        if (newPosition > this.xMax) {
            newPosition = this.xMax;
        }
        this.position = newPosition;
        this.$grip.css('left', newPosition + "px");
        // in steps/s
        let intervalBorders = [1, 10, 100, 1000, 10000, 100000, this.interpreter.maxStepsPerSecond];
        let intervalDelta = this.xMax / (intervalBorders.length - 1);
        let intervalIndex = Math.floor(newPosition / intervalDelta);
        if (intervalIndex == intervalBorders.length - 1)
            intervalIndex--;
        let factorInsideInterval = (newPosition - intervalIndex * intervalDelta) / intervalDelta;
        let intervalMin = intervalBorders[intervalIndex];
        let intervalMax = intervalBorders[intervalIndex + 1];
        let speed = intervalMin + (intervalMax - intervalMin) * factorInsideInterval;
        this.setInterpreterSpeed(speed);
        // console.log( speed + ' steps/s entspricht ' + this.interpreter.timerDelayMs + ' ms zwischen Steps')
    }
    setInterpreterSpeed(stepsPerSecond) {
        this.interpreter.stepsPerSecond = stepsPerSecond;
        this.interpreter.hideProgrampointerPosition();
        let speedString = "" + Math.ceil(stepsPerSecond);
        if (stepsPerSecond >= this.interpreter.maxStepsPerSecond - 10) {
            speedString = "Maximale Geschwindigkeit";
        }
        this.$display.html(speedString + " Schritte/s");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3BlZWRDb250cm9sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9tYWluL2d1aS9TcGVlZENvbnRyb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFLN0QsTUFBTSxPQUFPLFlBQVk7SUFjekIsaUZBQWlGO0lBQ2pGLDBEQUEwRDtJQUMxRCxxREFBcUQ7SUFDckQsOERBQThEO0lBQzlELGFBQWE7SUFDYixTQUFTO0lBR0wsWUFBWSxVQUErQjtRQXBCM0MsYUFBUSxHQUFXLENBQUMsQ0FBQztRQU9yQixjQUFTLEdBQVcsRUFBRSxDQUFDO1FBQ3ZCLGlCQUFZLEdBQVcsR0FBRyxDQUFDO1FBY3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLDRGQUE0RixDQUFDLENBQUM7UUFDbkgsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsMkRBQTJELENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyw0REFBNEQsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLDZFQUE2RSxDQUFDLENBQUM7UUFFdEcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRW5DLENBQUM7SUFFRCxjQUFjLENBQUMsQ0FBYztRQUN6QixJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQsT0FBTztRQUVILElBQUksVUFBa0IsQ0FBQztRQUN2QixJQUFJ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LENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxHQUFHLG9CQUFvQixDQUFDO1FBRTdFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVoQyxzR0FBc0c7SUFFMUcsQ0FBQztJQUVELG1CQUFtQixDQUFDLGNBQXNCO1FBQ3RDLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztRQUVqRCxJQUFJLENBQUMsV0FBVyxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFFOUMsSUFBSSxXQUFXLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDakQsSUFBRyxjQUFjLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLEVBQUM7WUFDekQsV0FBVyxHQUFHLDBCQUEwQixDQUFDO1NBQzVDO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLGFBQWEsQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbnZlcnRQeFRvTnVtYmVyIH0gZnJvbSBcIi4uLy4uL3Rvb2xzL0h0bWxUb29scy5qc1wiO1xyXG5pbXBvcnQgeyBJbnRlcnByZXRlciwgSW50ZXJwcmV0ZXJTdGF0ZSB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9JbnRlcnByZXRlci5qc1wiO1xyXG5cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgU3BlZWRDb250cm9sIHtcclxuXHJcbiAgICBwb3NpdGlvbjogbnVtYmVyID0gMDtcclxuICAgIHhNYXg6IG51bWJlcjtcclxuICAgICRncmlwOiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG4gICAgJGJhcjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuICAgICRkaXNwbGF5OiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG4gICAgJG91dGVyOiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG5cclxuICAgIGdyaXBXaWR0aDogbnVtYmVyID0gMTA7XHJcbiAgICBvdmVyYWxsV2lkdGg6IG51bWJlciA9IDEwMDtcclxuXHJcbiAgICBpbnRlcnByZXRlcjogSW50ZXJwcmV0ZXJcclxuXHJcbi8vIDxkaXYgaWQ9XCJzcGVlZGNvbnRyb2wtb3V0ZXJcIiB0aXRsZT1cIkdlc2Nod2luZGlna2VpdHNyZWdsZXJcIiBkcmFnZ2FibGU9XCJmYWxzZVwiPlxyXG4vLyAgICAgPGRpdiBpZD1cInNwZWVkY29udHJvbC1iYXJcIiBkcmFnZ2FibGU9XCJmYWxzZVwiPjwvZGl2PlxyXG4vLyAgICAgPGRpdiBpZD1cInNwZWVkY29udHJvbC1ncmlwXCIgZHJhZ2dhYmxlPVwiZmFsc2VcIj5cclxuLy8gICAgICAgICA8ZGl2IGlkPVwic3BlZWRjb250cm9sLWRpc3BsYXlcIj4xMDAgU2Nocml0dGUvczwvZGl2PlxyXG4vLyAgICAgPC9kaXY+XHJcbi8vIDwvZGl2PlxyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcigkY29udGFpbmVyOiBKUXVlcnk8SFRNTEVsZW1lbnQ+KXtcclxuXHJcbiAgICAgICAgdGhpcy4kb3V0ZXIgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19zcGVlZGNvbnRyb2wtb3V0ZXJcIiB0aXRsZT1cIkdlc2Nod2luZGlna2VpdHNyZWdsZXJcIiBkcmFnZ2FibGU9XCJmYWxzZVwiPjwvZGl2PicpO1xyXG4gICAgICAgIHRoaXMuJGJhciA9IGpRdWVyeSgnPGRpdiBjbGFzcz1cImpvX3NwZWVkY29udHJvbC1iYXJcIiBkcmFnZ2FibGU9XCJmYWxzZVwiPjwvZGl2PicpO1xyXG4gICAgICAgIHRoaXMuJGdyaXAgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19zcGVlZGNvbnRyb2wtZ3JpcFwiIGRyYWdnYWJsZT1cImZhbHNlXCI+PC9kaXY+Jyk7XHJcbiAgICAgICAgdGhpcy4kZGlzcGxheSA9IGpRdWVyeSgnPGRpdiBjbGFzcz1cImpvX3NwZWVkY29udHJvbC1kaXNwbGF5XCIgZHJhZ2dhYmxlPVwiZmFsc2VcIj4xMDAgU2Nocml0dGUvczwvZGl2PicpO1xyXG5cclxuICAgICAgICB0aGlzLiRncmlwLmFwcGVuZCh0aGlzLiRkaXNwbGF5KTtcclxuICAgICAgICB0aGlzLiRvdXRlci5hcHBlbmQodGhpcy4kYmFyLCB0aGlzLiRncmlwKTtcclxuXHJcbiAgICAgICAgJGNvbnRhaW5lci5hcHBlbmQodGhpcy4kb3V0ZXIpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzZXRJbnRlcnByZXRlcihpOiBJbnRlcnByZXRlcil7XHJcbiAgICAgICAgdGhpcy5pbnRlcnByZXRlciA9IGk7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEdVSSgpe1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBtb3VzZWRvd25YOiBudW1iZXI7XHJcbiAgICAgICAgbGV0IG9sZFBvc2l0aW9uOiBudW1iZXI7XHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIHRoYXQub3ZlcmFsbFdpZHRoID0gY29udmVydFB4VG9OdW1iZXIodGhpcy4kb3V0ZXIuY3NzKCd3aWR0aCcpKTtcclxuICAgICAgICB0aGF0LmdyaXBXaWR0aCA9IGNvbnZlcnRQeFRvTnVtYmVyKHRoYXQuJGdyaXAuY3NzKCd3aWR0aCcpKTtcclxuICAgICAgICB0aGF0LnhNYXggPSB0aGF0Lm92ZXJhbGxXaWR0aCAtIHRoYXQuZ3JpcFdpZHRoO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBtb3VzZVBvaW50ZXIgPSB3aW5kb3cuUG9pbnRlckV2ZW50ID8gXCJwb2ludGVyXCIgOiBcIm1vdXNlXCI7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhhdC4kb3V0ZXIub24obW91c2VQb2ludGVyICsgJ2Rvd24nLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgXHJcblxyXG4gICAgICAgICAgICBsZXQgeCA9IGUucGFnZVggLSB0aGF0LiRvdXRlci5vZmZzZXQoKS5sZWZ0IC0gNDtcclxuICAgICAgICAgICAgdGhhdC5zZXRTcGVlZCh4KTtcclxuICAgICAgICAgICAgdGhhdC4kZ3JpcC5jc3MoJ2xlZnQnLCB4ICsgJ3B4Jyk7XHJcbiAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICB0aGF0LiRncmlwLnRyaWdnZXIobW91c2VQb2ludGVyICsgJ2Rvd24nLCBbZS5jbGllbnRYXSk7XHJcblxyXG4gICAgICAgICAgICAvLyBqUXVlcnkoJyNzcGVlZGNvbnRyb2wtZGlzcGxheScpLnNob3coKTtcclxuICAgICAgICAgICAgLy8galF1ZXJ5KGRvY3VtZW50KS5vbignbW91c2V1cC5zcGVlZGNvbnRyb2wxJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ21vdXNldXAuc3BlZWRjb250cm9sMScpO1xyXG4gICAgICAgICAgICAvLyAgICAgalF1ZXJ5KCcjc3BlZWRjb250cm9sLWRpc3BsYXknKS5oaWRlKCk7XHJcbiAgICAgICAgICAgIC8vIH0pO1xyXG5cclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLiRncmlwLm9uKG1vdXNlUG9pbnRlciArICdkb3duJywgKGUsIHgpID0+IHtcclxuICAgICAgICAgICAgaWYoeCA9PSBudWxsKSB4ID0gZS5jbGllbnRYO1xyXG4gICAgICAgICAgICBtb3VzZWRvd25YID0geDtcclxuICAgICAgICAgICAgb2xkUG9zaXRpb24gPSB0aGF0LnBvc2l0aW9uO1xyXG4gICAgICAgICAgICBqUXVlcnkoJy5qb2VfY29udHJvbFBhbmVsX3RvcCcpLmNzcyhcInotaW5kZXhcIiwgXCIxMDAwXCIpO1xyXG4gICAgICAgICAgICB0aGF0LiRkaXNwbGF5LnNob3coKTtcclxuXHJcbiAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub24obW91c2VQb2ludGVyICsgJ21vdmUuc3BlZWRjb250cm9sJywgKGUpPT57XHJcbiAgICAgICAgICAgICAgICBsZXQgZGVsdGFYID0gZS5jbGllbnRYIC0gbW91c2Vkb3duWDtcclxuICAgICAgICAgICAgICAgIHRoYXQuc2V0U3BlZWQob2xkUG9zaXRpb24gKyBkZWx0YVgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub24obW91c2VQb2ludGVyICsgJ3VwLnNwZWVkY29udHJvbCcsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKG1vdXNlUG9pbnRlciArICd1cC5zcGVlZGNvbnRyb2wnKTtcclxuICAgICAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKG1vdXNlUG9pbnRlciArICdtb3ZlLnNwZWVkY29udHJvbCcpO1xyXG4gICAgICAgICAgICAgICAgdGhhdC4kZGlzcGxheS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICBqUXVlcnkoJy5qb2VfY29udHJvbFBhbmVsX3RvcCcpLmNzcyhcInotaW5kZXhcIiwgXCIwXCIpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzZXRTcGVlZEluU3RlcHNQZXJTZWNvbmQoc3RlcHNQZXJTZWNvbmQ6IG51bWJlciB8IFwibWF4XCIpe1xyXG4gICAgICAgIGxldCBpbnRlcnZhbEJvcmRlcnMgPSBbMSwgMTAsIDEwMCwgMTAwMCwgMTAwMDAsIDEwMDAwMCwgdGhpcy5pbnRlcnByZXRlci5tYXhTdGVwc1BlclNlY29uZF07XHJcblxyXG4gICAgICAgIGlmKHN0ZXBzUGVyU2Vjb25kID09IFwibWF4XCIpIHN0ZXBzUGVyU2Vjb25kID0gdGhpcy5pbnRlcnByZXRlci5tYXhTdGVwc1BlclNlY29uZDtcclxuICAgICAgICBzdGVwc1BlclNlY29uZCA9IE1hdGgubWluKHN0ZXBzUGVyU2Vjb25kLCB0aGlzLmludGVycHJldGVyLm1heFN0ZXBzUGVyU2Vjb25kKTtcclxuICAgICAgICBzdGVwc1BlclNlY29uZCA9IE1hdGgubWF4KHN0ZXBzUGVyU2Vjb25kLCAxKTtcclxuXHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGludGVydmFsQm9yZGVycy5sZW5ndGggLSAxOyBpKyspe1xyXG4gICAgICAgICAgICBsZXQgbGVmdCA9IGludGVydmFsQm9yZGVyc1tpXTtcclxuICAgICAgICAgICAgbGV0IHJpZ2h0ID0gaW50ZXJ2YWxCb3JkZXJzW2krMV07XHJcbiAgICAgICAgICAgIGlmKHN0ZXBzUGVyU2Vjb25kID49IGxlZnQgJiYgc3RlcHNQZXJTZWNvbmQgPD0gcmlnaHQpe1xyXG4gICAgICAgICAgICAgICAgbGV0IGdyaXBJbnRlcnZhbExlbmd0aCA9IHRoaXMueE1heC8oaW50ZXJ2YWxCb3JkZXJzLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGdyaXBQb3NpdGlvbiA9IE1hdGgucm91bmQoZ3JpcEludGVydmFsTGVuZ3RoICogaSArIGdyaXBJbnRlcnZhbExlbmd0aCAqIChzdGVwc1BlclNlY29uZCAtIGxlZnQpLyhyaWdodCAtIGxlZnQpKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuJGdyaXAuY3NzKCdsZWZ0JywgZ3JpcFBvc2l0aW9uICsgJ3B4Jyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gZ3JpcFBvc2l0aW9uO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2V0SW50ZXJwcmV0ZXJTcGVlZChzdGVwc1BlclNlY29uZCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNldFNwZWVkKG5ld1Bvc2l0aW9uOiBudW1iZXIpe1xyXG5cclxuICAgICAgICBpZihuZXdQb3NpdGlvbiA8IDApe1xyXG4gICAgICAgICAgICBuZXdQb3NpdGlvbiA9IDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZihuZXdQb3NpdGlvbiA+IHRoaXMueE1heCl7XHJcbiAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gdGhpcy54TWF4O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ld1Bvc2l0aW9uO1xyXG5cclxuICAgICAgICB0aGlzLiRncmlwLmNzcygnbGVmdCcsIG5ld1Bvc2l0aW9uICsgXCJweFwiKTtcclxuXHJcbiAgICAgICAgLy8gaW4gc3RlcHMvc1xyXG4gICAgICAgIGxldCBpbnRlcnZhbEJvcmRlcnMgPSBbMSwgMTAsIDEwMCwgMTAwMCwgMTAwMDAsIDEwMDAwMCwgdGhpcy5pbnRlcnByZXRlci5tYXhTdGVwc1BlclNlY29uZF07XHJcblxyXG4gICAgICAgIGxldCBpbnRlcnZhbERlbHRhID0gdGhpcy54TWF4IC8gKGludGVydmFsQm9yZGVycy5sZW5ndGggLSAxKTtcclxuICAgICAgICBsZXQgaW50ZXJ2YWxJbmRleCA9IE1hdGguZmxvb3IobmV3UG9zaXRpb24vaW50ZXJ2YWxEZWx0YSk7XHJcbiAgICAgICAgaWYoaW50ZXJ2YWxJbmRleCA9PSBpbnRlcnZhbEJvcmRlcnMubGVuZ3RoIC0gMSkgaW50ZXJ2YWxJbmRleC0tO1xyXG4gICAgICAgIGxldCBmYWN0b3JJbnNpZGVJbnRlcnZhbCA9IChuZXdQb3NpdGlvbiAtIGludGVydmFsSW5kZXgqaW50ZXJ2YWxEZWx0YSkvaW50ZXJ2YWxEZWx0YTtcclxuXHJcbiAgICAgICAgbGV0IGludGVydmFsTWluID0gaW50ZXJ2YWxCb3JkZXJzW2ludGVydmFsSW5kZXhdO1xyXG4gICAgICAgIGxldCBpbnRlcnZhbE1heCA9IGludGVydmFsQm9yZGVyc1tpbnRlcnZhbEluZGV4ICsgMV07XHJcblxyXG4gICAgICAgIGxldCBzcGVlZCA9IGludGVydmFsTWluICsgKGludGVydmFsTWF4IC0gaW50ZXJ2YWxNaW4pICogZmFjdG9ySW5zaWRlSW50ZXJ2YWw7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0SW50ZXJwcmV0ZXJTcGVlZChzcGVlZCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coIHNwZWVkICsgJyBzdGVwcy9zIGVudHNwcmljaHQgJyArIHRoaXMuaW50ZXJwcmV0ZXIudGltZXJEZWxheU1zICsgJyBtcyB6d2lzY2hlbiBTdGVwcycpXHJcblxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBzZXRJbnRlcnByZXRlclNwZWVkKHN0ZXBzUGVyU2Vjb25kOiBudW1iZXIpe1xyXG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXIuc3RlcHNQZXJTZWNvbmQgPSBzdGVwc1BlclNlY29uZDtcclxuXHJcbiAgICAgICAgdGhpcy5pbnRlcnByZXRlci5oaWRlUHJvZ3JhbXBvaW50ZXJQb3NpdGlvbigpO1xyXG5cclxuICAgICAgICBsZXQgc3BlZWRTdHJpbmcgPSBcIlwiICsgTWF0aC5jZWlsKHN0ZXBzUGVyU2Vjb25kKTtcclxuICAgICAgICBpZihzdGVwc1BlclNlY29uZCA+PSB0aGlzLmludGVycHJldGVyLm1heFN0ZXBzUGVyU2Vjb25kIC0gMTApe1xyXG4gICAgICAgICAgICBzcGVlZFN0cmluZyA9IFwiTWF4aW1hbGUgR2VzY2h3aW5kaWdrZWl0XCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLiRkaXNwbGF5Lmh0bWwoc3BlZWRTdHJpbmcgKyBcIiBTY2hyaXR0ZS9zXCIpO1xyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=