import { InterpreterState } from "../../interpreter/Interpreter.js";
import { SoundTools } from "../../tools/SoundTools.js";
export class ActionManager {
    constructor($mainElement, main) {
        this.$mainElement = $mainElement;
        this.main = main;
        this.actions = {};
        this.keyEntries = {};
        this.buttons = {};
    }
    init() {
        let $element = this.$mainElement;
        if ($element == null)
            $element = jQuery(document);
        let that = this;
        $element.on("keydown", function (event) {
            if (event != null) {
                that.executeKeyDownEvent(event);
                /*
                 * Event is bubbling down to body element
                 * when pressing space bar in embedded mode while program runs.
                 * This leads to scrolling page down. To prevent this:
                 */
                if (event.key == " " && that.main.isEmbedded() &&
                    that.main.getInterpreter().state == InterpreterState.running && !that.main.getMonacoEditor().hasTextFocus()) {
                    event.preventDefault();
                }
            }
        });
    }
    trigger(actionIdentifier) {
        let ae = this.actions[actionIdentifier];
        if (ae != null) {
            ae.action(actionIdentifier, null, "");
        }
    }
    registerAction(identifier, keys, action, text = "", button) {
        let ae = {
            action: action,
            identifier: identifier,
            keys: keys,
            text: text,
            active: true
        };
        this.actions[identifier] = ae;
        for (let key of keys) {
            if (this.keyEntries[key.toLowerCase()] == null) {
                this.keyEntries[key.toLowerCase()] = [];
            }
            this.keyEntries[key.toLowerCase()].push(ae);
        }
        if (button != null) {
            if (this.buttons[identifier] == null) {
                this.buttons[identifier] = [];
            }
            this.buttons[identifier].push(button);
            let t = text;
            if (keys.length > 0) {
                t += " [" + keys.join(", ") + "]";
            }
            button.attr("title", t);
            let mousePointer = window.PointerEvent ? "pointer" : "mouse";
            button.on(mousePointer + 'down', () => {
                if (ae.active) {
                    action(identifier, null, "mousedown");
                }
                if (identifier == "interpreter.start" && this.main.isEmbedded()) {
                    SoundTools.init();
                }
            });
        }
    }
    isActive(actionIdentifier) {
        let ae = this.actions[actionIdentifier];
        if (ae == null)
            return false;
        return ae.active;
    }
    setActive(actionIdentifier, active) {
        let ae = this.actions[actionIdentifier];
        if (ae != null) {
            ae.active = active;
        }
        let buttons = this.buttons[actionIdentifier];
        if (buttons != null) {
            for (let button of buttons) {
                if (active) {
                    button.addClass('jo_active');
                }
                else {
                    button.removeClass('jo_active');
                }
            }
        }
    }
    executeKeyDownEvent(event) {
        if (document.activeElement.tagName.toLowerCase() == "input") {
            return;
        }
        if (event.keyCode <= 18 && event.keyCode >= 16) {
            return; // ctrl, alt, shift
        }
        let key = "";
        if (event.ctrlKey) {
            key += "ctrl+";
        }
        if (event.shiftKey) {
            key += "shift+";
        }
        if (event.altKey) {
            key += "alt+";
        }
        if (event.key != null) {
            key += event.key.toLowerCase();
        }
        let actionEntries = this.keyEntries[key];
        if (actionEntries != null) {
            for (let actionEntry of actionEntries) {
                if (actionEntry.active) {
                    event.stopPropagation();
                    event.preventDefault();
                    actionEntry.action(actionEntry.identifier, null, key);
                    break;
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWN0aW9uTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jbGllbnQvbWFpbi9ndWkvQWN0aW9uTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFnQnZELE1BQU0sT0FBTyxhQUFhO0lBUXRCLFlBQW9CLFlBQWlDLEVBQVUsSUFBYztRQUF6RCxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFVO1FBTjdFLFlBQU8sR0FBZ0QsRUFBRyxDQUFDO1FBRTNELGVBQVUsR0FBcUMsRUFBRSxDQUFDO1FBRWxELFlBQU8sR0FBMEQsRUFBRSxDQUFDO0lBSXBFLENBQUM7SUFFTSxJQUFJO1FBRVAsSUFBSSxRQUFRLEdBQWUsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUU3QyxJQUFHLFFBQVEsSUFBSSxJQUFJO1lBQUUsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVqRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsUUFBUSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsVUFBVSxLQUEwQjtZQUN2RCxJQUFHLEtBQUssSUFBSSxJQUFJLEVBQUM7Z0JBQ2IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUVoQzs7OzttQkFJRztnQkFDSCxJQUFHLEtBQUssQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO29CQUMxQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssSUFBSSxnQkFBZ0IsQ0FBQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLFlBQVksRUFBRSxFQUFDO29CQUMzRyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7aUJBQzFCO2FBQ0o7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFRCxPQUFPLENBQUMsZ0JBQXdCO1FBQzVCLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN4QyxJQUFHLEVBQUUsSUFBSSxJQUFJLEVBQUM7WUFDVixFQUFFLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7SUFHTSxjQUFjLENBQUMsVUFBa0IsRUFBRSxJQUFjLEVBQUUsTUFBYyxFQUFFLE9BQWUsRUFBRSxFQUFFLE1BQTRCO1FBQ3JILElBQUksRUFBRSxHQUFnQjtZQUNsQixNQUFNLEVBQUUsTUFBTTtZQUNkLFVBQVUsRUFBRSxVQUFVO1lBQ3RCLElBQUksRUFBRSxJQUFJO1lBQ1YsSUFBSSxFQUFFLElBQUk7WUFDVixNQUFNLEVBQUUsSUFBSTtTQUNmLENBQUM7UUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUU5QixLQUFJLElBQUksR0FBRyxJQUFJLElBQUksRUFBQztZQUNoQixJQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFDO2dCQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQzthQUMzQztZQUNELElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQy9DO1FBRUQsSUFBRyxNQUFNLElBQUksSUFBSSxFQUFDO1lBQ2QsSUFBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLElBQUksRUFBQztnQkFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7YUFDakM7WUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV0QyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDYixJQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFDO2dCQUNmLENBQUMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7YUFDckM7WUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztZQUV4QixJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUU3RCxNQUFNLENBQUMsRUFBRSxDQUFDLFlBQVksR0FBRyxNQUFNLEVBQUUsR0FBRyxFQUFFO2dCQUNsQyxJQUFHLEVBQUUsQ0FBQyxNQUFNLEVBQUM7b0JBQ1QsTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7aUJBQ3pDO2dCQUNELElBQUcsVUFBVSxJQUFJLG1CQUFtQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUM7b0JBQzNELFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDckI7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUVOO0lBRUwsQ0FBQztJQUVNLFFBQVEsQ0FBQyxnQkFBd0I7UUFFcEMsSUFBSSxFQUFFLEdBQWdCLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUVyRCxJQUFHLEVBQUUsSUFBSSxJQUFJO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFNUIsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDO0lBRXJCLENBQUM7SUFFTSxTQUFTLENBQUMsZ0JBQXdCLEVBQUUsTUFBZTtRQUN0RCxJQUFJLEVBQUUsR0FBZ0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRXJELElBQUcsRUFBRSxJQUFJLElBQUksRUFBQztZQUNWLEVBQUUsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1NBQ3RCO1FBRUQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzdDLElBQUcsT0FBTyxJQUFJLElBQUksRUFBQztZQUNmLEtBQUksSUFBSSxNQUFNLElBQUksT0FBTyxFQUFDO2dCQUN0QixJQUFHLE1BQU0sRUFBQztvQkFDTixNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2lCQUNoQztxQkFBTTtvQkFDSCxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2lCQUNuQzthQUNKO1NBQ0o7SUFFTCxDQUFDO0lBRU0sbUJBQW1CLENBQUMsS0FBMEI7UUFFakQsSUFBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxPQUFPLEVBQUM7WUFDdkQsT0FBTztTQUNWO1FBRUQsSUFBSSxLQUFLLENBQUMsT0FBTyxJQUFJLEVBQUUsSUFBSSxLQUFLLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRTtZQUM1QyxPQUFPLENBQUMsbUJBQW1CO1NBQzlCO1FBRUQsSUFBSSxHQUFHLEdBQVcsRUFBRSxDQUFDO1FBRXJCLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUNmLEdBQUcsSUFBSSxPQUFPLENBQUM7U0FDbEI7UUFFRCxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDaEIsR0FBRyxJQUFJLFFBQVEsQ0FBQztTQUNuQjtRQUVELElBQUksS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNkLEdBQUcsSUFBSSxNQUFNLENBQUM7U0FDakI7UUFFRCxJQUFHLEtBQUssQ0FBQyxHQUFHLElBQUksSUFBSSxFQUFDO1lBQ2pCLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ2xDO1FBRUQsSUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV6QyxJQUFHLGFBQWEsSUFBSSxJQUFJLEVBQUM7WUFDckIsS0FBSSxJQUFJLFdBQVcsSUFBSSxhQUFhLEVBQUM7Z0JBQ2pDLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRTtvQkFDcEIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUN4QixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7b0JBQ3ZCLFdBQVcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQ3RELE1BQU07aUJBQ1Q7YUFDSjtTQUNKO0lBR0wsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW50ZXJwcmV0ZXJTdGF0ZSB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9JbnRlcnByZXRlci5qc1wiO1xyXG5pbXBvcnQgeyBTb3VuZFRvb2xzIH0gZnJvbSBcIi4uLy4uL3Rvb2xzL1NvdW5kVG9vbHMuanNcIjtcclxuaW1wb3J0IHsgTWFpbiB9IGZyb20gXCIuLi9NYWluLmpzXCI7XHJcbmltcG9ydCB7IE1haW5CYXNlIH0gZnJvbSBcIi4uL01haW5CYXNlLmpzXCI7XHJcblxyXG5leHBvcnQgdHlwZSBCdXR0b25Ub2dnbGVyID0gKHN0YXRlOiBib29sZWFuKSA9PiB2b2lkO1xyXG5cclxuZXhwb3J0IHR5cGUgQWN0aW9uID0gKG5hbWU6IHN0cmluZywgYnV0dG9uVG9nZ2xlcj86IEJ1dHRvblRvZ2dsZXIsIHByZXNzZWRfa2V5Pzogc3RyaW5nKSA9PiB2b2lkO1xyXG5cclxuZXhwb3J0IHR5cGUgQWN0aW9uRW50cnkgPSB7XHJcbiAgICB0ZXh0Pzogc3RyaW5nLFxyXG4gICAga2V5czogc3RyaW5nW10sXHJcbiAgICBhY3Rpb246IEFjdGlvbixcclxuICAgIGlkZW50aWZpZXI6IHN0cmluZywgLy8gbmFtZSBvZiBBY3Rpb24gaXMgY29waWVkIGF1dG9tYXRpY2FsbHkgdG8gbmFtZSBvZiBBY3Rpb25FbnRyeVxyXG4gICAgYWN0aXZlOiBib29sZWFuXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBBY3Rpb25NYW5hZ2VyIHtcclxuXHJcbiAgICBhY3Rpb25zOiB7IFthY3Rpb25JZGVudGlmaWVyOiBzdHJpbmddOiBBY3Rpb25FbnRyeSB9ID0geyB9O1xyXG5cclxuICAgIGtleUVudHJpZXM6IHsgW2tleTogc3RyaW5nXTogQWN0aW9uRW50cnlbXSB9ID0ge307XHJcblxyXG4gICAgYnV0dG9uczogeyBbYWN0aW9uSWRlbnRpZmllcjogc3RyaW5nXTogSlF1ZXJ5PEhUTUxFbGVtZW50PltdIH0gPSB7fTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlICRtYWluRWxlbWVudDogSlF1ZXJ5PEhUTUxFbGVtZW50PiwgcHJpdmF0ZSBtYWluOiBNYWluQmFzZSl7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpbml0KCl7XHJcblxyXG4gICAgICAgIGxldCAkZWxlbWVudDpKUXVlcnk8YW55PiA9IHRoaXMuJG1haW5FbGVtZW50O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKCRlbGVtZW50ID09IG51bGwpICRlbGVtZW50ID0galF1ZXJ5KGRvY3VtZW50KTtcclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgICRlbGVtZW50Lm9uKFwia2V5ZG93blwiLCBmdW5jdGlvbiAoZXZlbnQ6IEpRdWVyeS5LZXlEb3duRXZlbnQpIHsgXHJcbiAgICAgICAgICAgIGlmKGV2ZW50ICE9IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlS2V5RG93bkV2ZW50KGV2ZW50KTsgXHJcblxyXG4gICAgICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgICAgICAqIEV2ZW50IGlzIGJ1YmJsaW5nIGRvd24gdG8gYm9keSBlbGVtZW50XHJcbiAgICAgICAgICAgICAgICAgKiB3aGVuIHByZXNzaW5nIHNwYWNlIGJhciBpbiBlbWJlZGRlZCBtb2RlIHdoaWxlIHByb2dyYW0gcnVucy5cclxuICAgICAgICAgICAgICAgICAqIFRoaXMgbGVhZHMgdG8gc2Nyb2xsaW5nIHBhZ2UgZG93bi4gVG8gcHJldmVudCB0aGlzOlxyXG4gICAgICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgICAgICBpZihldmVudC5rZXkgPT0gXCIgXCIgJiYgdGhhdC5tYWluLmlzRW1iZWRkZWQoKSAmJiBcclxuICAgICAgICAgICAgICAgICAgIHRoYXQubWFpbi5nZXRJbnRlcnByZXRlcigpLnN0YXRlID09IEludGVycHJldGVyU3RhdGUucnVubmluZyAmJiAhdGhhdC5tYWluLmdldE1vbmFjb0VkaXRvcigpLmhhc1RleHRGb2N1cygpKXtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHRyaWdnZXIoYWN0aW9uSWRlbnRpZmllcjogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IGFlID0gdGhpcy5hY3Rpb25zW2FjdGlvbklkZW50aWZpZXJdO1xyXG4gICAgICAgIGlmKGFlICE9IG51bGwpe1xyXG4gICAgICAgICAgICBhZS5hY3Rpb24oYWN0aW9uSWRlbnRpZmllciwgbnVsbCwgXCJcIik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwdWJsaWMgcmVnaXN0ZXJBY3Rpb24oaWRlbnRpZmllcjogc3RyaW5nLCBrZXlzOiBzdHJpbmdbXSwgYWN0aW9uOiBBY3Rpb24sIHRleHQ6IHN0cmluZyA9IFwiXCIsIGJ1dHRvbj86IEpRdWVyeTxIVE1MRWxlbWVudD4pe1xyXG4gICAgICAgIGxldCBhZTogQWN0aW9uRW50cnkgPSB7XHJcbiAgICAgICAgICAgIGFjdGlvbjogYWN0aW9uLFxyXG4gICAgICAgICAgICBpZGVudGlmaWVyOiBpZGVudGlmaWVyLFxyXG4gICAgICAgICAgICBrZXlzOiBrZXlzLFxyXG4gICAgICAgICAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgICAgICAgICBhY3RpdmU6IHRydWVcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmFjdGlvbnNbaWRlbnRpZmllcl0gPSBhZTtcclxuXHJcbiAgICAgICAgZm9yKGxldCBrZXkgb2Yga2V5cyl7XHJcbiAgICAgICAgICAgIGlmKHRoaXMua2V5RW50cmllc1trZXkudG9Mb3dlckNhc2UoKV0gPT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmtleUVudHJpZXNba2V5LnRvTG93ZXJDYXNlKCldID0gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5rZXlFbnRyaWVzW2tleS50b0xvd2VyQ2FzZSgpXS5wdXNoKGFlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKGJ1dHRvbiAhPSBudWxsKXtcclxuICAgICAgICAgICAgaWYodGhpcy5idXR0b25zW2lkZW50aWZpZXJdID09IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5idXR0b25zW2lkZW50aWZpZXJdID0gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5idXR0b25zW2lkZW50aWZpZXJdLnB1c2goYnV0dG9uKTtcclxuXHJcbiAgICAgICAgICAgIGxldCB0ID0gdGV4dDtcclxuICAgICAgICAgICAgaWYoa2V5cy5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgICAgIHQgKz0gXCIgW1wiICsga2V5cy5qb2luKFwiLCBcIikgKyBcIl1cIjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYnV0dG9uLmF0dHIoXCJ0aXRsZVwiLCB0KTtcclxuXHJcbiAgICAgICAgICAgIGxldCBtb3VzZVBvaW50ZXIgPSB3aW5kb3cuUG9pbnRlckV2ZW50ID8gXCJwb2ludGVyXCIgOiBcIm1vdXNlXCI7XHJcblxyXG4gICAgICAgICAgICBidXR0b24ub24obW91c2VQb2ludGVyICsgJ2Rvd24nLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZihhZS5hY3RpdmUpe1xyXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbihpZGVudGlmaWVyLCBudWxsLCBcIm1vdXNlZG93blwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmKGlkZW50aWZpZXIgPT0gXCJpbnRlcnByZXRlci5zdGFydFwiICYmIHRoaXMubWFpbi5pc0VtYmVkZGVkKCkpe1xyXG4gICAgICAgICAgICAgICAgICAgIFNvdW5kVG9vbHMuaW5pdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaXNBY3RpdmUoYWN0aW9uSWRlbnRpZmllcjogc3RyaW5nKTogYm9vbGVhbiB7XHJcblxyXG4gICAgICAgIGxldCBhZTogQWN0aW9uRW50cnkgPSB0aGlzLmFjdGlvbnNbYWN0aW9uSWRlbnRpZmllcl07XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYoYWUgPT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgICAgICByZXR1cm4gYWUuYWN0aXZlO1xyXG4gICAgXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldEFjdGl2ZShhY3Rpb25JZGVudGlmaWVyOiBzdHJpbmcsIGFjdGl2ZTogYm9vbGVhbil7XHJcbiAgICAgICAgbGV0IGFlOiBBY3Rpb25FbnRyeSA9IHRoaXMuYWN0aW9uc1thY3Rpb25JZGVudGlmaWVyXTtcclxuICAgICAgICBcclxuICAgICAgICBpZihhZSAhPSBudWxsKXtcclxuICAgICAgICAgICAgYWUuYWN0aXZlID0gYWN0aXZlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGJ1dHRvbnMgPSB0aGlzLmJ1dHRvbnNbYWN0aW9uSWRlbnRpZmllcl07XHJcbiAgICAgICAgaWYoYnV0dG9ucyAhPSBudWxsKXtcclxuICAgICAgICAgICAgZm9yKGxldCBidXR0b24gb2YgYnV0dG9ucyl7XHJcbiAgICAgICAgICAgICAgICBpZihhY3RpdmUpe1xyXG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5hZGRDbGFzcygnam9fYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5yZW1vdmVDbGFzcygnam9fYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBleGVjdXRlS2V5RG93bkV2ZW50KGV2ZW50OiBKUXVlcnkuS2V5RG93bkV2ZW50KSB7XHJcblxyXG4gICAgICAgIGlmKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09IFwiaW5wdXRcIil7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChldmVudC5rZXlDb2RlIDw9IDE4ICYmIGV2ZW50LmtleUNvZGUgPj0gMTYpIHtcclxuICAgICAgICAgICAgcmV0dXJuOyAvLyBjdHJsLCBhbHQsIHNoaWZ0XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQga2V5OiBzdHJpbmcgPSBcIlwiO1xyXG5cclxuICAgICAgICBpZiAoZXZlbnQuY3RybEtleSkge1xyXG4gICAgICAgICAgICBrZXkgKz0gXCJjdHJsK1wiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LnNoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgIGtleSArPSBcInNoaWZ0K1wiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LmFsdEtleSkge1xyXG4gICAgICAgICAgICBrZXkgKz0gXCJhbHQrXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZihldmVudC5rZXkgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgIGtleSArPSBldmVudC5rZXkudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBhY3Rpb25FbnRyaWVzID0gdGhpcy5rZXlFbnRyaWVzW2tleV07XHJcblxyXG4gICAgICAgIGlmKGFjdGlvbkVudHJpZXMgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgIGZvcihsZXQgYWN0aW9uRW50cnkgb2YgYWN0aW9uRW50cmllcyl7XHJcbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uRW50cnkuYWN0aXZlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25FbnRyeS5hY3Rpb24oYWN0aW9uRW50cnkuaWRlbnRpZmllciwgbnVsbCwga2V5KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=