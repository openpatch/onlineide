import { DiagramUnitCm } from "../Diagram.js";
import { ArrowHead } from "./ArrowHead.js";
export class DiagramArrow {
    constructor(parent, routingArrow, color) {
        this.parent = parent;
        this.routingArrow = routingArrow;
        this.color = color;
    }
    show() {
        if (this.$element == null)
            return;
        this.$element.show();
    }
    hide() {
        if (this.$element == null)
            return;
        this.$element.hide();
    }
    detach() {
        if (this.$element == null)
            return;
        this.$element.detach();
    }
    remove() {
        if (this.$element == null)
            return;
        this.$element.remove();
    }
    appendTo($element) {
        $element.append(this.$element);
    }
    clear() {
        if (this.$element == null)
            return;
        this.$element.empty();
    }
    createElement(name, parent = null, attributes) {
        let ns = 'http://www.w3.org/2000/svg';
        let $element = jQuery(document.createElementNS(ns, name));
        if (attributes != null)
            $element.attr(attributes);
        if (parent != null)
            parent.appendChild($element[0]);
        return $element;
    }
    createTextElement(text, parent = null, attributes) {
        let $element = this.createElement("text", parent, {
            font: "16px Roboto",
            "font-family": "sans-serif",
            fill: "#000",
            "alignment-baseline": "hanging"
        });
        if (attributes != null)
            $element.attr(attributes);
        $element.text(text);
        return $element;
    }
    getTextMetrics(textElement) {
        let bbox = textElement[0].getBBox();
        return {
            height: bbox.height * DiagramArrow.cmPerPx,
            width: bbox.width * DiagramArrow.cmPerPx
        };
    }
    render() {
        let $group = this.$element;
        if ($group == null) {
            $group = this.createElement("g", this.parent);
            this.$element = $group;
            $group.css("stroke", this.color);
        }
        else {
            $group.empty();
        }
        let points = this.routingArrow.minimalPoints;
        if (points == null || points.length < 2) {
            return;
        }
        let path = "M " + this.getPathCoordinates(points[0]);
        for (let i = 1; i < points.length; i++) {
            path += " L " + this.getPathCoordinates(points[i]);
        }
        let arrowData = ArrowHead.arrows[this.routingArrow.arrowType];
        let $path = this.createElement("path", $group[0], { d: path });
        $path.css({
            // stroke: "#000000",
            "stroke-width": "0.2 cm",
            "fill": "none",
            "stroke-dasharray": arrowData["stroke-dasharray"]
        });
        while (points.length > 1 && points[points.length - 1].x == points[points.length - 2].x &&
            points[points.length - 1].y == points[points.length - 2].y) {
            points.pop();
        }
        if (points.length > 1 && this.routingArrow.endsOnArrowWithIdentifier == null) {
            let head = ArrowHead.makeHead(points[points.length - 2], points[points.length - 1], this.routingArrow.arrowType);
            let $head = this.createElement("path", $group[0], { d: head.path });
            $head.css({
                stroke: this.color,
                "stroke-width": "0.2 cm",
                "fill": head.fill
            });
        }
    }
    getPathCoordinates(point) {
        let x = point.x * DiagramUnitCm / DiagramArrow.cmPerPx;
        let y = point.y * DiagramUnitCm / DiagramArrow.cmPerPx;
        return "" + x + " " + y;
    }
}
DiagramArrow.cmPerPx = 2.54 / 96;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGlhZ3JhbUFycm93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9tYWluL2d1aS9kaWFncmFtcy9jbGFzc2RpYWdyYW0vRGlhZ3JhbUFycm93LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQVcsTUFBTSxlQUFlLENBQUM7QUFFdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDLE1BQU0sT0FBTyxZQUFZO0lBTXJCLFlBQXNCLE1BQWUsRUFBVSxZQUEwQixFQUFVLEtBQWE7UUFBMUUsV0FBTSxHQUFOLE1BQU0sQ0FBUztRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBUTtJQUVoRyxDQUFDO0lBRU0sSUFBSTtRQUNQLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJO1lBQUUsT0FBTztRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFTSxJQUFJO1FBQ1AsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUk7WUFBRSxPQUFPO1FBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVELE1BQU07UUFDRixJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSTtZQUFFLE9BQU87UUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQsTUFBTTtRQUNGLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJO1lBQUUsT0FBTztRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxRQUFRLENBQUMsUUFBeUI7UUFDOUIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7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QUcsQ0FBQztnQkFDTixNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUs7Z0JBQ2xCLGNBQWMsRUFBRSxRQUFRO2dCQUN4QixNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUk7YUFDcEIsQ0FBQyxDQUFDO1NBQ047SUFFTCxDQUFDO0lBRUQsa0JBQWtCLENBQUMsS0FBWTtRQUMzQixJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxHQUFHLGFBQWEsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsYUFBYSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7UUFDdkQsT0FBTyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDNUIsQ0FBQzs7QUF0SWEsb0JBQU8sR0FBVyxJQUFJLEdBQUcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlhZ3JhbVVuaXRDbSwgRGlhZ3JhbSB9IGZyb20gXCIuLi9EaWFncmFtLmpzXCI7XHJcbmltcG9ydCB7IFJvdXRpbmdBcnJvdywgUG9pbnQgfSBmcm9tIFwiLi9Sb3V0ZXIuanNcIjtcclxuaW1wb3J0IHsgQXJyb3dIZWFkIH0gZnJvbSBcIi4vQXJyb3dIZWFkLmpzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRGlhZ3JhbUFycm93IHtcclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGNtUGVyUHg6IG51bWJlciA9IDIuNTQgLyA5NjtcclxuXHJcbiAgICBwdWJsaWMgJGVsZW1lbnQ6IEpRdWVyeTxFbGVtZW50PjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcGFyZW50OiBFbGVtZW50LCBwcml2YXRlIHJvdXRpbmdBcnJvdzogUm91dGluZ0Fycm93LCBwcml2YXRlIGNvbG9yOiBzdHJpbmcpIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNob3coKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuJGVsZW1lbnQgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIHRoaXMuJGVsZW1lbnQuc2hvdygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoaWRlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLiRlbGVtZW50ID09IG51bGwpIHJldHVybjtcclxuICAgICAgICB0aGlzLiRlbGVtZW50LmhpZGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBkZXRhY2goKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuJGVsZW1lbnQgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIHRoaXMuJGVsZW1lbnQuZGV0YWNoKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLiRlbGVtZW50ID09IG51bGwpIHJldHVybjtcclxuICAgICAgICB0aGlzLiRlbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGFwcGVuZFRvKCRlbGVtZW50OiBKUXVlcnk8RWxlbWVudD4pIHtcclxuICAgICAgICAkZWxlbWVudC5hcHBlbmQodGhpcy4kZWxlbWVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgICAgIGlmICh0aGlzLiRlbGVtZW50ID09IG51bGwpIHJldHVybjtcclxuICAgICAgICB0aGlzLiRlbGVtZW50LmVtcHR5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNyZWF0ZUVsZW1lbnQobmFtZTogc3RyaW5nLCBwYXJlbnQ6IEVsZW1lbnQgPSBudWxsLCBhdHRyaWJ1dGVzPzpcclxuICAgICAgICB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9KTogSlF1ZXJ5PEVsZW1lbnQ+IHtcclxuXHJcbiAgICAgICAgbGV0IG5zID0gJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJztcclxuICAgICAgICBsZXQgJGVsZW1lbnQgPSBqUXVlcnkoZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5zLCBuYW1lKSk7XHJcblxyXG4gICAgICAgIGlmIChhdHRyaWJ1dGVzICE9IG51bGwpICRlbGVtZW50LmF0dHIoYXR0cmlidXRlcyk7XHJcblxyXG4gICAgICAgIGlmIChwYXJlbnQgIT0gbnVsbCkgcGFyZW50LmFwcGVuZENoaWxkKCRlbGVtZW50WzBdKTtcclxuXHJcbiAgICAgICAgcmV0dXJuICRlbGVtZW50O1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHVibGljIGNyZWF0ZVRleHRFbGVtZW50KHRleHQ6IHN0cmluZywgcGFyZW50OiBFbGVtZW50ID0gbnVsbCwgYXR0cmlidXRlcz86XHJcbiAgICAgICAgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSk6IEpRdWVyeTxFbGVtZW50PiB7XHJcblxyXG4gICAgICAgIGxldCAkZWxlbWVudDogSlF1ZXJ5PEVsZW1lbnQ+ID0gdGhpcy5jcmVhdGVFbGVtZW50KFwidGV4dFwiLCBwYXJlbnQsIHtcclxuICAgICAgICAgICAgZm9udDogXCIxNnB4IFJvYm90b1wiLFxyXG4gICAgICAgICAgICBcImZvbnQtZmFtaWx5XCI6IFwic2Fucy1zZXJpZlwiLFxyXG4gICAgICAgICAgICBmaWxsOiBcIiMwMDBcIixcclxuICAgICAgICAgICAgXCJhbGlnbm1lbnQtYmFzZWxpbmVcIjogXCJoYW5naW5nXCJcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKGF0dHJpYnV0ZXMgIT0gbnVsbCkgJGVsZW1lbnQuYXR0cihhdHRyaWJ1dGVzKTtcclxuXHJcbiAgICAgICAgJGVsZW1lbnQudGV4dCh0ZXh0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuICRlbGVtZW50O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRUZXh0TWV0cmljcyh0ZXh0RWxlbWVudDogSlF1ZXJ5PFNWR1RleHRFbGVtZW50Pik6IHsgaGVpZ2h0OiBudW1iZXIsIHdpZHRoOiBudW1iZXIgfSB7XHJcbiAgICAgICAgbGV0IGJib3g6IERPTVJlY3QgPSB0ZXh0RWxlbWVudFswXS5nZXRCQm94KCk7XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGhlaWdodDogYmJveC5oZWlnaHQgKiBEaWFncmFtQXJyb3cuY21QZXJQeCxcclxuICAgICAgICAgICAgd2lkdGg6IGJib3gud2lkdGggKiBEaWFncmFtQXJyb3cuY21QZXJQeFxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIHB1YmxpYyByZW5kZXIoKSB7XHJcblxyXG4gICAgICAgIGxldCAkZ3JvdXAgPSB0aGlzLiRlbGVtZW50O1xyXG4gICAgICAgIGlmICgkZ3JvdXAgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAkZ3JvdXAgPSB0aGlzLmNyZWF0ZUVsZW1lbnQoXCJnXCIsIHRoaXMucGFyZW50KTtcclxuICAgICAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRncm91cDtcclxuICAgICAgICAgICAgJGdyb3VwLmNzcyhcInN0cm9rZVwiLCB0aGlzLmNvbG9yKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkZ3JvdXAuZW1wdHkoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBwb2ludHMgPSB0aGlzLnJvdXRpbmdBcnJvdy5taW5pbWFsUG9pbnRzO1xyXG4gICAgICAgIGlmIChwb2ludHMgPT0gbnVsbCB8fCBwb2ludHMubGVuZ3RoIDwgMikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcGF0aCA9IFwiTSBcIiArIHRoaXMuZ2V0UGF0aENvb3JkaW5hdGVzKHBvaW50c1swXSk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHBhdGggKz0gXCIgTCBcIiArIHRoaXMuZ2V0UGF0aENvb3JkaW5hdGVzKHBvaW50c1tpXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgYXJyb3dEYXRhID0gQXJyb3dIZWFkLmFycm93c1t0aGlzLnJvdXRpbmdBcnJvdy5hcnJvd1R5cGVdO1xyXG4gICAgICAgIGxldCAkcGF0aCA9IHRoaXMuY3JlYXRlRWxlbWVudChcInBhdGhcIiwgJGdyb3VwWzBdLCB7IGQ6IHBhdGggfSk7XHJcbiAgICAgICAgJHBhdGguY3NzKHtcclxuICAgICAgICAgICAgLy8gc3Ryb2tlOiBcIiMwMDAwMDBcIixcclxuICAgICAgICAgICAgXCJzdHJva2Utd2lkdGhcIjogXCIwLjIgY21cIixcclxuICAgICAgICAgICAgXCJmaWxsXCI6IFwibm9uZVwiLFxyXG4gICAgICAgICAgICBcInN0cm9rZS1kYXNoYXJyYXlcIjogYXJyb3dEYXRhW1wic3Ryb2tlLWRhc2hhcnJheVwiXVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB3aGlsZSAocG9pbnRzLmxlbmd0aCA+IDEgJiYgcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXS54ID09IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMl0ueCAmJlxyXG4gICAgICAgICAgICBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdLnkgPT0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAyXS55KSB7XHJcbiAgICAgICAgICAgIHBvaW50cy5wb3AoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwb2ludHMubGVuZ3RoID4gMSAmJiB0aGlzLnJvdXRpbmdBcnJvdy5lbmRzT25BcnJvd1dpdGhJZGVudGlmaWVyID09IG51bGwpIHtcclxuICAgICAgICAgICAgbGV0IGhlYWQgPSBBcnJvd0hlYWQubWFrZUhlYWQocG9pbnRzW3BvaW50cy5sZW5ndGggLSAyXSwgcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXSxcclxuICAgICAgICAgICAgICAgIHRoaXMucm91dGluZ0Fycm93LmFycm93VHlwZSk7XHJcblxyXG4gICAgICAgICAgICBsZXQgJGhlYWQgPSB0aGlzLmNyZWF0ZUVsZW1lbnQoXCJwYXRoXCIsICRncm91cFswXSwgeyBkOiBoZWFkLnBhdGggfSk7XHJcbiAgICAgICAgICAgICRoZWFkLmNzcyh7XHJcbiAgICAgICAgICAgICAgICBzdHJva2U6IHRoaXMuY29sb3IsXHJcbiAgICAgICAgICAgICAgICBcInN0cm9rZS13aWR0aFwiOiBcIjAuMiBjbVwiLFxyXG4gICAgICAgICAgICAgICAgXCJmaWxsXCI6IGhlYWQuZmlsbFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGdldFBhdGhDb29yZGluYXRlcyhwb2ludDogUG9pbnQpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCB4ID0gcG9pbnQueCAqIERpYWdyYW1Vbml0Q20gLyBEaWFncmFtQXJyb3cuY21QZXJQeDtcclxuICAgICAgICBsZXQgeSA9IHBvaW50LnkgKiBEaWFncmFtVW5pdENtIC8gRGlhZ3JhbUFycm93LmNtUGVyUHg7XHJcbiAgICAgICAgcmV0dXJuIFwiXCIgKyB4ICsgXCIgXCIgKyB5O1xyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuXHJcbiJdfQ==