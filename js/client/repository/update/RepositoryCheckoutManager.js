import { makeDiv, setSelectItems, getSelectedObject } from "../../tools/HtmlTools.js";
import { ajax } from "../../communication/AjaxHelper.js";
export class RepositoryCheckoutManager {
    constructor(main) {
        this.main = main;
        this.guiReady = false;
        this.filterbuttonOptions = ["alle", "private", "f端r die Klasse freigegebene", "f端r die Schule freigegebene"];
        this.repositories = [];
    }
    initGUI() {
        this.guiReady = true;
        let that = this;
        let $checkoutDiv = jQuery('#checkoutRepo-div');
        $checkoutDiv.append(this.$mainHeading = makeDiv('checkoutRepo-mainHeading', "createUpdateRepo-mainHeading", ""));
        this.$mainHeading.append(makeDiv("", "", "Checkout Repository - Workspace mit Repository verbinden"));
        this.$mainHeading.append(this.$exitButton = makeDiv("", "jo_synchro_button", "Zur端ck zum Programmieren", { "background-color": "var(--speedcontrol-grip)", "color": "var(--fontColorLight)", "font-size": "10pt" }));
        this.$exitButton.on("click", () => { that.exitButtonClicked(); });
        let $divBelow = makeDiv("checkoutRepo-divBelow");
        $checkoutDiv.append($divBelow);
        let $chooseWorkspaceDiv = makeDiv("", "checkoutRepo-chooseDiv");
        $divBelow.append($chooseWorkspaceDiv);
        $chooseWorkspaceDiv.append(makeDiv("", "checkoutRepo-minorHeading", "Diesen Worspace mit dem Repository verbinden:"));
        this.$workspaceDropdown = jQuery('<select></select>');
        $chooseWorkspaceDiv.append(this.$workspaceDropdown);
        let $publishedToFilterDiv = makeDiv("", "checkoutRepo-chooseDiv");
        $divBelow.append($publishedToFilterDiv);
        $publishedToFilterDiv.append(makeDiv("", "checkoutRepo-minorHeading", "Diese Repositories anzeigen:"));
        this.$filterButtonDiv = jQuery('<fieldset></fieldset>');
        $publishedToFilterDiv.append(this.$filterButtonDiv);
        this.filterbuttonOptions.forEach((value, index) => {
            let $radioButton = jQuery(`<input type="radio" id="b${index}" name="publishedFilter" value="${index}" ${index == 0 ? "checked" : ""}>`);
            $radioButton.data('value', index);
            $radioButton.on("change", (e) => {
                that.showRepositories();
            });
            this.$filterButtonDiv.append($radioButton);
            this.$filterButtonDiv.append(jQuery(`<label for="b${index}">${value}</label>`));
        });
        let $inputFilterDiv = makeDiv("", "checkoutRepo-chooseDiv");
        $divBelow.append($inputFilterDiv);
        $inputFilterDiv.append(makeDiv("", "checkoutRepo-minorHeading", "Filter/Suche:"));
        this.$filterInput = jQuery('<input type="text"></input>');
        $inputFilterDiv.append(this.$filterInput);
        this.$filterInput.on("input", (e) => {
            that.showRepositories();
        });
        $divBelow.append(makeDiv('', 'updateRepo-minorHeading', 'Repositories:', { 'margin-bottom': '10px', 'margin-top': '20px' }));
        this.$repoListDiv = makeDiv('#checkoutRepo-repoListDiv', 'jo-scrollable');
        $divBelow.append(this.$repoListDiv);
        let $buttonDiv = makeDiv("updateRepo-buttonDiv");
        $buttonDiv.append(this.$checkoutButton = makeDiv("", "jo_synchro_button", "Checkout", { "background-color": "var(--updateButtonBackground)", "color": "var(--updateButtonColor)" }));
        this.$checkoutButton.on("click", () => { that.checkoutButtonClicked(); });
        $divBelow.append($buttonDiv);
    }
    show(workspace) {
        if (!this.guiReady) {
            this.initGUI();
        }
        let $checkoutDiv = jQuery('#checkoutRepo-div');
        $checkoutDiv.css('visibility', 'visible');
        let $mainDiv = jQuery('#main');
        $mainDiv.css('visibility', 'hidden');
        let user = this.main.user;
        let grlq = {
            onlyOwnRepositories: false
        };
        this.$repoListDiv.empty();
        let that = this;
        ajax('getRepositoryList', grlq, (response) => {
            this.repositories = response.repositories;
            this.showRepositories();
        });
        // Init Workspace-Dropdown
        this.$workspaceDropdown.empty();
        setSelectItems(this.$workspaceDropdown, [{
                caption: "Neuen Workspace erstellen",
                object: null,
                value: -1
            }].concat(this.main.workspaceList.filter(ws => ws.repository_id == null).map(ws => {
            return {
                caption: ws.name,
                object: ws,
                value: ws.id
            };
        })), -1);
        this.main.windowStateManager.registerOneTimeBackButtonListener(() => {
            that.hide();
        });
    }
    showRepositories() {
        let that = this;
        this.$repoListDiv.find('.checkoutRepo-repoListItem').remove();
        let published_to = this.$filterButtonDiv.find('input:checked').data('value') - 1;
        let filteredRepositories = published_to < 0 ? this.repositories :
            this.repositories.filter(repoInfo => repoInfo.published_to == published_to);
        let filterSearch = this.$filterInput.val();
        filterSearch = filterSearch.toLocaleLowerCase();
        if (filterSearch != "") {
            filteredRepositories = filteredRepositories.filter(repInfo => [repInfo.owner_username, repInfo.owner_name, repInfo.name, repInfo.description].join(" ").toLocaleLowerCase().indexOf(filterSearch) >= 0);
        }
        filteredRepositories.forEach(repInfo => {
            let $div = makeDiv('', 'checkoutRepo-repoListItem');
            let $divLeft = makeDiv('', 'checkoutRepo-repoListItemLeft');
            $div.append($divLeft);
            $divLeft.append(makeDiv('', 'checkoutRepo-repoListName', repInfo.name));
            $divLeft.append(makeDiv('', 'checkoutRepo-repoListOwner', repInfo.owner_name + " (" + repInfo.owner_username + ")"));
            let $divRight = makeDiv('', 'checkoutRepo-repoListItemRight', repInfo.description);
            $div.append($divRight);
            this.$repoListDiv.append($div);
            $div.data('repoInfo', repInfo);
            $div.on("click", () => {
                that.selectRepository($div, repInfo);
            });
        });
        this.selectFirstRepository();
    }
    selectRepository($repoDiv, repInfo) {
        this.$repoListDiv.find('.checkoutRepo-repoListItem').removeClass('active');
        if ($repoDiv != null) {
            $repoDiv.addClass('active');
        }
    }
    selectFirstRepository() {
        this.$repoListDiv.find('.checkoutRepo-repoListItem').removeClass('active');
        this.$repoListDiv.find('.checkoutRepo-repoListItem').first().addClass('active');
    }
    hide() {
        let $synchroDiv = jQuery('#checkoutRepo-div');
        $synchroDiv.css('visibility', 'hidden');
        let $mainDiv = jQuery('#main');
        $mainDiv.css('visibility', 'visible');
    }
    checkoutButtonClicked() {
        let selectedItem = this.$repoListDiv.find('.active').first();
        let repoData = selectedItem.data('repoInfo');
        let workspace = getSelectedObject(this.$workspaceDropdown);
        let request = {
            repository_id: repoData.id,
            createNewWorkspace: workspace == null,
            workspace_id: workspace == null ? null : workspace.id
        };
        let that = this;
        ajax('attachWorkspaceToRepository', request, (response) => {
            if (workspace == null && response.new_workspace != null) {
                that.main.networkManager.createNewWorkspaceFromWorkspaceData(response.new_workspace);
                alert('Der neue Workspace ' + response.new_workspace.name + " wurde erfolgreich angelegt.");
            }
            else {
                workspace.repository_id = repoData.id;
                let explorer = that.main.projectExplorer;
                explorer.workspaceListPanel.setElementClass(workspace.panelElement, "repository");
                alert(`Der Workspace ${workspace.name} wurde erfolgreich mit dem Repository ${repoData.name} verkn端pft.`);
            }
            window.history.back();
        });
        // let updateRepositoryRequest: UpdateRepositoryRequest = {
        //     owner_id: owner.user_id,
        //     description: <string>this.$repoDescription.val(),
        //     published_to: published_to,
        //     repository_id: repoData.id
        // };
        // ajax("updateRepository", updateRepositoryRequest, (response: UpdateRepositoryResponse) => {
        //     //TODO: update user write access..
        // });
    }
    exitButtonClicked() {
        this.hide();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVwb3NpdG9yeUNoZWNrb3V0TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jbGllbnQvcmVwb3NpdG9yeS91cGRhdGUvUmVwb3NpdG9yeUNoZWNrb3V0TWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFjLGNBQWMsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRWxHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQU16RCxNQUFNLE9BQU8seUJBQXlCO0lBcUJsQyxZQUFtQixJQUFVO1FBQVYsU0FBSSxHQUFKLElBQUksQ0FBTTtRQW5CN0IsYUFBUSxHQUFZLEtBQUssQ0FBQztRQWExQix3QkFBbUIsR0FBRyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsNkJBQTZCLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztRQUl4RyxpQkFBWSxHQUFxQixFQUFFLENBQUM7SUFHcEMsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxZQUFZLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFL0MsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsRUFBRSw4QkFBOEIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2pILElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLDBEQUEwRCxDQUFDLENBQUMsQ0FBQztRQUN0RyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsMEJBQTBCLEVBQUUs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SSxRQUFRLENBQUMsYUFBYSxJQUFJLElBQUksRUFBQztnQkFFbkQsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsbUNBQW1DLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUNyRixLQUFLLENBQUMscUJBQXFCLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsOEJBQThCLENBQUMsQ0FBQzthQUUvRjtpQkFBTTtnQkFFSCxTQUFTLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQ3RDLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDO2dCQUN6QyxRQUFRLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7Z0JBQ2xGLEtBQUssQ0FBQyxpQkFBaUIsU0FBUyxDQUFDLElBQUkseUNBQXlDLFFBQVEsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDO2FBRTdHO1lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUUxQixDQUFDLENBQUMsQ0FBQztRQUVILDJEQUEyRDtRQUMzRCwrQkFBK0I7UUFDL0Isd0RBQXdEO1FBQ3hELGtDQUFrQztRQUNsQyxpQ0FBaUM7UUFDakMsS0FBSztRQUVMLDhGQUE4RjtRQUU5Rix5Q0FBeUM7UUFHekMsTUFBTTtJQUlWLENBQUM7SUFHRCxpQkFBaUI7UUFDYixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWFpbiB9IGZyb20gXCIuLi8uLi9tYWluL01haW4uanNcIjtcclxuaW1wb3J0IHsgV29ya3NwYWNlIH0gZnJvbSBcIi4uLy4uL3dvcmtzcGFjZS9Xb3Jrc3BhY2UuanNcIjtcclxuaW1wb3J0IHsgbWFrZURpdiwgU2VsZWN0SXRlbSwgc2V0U2VsZWN0SXRlbXMsIGdldFNlbGVjdGVkT2JqZWN0IH0gZnJvbSBcIi4uLy4uL3Rvb2xzL0h0bWxUb29scy5qc1wiO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5VXNlciwgR2V0UmVwb3NpdG9yeVJlcXVlc3QsIEdldFJlcG9zaXRvcnlSZXNwb25zZSwgR2V0UmVwb3NpdG9yeVVzZXJMaXN0UmVxdWVzdCwgR2V0UmVwb3NpdG9yeVVzZXJMaXN0UmVzcG9uc2UsIFVzZXJEYXRhLCBHZXRSZXBvc2l0b3J5TGlzdFJlcXVlc3QsIEdldFJlcG9zaXRvcnlMaXN0UmVzcG9uc2UsIFJlcG9zaXRvcnlJbmZvLCBVcGRhdGVSZXBvc2l0b3J5UmVxdWVzdCwgVXBkYXRlUmVwb3NpdG9yeVJlc3BvbnNlLCBBdHRhY2hXb3Jrc3BhY2VUb1JlcG9zaXRvcnlSZXF1ZXN0LCBXb3Jrc3BhY2VEYXRhLCBBdHRhY2hXb3Jrc3BhY2VUb1JlcG9zaXRvcnlSZXNwb25zZSB9IGZyb20gXCIuLi8uLi9jb21tdW5pY2F0aW9uL0RhdGEuanNcIjtcclxuaW1wb3J0IHsgYWpheCB9IGZyb20gXCIuLi8uLi9jb21tdW5pY2F0aW9uL0FqYXhIZWxwZXIuanNcIjtcclxuaW1wb3J0IHsgVGVhY2hlcnNXaXRoQ2xhc3Nlc01JIH0gZnJvbSBcIi4uLy4uL2FkbWluaXN0cmF0aW9uL1RlYWNoZXJzV2l0aENsYXNzZXMuanNcIjtcclxuaW1wb3J0IHsgVGlsaW5nU3ByaXRlIH0gZnJvbSBcInBpeGkuanNcIjtcclxuaW1wb3J0IHsgUHJvamVjdEV4cGxvcmVyIH0gZnJvbSBcIi4uLy4uL21haW4vZ3VpL1Byb2plY3RFeHBsb3Jlci5qc1wiO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBSZXBvc2l0b3J5Q2hlY2tvdXRNYW5hZ2VyIHtcclxuXHJcbiAgICBndWlSZWFkeTogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgICRtYWluSGVhZGluZzogSlF1ZXJ5PEhUTUxEaXZFbGVtZW50PjtcclxuXHJcbiAgICAkcmVwb0xpc3REaXY6IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgJGV4aXRCdXR0b246IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcbiAgICAkY2hlY2tvdXRCdXR0b246IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgJHdvcmtzcGFjZURyb3Bkb3duOiBKUXVlcnk8SFRNTFNlbGVjdEVsZW1lbnQ+O1xyXG4gICAgJGZpbHRlckJ1dHRvbkRpdjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuICAgICRmaWx0ZXJJbnB1dDogSlF1ZXJ5PEhUTUxJbnB1dEVsZW1lbnQ+O1xyXG5cclxuICAgIGZpbHRlcmJ1dHRvbk9wdGlvbnMgPSBbXCJhbGxlXCIsIFwicHJpdmF0ZVwiLCBcImbDvHIgZGllIEtsYXNzZSBmcmVpZ2VnZWJlbmVcIiwgXCJmw7xyIGRpZSBTY2h1bGUgZnJlaWdlZ2ViZW5lXCJdO1xyXG5cclxuICAgIHdvcmtzcGFjZTogV29ya3NwYWNlO1xyXG5cclxuICAgIHJlcG9zaXRvcmllczogUmVwb3NpdG9yeUluZm9bXSA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBtYWluOiBNYWluKSB7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEdVSSgpIHtcclxuICAgICAgICB0aGlzLmd1aVJlYWR5ID0gdHJ1ZTtcclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgbGV0ICRjaGVja291dERpdiA9IGpRdWVyeSgnI2NoZWNrb3V0UmVwby1kaXYnKTtcclxuXHJcbiAgICAgICAgJGNoZWNrb3V0RGl2LmFwcGVuZCh0aGlzLiRtYWluSGVhZGluZyA9IG1ha2VEaXYoJ2NoZWNrb3V0UmVwby1tYWluSGVhZGluZycsIFwiY3JlYXRlVXBkYXRlUmVwby1tYWluSGVhZGluZ1wiLCBcIlwiKSk7XHJcbiAgICAgICAgdGhpcy4kbWFpbkhlYWRpbmcuYXBwZW5kKG1ha2VEaXYoXCJcIiwgXCJcIiwgXCJDaGVja291dCBSZXBvc2l0b3J5IC0gV29ya3NwYWNlIG1pdCBSZXBvc2l0b3J5IHZlcmJpbmRlblwiKSk7XHJcbiAgICAgICAgdGhpcy4kbWFpbkhlYWRpbmcuYXBwZW5kKHRoaXMuJGV4aXRCdXR0b24gPSBtYWtlRGl2KFwiXCIsIFwiam9fc3luY2hyb19idXR0b25cIiwgXCJadXLDvGNrIHp1bSBQcm9ncmFtbWllcmVuXCIsIHsgXCJiYWNrZ3JvdW5kLWNvbG9yXCI6IFwidmFyKC0tc3BlZWRjb250cm9sLWdyaXApXCIsIFwiY29sb3JcIjogXCJ2YXIoLS1mb250Q29sb3JMaWdodClcIiwgXCJmb250LXNpemVcIjogXCIxMHB0XCIgfSkpO1xyXG4gICAgICAgIHRoaXMuJGV4aXRCdXR0b24ub24oXCJjbGlja1wiLCAoKSA9PiB7IHRoYXQuZXhpdEJ1dHRvbkNsaWNrZWQoKSB9KVxyXG5cclxuXHJcbiAgICAgICAgbGV0ICRkaXZCZWxvdyA9IG1ha2VEaXYoXCJjaGVja291dFJlcG8tZGl2QmVsb3dcIik7XHJcbiAgICAgICAgJGNoZWNrb3V0RGl2LmFwcGVuZCgkZGl2QmVsb3cpO1xyXG5cclxuICAgICAgICBsZXQgJGNob29zZVdvcmtzcGFjZURpdiA9IG1ha2VEaXYoXCJcIiwgXCJjaGVja291dFJlcG8tY2hvb3NlRGl2XCIpO1xyXG4gICAgICAgICRkaXZCZWxvdy5hcHBlbmQoJGNob29zZVdvcmtzcGFjZURpdik7XHJcbiAgICAgICAgJGNob29zZVdvcmtzcGFjZURpdi5hcHBlbmQobWFrZURpdihcIlwiLCBcImNoZWNrb3V0UmVwby1taW5vckhlYWRpbmdcIiwgXCJEaWVzZW4gV29yc3BhY2UgbWl0IGRlbSBSZXBvc2l0b3J5IHZlcmJpbmRlbjpcIikpO1xyXG4gICAgICAgIHRoaXMuJHdvcmtzcGFjZURyb3Bkb3duID0galF1ZXJ5KCc8c2VsZWN0Pjwvc2VsZWN0PicpO1xyXG4gICAgICAgICRjaG9vc2VXb3Jrc3BhY2VEaXYuYXBwZW5kKHRoaXMuJHdvcmtzcGFjZURyb3Bkb3duKTtcclxuXHJcbiAgICAgICAgbGV0ICRwdWJsaXNoZWRUb0ZpbHRlckRpdiA9IG1ha2VEaXYoXCJcIiwgXCJjaGVja291dFJlcG8tY2hvb3NlRGl2XCIpO1xyXG4gICAgICAgICRkaXZCZWxvdy5hcHBlbmQoJHB1Ymxpc2hlZFRvRmlsdGVyRGl2KTtcclxuICAgICAgICAkcHVibGlzaGVkVG9GaWx0ZXJEaXYuYXBwZW5kKG1ha2VEaXYoXCJcIiwgXCJjaGVja291dFJlcG8tbWlub3JIZWFkaW5nXCIsIFwiRGllc2UgUmVwb3NpdG9yaWVzIGFuemVpZ2VuOlwiKSk7XHJcbiAgICAgICAgdGhpcy4kZmlsdGVyQnV0dG9uRGl2ID0galF1ZXJ5KCc8ZmllbGRzZXQ+PC9maWVsZHNldD4nKTtcclxuICAgICAgICAkcHVibGlzaGVkVG9GaWx0ZXJEaXYuYXBwZW5kKHRoaXMuJGZpbHRlckJ1dHRvbkRpdik7XHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVyYnV0dG9uT3B0aW9ucy5mb3JFYWNoKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgbGV0ICRyYWRpb0J1dHRvbiA9IGpRdWVyeShgPGlucHV0IHR5cGU9XCJyYWRpb1wiIGlkPVwiYiR7aW5kZXh9XCIgbmFtZT1cInB1Ymxpc2hlZEZpbHRlclwiIHZhbHVlPVwiJHtpbmRleH1cIiAke2luZGV4ID09IDAgPyBcImNoZWNrZWRcIiA6IFwiXCJ9PmApO1xyXG4gICAgICAgICAgICAkcmFkaW9CdXR0b24uZGF0YSgndmFsdWUnLCBpbmRleCk7XHJcbiAgICAgICAgICAgICRyYWRpb0J1dHRvbi5vbihcImNoYW5nZVwiLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhhdC5zaG93UmVwb3NpdG9yaWVzKCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIHRoaXMuJGZpbHRlckJ1dHRvbkRpdi5hcHBlbmQoJHJhZGlvQnV0dG9uKTtcclxuICAgICAgICAgICAgdGhpcy4kZmlsdGVyQnV0dG9uRGl2LmFwcGVuZChqUXVlcnkoYDxsYWJlbCBmb3I9XCJiJHtpbmRleH1cIj4ke3ZhbHVlfTwvbGFiZWw+YCkpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIGxldCAkaW5wdXRGaWx0ZXJEaXYgPSBtYWtlRGl2KFwiXCIsIFwiY2hlY2tvdXRSZXBvLWNob29zZURpdlwiKTtcclxuICAgICAgICAkZGl2QmVsb3cuYXBwZW5kKCRpbnB1dEZpbHRlckRpdik7XHJcbiAgICAgICAgJGlucHV0RmlsdGVyRGl2LmFwcGVuZChtYWtlRGl2KFwiXCIsIFwiY2hlY2tvdXRSZXBvLW1pbm9ySGVhZGluZ1wiLCBcIkZpbHRlci9TdWNoZTpcIikpO1xyXG4gICAgICAgIHRoaXMuJGZpbHRlcklucHV0ID0galF1ZXJ5KCc8aW5wdXQgdHlwZT1cInRleHRcIj48L2lucHV0PicpO1xyXG4gICAgICAgICRpbnB1dEZpbHRlckRpdi5hcHBlbmQodGhpcy4kZmlsdGVySW5wdXQpO1xyXG5cclxuICAgICAgICB0aGlzLiRmaWx0ZXJJbnB1dC5vbihcImlucHV0XCIsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoYXQuc2hvd1JlcG9zaXRvcmllcygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkZGl2QmVsb3cuYXBwZW5kKG1ha2VEaXYoJycsICd1cGRhdGVSZXBvLW1pbm9ySGVhZGluZycsICdSZXBvc2l0b3JpZXM6JywgeydtYXJnaW4tYm90dG9tJzogJzEwcHgnLCAnbWFyZ2luLXRvcCc6ICcyMHB4J30pKTtcclxuXHJcbiAgICAgICAgdGhpcy4kcmVwb0xpc3REaXYgPSBtYWtlRGl2KCcjY2hlY2tvdXRSZXBvLXJlcG9MaXN0RGl2JywgJ2pvLXNjcm9sbGFibGUnKTtcclxuICAgICAgICAkZGl2QmVsb3cuYXBwZW5kKHRoaXMuJHJlcG9MaXN0RGl2KTtcclxuXHJcbiAgICAgICAgbGV0ICRidXR0b25EaXYgPSBtYWtlRGl2KFwidXBkYXRlUmVwby1idXR0b25EaXZcIik7XHJcblxyXG4gICAgICAgICRidXR0b25EaXYuYXBwZW5kKHRoaXMuJGNoZWNrb3V0QnV0dG9uID0gbWFrZURpdihcIlwiLCBcImpvX3N5bmNocm9fYnV0dG9uXCIsIFwiQ2hlY2tvdXRcIiwgeyBcImJhY2tncm91bmQtY29sb3JcIjogXCJ2YXIoLS11cGRhdGVCdXR0b25CYWNrZ3JvdW5kKVwiLCBcImNvbG9yXCI6IFwidmFyKC0tdXBkYXRlQnV0dG9uQ29sb3IpXCIgfSkpO1xyXG4gICAgICAgIHRoaXMuJGNoZWNrb3V0QnV0dG9uLm9uKFwiY2xpY2tcIiwgKCkgPT4geyB0aGF0LmNoZWNrb3V0QnV0dG9uQ2xpY2tlZCgpIH0pXHJcblxyXG4gICAgICAgICRkaXZCZWxvdy5hcHBlbmQoJGJ1dHRvbkRpdik7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNob3cod29ya3NwYWNlOiBXb3Jrc3BhY2UpIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmd1aVJlYWR5KSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdEdVSSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0ICRjaGVja291dERpdiA9IGpRdWVyeSgnI2NoZWNrb3V0UmVwby1kaXYnKTtcclxuICAgICAgICAkY2hlY2tvdXREaXYuY3NzKCd2aXNpYmlsaXR5JywgJ3Zpc2libGUnKTtcclxuICAgICAgICBsZXQgJG1haW5EaXYgPSBqUXVlcnkoJyNtYWluJyk7XHJcbiAgICAgICAgJG1haW5EaXYuY3NzKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xyXG5cclxuICAgICAgICBsZXQgdXNlciA9IHRoaXMubWFpbi51c2VyO1xyXG5cclxuICAgICAgICBsZXQgZ3JscTogR2V0UmVwb3NpdG9yeUxpc3RSZXF1ZXN0ID0ge1xyXG4gICAgICAgICAgICBvbmx5T3duUmVwb3NpdG9yaWVzOiBmYWxzZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy4kcmVwb0xpc3REaXYuZW1wdHkoKTtcclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgYWpheCgnZ2V0UmVwb3NpdG9yeUxpc3QnLCBncmxxLCAocmVzcG9uc2U6IEdldFJlcG9zaXRvcnlMaXN0UmVzcG9uc2UpID0+IHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucmVwb3NpdG9yaWVzID0gcmVzcG9uc2UucmVwb3NpdG9yaWVzO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zaG93UmVwb3NpdG9yaWVzKCk7XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBJbml0IFdvcmtzcGFjZS1Ecm9wZG93blxyXG4gICAgICAgIHRoaXMuJHdvcmtzcGFjZURyb3Bkb3duLmVtcHR5KCk7XHJcbiAgICAgICAgc2V0U2VsZWN0SXRlbXModGhpcy4kd29ya3NwYWNlRHJvcGRvd24sIFt7XHJcbiAgICAgICAgICAgIGNhcHRpb246IFwiTmV1ZW4gV29ya3NwYWNlIGVyc3RlbGxlblwiLFxyXG4gICAgICAgICAgICBvYmplY3Q6IG51bGwsXHJcbiAgICAgICAgICAgIHZhbHVlOiAtMVxyXG4gICAgICAgIH1dLmNvbmNhdCh0aGlzLm1haW4ud29ya3NwYWNlTGlzdC5maWx0ZXIod3MgPT4gd3MucmVwb3NpdG9yeV9pZCA9PSBudWxsKS5tYXAod3MgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgY2FwdGlvbjogd3MubmFtZSxcclxuICAgICAgICAgICAgICAgIG9iamVjdDogd3MsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogd3MuaWRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pKVxyXG4gICAgICAgICwgLTEpO1xyXG5cclxuICAgICAgICB0aGlzLm1haW4ud2luZG93U3RhdGVNYW5hZ2VyLnJlZ2lzdGVyT25lVGltZUJhY2tCdXR0b25MaXN0ZW5lcigoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoYXQuaGlkZSgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgc2hvd1JlcG9zaXRvcmllcygpe1xyXG5cclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgICAgIHRoaXMuJHJlcG9MaXN0RGl2LmZpbmQoJy5jaGVja291dFJlcG8tcmVwb0xpc3RJdGVtJykucmVtb3ZlKCk7XHJcblxyXG4gICAgICAgIGxldCBwdWJsaXNoZWRfdG8gPSB0aGlzLiRmaWx0ZXJCdXR0b25EaXYuZmluZCgnaW5wdXQ6Y2hlY2tlZCcpLmRhdGEoJ3ZhbHVlJykgLSAxO1xyXG5cclxuICAgICAgICBsZXQgZmlsdGVyZWRSZXBvc2l0b3JpZXM6IFJlcG9zaXRvcnlJbmZvW10gPSBwdWJsaXNoZWRfdG8gPCAwID8gdGhpcy5yZXBvc2l0b3JpZXMgOlxyXG4gICAgICAgICAgICB0aGlzLnJlcG9zaXRvcmllcy5maWx0ZXIocmVwb0luZm8gPT4gcmVwb0luZm8ucHVibGlzaGVkX3RvID09IHB1Ymxpc2hlZF90byk7XHJcblxyXG4gICAgICAgIGxldCBmaWx0ZXJTZWFyY2g6IHN0cmluZyA9IDxzdHJpbmc+dGhpcy4kZmlsdGVySW5wdXQudmFsKCk7XHJcbiAgICAgICAgZmlsdGVyU2VhcmNoID0gZmlsdGVyU2VhcmNoLnRvTG9jYWxlTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgICAgIGlmKGZpbHRlclNlYXJjaCAhPSBcIlwiKXtcclxuICAgICAgICAgICAgZmlsdGVyZWRSZXBvc2l0b3JpZXMgPSBmaWx0ZXJlZFJlcG9zaXRvcmllcy5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICByZXBJbmZvID0+IFtyZXBJbmZvLm93bmVyX3VzZXJuYW1lICwgcmVwSW5mby5vd25lcl9uYW1lICwgcmVwSW5mby5uYW1lICwgcmVwSW5mby5kZXNjcmlwdGlvbl0uam9pbihcIiBcIikudG9Mb2NhbGVMb3dlckNhc2UoKS5pbmRleE9mKGZpbHRlclNlYXJjaCkgPj0gMFxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmaWx0ZXJlZFJlcG9zaXRvcmllcy5mb3JFYWNoKHJlcEluZm8gPT4ge1xyXG4gICAgICAgICAgICBsZXQgJGRpdiA9IG1ha2VEaXYoJycsICdjaGVja291dFJlcG8tcmVwb0xpc3RJdGVtJyk7XHJcbiAgICAgICAgICAgIGxldCAkZGl2TGVmdCA9IG1ha2VEaXYoJycsICdjaGVja291dFJlcG8tcmVwb0xpc3RJdGVtTGVmdCcpO1xyXG4gICAgICAgICAgICAkZGl2LmFwcGVuZCgkZGl2TGVmdCk7XHJcblxyXG4gICAgICAgICAgICAkZGl2TGVmdC5hcHBlbmQobWFrZURpdignJywgJ2NoZWNrb3V0UmVwby1yZXBvTGlzdE5hbWUnLCByZXBJbmZvLm5hbWUpKTtcclxuICAgICAgICAgICAgJGRpdkxlZnQuYXBwZW5kKG1ha2VEaXYoJycsICdjaGVja291dFJlcG8tcmVwb0xpc3RPd25lcicsIHJlcEluZm8ub3duZXJfbmFtZSArIFwiIChcIiArIHJlcEluZm8ub3duZXJfdXNlcm5hbWUgKyBcIilcIikpO1xyXG5cclxuICAgICAgICAgICAgbGV0ICRkaXZSaWdodCA9IG1ha2VEaXYoJycsICdjaGVja291dFJlcG8tcmVwb0xpc3RJdGVtUmlnaHQnLCByZXBJbmZvLmRlc2NyaXB0aW9uKTtcclxuICAgICAgICAgICAgJGRpdi5hcHBlbmQoJGRpdlJpZ2h0KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuJHJlcG9MaXN0RGl2LmFwcGVuZCgkZGl2KTtcclxuICAgICAgICAgICAgJGRpdi5kYXRhKCdyZXBvSW5mbycsIHJlcEluZm8pO1xyXG4gICAgICAgICAgICAkZGl2Lm9uKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhhdC5zZWxlY3RSZXBvc2l0b3J5KCRkaXYsIHJlcEluZm8pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnNlbGVjdEZpcnN0UmVwb3NpdG9yeSgpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RSZXBvc2l0b3J5KCRyZXBvRGl2OiBKUXVlcnk8SFRNTERpdkVsZW1lbnQ+LCByZXBJbmZvOiBSZXBvc2l0b3J5SW5mbykge1xyXG4gICAgICAgIHRoaXMuJHJlcG9MaXN0RGl2LmZpbmQoJy5jaGVja291dFJlcG8tcmVwb0xpc3RJdGVtJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xyXG4gICAgICAgIGlmKCRyZXBvRGl2ICE9IG51bGwpe1xyXG4gICAgICAgICAgICAkcmVwb0Rpdi5hZGRDbGFzcygnYWN0aXZlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEZpcnN0UmVwb3NpdG9yeSgpe1xyXG4gICAgICAgIHRoaXMuJHJlcG9MaXN0RGl2LmZpbmQoJy5jaGVja291dFJlcG8tcmVwb0xpc3RJdGVtJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xyXG4gICAgICAgIHRoaXMuJHJlcG9MaXN0RGl2LmZpbmQoJy5jaGVja291dFJlcG8tcmVwb0xpc3RJdGVtJykuZmlyc3QoKS5hZGRDbGFzcygnYWN0aXZlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaGlkZSgpIHtcclxuICAgICAgICBsZXQgJHN5bmNocm9EaXYgPSBqUXVlcnkoJyNjaGVja291dFJlcG8tZGl2Jyk7XHJcbiAgICAgICAgJHN5bmNocm9EaXYuY3NzKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xyXG4gICAgICAgIGxldCAkbWFpbkRpdiA9IGpRdWVyeSgnI21haW4nKTtcclxuICAgICAgICAkbWFpbkRpdi5jc3MoJ3Zpc2liaWxpdHknLCAndmlzaWJsZScpO1xyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrb3V0QnV0dG9uQ2xpY2tlZCgpIHtcclxuICAgICAgICBsZXQgc2VsZWN0ZWRJdGVtID0gdGhpcy4kcmVwb0xpc3REaXYuZmluZCgnLmFjdGl2ZScpLmZpcnN0KCk7XHJcbiAgICAgICAgbGV0IHJlcG9EYXRhOiBSZXBvc2l0b3J5SW5mbyA9IDxhbnk+c2VsZWN0ZWRJdGVtLmRhdGEoJ3JlcG9JbmZvJyk7XHJcblxyXG4gICAgICAgIGxldCB3b3Jrc3BhY2U6IFdvcmtzcGFjZSA9IGdldFNlbGVjdGVkT2JqZWN0KHRoaXMuJHdvcmtzcGFjZURyb3Bkb3duKTtcclxuXHJcbiAgICAgICAgbGV0IHJlcXVlc3Q6IEF0dGFjaFdvcmtzcGFjZVRvUmVwb3NpdG9yeVJlcXVlc3QgPSB7XHJcbiAgICAgICAgICAgIHJlcG9zaXRvcnlfaWQ6IHJlcG9EYXRhLmlkLFxyXG4gICAgICAgICAgICBjcmVhdGVOZXdXb3Jrc3BhY2U6IHdvcmtzcGFjZSA9PSBudWxsLFxyXG4gICAgICAgICAgICB3b3Jrc3BhY2VfaWQ6IHdvcmtzcGFjZSA9PSBudWxsID8gbnVsbCA6IHdvcmtzcGFjZS5pZFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGFqYXgoJ2F0dGFjaFdvcmtzcGFjZVRvUmVwb3NpdG9yeScsIHJlcXVlc3QsIChyZXNwb25zZTogQXR0YWNoV29ya3NwYWNlVG9SZXBvc2l0b3J5UmVzcG9uc2UpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmKHdvcmtzcGFjZSA9PSBudWxsICYmIHJlc3BvbnNlLm5ld193b3Jrc3BhY2UgIT0gbnVsbCl7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhhdC5tYWluLm5ldHdvcmtNYW5hZ2VyLmNyZWF0ZU5ld1dvcmtzcGFjZUZyb21Xb3Jrc3BhY2VEYXRhKHJlc3BvbnNlLm5ld193b3Jrc3BhY2UpO1xyXG4gICAgICAgICAgICAgICAgYWxlcnQoJ0RlciBuZXVlIFdvcmtzcGFjZSAnICsgcmVzcG9uc2UubmV3X3dvcmtzcGFjZS5uYW1lICsgXCIgd3VyZGUgZXJmb2xncmVpY2ggYW5nZWxlZ3QuXCIpO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2UucmVwb3NpdG9yeV9pZCA9IHJlcG9EYXRhLmlkO1xyXG4gICAgICAgICAgICAgICAgbGV0IGV4cGxvcmVyID0gdGhhdC5tYWluLnByb2plY3RFeHBsb3JlcjtcclxuICAgICAgICAgICAgICAgIGV4cGxvcmVyLndvcmtzcGFjZUxpc3RQYW5lbC5zZXRFbGVtZW50Q2xhc3Mod29ya3NwYWNlLnBhbmVsRWxlbWVudCwgXCJyZXBvc2l0b3J5XCIpO1xyXG4gICAgICAgICAgICAgICAgYWxlcnQoYERlciBXb3Jrc3BhY2UgJHt3b3Jrc3BhY2UubmFtZX0gd3VyZGUgZXJmb2xncmVpY2ggbWl0IGRlbSBSZXBvc2l0b3J5ICR7cmVwb0RhdGEubmFtZX0gdmVya27DvHBmdC5gKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LmJhY2soKTtcclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIGxldCB1cGRhdGVSZXBvc2l0b3J5UmVxdWVzdDogVXBkYXRlUmVwb3NpdG9yeVJlcXVlc3QgPSB7XHJcbiAgICAgICAgLy8gICAgIG93bmVyX2lkOiBvd25lci51c2VyX2lkLFxyXG4gICAgICAgIC8vICAgICBkZXNjcmlwdGlvbjogPHN0cmluZz50aGlzLiRyZXBvRGVzY3JpcHRpb24udmFsKCksXHJcbiAgICAgICAgLy8gICAgIHB1Ymxpc2hlZF90bzogcHVibGlzaGVkX3RvLFxyXG4gICAgICAgIC8vICAgICByZXBvc2l0b3J5X2lkOiByZXBvRGF0YS5pZFxyXG4gICAgICAgIC8vIH07XHJcblxyXG4gICAgICAgIC8vIGFqYXgoXCJ1cGRhdGVSZXBvc2l0b3J5XCIsIHVwZGF0ZVJlcG9zaXRvcnlSZXF1ZXN0LCAocmVzcG9uc2U6IFVwZGF0ZVJlcG9zaXRvcnlSZXNwb25zZSkgPT4ge1xyXG5cclxuICAgICAgICAvLyAgICAgLy9UT0RPOiB1cGRhdGUgdXNlciB3cml0ZSBhY2Nlc3MuLlxyXG5cclxuXHJcbiAgICAgICAgLy8gfSk7XHJcblxyXG5cclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIGV4aXRCdXR0b25DbGlja2VkKCkge1xyXG4gICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=