import { abstandPunktZuGerade, abstand } from "../../tools/MatheTools.js";
export class HitPolygonStore {
    static getPolygonForTexture(name, index, spriteHelper, sprite) {
        if (index == null) {
            index = 0;
        }
        name += "#" + index;
        let polygon = HitPolygonStore.polygonStore[name];
        if (polygon == null) {
            // polygon = HitPolygonStore.getPolygon(<PIXI.Sprite>spriteHelper.displayObject, spriteHelper.worldHelper);
            polygon = HitPolygonStore.getPolygon(sprite, spriteHelper.worldHelper);
            HitPolygonStore.polygonStore[name] = polygon;
        }
        return polygon;
    }
    static getPolygon(sprite, worldHelper) {
        let pixels = worldHelper.app.renderer.plugins.extract.pixels(sprite);
        let w = sprite.width;
        let h = sprite.height;
        if (pixels.length !== 4 * w * h) {
            return [{ x: 0, y: 0 }, { x: w, y: 0 }, { x: w, y: h }, { x: 0, y: h }];
        }
        let polygon = [];
        let additionalPointsPerHalfBorder = 3;
        let pointsPerBorder = additionalPointsPerHalfBorder * 2 + 3;
        let probes = [];
        HitPolygonStore.addPointsOnLine({ x: 0, y: 0 }, { x: w - 1, y: 0 }, pointsPerBorder, probes);
        HitPolygonStore.addPointsOnLine({ x: w - 1, y: 0 }, { x: w - 1, y: h - 1 }, pointsPerBorder, probes);
        HitPolygonStore.addPointsOnLine({ x: w - 1, y: h - 1 }, { x: 0, y: h - 1 }, pointsPerBorder, probes);
        HitPolygonStore.addPointsOnLine({ x: 0, y: h - 1 }, { x: 0, y: 0 }, pointsPerBorder, probes);
        let mid = { x: w / 2, y: h / 2 };
        for (let probe of probes) {
            HitPolygonStore.probe(polygon, probe, mid, w, h, pixels);
        }
        let done = false;
        while (!done) {
            done = true;
            for (let i = 0; i < polygon.length - 1; i++) {
                let d = abstandPunktZuGerade(polygon[i], polygon[(i + 2) % polygon.length], polygon[i + 1]);
                if (d < 2) {
                    polygon.splice(i + 1, 1);
                    done = false;
                }
            }
        }
        // console.log(polygon);
        return polygon;
    }
    static addPointsOnLine(start, end, n, points) {
        let fx = (end.x - start.x) / (n - 1);
        let fy = (end.y - start.y) / (n - 1);
        for (let i = 1; i <= n - 1 + 0.1; i++) {
            points.push({
                x: start.x + fx * i,
                y: start.y + fy * i
            });
        }
    }
    static probe(polygon, start, end, width, height, pixels) {
        let length = abstand(start, end);
        let fx = (end.x - start.x) / length;
        let fy = (end.y - start.y) / length;
        let x, y;
        for (let i = 0; i <= length - 2; i++) {
            x = start.x + i * fx;
            y = start.y + i * fy;
            if (!HitPolygonStore.isTransparent(x, y, width, height, pixels)) {
                break;
            }
        }
        polygon.push({ x: x, y: y });
    }
    static isTransparent(x, y, width, height, pixels) {
        if (x < 0 || y < 0 || x > width || y > height) {
            return true;
        }
        let p = pixels[4 * Math.round(x) + 4 * width * Math.round(y) + 3];
        // console.log("x: " + x + ", y: " + y + ", width: " + width + " = " + p);
        // console.log("index: " + (4 * x + 4 * width * y + 3) + ", length: " + pixels.length);
        return p == 0;
    }
}
HitPolygonStore.polygonStore = {};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUG9seWdvblN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9ydW50aW1lbGlicmFyeS9ncmFwaGljcy9Qb2x5Z29uU3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFTLG9CQUFvQixFQUFFLE9BQU8sRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBSWpGLE1BQU0sT0FBTyxlQUFlO0lBSWpCLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFZLEVBQUUsS0FBYSxFQUFFLFlBQTBCLEVBQUUsTUFBbUI7UUFFM0csSUFBSSxLQUFLLElBQUksSUFBSSxFQUFFO1lBQ2YsS0FBSyxHQUFHLENBQUMsQ0FBQztTQUNiO1FBQ0QsSUFBSSxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUM7UUFFcEIsSUFBSSxPQUFPLEdBQUcsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVqRCxJQUFJLE9BQU8sSUFBSSxJQUFJLEVBQUU7WUFDakIsMkdBQTJHO1lBQzNHLE9BQU8sR0FBRyxlQUFlLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFdkUsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7U0FDaEQ7UUFHRCxPQUFPLE9BQU8sQ0FBQztJQUVuQixDQUFDO0lBRU8sTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFtQixFQUFFLFdBQXdCO1FBRW5FLElBQUksTUFBTSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUV0QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDN0IsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMzRTtRQUVELElBQUksT0FBTyxHQUFZLEVBQUUsQ0FBQztRQUMxQixJQUFJLDZCQUE2QixHQUFHLENBQUMsQ0FBQztRQUN0QyxJQUFJLGVBQWUsR0FBRyw2QkFBNkIsR0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTFELElBQUksTUFBTSxHQUFZLEVBQUUsQ0FBQztRQUN6QixlQUFlLENBQUMsZUFBZSxDQUFDLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFDLEVBQUUsRUFBQyxDQUFDLEVBQUUsQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFDLEVBQ3hELGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM3QixlQUFlLENBQUMsZUFBZSxDQUFDLEVBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBQyxFQUFFLEVBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUMsRUFDNUQsZUFBZSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzdCLGVBQWUsQ0FBQyxlQUFlLENBQUMsRUFBQyxDQUFDLEVBQUUsQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFDLENBQUMsRUFBQyxFQUFFLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFDLENBQUMsRUFB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LEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBRWxDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDckIsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUVyQixJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLEVBQUU7Z0JBQzdELE1BQU07YUFDVDtTQUNKO1FBRUQsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFakMsQ0FBQztJQUdPLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBUyxFQUFFLENBQVMsRUFBRSxLQUFhLEVBQUUsTUFBYyxFQUFFLE1BQWtCO1FBRWhHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxHQUFHLE1BQU0sRUFBRTtZQUMzQyxPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNsRSwwRUFBMEU7UUFDMUUsdUZBQXVGO1FBRXZGLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQixDQUFDOztBQXhIYyw0QkFBWSxHQUFnQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQdW5rdCwgYWJzdGFuZFB1bmt0WnVHZXJhZGUsIGFic3RhbmQgfSBmcm9tIFwiLi4vLi4vdG9vbHMvTWF0aGVUb29scy5qc1wiO1xyXG5pbXBvcnQgeyBXb3JsZEhlbHBlciB9IGZyb20gXCIuL1dvcmxkLmpzXCI7XHJcbmltcG9ydCB7IFNwcml0ZUhlbHBlciB9IGZyb20gXCIuL1Nwcml0ZS5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEhpdFBvbHlnb25TdG9yZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcG9seWdvblN0b3JlOiB7IFtwYXRoOiBzdHJpbmddOiBQdW5rdFtdIH0gPSB7fTtcclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGdldFBvbHlnb25Gb3JUZXh0dXJlKG5hbWU6IHN0cmluZywgaW5kZXg6IG51bWJlciwgc3ByaXRlSGVscGVyOiBTcHJpdGVIZWxwZXIsIHNwcml0ZTogUElYSS5TcHJpdGUpOiBQdW5rdFtdIHtcclxuXHJcbiAgICAgICAgaWYgKGluZGV4ID09IG51bGwpIHtcclxuICAgICAgICAgICAgaW5kZXggPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBuYW1lICs9IFwiI1wiICsgaW5kZXg7XHJcblxyXG4gICAgICAgIGxldCBwb2x5Z29uID0gSGl0UG9seWdvblN0b3JlLnBvbHlnb25TdG9yZVtuYW1lXTtcclxuXHJcbiAgICAgICAgaWYgKHBvbHlnb24gPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAvLyBwb2x5Z29uID0gSGl0UG9seWdvblN0b3JlLmdldFBvbHlnb24oPFBJWEkuU3ByaXRlPnNwcml0ZUhlbHBlci5kaXNwbGF5T2JqZWN0LCBzcHJpdGVIZWxwZXIud29ybGRIZWxwZXIpO1xyXG4gICAgICAgICAgICBwb2x5Z29uID0gSGl0UG9seWdvblN0b3JlLmdldFBvbHlnb24oc3ByaXRlLCBzcHJpdGVIZWxwZXIud29ybGRIZWxwZXIpO1xyXG5cclxuICAgICAgICAgICAgSGl0UG9seWdvblN0b3JlLnBvbHlnb25TdG9yZVtuYW1lXSA9IHBvbHlnb247XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgcmV0dXJuIHBvbHlnb247XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGdldFBvbHlnb24oc3ByaXRlOiBQSVhJLlNwcml0ZSwgd29ybGRIZWxwZXI6IFdvcmxkSGVscGVyKTogUHVua3RbXSB7XHJcblxyXG4gICAgICAgIGxldCBwaXhlbHMgPSB3b3JsZEhlbHBlci5hcHAucmVuZGVyZXIucGx1Z2lucy5leHRyYWN0LnBpeGVscyhzcHJpdGUpO1xyXG4gICAgICAgIGxldCB3ID0gc3ByaXRlLndpZHRoO1xyXG4gICAgICAgIGxldCBoID0gc3ByaXRlLmhlaWdodDtcclxuXHJcbiAgICAgICAgaWYgKHBpeGVscy5sZW5ndGggIT09IDQgKiB3ICogaCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW3sgeDogMCwgeTogMCB9LCB7IHg6IHcsIHk6IDAgfSwgeyB4OiB3LCB5OiBoIH0sIHsgeDogMCwgeTogaCB9XTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBwb2x5Z29uOiBQdW5rdFtdID0gW107XHJcbiAgICAgICAgbGV0IGFkZGl0aW9uYWxQb2ludHNQZXJIYWxmQm9yZGVyID0gMztcclxuICAgICAgICBsZXQgcG9pbnRzUGVyQm9yZGVyID0gYWRkaXRpb25hbFBvaW50c1BlckhhbGZCb3JkZXIqMiArIDM7XHJcblxyXG4gICAgICAgIGxldCBwcm9iZXM6IFB1bmt0W10gPSBbXTtcclxuICAgICAgICBIaXRQb2x5Z29uU3RvcmUuYWRkUG9pbnRzT25MaW5lKHt4OiAwLCB5OiAwfSwge3g6IHctMSwgeTogMH0sIFxyXG4gICAgICAgICAgICBwb2ludHNQZXJCb3JkZXIsIHByb2Jlcyk7XHJcbiAgICAgICAgSGl0UG9seWdvblN0b3JlLmFkZFBvaW50c09uTGluZSh7eDogdy0xLCB5OiAwfSwge3g6IHctMSwgeTogaC0xfSwgXHJcbiAgICAgICAgICAgIHBvaW50c1BlckJvcmRlciwgcHJvYmVzKTtcclxuICAgICAgICBIaXRQb2x5Z29uU3RvcmUuYWRkUG9pbnRzT25MaW5lKHt4OiB3LTEsIHk6IGgtMX0sIHt4OiAwLCB5OiBoLTF9LCBcclxuICAgICAgICAgICAgcG9pbnRzUGVyQm9yZGVyLCBwcm9iZXMpO1xyXG4gICAgICAgIEhpdFBvbHlnb25TdG9yZS5hZGRQb2ludHNPbkxpbmUoe3g6IDAsIHk6IGgtMX0sIHt4OiAwLCB5OiAwfSwgXHJcbiAgICAgICAgICAgIHBvaW50c1BlckJvcmRlciwgcHJvYmVzKTtcclxuXHJcbiAgICAgICAgbGV0IG1pZCA9IHt4OiB3LzIsIHk6IGgvMn07ICAgIFxyXG4gICAgICAgIGZvcihsZXQgcHJvYmUgb2YgcHJvYmVzKXtcclxuICAgICAgICAgICAgSGl0UG9seWdvblN0b3JlLnByb2JlKHBvbHlnb24sIHByb2JlLCBtaWQsdywgaCwgcGl4ZWxzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBkb25lOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICAgICAgd2hpbGUoIWRvbmUpe1xyXG4gICAgICAgICAgICBkb25lID0gdHJ1ZTtcclxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHBvbHlnb24ubGVuZ3RoIC0gMTsgaSsrKXtcclxuICAgICAgICAgICAgICAgIGxldCBkID0gYWJzdGFuZFB1bmt0WnVHZXJhZGUocG9seWdvbltpXSwgcG9seWdvblsoaSsyKSVwb2x5Z29uLmxlbmd0aF0sIHBvbHlnb25baSsxXSk7XHJcbiAgICAgICAgICAgICAgICBpZihkIDwgMil7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9seWdvbi5zcGxpY2UoaSsxLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICBkb25lID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHBvbHlnb24pO1xyXG5cclxuICAgICAgICByZXR1cm4gcG9seWdvbjtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgYWRkUG9pbnRzT25MaW5lKHN0YXJ0OiBQdW5rdCwgZW5kOiBQdW5rdCwgbjogbnVtYmVyLCBwb2ludHM6IFB1bmt0W10pe1xyXG4gICAgXHJcbiAgICAgICAgbGV0IGZ4ID0gKGVuZC54IC0gc3RhcnQueCkvKG4tMSk7XHJcbiAgICAgICAgbGV0IGZ5ID0gKGVuZC55IC0gc3RhcnQueSkvKG4tMSk7XHJcblxyXG4gICAgICAgIGZvcihsZXQgaSA9IDE7IGkgPD0gbiAtIDEgKyAwLjE7IGkrKyApe1xyXG4gICAgICAgICAgICBwb2ludHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICB4OiBzdGFydC54ICsgZngqaSxcclxuICAgICAgICAgICAgICAgIHk6IHN0YXJ0LnkgKyBmeSppXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gICAgXHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBwcm9iZShwb2x5Z29uOiBQdW5rdFtdLCBzdGFydDogUHVua3QsIGVuZDogUHVua3QsIFxyXG4gICAgICAgIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBwaXhlbHM6IFVpbnQ4QXJyYXkpIHtcclxuXHJcbiAgICAgICAgbGV0IGxlbmd0aCA9IGFic3RhbmQoc3RhcnQsIGVuZCk7XHJcbiAgICAgICAgbGV0IGZ4ID0gKGVuZC54IC0gc3RhcnQueCkgLyBsZW5ndGg7XHJcbiAgICAgICAgbGV0IGZ5ID0gKGVuZC55IC0gc3RhcnQueSkgLyBsZW5ndGg7XHJcblxyXG4gICAgICAgIGxldCB4OiBudW1iZXIsIHk6IG51bWJlcjtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbGVuZ3RoIC0gMjsgaSsrKSB7XHJcblxyXG4gICAgICAgICAgICB4ID0gc3RhcnQueCArIGkgKiBmeDtcclxuICAgICAgICAgICAgeSA9IHN0YXJ0LnkgKyBpICogZnk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIUhpdFBvbHlnb25TdG9yZS5pc1RyYW5zcGFyZW50KHgsIHksIHdpZHRoLCBoZWlnaHQsIHBpeGVscykpIHtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwb2x5Z29uLnB1c2goeyB4OiB4LCB5OiB5IH0pO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgaXNUcmFuc3BhcmVudCh4OiBudW1iZXIsIHk6IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIsIHBpeGVsczogVWludDhBcnJheSkge1xyXG5cclxuICAgICAgICBpZiAoeCA8IDAgfHwgeSA8IDAgfHwgeCA+IHdpZHRoIHx8IHkgPiBoZWlnaHQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcCA9IHBpeGVsc1s0ICogTWF0aC5yb3VuZCh4KSArIDQgKiB3aWR0aCAqIE1hdGgucm91bmQoeSkgKyAzXTtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIng6IFwiICsgeCArIFwiLCB5OiBcIiArIHkgKyBcIiwgd2lkdGg6IFwiICsgd2lkdGggKyBcIiA9IFwiICsgcCk7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJpbmRleDogXCIgKyAoNCAqIHggKyA0ICogd2lkdGggKiB5ICsgMykgKyBcIiwgbGVuZ3RoOiBcIiArIHBpeGVscy5sZW5ndGgpO1xyXG5cclxuICAgICAgICByZXR1cm4gcCA9PSAwO1xyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=