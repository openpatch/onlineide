import { Klass } from "../../compiler/types/Class.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { voidPrimitiveType, stringPrimitiveType, booleanPrimitiveType, doublePrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { WorldHelper } from "./World.js";
export class Actor extends Klass {
    constructor(module) {
        super("Actor", module, "Abstrakte Klasse mit überschreibbaren Methoden act (zur Implemntierung eines Timers) und onKeyTyped, onKeyUp usw. zur entgegennahme von Tastaturereignissen");
        this.setBaseClass(module.typeStore.getType("Object"));
        this.isAbstract = true;
        let methodSignatures = [
            { signature: "onKeyTyped(String)", actorListIdentifier: "keyPressedActors" },
            { signature: "onKeyUp(String)", actorListIdentifier: "keyUpActors" },
            { signature: "onKeyDown(String)", actorListIdentifier: "keyDownActors" },
            { signature: "act()", actorListIdentifier: "actActors" },
            { signature: "act(double)", actorListIdentifier: "actActors" },
        ];
        this.postConstructorCallbacks = [
            (r) => {
                for (let ms of methodSignatures) {
                    let method = r.class.getMethodBySignature(ms.signature);
                    if ((method === null || method === void 0 ? void 0 : method.program) != null || (method === null || method === void 0 ? void 0 : method.invoke) != null) {
                        let ah = r.intrinsicData['Actor'];
                        ah.worldHelper[ms.actorListIdentifier].push({
                            actorHelper: ah,
                            method: method
                        });
                    }
                }
            }
        ];
        this.addMethod(new Method("Actor", new Parameterlist([
        // { identifier: "deltaTimeInMs", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        // ]), this,
        ]), null, (parameters) => {
            let o = parameters[0].value;
            let actorHelper = new ActorHelper(module.main.getInterpreter(), o);
            o.intrinsicData["Actor"] = actorHelper;
            // return o;
        }, // no implementation!
        false, false, "Der Konstruktor registriert den Actor beim Grafikfenster", true));
        this.addMethod(new Method("destroy", new Parameterlist([]), null, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            sh.destroy();
        }, false, false, "Vernichtet das Grafikobjekt. Falls es in einem Group-Objekt enthalten ist, wird es vor dem Vernichten automatisch aus diesem entfernt.", false));
        this.addMethod(new Method("isKeyUp", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let key = parameters[1].value;
            let sh = o.intrinsicData["Actor"];
            return !sh.isKeyDown(key);
        }, false, false, "Gibt genau dann true zurück, wenn der Benutzer die gegebenen Taste gerade NICHT drückt. Als Taste kann auch bsw. [shift]+m angegeben werden. Die Angabe von Sondertasten (Enter, ArrowUp, ArrowLeft, ...) ist auch möglich.", false));
        this.addMethod(new Method("isKeyDown", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let key = parameters[1].value;
            let sh = o.intrinsicData["Actor"];
            return sh.isKeyDown(key);
        }, false, false, "Gibt genau dann true zurück, wenn der Benutzer die gegebenen Taste gerade drückt. Als Taste kann auch bsw. [shift]+m angegeben werden. Die Angabe von Sondertasten (Enter, ArrowUp, ArrowLeft, ...) ist auch möglich.", false));
        this.addMethod(new Method("isDestroyed", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            return sh.isDestroyed;
        }, false, false, "Gibt true zurück, falls das Objekt bereits durch die Methode destroy() zerstört wurde.", false));
        this.addMethod(new Method("getWorld", new Parameterlist([]), module.typeStore.getType("World"), (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            let interpreter = module.main.getInterpreter();
            let worldHelper = interpreter.worldHelper;
            if (worldHelper == null) {
                let w = new RuntimeObject(interpreter.moduleStore.getType("World").type);
                worldHelper = new WorldHelper(800, 600, interpreter.moduleStore.getModule("Base Module"), w);
            }
            return worldHelper.world;
        }, false, false, "Gibt das Welt-Objekt zurück.", false));
        this.addMethod(new Method("stopActing", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let ah = o.intrinsicData["Actor"];
            // ah.timerPaused = true;
            ah.setTimerPaused(true);
            return;
        }, false, false, "Stoppt den 30-mal pro Sekunde erfolgenden Aufruf der Methode act für dieses Objekt.", false));
        this.addMethod(new Method("restartActing", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            // sh.timerPaused = false;
            sh.setTimerPaused(false);
        }, false, false, "Startet den 30-mal pro Sekunde erfolgenden Aufruf der Methode act für dieses Objekt erneut.", false));
        this.addMethod(new Method("isActing", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            return !sh.timerPaused;
        }, false, false, "Gibt true zurück, wenn der periodische Aufruf der Methode act weiterhin erfolgt.", false));
        this.addMethod(new Method("act", new Parameterlist([
            { identifier: "deltaTime", type: doublePrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), null, null, // no statements!
        false, false, "Wird ca. 30-mal pro Sekunde aufgerufen", false));
        this.addMethod(new Method("act", new Parameterlist([]), null, null, // no statements!
        false, false, "Wird ca. 30-mal pro Sekunde aufgerufen", false));
        this.addMethod(new Method("onKeyTyped", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), null, null, // no statements!
        false, false, "Wird aufgerufen, nachdem der Benutzer eine Taste gedrückt und wieder losgelassen hat.", false));
        this.addMethod(new Method("onKeyDown", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), null, null, // no statements!
        false, false, "Wird aufgerufen, nachdem der Benutzer eine Taste gedrückt hat.", false));
        this.addMethod(new Method("onKeyUp", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), null, null, // no statements!
        false, false, "Wird aufgerufen, nachdem der Benutzer eine Taste losgelassen hat.", false));
    }
    registerWorldType() {
        this.methods.filter(m => m.identifier == "getWorld")[0].returnType = this.module.typeStore.getType("World");
    }
}
export class ActorHelper {
    constructor(interpreter, runtimeObject) {
        this.runtimeObject = runtimeObject;
        this.isDestroyed = false;
        this.timerPaused = false;
        let worldHelper = interpreter.worldHelper;
        if (worldHelper == null) {
            let w = new RuntimeObject(interpreter.moduleStore.getType("World").type);
            worldHelper = new WorldHelper(800, 600, interpreter.moduleStore.getModule("Base Module"), w);
            // worldHelper = new WorldHelper(800, 600, interpreter.main.currentWorkspace.moduleStore.getModule("Base Module"), w);
            w.intrinsicData["World"] = worldHelper;
            if (runtimeObject.intrinsicData["isGNG"]) {
                worldHelper.setBackgroundColor("#e6e6e6");
            }
        }
        this.worldHelper = worldHelper;
    }
    setTimerPaused(tp) {
        this.timerPaused = tp;
    }
    isKeyDown(key) {
        return this.worldHelper.interpreter.keyboardTool.isPressed(key);
    }
    destroy() {
        this.isDestroyed = true;
        this.worldHelper.actorHelpersToDestroy.push(this);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L3J1bnRpbWVsaWJyYXJ5L2dyYXBoaWNzL0FjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYSxLQUFLLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxtQkFBbUIsRUFBRSxvQkFBb0IsRUFBRSxtQkFBbUIsRUFBb0IsTUFBTSx3Q0FBd0MsQ0FBQztBQUM3SixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDbkUsT0FBTyxFQUFFLFdBQVcsRUFBYyxNQUFNLFlBQVksQ0FBQztBQUdyRCxNQUFNLE9BQU8sS0FBTSxTQUFRLEtBQUs7SUFFNUIsWUFBWSxNQUFjO1FBRXRCLEtBQUssQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLDZKQUE2SixDQUFDLENBQUM7UUFFdEwsSUFBSSxDQUFDLFlBQVksQ0FBUSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXZCLElBQUksZ0JBQWdCLEdBQXlEO1lBQ3pFLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFO1lBQzVFLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLG1CQUFtQixFQUFFLGFBQWEsRUFBRTtZQUNwRSxFQUFFLFNBQVMsRUFBRSxtQkFBbUIsRUFBRSxtQkFBbUIsRUFBRSxlQUFlLEVBQUU7WUFDeEUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLFdBQVcsRUFBRTtZQUN4RCxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsbUJBQW1CLEVB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LENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsV0FBVyxDQUFDO1lBQ3ZDLElBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBQztnQkFDcEMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzdDO1NBQ0o7UUFDRCxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztJQUNuQyxDQUFDO0lBRUQsY0FBYyxDQUFDLEVBQVc7UUFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUdELFNBQVMsQ0FBQyxHQUFXO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEludGVyZmFjZSwgS2xhc3MgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgTW9kdWxlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgTWV0aG9kLCBQYXJhbWV0ZXJsaXN0IH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IHZvaWRQcmltaXRpdmVUeXBlLCBzdHJpbmdQcmltaXRpdmVUeXBlLCBib29sZWFuUHJpbWl0aXZlVHlwZSwgZG91YmxlUHJpbWl0aXZlVHlwZSwgaW50UHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBSdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4uLy4uL2ludGVycHJldGVyL1J1bnRpbWVPYmplY3QuanNcIjtcclxuaW1wb3J0IHsgV29ybGRIZWxwZXIsIFdvcmxkQ2xhc3MgfSBmcm9tIFwiLi9Xb3JsZC5qc1wiO1xyXG5pbXBvcnQgeyBJbnRlcnByZXRlciB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9JbnRlcnByZXRlci5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEFjdG9yIGV4dGVuZHMgS2xhc3Mge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG1vZHVsZTogTW9kdWxlKSB7XHJcblxyXG4gICAgICAgIHN1cGVyKFwiQWN0b3JcIiwgbW9kdWxlLCBcIkFic3RyYWt0ZSBLbGFzc2UgbWl0IMO8YmVyc2NocmVpYmJhcmVuIE1ldGhvZGVuIGFjdCAoenVyIEltcGxlbW50aWVydW5nIGVpbmVzIFRpbWVycykgdW5kIG9uS2V5VHlwZWQsIG9uS2V5VXAgdXN3LiB6dXIgZW50Z2VnZW5uYWhtZSB2b24gVGFzdGF0dXJlcmVpZ25pc3NlblwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5zZXRCYXNlQ2xhc3MoPEtsYXNzPm1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIk9iamVjdFwiKSk7XHJcbiAgICAgICAgdGhpcy5pc0Fic3RyYWN0ID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgbGV0IG1ldGhvZFNpZ25hdHVyZXM6IHsgc2lnbmF0dXJlOiBzdHJpbmcsIGFjdG9yTGlzdElkZW50aWZpZXI6IHN0cmluZyB9W10gPSBbXHJcbiAgICAgICAgICAgIHsgc2lnbmF0dXJlOiBcIm9uS2V5VHlwZWQoU3RyaW5nKVwiLCBhY3Rvckxpc3RJZGVudGlmaWVyOiBcImtleVByZXNzZWRBY3RvcnNcIiB9LFxyXG4gICAgICAgICAgICB7IHNpZ25hdHVyZTogXCJvbktleVVwKFN0cmluZylcIiwgYWN0b3JMaXN0SWRlbnRpZmllcjogXCJrZXlVcEFjdG9yc1wiIH0sXHJcbiAgICAgICAgICAgIHsgc2lnbmF0dXJlOiBcIm9uS2V5RG93bihTdHJpbmcpXCIsIGFjdG9yTGlzdElkZW50aWZpZXI6IFwia2V5RG93bkFjdG9yc1wiIH0sXHJcbiAgICAgICAgICAgIHsgc2lnbmF0dXJlOiBcImFjdCgpXCIsIGFjdG9yTGlzdElkZW50aWZpZXI6IFwiYWN0QWN0b3JzXCIgfSxcclxuICAgICAgICAgICAgeyBzaWduYXR1cmU6IFwiYWN0KGRvdWJsZSlcIiwgYWN0b3JMaXN0SWRlbnRpZmllcjogXCJhY3RBY3RvcnNcIiB9LFxyXG4gICAgICAgIF07XHJcblxyXG4gICAgICAgIHRoaXMucG9zdENvbnN0cnVjdG9yQ2FsbGJhY2tzID0gW1xyXG4gICAgICAgICAgICAocjogUnVudGltZU9iamVjdCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IG1zIG9mIG1ldGhvZFNpZ25hdHVyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbWV0aG9kOiBNZXRob2QgPSAoPEtsYXNzPnIuY2xhc3MpLmdldE1ldGhvZEJ5U2lnbmF0dXJlKG1zLnNpZ25hdHVyZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2Q/LnByb2dyYW0gIT0gbnVsbCB8fCBtZXRob2Q/Lmludm9rZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhaDogQWN0b3JIZWxwZXIgPSA8QWN0b3JIZWxwZXI+ci5pbnRyaW5zaWNEYXRhWydBY3RvciddO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhaC53b3JsZEhlbHBlclttcy5hY3Rvckxpc3RJZGVudGlmaWVyXS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdG9ySGVscGVyOiBhaCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIF07XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJBY3RvclwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIC8vIHsgaWRlbnRpZmllcjogXCJkZWx0YVRpbWVJbk1zXCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgLy8gXSksIHRoaXMsXHJcbiAgICAgICAgXSksIG51bGwsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBhY3RvckhlbHBlciA9IG5ldyBBY3RvckhlbHBlcihtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLCBvKTtcclxuXHJcbiAgICAgICAgICAgICAgICBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXSA9IGFjdG9ySGVscGVyO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHJldHVybiBvO1xyXG5cclxuICAgICAgICAgICAgfSwgIC8vIG5vIGltcGxlbWVudGF0aW9uIVxyXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiRGVyIEtvbnN0cnVrdG9yIHJlZ2lzdHJpZXJ0IGRlbiBBY3RvciBiZWltIEdyYWZpa2ZlbnN0ZXJcIiwgdHJ1ZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiZGVzdHJveVwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIG51bGwsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG4gICAgICAgICAgICAgICAgc2guZGVzdHJveSgpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIlZlcm5pY2h0ZXQgZGFzIEdyYWZpa29iamVrdC4gRmFsbHMgZXMgaW4gZWluZW0gR3JvdXAtT2JqZWt0IGVudGhhbHRlbiBpc3QsIHdpcmQgZXMgdm9yIGRlbSBWZXJuaWNodGVuIGF1dG9tYXRpc2NoIGF1cyBkaWVzZW0gZW50ZmVybnQuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJpc0tleVVwXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImtleVwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCBib29sZWFuUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQga2V5OiBzdHJpbmcgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiAhc2guaXNLZXlEb3duKGtleSk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiR2lidCBnZW5hdSBkYW5uIHRydWUgenVyw7xjaywgd2VubiBkZXIgQmVudXR6ZXIgZGllIGdlZ2ViZW5lbiBUYXN0ZSBnZXJhZGUgTklDSFQgZHLDvGNrdC4gQWxzIFRhc3RlIGthbm4gYXVjaCBic3cuIFtzaGlmdF0rbSBhbmdlZ2ViZW4gd2VyZGVuLiBEaWUgQW5nYWJlIHZvbiBTb25kZXJ0YXN0ZW4gKEVudGVyLCBBcnJvd1VwLCBBcnJvd0xlZnQsIC4uLikgaXN0IGF1Y2ggbcO2Z2xpY2guXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJpc0tleURvd25cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwia2V5XCIsIHR5cGU6IHN0cmluZ1ByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIGJvb2xlYW5QcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBrZXk6IHN0cmluZyA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2g6IEFjdG9ySGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiQWN0b3JcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNoLmlzS2V5RG93bihrZXkpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgZ2VuYXUgZGFubiB0cnVlIHp1csO8Y2ssIHdlbm4gZGVyIEJlbnV0emVyIGRpZSBnZWdlYmVuZW4gVGFzdGUgZ2VyYWRlIGRyw7xja3QuIEFscyBUYXN0ZSBrYW5uIGF1Y2ggYnN3LiBbc2hpZnRdK20gYW5nZWdlYmVuIHdlcmRlbi4gRGllIEFuZ2FiZSB2b24gU29uZGVydGFzdGVuIChFbnRlciwgQXJyb3dVcCwgQXJyb3dMZWZ0LCAuLi4pIGlzdCBhdWNoIG3DtmdsaWNoLlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiaXNEZXN0cm95ZWRcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBib29sZWFuUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2g6IEFjdG9ySGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiQWN0b3JcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNoLmlzRGVzdHJveWVkO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgdHJ1ZSB6dXLDvGNrLCBmYWxscyBkYXMgT2JqZWt0IGJlcmVpdHMgZHVyY2ggZGllIE1ldGhvZGUgZGVzdHJveSgpIHplcnN0w7ZydCB3dXJkZS5cIiwgZmFsc2UpKTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJnZXRXb3JsZFwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIG1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIldvcmxkXCIpLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBzaDogQWN0b3JIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpO1xyXG4gICAgICAgICAgICAgICAgbGV0IHdvcmxkSGVscGVyID0gaW50ZXJwcmV0ZXIud29ybGRIZWxwZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAod29ybGRIZWxwZXIgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB3OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3QoPEtsYXNzPmludGVycHJldGVyLm1vZHVsZVN0b3JlLmdldFR5cGUoXCJXb3JsZFwiKS50eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICB3b3JsZEhlbHBlciA9IG5ldyBXb3JsZEhlbHBlcig4MDAsIDYwMCwgaW50ZXJwcmV0ZXIubW9kdWxlU3RvcmUuZ2V0TW9kdWxlKFwiQmFzZSBNb2R1bGVcIiksIHcpO1xyXG4gICAgICAgICAgICAgICAgfSAgICAgICAgXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gd29ybGRIZWxwZXIud29ybGQ7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiR2lidCBkYXMgV2VsdC1PYmpla3QgenVyw7xjay5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcInN0b3BBY3RpbmdcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgYWg6IEFjdG9ySGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiQWN0b3JcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gYWgudGltZXJQYXVzZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgYWguc2V0VGltZXJQYXVzZWQodHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIlN0b3BwdCBkZW4gMzAtbWFsIHBybyBTZWt1bmRlIGVyZm9sZ2VuZGVuIEF1ZnJ1ZiBkZXIgTWV0aG9kZSBhY3QgZsO8ciBkaWVzZXMgT2JqZWt0LlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcInJlc3RhcnRBY3RpbmdcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2g6IEFjdG9ySGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiQWN0b3JcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gc2gudGltZXJQYXVzZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHNoLnNldFRpbWVyUGF1c2VkKGZhbHNlKTtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgXCJTdGFydGV0IGRlbiAzMC1tYWwgcHJvIFNla3VuZGUgZXJmb2xnZW5kZW4gQXVmcnVmIGRlciBNZXRob2RlIGFjdCBmw7xyIGRpZXNlcyBPYmpla3QgZXJuZXV0LlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImlzQWN0aW5nXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiAhc2gudGltZXJQYXVzZWQ7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiR2lidCB0cnVlIHp1csO8Y2ssIHdlbm4gZGVyIHBlcmlvZGlzY2hlIEF1ZnJ1ZiBkZXIgTWV0aG9kZSBhY3Qgd2VpdGVyaGluIGVyZm9sZ3QuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJhY3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiZGVsdGFUaW1lXCIsIHR5cGU6IGRvdWJsZVByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIG51bGwsXHJcbiAgICAgICAgICAgIG51bGwsIC8vIG5vIHN0YXRlbWVudHMhXHJcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGNhLiAzMC1tYWwgcHJvIFNla3VuZGUgYXVmZ2VydWZlblwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiYWN0XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgbnVsbCxcclxuICAgICAgICAgICAgbnVsbCwgLy8gbm8gc3RhdGVtZW50cyFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgY2EuIDMwLW1hbCBwcm8gU2VrdW5kZSBhdWZnZXJ1ZmVuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJvbktleVR5cGVkXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImtleVwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICBudWxsLCAvLyBubyBzdGF0ZW1lbnRzIVxyXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiV2lyZCBhdWZnZXJ1ZmVuLCBuYWNoZGVtIGRlciBCZW51dHplciBlaW5lIFRhc3RlIGdlZHLDvGNrdCB1bmQgd2llZGVyIGxvc2dlbGFzc2VuIGhhdC5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIm9uS2V5RG93blwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJrZXlcIiwgdHlwZTogc3RyaW5nUHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgbnVsbCxcclxuICAgICAgICAgICAgbnVsbCwgLy8gbm8gc3RhdGVtZW50cyFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgYXVmZ2VydWZlbiwgbmFjaGRlbSBkZXIgQmVudXR6ZXIgZWluZSBUYXN0ZSBnZWRyw7xja3QgaGF0LlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwib25LZXlVcFwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJrZXlcIiwgdHlwZTogc3RyaW5nUHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgbnVsbCxcclxuICAgICAgICAgICAgbnVsbCwgLy8gbm8gc3RhdGVtZW50cyFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgYXVmZ2VydWZlbiwgbmFjaGRlbSBkZXIgQmVudXR6ZXIgZWluZSBUYXN0ZSBsb3NnZWxhc3NlbiBoYXQuXCIsIGZhbHNlKSk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICByZWdpc3RlcldvcmxkVHlwZSgpIHtcclxuICAgICAgICB0aGlzLm1ldGhvZHMuZmlsdGVyKG0gPT4gbS5pZGVudGlmaWVyID09IFwiZ2V0V29ybGRcIilbMF0ucmV0dXJuVHlwZSA9IHRoaXMubW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiV29ybGRcIik7XHJcbiAgICB9XHJcblxyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEFjdG9ySGVscGVyIHtcclxuXHJcbiAgICB3b3JsZEhlbHBlcjogV29ybGRIZWxwZXI7XHJcbiAgICBpc0Rlc3Ryb3llZDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIHRpbWVyUGF1c2VkOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IoaW50ZXJwcmV0ZXI6IEludGVycHJldGVyLCBwdWJsaWMgcnVudGltZU9iamVjdDogUnVudGltZU9iamVjdCkge1xyXG4gICAgICAgIGxldCB3b3JsZEhlbHBlciA9IGludGVycHJldGVyLndvcmxkSGVscGVyO1xyXG4gICAgICAgIGlmICh3b3JsZEhlbHBlciA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGxldCB3OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3QoPEtsYXNzPmludGVycHJldGVyLm1vZHVsZVN0b3JlLmdldFR5cGUoXCJXb3JsZFwiKS50eXBlKTtcclxuICAgICAgICAgICAgd29ybGRIZWxwZXIgPSBuZXcgV29ybGRIZWxwZXIoODAwLCA2MDAsIGludGVycHJldGVyLm1vZHVsZVN0b3JlLmdldE1vZHVsZShcIkJhc2UgTW9kdWxlXCIpLCB3KTtcclxuICAgICAgICAgICAgLy8gd29ybGRIZWxwZXIgPSBuZXcgV29ybGRIZWxwZXIoODAwLCA2MDAsIGludGVycHJldGVyLm1haW4uY3VycmVudFdvcmtzcGFjZS5tb2R1bGVTdG9yZS5nZXRNb2R1bGUoXCJCYXNlIE1vZHVsZVwiKSwgdyk7XHJcbiAgICAgICAgICAgIHcuaW50cmluc2ljRGF0YVtcIldvcmxkXCJdID0gd29ybGRIZWxwZXI7XHJcbiAgICAgICAgICAgIGlmKHJ1bnRpbWVPYmplY3QuaW50cmluc2ljRGF0YVtcImlzR05HXCJdKXtcclxuICAgICAgICAgICAgICAgIHdvcmxkSGVscGVyLnNldEJhY2tncm91bmRDb2xvcihcIiNlNmU2ZTZcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy53b3JsZEhlbHBlciA9IHdvcmxkSGVscGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWVyUGF1c2VkKHRwOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy50aW1lclBhdXNlZCA9IHRwO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBpc0tleURvd24oa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JsZEhlbHBlci5pbnRlcnByZXRlci5rZXlib2FyZFRvb2wuaXNQcmVzc2VkKGtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLmlzRGVzdHJveWVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLndvcmxkSGVscGVyLmFjdG9ySGVscGVyc1RvRGVzdHJveS5wdXNoKHRoaXMpO1xyXG4gICAgfVxyXG5cclxufVxyXG5cclxuIl19