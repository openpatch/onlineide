import { Klass } from "../../compiler/types/Class.js";
import { intPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { WorldHelper } from "../graphics/World.js";
import { GNGEreignisbehandlung } from "./GNGEreignisbehandlung.js";
export class GNGZeichenfensterClass extends Klass {
    constructor(module, moduleStore) {
        super("Zeichenfenster", module, "Grafische Zeichenfläche mit Koordinatensystem");
        this.module = module;
        this.setBaseClass(moduleStore.getType("Object").type);
        let aktionsempfaengerType = module.typeStore.getType("Aktionsempfaenger");
        // this.addAttribute(new Attribute("PI", doublePrimitiveType, (object) => { return Math.PI }, true, Visibility.public, true, "Die Kreiszahl Pi (3.1415...)"));
        this.addMethod(new Method("MalflächenBreiteGeben", new Parameterlist([]), intPrimitiveType, (parameters) => {
            return Math.round(this.getWorldHelper().width);
        }, false, true, 'Gibt die Breite des Zeichenbereichs in Pixeln zurück.', false));
        this.addMethod(new Method("MalflächenHöheGeben", new Parameterlist([]), intPrimitiveType, (parameters) => {
            return Math.round(this.getWorldHelper().width);
        }, false, true, 'Gibt die Höhe des Zeichenbereichs in Pixeln zurück.', false));
        this.addMethod(new Method("AktionsEmpfängerEintragen", new Parameterlist([
            { identifier: "neu", type: aktionsempfaengerType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let aktionsempfaenger = parameters[1].value;
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.registerEvents(aktionsempfaenger);
        }, false, true, 'Trägt einen neuen Aktionsempfänger ein.', false));
        this.addMethod(new Method("AktionsEmpfängerEntfernen", new Parameterlist([
            { identifier: "alt", type: aktionsempfaengerType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let aktionsempfaenger = parameters[1].value;
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.unregisterEvents(aktionsempfaenger);
        }, false, true, 'Löscht einen Aktionsempfänger aus der Liste.', false));
        this.addMethod(new Method("TaktgeberStarten", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.startTimer();
        }, false, true, 'Startet den Taktgeber', false));
        this.addMethod(new Method("TaktgeberStoppen", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.stopTimer();
        }, false, true, 'Stoppt den Taktgeber', false));
        this.addMethod(new Method("TaktdauerSetzen", new Parameterlist([
            { identifier: "dauer", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let dauer = parameters[1].value;
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.taktdauer = dauer;
        }, false, true, 'Setzt die Taktdauer des Zeitgebers in Millisekunden', false));
    }
    getWorldHelper(breite = 800, höhe = 600) {
        var _a, _b, _c, _d;
        let wh = (_c = (_b = (_a = this.module) === null || _a === void 0 ? void 0 : _a.main) === null || _b === void 0 ? void 0 : _b.getInterpreter()) === null || _c === void 0 ? void 0 : _c.worldHelper;
        if (wh != null) {
            if (wh.width != breite || wh.height != höhe) {
                let ratio = Math.round(höhe / breite * 100);
                wh.$containerOuter.css('padding-bottom', ratio + "%");
                wh.stage.localTransform.scale(wh.width / breite, wh.height / höhe);
                wh.width = breite;
                wh.height = höhe;
                // this.stage.localTransform.rotate(45/180*Math.PI);
                // this.stage.localTransform.translate(400,300);
                wh.stage.transform.onChange();
                (_d = this.module.main.getRightDiv()) === null || _d === void 0 ? void 0 : _d.adjustWidthToWorld();
            }
            return wh;
        }
        else {
            let worldObject = new RuntimeObject(this.module.typeStore.getType("World"));
            let wh = new WorldHelper(breite, höhe, this.module, worldObject);
            worldObject.intrinsicData["World"] = wh;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR05HWmVpY2hlbmZlbnN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L3J1bnRpbWVsaWJyYXJ5L2duZy9HTkdaZWljaGVuZmVuc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDN0YsT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDbkUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxxQkFBcUIsRUFBK0IsTUFBTSw0QkFBNEIsQ0FBQztBQUVoRyxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsS0FBSztJQUU3QyxZQUFtQixNQUFjLEVBQUUsV0FBd0I7UUFFdkQsS0FBSyxDQUFDLGdCQUFnQixFQUFFLE1BQU0sRUFBRSwrQ0FBK0MsQ0FBQyxDQUFBO1FBRmpFLFdBQU0sR0FBTixNQUFNLENBQVE7UUFJN0IsSUFBSSxDQUFDLFlBQVksQ0FBUSxXQUFXLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTdELElBQUkscUJBQXFCLEdBQTJCLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFHbEcsOEpBQThKO1FBRzlKLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsdUJBQXVCLEVBQUUsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDLEVBQUUsZ0JBQWdCLEVBQ3RGLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFFWCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxD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Q0FBQyxLQUFLLEdBQUcsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLENBQUM7Z0JBQ25FLEVBQUUsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO2dCQUNsQixFQUFFLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztnQkFDakIsb0RBQW9EO2dCQUNwRCxnREFBZ0Q7Z0JBQ2hELEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUU5QixNQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSwwQ0FBRSxrQkFBa0IsR0FBRzthQUV4RDtZQUVELE9BQU8sRUFBRSxDQUFDO1NBRWI7YUFBTTtZQUNILElBQUksV0FBVyxHQUFrQixJQUFJLGFBQWEsQ0FBUSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNsRyxJQUFJLEVBQUUsR0FBRyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDakUsV0FBVyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDM0M7SUFFTCxDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2R1bGUsIE1vZHVsZVN0b3JlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3BhcnNlci9Nb2R1bGUuanNcIjtcbmltcG9ydCB7IEtsYXNzIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XG5pbXBvcnQgeyBpbnRQcmltaXRpdmVUeXBlLCB2b2lkUHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xuaW1wb3J0IHsgTWV0aG9kLCBQYXJhbWV0ZXJsaXN0IH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XG5pbXBvcnQgeyBSdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4uLy4uL2ludGVycHJldGVyL1J1bnRpbWVPYmplY3QuanNcIjtcbmltcG9ydCB7IFdvcmxkSGVscGVyIH0gZnJvbSBcIi4uL2dyYXBoaWNzL1dvcmxkLmpzXCI7XG5pbXBvcnQgeyBHTkdFcmVpZ25pc2JlaGFuZGx1bmcsIEdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlciB9IGZyb20gXCIuL0dOR0VyZWlnbmlzYmVoYW5kbHVuZy5qc1wiO1xuXG5leHBvcnQgY2xhc3MgR05HWmVpY2hlbmZlbnN0ZXJDbGFzcyBleHRlbmRzIEtsYXNzIHtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBtb2R1bGU6IE1vZHVsZSwgbW9kdWxlU3RvcmU6IE1vZHVsZVN0b3JlKSB7XG5cbiAgICAgICAgc3VwZXIoXCJaZWljaGVuZmVuc3RlclwiLCBtb2R1bGUsIFwiR3JhZmlzY2hlIFplaWNoZW5mbMOkY2hlIG1pdCBLb29yZGluYXRlbnN5c3RlbVwiKVxuXG4gICAgICAgIHRoaXMuc2V0QmFzZUNsYXNzKDxLbGFzcz5tb2R1bGVTdG9yZS5nZXRUeXBlKFwiT2JqZWN0XCIpLnR5cGUpO1xuXG4gICAgICAgIGxldCBha3Rpb25zZW1wZmFlbmdlclR5cGUgPSA8R05HWmVpY2hlbmZlbnN0ZXJDbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJBa3Rpb25zZW1wZmFlbmdlclwiKTtcblxuXG4gICAgICAgIC8vIHRoaXMuYWRkQXR0cmlidXRlKG5ldyBBdHRyaWJ1dGUoXCJQSVwiLCBkb3VibGVQcmltaXRpdmVUeXBlLCAob2JqZWN0KSA9PiB7IHJldHVybiBNYXRoLlBJIH0sIHRydWUsIFZpc2liaWxpdHkucHVibGljLCB0cnVlLCBcIkRpZSBLcmVpc3phaGwgUGkgKDMuMTQxNS4uLilcIikpO1xuXG5cbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIk1hbGZsw6RjaGVuQnJlaXRlR2ViZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW10pLCBpbnRQcmltaXRpdmVUeXBlLFxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcblxuICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMuZ2V0V29ybGRIZWxwZXIoKS53aWR0aCk7XG5cbiAgICAgICAgICAgIH0sIGZhbHNlLCB0cnVlLCAnR2lidCBkaWUgQnJlaXRlIGRlcyBaZWljaGVuYmVyZWljaHMgaW4gUGl4ZWxuIHp1csO8Y2suJywgZmFsc2UpKTtcblxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiTWFsZmzDpGNoZW5Iw7ZoZUdlYmVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgaW50UHJpbWl0aXZlVHlwZSxcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmdldFdvcmxkSGVscGVyKCkud2lkdGgpO1xuXG4gICAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSwgJ0dpYnQgZGllIEjDtmhlIGRlcyBaZWljaGVuYmVyZWljaHMgaW4gUGl4ZWxuIHp1csO8Y2suJywgZmFsc2UpKTtcblxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiQWt0aW9uc0VtcGbDpG5nZXJFaW50cmFnZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcIm5ldVwiLCB0eXBlOiBha3Rpb25zZW1wZmFlbmdlclR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IGFrdGlvbnNlbXBmYWVuZ2VyOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcblxuICAgICAgICAgICAgICAgIGxldCBoZWxwZXI6IEdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlciA9IEdOR0VyZWlnbmlzYmVoYW5kbHVuZy5nZXRIZWxwZXIobW9kdWxlKTtcbiAgICAgICAgICAgICAgICBoZWxwZXIucmVnaXN0ZXJFdmVudHMoYWt0aW9uc2VtcGZhZW5nZXIpO1xuXG4gICAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSwgJ1Ryw6RndCBlaW5lbiBuZXVlbiBBa3Rpb25zZW1wZsOkbmdlciBlaW4uJywgZmFsc2UpKTtcblxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiQWt0aW9uc0VtcGbDpG5nZXJFbnRmZXJuZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImFsdFwiLCB0eXBlOiBha3Rpb25zZW1wZmFlbmdlclR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IGFrdGlvbnNlbXBmYWVuZ2VyOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcblxuICAgICAgICAgICAgICAgIGxldCBoZWxwZXI6IEdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlciA9IEdOR0VyZWlnbmlzYmVoYW5kbHVuZy5nZXRIZWxwZXIobW9kdWxlKTtcbiAgICAgICAgICAgICAgICBoZWxwZXIudW5yZWdpc3RlckV2ZW50cyhha3Rpb25zZW1wZmFlbmdlcik7XG5cbiAgICAgICAgICAgIH0sIGZhbHNlLCB0cnVlLCAnTMO2c2NodCBlaW5lbiBBa3Rpb25zZW1wZsOkbmdlciBhdXMgZGVyIExpc3RlLicsIGZhbHNlKSk7XG5cbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlRha3RnZWJlclN0YXJ0ZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW10pLCB2b2lkUHJpbWl0aXZlVHlwZSxcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBsZXQgaGVscGVyOiBHTkdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXIgPSBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSk7XG4gICAgICAgICAgICAgICAgaGVscGVyLnN0YXJ0VGltZXIoKTtcblxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsICdTdGFydGV0IGRlbiBUYWt0Z2ViZXInLCBmYWxzZSkpO1xuXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJUYWt0Z2ViZXJTdG9wcGVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IGhlbHBlcjogR05HRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID0gR05HRXJlaWduaXNiZWhhbmRsdW5nLmdldEhlbHBlcihtb2R1bGUpO1xuICAgICAgICAgICAgICAgIGhlbHBlci5zdG9wVGltZXIoKTtcblxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsICdTdG9wcHQgZGVuIFRha3RnZWJlcicsIGZhbHNlKSk7XG5cbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlRha3RkYXVlclNldHplblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiZGF1ZXJcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBsZXQgZGF1ZXI6IG51bWJlciA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XG5cbiAgICAgICAgICAgICAgICBsZXQgaGVscGVyOiBHTkdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXIgPSBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSk7XG4gICAgICAgICAgICAgICAgaGVscGVyLnRha3RkYXVlciA9IGRhdWVyO1xuXG4gICAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSwgJ1NldHp0IGRpZSBUYWt0ZGF1ZXIgZGVzIFplaXRnZWJlcnMgaW4gTWlsbGlzZWt1bmRlbicsIGZhbHNlKSk7XG5cblxuICAgIH1cblxuICAgIGdldFdvcmxkSGVscGVyKGJyZWl0ZTogbnVtYmVyID0gODAwLCBow7ZoZTogbnVtYmVyID0gNjAwKTogV29ybGRIZWxwZXIge1xuXG4gICAgICAgIGxldCB3aCA9IHRoaXMubW9kdWxlPy5tYWluPy5nZXRJbnRlcnByZXRlcigpPy53b3JsZEhlbHBlcjtcblxuICAgICAgICBpZiAod2ggIT0gbnVsbCkge1xuXG4gICAgICAgICAgICBpZiAod2gud2lkdGggIT0gYnJlaXRlIHx8IHdoLmhlaWdodCAhPSBow7ZoZSkge1xuXG4gICAgICAgICAgICAgICAgbGV0IHJhdGlvOiBudW1iZXIgPSBNYXRoLnJvdW5kKGjDtmhlIC8gYnJlaXRlICogMTAwKTtcbiAgICAgICAgICAgICAgICB3aC4kY29udGFpbmVyT3V0ZXIuY3NzKCdwYWRkaW5nLWJvdHRvbScsIHJhdGlvICsgXCIlXCIpO1xuXG4gICAgICAgICAgICAgICAgd2guc3RhZ2UubG9jYWxUcmFuc2Zvcm0uc2NhbGUod2gud2lkdGggLyBicmVpdGUsIHdoLmhlaWdodCAvIGjDtmhlKTtcbiAgICAgICAgICAgICAgICB3aC53aWR0aCA9IGJyZWl0ZTtcbiAgICAgICAgICAgICAgICB3aC5oZWlnaHQgPSBow7ZoZTtcbiAgICAgICAgICAgICAgICAvLyB0aGlzLnN0YWdlLmxvY2FsVHJhbnNmb3JtLnJvdGF0ZSg0NS8xODAqTWF0aC5QSSk7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy5zdGFnZS5sb2NhbFRyYW5zZm9ybS50cmFuc2xhdGUoNDAwLDMwMCk7XG4gICAgICAgICAgICAgICAgd2guc3RhZ2UudHJhbnNmb3JtLm9uQ2hhbmdlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLm1vZHVsZS5tYWluLmdldFJpZ2h0RGl2KCk/LmFkanVzdFdpZHRoVG9Xb3JsZCgpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB3aDtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IHdvcmxkT2JqZWN0OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3QoPEtsYXNzPnRoaXMubW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiV29ybGRcIikpO1xuICAgICAgICAgICAgbGV0IHdoID0gbmV3IFdvcmxkSGVscGVyKGJyZWl0ZSwgaMO2aGUsIHRoaXMubW9kdWxlLCB3b3JsZE9iamVjdCk7XG4gICAgICAgICAgICB3b3JsZE9iamVjdC5pbnRyaW5zaWNEYXRhW1wiV29ybGRcIl0gPSB3aDtcbiAgICAgICAgfVxuXG4gICAgfVxuXG5cbn1cblxuIl19