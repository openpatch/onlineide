import { openContextMenu, makeEditable } from "../tools/HtmlTools.js";
export class EmbeddedFileExplorer {
    constructor(moduleStore, $fileListDiv, main) {
        this.moduleStore = moduleStore;
        this.$fileListDiv = $fileListDiv;
        this.main = main;
        this.files = [];
        let that = this;
        for (let module of moduleStore.getModules(false)) {
            this.addModule(module);
        }
        let $filesDiv = $fileListDiv.parent();
        let $addButton = jQuery('<div class="joe_addFileButton jo_button img_add-dark jo_active" title="Datei hinzufügen"></div>');
        $filesDiv.append($addButton);
        $addButton.on("click", () => {
            let module = this.main.addModule({ text: "", title: "Neue Datei.java", type: "java" });
            let fileData = this.addModule(module);
            this.renameElement(fileData, () => {
                // if there's no file yet and then one is added and subsequently renamed: select it!
                if (that.currentFile != fileData) {
                    that.selectFile(fileData);
                }
            });
        });
    }
    removeAllFiles() {
        this.files.forEach(f => this.removeFile(f));
    }
    addHint(script) {
        let that = this;
        let $fileDiv = jQuery('<div class="jo_file jo_hint" ><div class="jo_fileimage"></div><div class="jo_filename" style="line-height: 22px">' +
            script.title + '</div><div class="jo_additionalButtons"></div></div></div>');
        this.$fileListDiv.append($fileDiv);
        let fileData = {
            module: null,
            $fileDiv: $fileDiv,
            type: "hint",
            hint: script.text
        };
        this.files.push(fileData);
        $fileDiv.on("click", (event) => {
            that.selectFile(fileData);
        });
    }
    addModule(module) {
        let that = this;
        let $fileDiv = jQuery(`<div class="jo_file jo_java" >
        <div class="jo_fileimage"></div>
        <div class="jo_filename" style="line-height: 22px">${module.file.name}</div>
        <div class="jo_additionalButtonStart"></div>
        <div class="jo_delete img_delete jo_button jo_active" title="Datei löschen"></div></div></div>`);
        this.$fileListDiv.append($fileDiv);
        let fileData = {
            module: module,
            $fileDiv: $fileDiv,
            type: "java"
        };
        this.files.push(fileData);
        module.file.panelElement = {
            name: module.file.name,
            $htmlFirstLine: $fileDiv
        };
        $fileDiv.find('.jo_delete').on("mousedown", (e) => {
            that.onDelete(fileData, e);
        });
        $fileDiv.find('.jo_delete').on("click", (e) => { e.preventDefault(); e.stopPropagation(); });
        $fileDiv.on("click", (event) => {
            that.selectFile(fileData);
        });
        $fileDiv[0].addEventListener("contextmenu", function (event) {
            event.preventDefault();
            openContextMenu([{
                    caption: "Umbenennen",
                    callback: () => {
                        that.renameElement(fileData, () => { });
                    }
                }], event.pageX, event.pageY);
        }, false);
        return fileData;
    }
    onDelete(fileData, ev) {
        ev.preventDefault();
        ev.stopPropagation();
        let that = this;
        openContextMenu([{
                caption: "Abbrechen",
                callback: () => {
                    // nothing to do.
                }
            }, {
                caption: "Ich bin mir sicher: löschen!",
                color: "#ff6060",
                callback: () => {
                    that.removeFile(fileData);
                }
            }], ev.pageX + 2, ev.pageY + 2);
    }
    removeFile(fileData) {
        fileData.$fileDiv.remove();
        this.main.removeModule(fileData.module);
        this.files = this.files.filter((fd) => fd != fileData);
        if (this.currentFile == fileData) {
            if (this.files.length > 0) {
                this.selectFile(this.files[0]);
            }
            else {
                this.main.getMonacoEditor().setValue("Keine Datei vorhanden.");
                this.main.getMonacoEditor().updateOptions({ readOnly: true });
            }
        }
        this.files.forEach((file) => {
            if (file.module != null) { // Hints have module == null
                file.module.file.saved = false;
            }
        });
    }
    removeModule(module) {
        for (let fileData of this.files) {
            if (fileData.module == module) {
                this.removeFile(fileData);
            }
        }
    }
    renameElement(fileData, callback) {
        let that = this;
        let $div = fileData.$fileDiv.find('.jo_filename');
        let pointPos = fileData.module.file.name.indexOf('.');
        let selection = pointPos == null ? null : { start: 0, end: pointPos };
        makeEditable($div, $div, (newText) => {
            fileData.module.file.name = newText;
            $div.html(newText);
            if (callback != null)
                callback();
        }, selection);
    }
    setFirstFileActive() {
        if (this.files.length > 0) {
            this.selectFile(this.files[0]);
        }
    }
    selectFile(fileData) {
        if (fileData == null)
            return;
        switch (fileData.type) {
            case "java":
                this.main.$hintDiv.hide();
                this.main.$monacoDiv.show();
                this.main.setModuleActive(fileData.module);
                this.main.getMonacoEditor().focus();
                break;
            case "hint":
                this.main.$monacoDiv.hide();
                this.main.$hintDiv.show();
                let syntaxMap = {};
                let code = [];
                //@ts-ignore
                let md1 = window.markdownit({
                    highlight: function (str, lang) {
                        code.push(str);
                        return "";
                    }
                });
                md1.renderer.rules.code_inline = function (tokens, idx, options, env, self) {
                    var token = tokens[idx];
                    code.push(token.content);
                    // pass token to default renderer.
                    return ""; //md1.renderer.rules.code_block(tokens, idx, options, env, self);
                };
                md1.render(fileData.hint);
                this.colorize(code, syntaxMap, () => {
                    //@ts-ignore
                    let md2 = window.markdownit({
                        highlight: function (str, lang) {
                            return syntaxMap[str];
                        }
                    });
                    md2.renderer.rules.code_inline = function (tokens, idx, options, env, self) {
                        var token = tokens[idx];
                        // pass token to default renderer.
                        return syntaxMap[token.content].replace("<br/>", "");
                    };
                    let html = md2.render(fileData.hint);
                    this.main.$hintDiv.html(html);
                });
                this.$fileListDiv.find('.jo_file').removeClass('jo_active');
                fileData.$fileDiv.addClass('jo_active');
                break;
        }
    }
    colorize(code, codeMap, callback) {
        let that = this;
        if (code.length > 0) {
            let uncoloredtext = code.pop();
            monaco.editor.colorize(uncoloredtext, 'myJava', { tabSize: 3 }).then((text) => {
                codeMap[uncoloredtext] = text;
                that.colorize(code, codeMap, callback);
            });
        }
        else {
            callback();
        }
    }
    markFile(module) {
        this.$fileListDiv.find('.jo_file').removeClass('jo_active');
        this.currentFile = this.files.find((fileData) => fileData.module == module);
        if (this.currentFile != null)
            this.currentFile.$fileDiv.addClass('jo_active');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW1iZWRkZWRGaWxlRXhwbG9yZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L2VtYmVkZGVkL0VtYmVkZGVkRmlsZUV4cGxvcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFVdEUsTUFBTSxPQUFPLG9CQUFvQjtJQUs3QixZQUFvQixXQUF3QixFQUFVLFlBQWlDLEVBQVUsSUFBa0I7UUFBL0YsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFjO1FBRm5ILFVBQUssR0FBZSxFQUFFLENBQUM7UUFJbkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWhCLEtBQUssSUFBSSxNQUFNLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUU5QyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBRTFCO1FBRUQsSUFBSSxTQUFTLEdBQUcsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3RDLElBQUksVUFBVSxHQUFHLE1BQU0sQ0FBQyxpR0FBaUcsQ0FBQyxDQUFDO1FBQzNILFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFN0IsVUFBVSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1lBRXhCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDdkYsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV0QyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7Z0JBQzlCLG9GQUFvRjtnQkFDcEYsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLFFBQVEsRUFBRTtvQkFDOUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDN0I7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBR1AsQ0FBQztJQUVELGNBQWM7UUFDVixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBR0QsT0FBTyxDQUFDLE1BQWdCO1FBQ3BCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsbUhBQW1IO1lBQ3JJLE1BQU0sQ0FBQyxLQUFLLEdBQUcsNERBQTRELENBQUMsQ0FBQztRQUNqRixJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVuQyxJQUFJLFFBQVEsR0FBYTtZQUNyQixNQUFNLEVBQUUsSUFBSTtZQUNaLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLElBQUksRUFBRSxNQUFNO1lBQ1osSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1NBQ3BCLENBQUM7UUFFRixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUxQixRQUFRLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBR0QsU0FBUyxDQUFDLE1BQWM7UUFDcEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksUUFBUSxHQUFHLE1BQU0sQ0FBQzs7NkRBRStCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSTs7dUdBRTBCLENBQUMsQ0FBQztRQUNqRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVuQyxJQUFJLFFBQVEsR0FBYTtZQUNyQixNQUFNLEVBQUUsTUFBTTtZQUNkLFFBQVEsRUFBRSxRQUFRO1lBQ2xCLElBQUksRUFBRSxNQUFNO1NBQ2YsQ0FBQztRQUVGLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHO1lBQ3ZCLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUk7WUFDdEIsY0FBYyxFQUFFLFFBQVE7U0FDM0IsQ0FBQTtRQUVELFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQXdCLEVBQUUsRUFBRTtZQUNyRSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUMsQ0FBQTtRQUVGLFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFNUYsUUFBUSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO1FBRUgsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxVQUFVLEtBQUs7WUFDdkQsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLGVBQWUsQ0FBQyxDQUFDO29CQUNiLE9BQU8sRUFBRSxZQUFZO29CQUNyQixRQUFRLEVBQUUsR0FBRyxFQUFFO3dCQUNYLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUM1QyxDQUFDO2lCQUNKLENBQUMsRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFVixPQUFPLFFBQVEsQ0FBQztJQUVwQixDQUFDO0lBRUQsUUFBUSxDQUFDLFFBQWtCLEVBQUUsRUFBeUI7UUFDbEQsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3BCLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUNyQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsZUFBZSxDQUFDLENBQUM7Z0JBQ2IsT0FBTyxFQUFFLFdBQVc7Z0JBQ3BCLFFBQVEsRUFBRSxHQUFHLEVBQUU7b0JBQ1gsaUJBQWlCO2dCQUNyQixDQUFDO2FBQ0osRUFBRTtnQkFDQyxPQUFPLEVBQUUsOEJBQThCO2dCQUN2QyxLQUFLLEVBQUUsU0FBUztnQkFDaEIsUUFBUSxFQUFFLEdBQUcsRUFBRTtvQkFDWCxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUM5QixDQUFDO2FBQ0osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFFcEMsQ0FBQztJQUVELFVBQVUsQ0FBQyxRQUFrQjtRQUN6QixRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLElBQUksUUFBUSxDQUFDLENBQUM7UUFDdkQsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLFFBQVEsRUFBRTtZQUM5QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDbEM7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLENBQUMsd0JBQXdCLENBQUMsQ0FBQztnQkFDL0QsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxhQUFhLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUNqRTtTQUNKO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUN4QixJQUFHLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxFQUFDLEVBQWlCLDRCQUE0QjtnQkFDaEUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQzthQUNsQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFlBQVksQ0FBQyxNQUFjO1FBQ3ZCLEtBQUssSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUM3QixJQUFJLFFBQVEsQ0FBQyxNQUFNLElBQUksTUFBTSxFQUFFO2dCQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzdCO1NBQ0o7SUFDTCxDQUFDO0lBRUQsYUFBYSxDQUFDLFFBQWtCLEVBQUUsUUFBb0I7UUFDbEQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2xELElBQUksUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEQsSUFBSSxTQUFTLEdBQUcsUUFBUSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxDQUFDO1FBQ3RFLFlBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUU7WUFDekMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztZQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25CLElBQUksUUFBUSxJQUFJLElBQUk7Z0JBQUUsUUFBUSxFQUFFLENBQUM7UUFDckMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRWxCLENBQUM7SUFHRCxrQkFBa0I7UUFDZCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNsQztJQUNMLENBQUM7SUFFRCxVQUFVLENBQUMsUUFBa0I7UUFDekIsSUFBSSxRQUFRLElBQUksSUFBSTtZQUFFLE9BQU87UUFDN0IsUUFBUSxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ25CLEtBQUssTUFBTTtnQkFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDcEMsTUFBTTtZQUNWLEtBQUssTUFBTTtnQkFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBRTFCLElBQUksU0FBUyxHQUErQixFQUFFLENBQUM7Z0JBQy9DLElBQUksSUFBSSxHQUFhLEVBQUUsQ0FBQztnQkFFeEIsWUFBWTtnQkFDWixJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDO29CQUN4QixTQUFTLEVBQUUsVUFBVSxHQUFHLEVBQUUsSUFBSTt3QkFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDZixPQUFPLEVBQUUsQ0FBQztvQkFDZCxDQUFDO2lCQUNKLENBQUMsQ0FBQztnQkFFSCxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxXQUFXLEdBQUcsVUFBVSxNQUFNLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSTtvQkFDdEUsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDekIsa0NBQWtDO29CQUNsQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLGlFQUFpRTtnQkFDaEYsQ0FBQyxDQUFDO2dCQUVGLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUUxQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFO29CQUNoQyxZQUFZO29CQUNaLElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7d0JBQ3hCLFNBQVMsRUFBRSxVQUFVLEdBQUcsRUFBRSxJQUFJOzRCQUMxQixPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDMUIsQ0FBQztxQkFDSixDQUFDLENBQUM7b0JBRUgsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxHQUFHLFVBQVUsTUFBTSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUk7d0JBQ3RFLElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDeEIsa0NBQWtDO3dCQUNsQyxPQUFPLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDekQsQ0FBQyxDQUFDO29CQUdGLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2xDLENBQUMsQ0FBQyxDQUFDO2dCQUNILElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDNUQsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3hDLE1BQU07U0FDYjtJQUNMLENBQUM7SUFFRCxRQUFRLENBQUMsSUFBYyxFQUFFLE9BQW1DLEVBQUUsUUFBb0I7UUFDOUUsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDakIsSUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDMUUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQztnQkFDOUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzNDLENBQUMsQ0FDQSxDQUFDO1NBQ0w7YUFBTTtZQUNILFFBQVEsRUFBRSxDQUFDO1NBQ2Q7SUFFTCxDQUFDO0lBR0QsUUFBUSxDQUFDLE1BQWM7UUFDbkIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRTVELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLENBQUM7UUFFNUUsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUk7WUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7SUFFbEYsQ0FBQztDQUlKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kdWxlLCBNb2R1bGVTdG9yZSB9IGZyb20gXCIuLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IE1haW5FbWJlZGRlZCB9IGZyb20gXCIuL01haW5FbWJlZGRlZC5qc1wiO1xyXG5pbXBvcnQgeyBvcGVuQ29udGV4dE1lbnUsIG1ha2VFZGl0YWJsZSB9IGZyb20gXCIuLi90b29scy9IdG1sVG9vbHMuanNcIjtcclxuaW1wb3J0IHsgSk9TY3JpcHQsIFNjcmlwdFR5cGUgfSBmcm9tIFwiLi9FbWJlZGRlZFN0YXJ0ZXIuanNcIjtcclxuXHJcbnR5cGUgRmlsZURhdGEgPSB7XHJcbiAgICB0eXBlOiBTY3JpcHRUeXBlLFxyXG4gICAgbW9kdWxlPzogTW9kdWxlLFxyXG4gICAgaGludD86IHN0cmluZyxcclxuICAgICRmaWxlRGl2OiBKUXVlcnk8SFRNTEVsZW1lbnQ+XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBFbWJlZGRlZEZpbGVFeHBsb3JlciB7XHJcblxyXG4gICAgY3VycmVudEZpbGU6IEZpbGVEYXRhO1xyXG4gICAgZmlsZXM6IEZpbGVEYXRhW10gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZSwgcHJpdmF0ZSAkZmlsZUxpc3REaXY6IEpRdWVyeTxIVE1MRWxlbWVudD4sIHByaXZhdGUgbWFpbjogTWFpbkVtYmVkZGVkKSB7XHJcblxyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuXHJcbiAgICAgICAgZm9yIChsZXQgbW9kdWxlIG9mIG1vZHVsZVN0b3JlLmdldE1vZHVsZXMoZmFsc2UpKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmFkZE1vZHVsZShtb2R1bGUpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCAkZmlsZXNEaXYgPSAkZmlsZUxpc3REaXYucGFyZW50KCk7XHJcbiAgICAgICAgbGV0ICRhZGRCdXR0b24gPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb2VfYWRkRmlsZUJ1dHRvbiBqb19idXR0b24gaW1nX2FkZC1kYXJrIGpvX2FjdGl2ZVwiIHRpdGxlPVwiRGF0ZWkgaGluenVmw7xnZW5cIj48L2Rpdj4nKTtcclxuICAgICAgICAkZmlsZXNEaXYuYXBwZW5kKCRhZGRCdXR0b24pO1xyXG5cclxuICAgICAgICAkYWRkQnV0dG9uLm9uKFwiY2xpY2tcIiwgKCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgbGV0IG1vZHVsZSA9IHRoaXMubWFpbi5hZGRNb2R1bGUoeyB0ZXh0OiBcIlwiLCB0aXRsZTogXCJOZXVlIERhdGVpLmphdmFcIiwgdHlwZTogXCJqYXZhXCIgfSk7XHJcbiAgICAgICAgICAgIGxldCBmaWxlRGF0YSA9IHRoaXMuYWRkTW9kdWxlKG1vZHVsZSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlbmFtZUVsZW1lbnQoZmlsZURhdGEsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlJ3Mgbm8gZmlsZSB5ZXQgYW5kIHRoZW4gb25lIGlzIGFkZGVkIGFuZCBzdWJzZXF1ZW50bHkgcmVuYW1lZDogc2VsZWN0IGl0IVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoYXQuY3VycmVudEZpbGUgIT0gZmlsZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGF0LnNlbGVjdEZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUFsbEZpbGVzKCkge1xyXG4gICAgICAgIHRoaXMuZmlsZXMuZm9yRWFjaChmID0+IHRoaXMucmVtb3ZlRmlsZShmKSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGFkZEhpbnQoc2NyaXB0OiBKT1NjcmlwdCk6IHZvaWQge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBsZXQgJGZpbGVEaXYgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19maWxlIGpvX2hpbnRcIiA+PGRpdiBjbGFzcz1cImpvX2ZpbGVpbWFnZVwiPjwvZGl2PjxkaXYgY2xhc3M9XCJqb19maWxlbmFtZVwiIHN0eWxlPVwibGluZS1oZWlnaHQ6IDIycHhcIj4nICtcclxuICAgICAgICAgICAgc2NyaXB0LnRpdGxlICsgJzwvZGl2PjxkaXYgY2xhc3M9XCJqb19hZGRpdGlvbmFsQnV0dG9uc1wiPjwvZGl2PjwvZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIHRoaXMuJGZpbGVMaXN0RGl2LmFwcGVuZCgkZmlsZURpdik7XHJcblxyXG4gICAgICAgIGxldCBmaWxlRGF0YTogRmlsZURhdGEgPSB7XHJcbiAgICAgICAgICAgIG1vZHVsZTogbnVsbCxcclxuICAgICAgICAgICAgJGZpbGVEaXY6ICRmaWxlRGl2LFxyXG4gICAgICAgICAgICB0eXBlOiBcImhpbnRcIixcclxuICAgICAgICAgICAgaGludDogc2NyaXB0LnRleHRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmZpbGVzLnB1c2goZmlsZURhdGEpO1xyXG5cclxuICAgICAgICAkZmlsZURpdi5vbihcImNsaWNrXCIsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICB0aGF0LnNlbGVjdEZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgYWRkTW9kdWxlKG1vZHVsZTogTW9kdWxlKTogRmlsZURhdGEge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBsZXQgJGZpbGVEaXYgPSBqUXVlcnkoYDxkaXYgY2xhc3M9XCJqb19maWxlIGpvX2phdmFcIiA+XHJcbiAgICAgICAgPGRpdiBjbGFzcz1cImpvX2ZpbGVpbWFnZVwiPjwvZGl2PlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJqb19maWxlbmFtZVwiIHN0eWxlPVwibGluZS1oZWlnaHQ6IDIycHhcIj4ke21vZHVsZS5maWxlLm5hbWV9PC9kaXY+XHJcbiAgICAgICAgPGRpdiBjbGFzcz1cImpvX2FkZGl0aW9uYWxCdXR0b25TdGFydFwiPjwvZGl2PlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJqb19kZWxldGUgaW1nX2RlbGV0ZSBqb19idXR0b24gam9fYWN0aXZlXCIgdGl0bGU9XCJEYXRlaSBsw7ZzY2hlblwiPjwvZGl2PjwvZGl2PjwvZGl2PmApO1xyXG4gICAgICAgIHRoaXMuJGZpbGVMaXN0RGl2LmFwcGVuZCgkZmlsZURpdik7XHJcblxyXG4gICAgICAgIGxldCBmaWxlRGF0YTogRmlsZURhdGEgPSB7XHJcbiAgICAgICAgICAgIG1vZHVsZTogbW9kdWxlLFxyXG4gICAgICAgICAgICAkZmlsZURpdjogJGZpbGVEaXYsXHJcbiAgICAgICAgICAgIHR5cGU6IFwiamF2YVwiXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5maWxlcy5wdXNoKGZpbGVEYXRhKTtcclxuXHJcbiAgICAgICAgbW9kdWxlLmZpbGUucGFuZWxFbGVtZW50ID0ge1xyXG4gICAgICAgICAgICBuYW1lOiBtb2R1bGUuZmlsZS5uYW1lLFxyXG4gICAgICAgICAgICAkaHRtbEZpcnN0TGluZTogJGZpbGVEaXZcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgICRmaWxlRGl2LmZpbmQoJy5qb19kZWxldGUnKS5vbihcIm1vdXNlZG93blwiLCAoZTogSlF1ZXJ5Lk1vdXNlRG93bkV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIHRoYXQub25EZWxldGUoZmlsZURhdGEsIGUpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgICRmaWxlRGl2LmZpbmQoJy5qb19kZWxldGUnKS5vbihcImNsaWNrXCIsIChlKSA9PiB7IGUucHJldmVudERlZmF1bHQoKTsgZS5zdG9wUHJvcGFnYXRpb24oKSB9KTtcclxuXHJcbiAgICAgICAgJGZpbGVEaXYub24oXCJjbGlja1wiLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgdGhhdC5zZWxlY3RGaWxlKGZpbGVEYXRhKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJGZpbGVEaXZbMF0uYWRkRXZlbnRMaXN0ZW5lcihcImNvbnRleHRtZW51XCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICBvcGVuQ29udGV4dE1lbnUoW3tcclxuICAgICAgICAgICAgICAgIGNhcHRpb246IFwiVW1iZW5lbm5lblwiLFxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGF0LnJlbmFtZUVsZW1lbnQoZmlsZURhdGEsICgpID0+IHsgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1dLCBldmVudC5wYWdlWCwgZXZlbnQucGFnZVkpO1xyXG4gICAgICAgIH0sIGZhbHNlKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGZpbGVEYXRhO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBvbkRlbGV0ZShmaWxlRGF0YTogRmlsZURhdGEsIGV2OiBKUXVlcnkuTW91c2VEb3duRXZlbnQpIHtcclxuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBvcGVuQ29udGV4dE1lbnUoW3tcclxuICAgICAgICAgICAgY2FwdGlvbjogXCJBYmJyZWNoZW5cIixcclxuICAgICAgICAgICAgY2FsbGJhY2s6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIG5vdGhpbmcgdG8gZG8uXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIGNhcHRpb246IFwiSWNoIGJpbiBtaXIgc2ljaGVyOiBsw7ZzY2hlbiFcIixcclxuICAgICAgICAgICAgY29sb3I6IFwiI2ZmNjA2MFwiLFxyXG4gICAgICAgICAgICBjYWxsYmFjazogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhhdC5yZW1vdmVGaWxlKGZpbGVEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1dLCBldi5wYWdlWCArIDIsIGV2LnBhZ2VZICsgMik7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUZpbGUoZmlsZURhdGE6IEZpbGVEYXRhKSB7XHJcbiAgICAgICAgZmlsZURhdGEuJGZpbGVEaXYucmVtb3ZlKCk7XHJcbiAgICAgICAgdGhpcy5tYWluLnJlbW92ZU1vZHVsZShmaWxlRGF0YS5tb2R1bGUpO1xyXG4gICAgICAgIHRoaXMuZmlsZXMgPSB0aGlzLmZpbGVzLmZpbHRlcigoZmQpID0+IGZkICE9IGZpbGVEYXRhKTtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50RmlsZSA9PSBmaWxlRGF0YSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5maWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEZpbGUodGhpcy5maWxlc1swXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1haW4uZ2V0TW9uYWNvRWRpdG9yKCkuc2V0VmFsdWUoXCJLZWluZSBEYXRlaSB2b3JoYW5kZW4uXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYWluLmdldE1vbmFjb0VkaXRvcigpLnVwZGF0ZU9wdGlvbnMoeyByZWFkT25seTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5maWxlcy5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKGZpbGUubW9kdWxlICE9IG51bGwpeyAgICAgICAgICAgICAgICAvLyBIaW50cyBoYXZlIG1vZHVsZSA9PSBudWxsXHJcbiAgICAgICAgICAgICAgICBmaWxlLm1vZHVsZS5maWxlLnNhdmVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVNb2R1bGUobW9kdWxlOiBNb2R1bGUpIHtcclxuICAgICAgICBmb3IgKGxldCBmaWxlRGF0YSBvZiB0aGlzLmZpbGVzKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWxlRGF0YS5tb2R1bGUgPT0gbW9kdWxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbmFtZUVsZW1lbnQoZmlsZURhdGE6IEZpbGVEYXRhLCBjYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBsZXQgJGRpdiA9IGZpbGVEYXRhLiRmaWxlRGl2LmZpbmQoJy5qb19maWxlbmFtZScpO1xyXG4gICAgICAgIGxldCBwb2ludFBvcyA9IGZpbGVEYXRhLm1vZHVsZS5maWxlLm5hbWUuaW5kZXhPZignLicpO1xyXG4gICAgICAgIGxldCBzZWxlY3Rpb24gPSBwb2ludFBvcyA9PSBudWxsID8gbnVsbCA6IHsgc3RhcnQ6IDAsIGVuZDogcG9pbnRQb3MgfTtcclxuICAgICAgICBtYWtlRWRpdGFibGUoJGRpdiwgJGRpdiwgKG5ld1RleHQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICBmaWxlRGF0YS5tb2R1bGUuZmlsZS5uYW1lID0gbmV3VGV4dDtcclxuICAgICAgICAgICAgJGRpdi5odG1sKG5ld1RleHQpO1xyXG4gICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT0gbnVsbCkgY2FsbGJhY2soKTtcclxuICAgICAgICB9LCBzZWxlY3Rpb24pO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgc2V0Rmlyc3RGaWxlQWN0aXZlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZpbGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RGaWxlKHRoaXMuZmlsZXNbMF0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RGaWxlKGZpbGVEYXRhOiBGaWxlRGF0YSkge1xyXG4gICAgICAgIGlmIChmaWxlRGF0YSA9PSBudWxsKSByZXR1cm47XHJcbiAgICAgICAgc3dpdGNoIChmaWxlRGF0YS50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgXCJqYXZhXCI6XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1haW4uJGhpbnREaXYuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYWluLiRtb25hY29EaXYuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYWluLnNldE1vZHVsZUFjdGl2ZShmaWxlRGF0YS5tb2R1bGUpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYWluLmdldE1vbmFjb0VkaXRvcigpLmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcImhpbnRcIjpcclxuICAgICAgICAgICAgICAgIHRoaXMubWFpbi4kbW9uYWNvRGl2LmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFpbi4kaGludERpdi5zaG93KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHN5bnRheE1hcDogeyBbY29kZTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcclxuICAgICAgICAgICAgICAgIGxldCBjb2RlOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgbGV0IG1kMSA9IHdpbmRvdy5tYXJrZG93bml0KHtcclxuICAgICAgICAgICAgICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uIChzdHIsIGxhbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZS5wdXNoKHN0cik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIG1kMS5yZW5kZXJlci5ydWxlcy5jb2RlX2lubGluZSA9IGZ1bmN0aW9uICh0b2tlbnMsIGlkeCwgb3B0aW9ucywgZW52LCBzZWxmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zW2lkeF07XHJcbiAgICAgICAgICAgICAgICAgICAgY29kZS5wdXNoKHRva2VuLmNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHBhc3MgdG9rZW4gdG8gZGVmYXVsdCByZW5kZXJlci5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJcIjsgLy9tZDEucmVuZGVyZXIucnVsZXMuY29kZV9ibG9jayh0b2tlbnMsIGlkeCwgb3B0aW9ucywgZW52LCBzZWxmKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgbWQxLnJlbmRlcihmaWxlRGF0YS5oaW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yaXplKGNvZGUsIHN5bnRheE1hcCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBtZDIgPSB3aW5kb3cubWFya2Rvd25pdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodDogZnVuY3Rpb24gKHN0ciwgbGFuZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bnRheE1hcFtzdHJdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIG1kMi5yZW5kZXJlci5ydWxlcy5jb2RlX2lubGluZSA9IGZ1bmN0aW9uICh0b2tlbnMsIGlkeCwgb3B0aW9ucywgZW52LCBzZWxmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2Vuc1tpZHhdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBwYXNzIHRva2VuIHRvIGRlZmF1bHQgcmVuZGVyZXIuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50YXhNYXBbdG9rZW4uY29udGVudF0ucmVwbGFjZShcIjxici8+XCIsIFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgaHRtbCA9IG1kMi5yZW5kZXIoZmlsZURhdGEuaGludCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYWluLiRoaW50RGl2Lmh0bWwoaHRtbCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuJGZpbGVMaXN0RGl2LmZpbmQoJy5qb19maWxlJykucmVtb3ZlQ2xhc3MoJ2pvX2FjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgZmlsZURhdGEuJGZpbGVEaXYuYWRkQ2xhc3MoJ2pvX2FjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbG9yaXplKGNvZGU6IHN0cmluZ1tdLCBjb2RlTWFwOiB7IFtjb2RlOiBzdHJpbmddOiBzdHJpbmcgfSwgY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgaWYgKGNvZGUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBsZXQgdW5jb2xvcmVkdGV4dCA9IGNvZGUucG9wKCk7XHJcbiAgICAgICAgICAgIG1vbmFjby5lZGl0b3IuY29sb3JpemUodW5jb2xvcmVkdGV4dCwgJ215SmF2YScsIHsgdGFiU2l6ZTogMyB9KS50aGVuKCh0ZXh0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb2RlTWFwW3VuY29sb3JlZHRleHRdID0gdGV4dDtcclxuICAgICAgICAgICAgICAgIHRoYXQuY29sb3JpemUoY29kZSwgY29kZU1hcCwgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBtYXJrRmlsZShtb2R1bGU6IE1vZHVsZSkge1xyXG4gICAgICAgIHRoaXMuJGZpbGVMaXN0RGl2LmZpbmQoJy5qb19maWxlJykucmVtb3ZlQ2xhc3MoJ2pvX2FjdGl2ZScpO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRGaWxlID0gdGhpcy5maWxlcy5maW5kKChmaWxlRGF0YSkgPT4gZmlsZURhdGEubW9kdWxlID09IG1vZHVsZSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWxlICE9IG51bGwpIHRoaXMuY3VycmVudEZpbGUuJGZpbGVEaXYuYWRkQ2xhc3MoJ2pvX2FjdGl2ZScpO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG5cclxufSJdfQ==