import { stringPrimitiveType } from "../compiler/types/PrimitiveTypes.js";
import { ArrayType } from "../compiler/types/Array.js";
import { Klass, Visibility, StaticClass, Interface } from "../compiler/types/Class.js";
import { Enum } from "../compiler/types/Enum.js";
import { RuntimeObject } from "./RuntimeObject.js";
export class DebuggerElement {
    constructor(caption, parent, identifier, value, type, variable) {
        this.children = [];
        this.isOpen = false;
        this.caption = caption;
        this.parent = parent;
        if (parent != null) {
            parent.children.push(this);
        }
        this.value = value;
        this.type = type;
        this.variable = variable;
        this.identifier = identifier;
    }
    getLevel() {
        return this.parent == null ? 0 : this.parent.getLevel() + 1;
    }
    getIndent() {
        // return this.getLevel() * 15;
        return this.getLevel() == 0 ? 0 : 15;
    }
    render() {
        if (this.$debuggerElement == null) {
            this.$debuggerElement = jQuery('<div>');
            this.$debuggerElement.addClass("jo_debuggerElement");
            this.$debuggerElement.css('margin-left', '' + this.getIndent() + 'px');
            let $deFirstLine = jQuery('<div class="jo_deFirstline"><span class="jo_deIdentifier">' +
                this.identifier + '</span>:&nbsp;<span class="jo_deValue"></span></div>');
            this.$debuggerElement.append($deFirstLine);
            // show compound types in own branch of visible tree
            if (this.type instanceof ArrayType ||
                (this.type instanceof Klass && !(this.type instanceof Enum) && !(this.type == stringPrimitiveType))
                || this.type instanceof StaticClass
                || this.type instanceof Interface) {
                this.canOpen = true;
                this.$debuggerElement.addClass('jo_canOpen');
                this.$debuggerElement.append(jQuery('<div class="jo_deChildContainer"></div>'));
                this.$debuggerElement.find('.jo_deFirstline').on('mousedown', (event) => {
                    if (this.value != null && this.value.value != null) {
                        if (this.children.length == 0) {
                            this.onFirstOpening();
                        }
                        this.$debuggerElement.toggleClass('jo_expanded');
                        this.isOpen = !this.isOpen;
                    }
                    else {
                        this.children = [];
                    }
                    event.stopPropagation();
                });
            }
        }
        this.renderValue();
    }
    onFirstOpening() {
        this.children = [];
        if (this.type instanceof Klass) {
            let ro = this.value.value;
            let listHelper = ro.intrinsicData == null ? null : ro.intrinsicData["ListHelper"];
            if (listHelper != null) {
                this.renderListElements(listHelper);
            }
            else {
                for (let a of this.value.type.getAttributes(Visibility.private)) {
                    let de = new DebuggerElement(null, this, a.identifier, ro.getValue(a.index), a.type, null);
                    de.render();
                    this.$debuggerElement.find('.jo_deChildContainer').append(de.$debuggerElement);
                }
            }
        }
        else if (this.type instanceof ArrayType) {
            let a = this.value.value;
            let $childContainer = this.$debuggerElement.find('.jo_deChildContainer');
            for (let i = 0; i < a.length && i < 100; i++) {
                let de = new DebuggerElement(null, this, "[" + i + "]", a[i], this.type.arrayOfType, null);
                de.render();
                $childContainer.append(de.$debuggerElement);
            }
        }
        else if (this.type instanceof StaticClass) {
            for (let a of this.type.getAttributes(Visibility.private)) {
                let ro = this.type.classObject;
                let de = new DebuggerElement(null, this, a.identifier, ro.getValue(a.index), a.type, null);
                de.render();
                this.$debuggerElement.find('.jo_deChildContainer').append(de.$debuggerElement);
            }
        }
        else if (this.type instanceof Interface) {
            if (this.value.value != null && this.value.value instanceof RuntimeObject) {
                let ro = this.value.value;
                for (let a of ro.class.getAttributes(Visibility.private)) {
                    let de = new DebuggerElement(null, this, a.identifier, ro.getValue(a.index), a.type, null);
                    de.render();
                    this.$debuggerElement.find('.jo_deChildContainer').append(de.$debuggerElement);
                }
            }
            else {
                this.children == [];
            }
        }
    }
    renderListElements(listHelper) {
        let valueArray = listHelper.valueArray;
        if (this.children.length > valueArray.length) {
            for (let i = valueArray.length; i < this.children.length; i++) {
                let childElement = this.children[i];
                childElement.$debuggerElement.remove();
            }
            this.children.splice(valueArray.length);
        }
        if (this.children.length < valueArray.length && this.children.length < 100) {
            for (let i = this.children.length; i < valueArray.length && i <= 100; i++) {
                let v = valueArray[i];
                let title = "" + i;
                if (i == 100) {
                    v = { type: stringPrimitiveType, value: "" + (listHelper.valueArray.length - 100) + " weitere..." };
                    title = "...";
                }
                let de = new DebuggerElement(null, this, title, v, v.type, null);
                de.render();
                this.$debuggerElement.find('.jo_deChildContainer').first().append(de.$debuggerElement);
            }
        }
    }
    renderValue() {
        let s;
        let v = this.value;
        if (v == null) {
            this.$debuggerElement.hide();
            return;
        }
        this.$debuggerElement.show();
        if (v.value == null) {
            s = "null";
            this.removeAllChildren();
        }
        else {
            if (v.updateValue != null) {
                v.updateValue(v);
            }
            s = v.type.debugOutput(v);
            if (this.type instanceof Klass) {
                let ro = this.value.value;
                let listHelper = ro.intrinsicData == null ? null : ro.intrinsicData["ListHelper"];
                if (listHelper != null) {
                    this.renderListElements(listHelper);
                    if (listHelper.allElementsPrimitive()) {
                        s = "" + listHelper.valueArray.length + " El: ";
                        s += "[" + listHelper.objectArray.slice(0, 20).map(o => "" + o).join(", ") + "]";
                    }
                    else {
                        s = v.type.identifier + " (" + listHelper.valueArray.length + " Elemente)";
                    }
                }
            }
        }
        this.$debuggerElement.find('.jo_deValue').first().html(s);
        for (let child of this.children) {
            child.renderValue();
        }
    }
    removeAllChildren() {
        for (let de of this.children) {
            de.$debuggerElement.remove();
        }
        this.children = [];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdnZXJFbGVtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9pbnRlcnByZXRlci9EZWJ1Z2dlckVsZW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR25ELE1BQU0sT0FBTyxlQUFlO0lBbUJ4QixZQUFZLE9BQWUsRUFBRSxNQUF1QixFQUFFLFVBQWtCLEVBQUUsS0FBWSxFQUFFLElBQVUsRUFBRSxRQUFrQjtRQWJ0SCxhQUFRLEdBQXNCLEVBQUUsQ0FBQztRQUdqQyxXQUFNLEdBQVksS0FBSyxDQUFDO1FBV3BCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksTUFBTSxJQUFJLElBQUksRUFBRTtZQUNoQixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQ2pDLENBQUM7SUFFRCxRQUFRO1FBQ0osT0FBTyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FB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QztRQUcxRCxLQUFLLElBQUksS0FBSyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDN0IsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3ZCO0lBQ0wsQ0FBQztJQUVELGlCQUFpQjtRQUNiLEtBQUssSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUMxQixFQUFFLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDaEM7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQTtJQUN0QixDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWYWx1ZSwgVHlwZSwgVmFyaWFibGUgfSBmcm9tIFwiLi4vY29tcGlsZXIvdHlwZXMvVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgc3RyaW5nUHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBBcnJheVR5cGUgfSBmcm9tIFwiLi4vY29tcGlsZXIvdHlwZXMvQXJyYXkuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MsIFZpc2liaWxpdHksIFN0YXRpY0NsYXNzLCBJbnRlcmZhY2UgfSBmcm9tIFwiLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgRW51bSB9IGZyb20gXCIuLi9jb21waWxlci90eXBlcy9FbnVtLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi9SdW50aW1lT2JqZWN0LmpzXCI7XHJcbmltcG9ydCB7IExpc3RIZWxwZXIgfSBmcm9tIFwiLi4vcnVudGltZWxpYnJhcnkvY29sbGVjdGlvbnMvQXJyYXlMaXN0LmpzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRGVidWdnZXJFbGVtZW50IHtcclxuXHJcbiAgICBjYXB0aW9uOiBzdHJpbmc7IC8vIG9ubHkgdXNlZCBmb3Igcm9vdCBlbGVtZW50cywgZS5nLiBcIkxvY2FsIHZhcmlhYmxlc1wiXHJcbiAgICAvLyBpZiBjYXB0aW9uIGlzIHNldCB0aGVuIHZhbHVlID09IG51bGwgYW5kIHBhcmVudCA9PSBudWxsXHJcblxyXG4gICAgcGFyZW50OiBEZWJ1Z2dlckVsZW1lbnQ7XHJcbiAgICBjaGlsZHJlbjogRGVidWdnZXJFbGVtZW50W10gPSBbXTtcclxuXHJcbiAgICBjYW5PcGVuOiBib29sZWFuO1xyXG4gICAgaXNPcGVuOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgdmFsdWU6IFZhbHVlO1xyXG4gICAgdmFyaWFibGU6IFZhcmlhYmxlO1xyXG5cclxuICAgIHR5cGU6IFR5cGU7XHJcbiAgICBpZGVudGlmaWVyOiBzdHJpbmc7XHJcblxyXG4gICAgJGRlYnVnZ2VyRWxlbWVudDogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihjYXB0aW9uOiBzdHJpbmcsIHBhcmVudDogRGVidWdnZXJFbGVtZW50LCBpZGVudGlmaWVyOiBzdHJpbmcsIHZhbHVlOiBWYWx1ZSwgdHlwZTogVHlwZSwgdmFyaWFibGU6IFZhcmlhYmxlKSB7XHJcbiAgICAgICAgdGhpcy5jYXB0aW9uID0gY2FwdGlvbjtcclxuICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDtcclxuICAgICAgICBpZiAocGFyZW50ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2godGhpcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICB0aGlzLnR5cGUgPSB0eXBlO1xyXG4gICAgICAgIHRoaXMudmFyaWFibGUgPSB2YXJpYWJsZTtcclxuICAgICAgICB0aGlzLmlkZW50aWZpZXIgPSBpZGVudGlmaWVyO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExldmVsKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50ID09IG51bGwgPyAwIDogdGhpcy5wYXJlbnQuZ2V0TGV2ZWwoKSArIDE7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0SW5kZW50KCk6IG51bWJlciB7XHJcbiAgICAgICAgLy8gcmV0dXJuIHRoaXMuZ2V0TGV2ZWwoKSAqIDE1O1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldExldmVsKCkgPT0gMCA/IDAgOiAxNTtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoKSB7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLiRkZWJ1Z2dlckVsZW1lbnQgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQgPSBqUXVlcnkoJzxkaXY+Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5hZGRDbGFzcyhcImpvX2RlYnVnZ2VyRWxlbWVudFwiKTtcclxuICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmNzcygnbWFyZ2luLWxlZnQnLCAnJyArIHRoaXMuZ2V0SW5kZW50KCkgKyAncHgnKTtcclxuXHJcbiAgICAgICAgICAgIGxldCAkZGVGaXJzdExpbmUgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19kZUZpcnN0bGluZVwiPjxzcGFuIGNsYXNzPVwiam9fZGVJZGVudGlmaWVyXCI+JyArXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlkZW50aWZpZXIgKyAnPC9zcGFuPjombmJzcDs8c3BhbiBjbGFzcz1cImpvX2RlVmFsdWVcIj48L3NwYW4+PC9kaXY+Jyk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuYXBwZW5kKCRkZUZpcnN0TGluZSk7XHJcblxyXG4gICAgICAgICAgICAvLyBzaG93IGNvbXBvdW5kIHR5cGVzIGluIG93biBicmFuY2ggb2YgdmlzaWJsZSB0cmVlXHJcbiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgaW5zdGFuY2VvZiBBcnJheVR5cGUgfHxcclxuICAgICAgICAgICAgICAgICh0aGlzLnR5cGUgaW5zdGFuY2VvZiBLbGFzcyAmJiAhKHRoaXMudHlwZSBpbnN0YW5jZW9mIEVudW0pICYmICEodGhpcy50eXBlID09IHN0cmluZ1ByaW1pdGl2ZVR5cGUpKVxyXG4gICAgICAgICAgICAgICAgfHwgdGhpcy50eXBlIGluc3RhbmNlb2YgU3RhdGljQ2xhc3NcclxuICAgICAgICAgICAgICAgIHx8IHRoaXMudHlwZSBpbnN0YW5jZW9mIEludGVyZmFjZVxyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2FuT3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuYWRkQ2xhc3MoJ2pvX2Nhbk9wZW4nKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5hcHBlbmQoalF1ZXJ5KCc8ZGl2IGNsYXNzPVwiam9fZGVDaGlsZENvbnRhaW5lclwiPjwvZGl2PicpKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuZmluZCgnLmpvX2RlRmlyc3RsaW5lJykub24oJ21vdXNlZG93bicsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhbHVlICE9IG51bGwgJiYgdGhpcy52YWx1ZS52YWx1ZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uRmlyc3RPcGVuaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LnRvZ2dsZUNsYXNzKCdqb19leHBhbmRlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlzT3BlbiA9ICF0aGlzLmlzT3BlbjtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucmVuZGVyVmFsdWUoKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgb25GaXJzdE9wZW5pbmcoKSB7XHJcblxyXG4gICAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMudHlwZSBpbnN0YW5jZW9mIEtsYXNzKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQgcm86IFJ1bnRpbWVPYmplY3QgPSB0aGlzLnZhbHVlLnZhbHVlO1xyXG4gICAgICAgICAgICBsZXQgbGlzdEhlbHBlcjogTGlzdEhlbHBlciA9IHJvLmludHJpbnNpY0RhdGEgPT0gbnVsbCA/IG51bGwgOiByby5pbnRyaW5zaWNEYXRhW1wiTGlzdEhlbHBlclwiXTtcclxuICAgICAgICAgICAgaWYgKGxpc3RIZWxwZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJMaXN0RWxlbWVudHMobGlzdEhlbHBlcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBhIG9mICg8S2xhc3M+dGhpcy52YWx1ZS50eXBlKS5nZXRBdHRyaWJ1dGVzKFZpc2liaWxpdHkucHJpdmF0ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZGUgPSBuZXcgRGVidWdnZXJFbGVtZW50KG51bGwsIHRoaXMsIGEuaWRlbnRpZmllciwgcm8uZ2V0VmFsdWUoYS5pbmRleCksIGEudHlwZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGUucmVuZGVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmZpbmQoJy5qb19kZUNoaWxkQ29udGFpbmVyJykuYXBwZW5kKGRlLiRkZWJ1Z2dlckVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSBpbnN0YW5jZW9mIEFycmF5VHlwZSkge1xyXG5cclxuICAgICAgICAgICAgbGV0IGEgPSA8VmFsdWVbXT50aGlzLnZhbHVlLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgbGV0ICRjaGlsZENvbnRhaW5lciA9IHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5maW5kKCcuam9fZGVDaGlsZENvbnRhaW5lcicpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoICYmIGkgPCAxMDA7IGkrKykge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBkZSA9IG5ldyBEZWJ1Z2dlckVsZW1lbnQobnVsbCwgdGhpcywgXCJbXCIgKyBpICsgXCJdXCIsIGFbaV0sIHRoaXMudHlwZS5hcnJheU9mVHlwZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICBkZS5yZW5kZXIoKTtcclxuICAgICAgICAgICAgICAgICRjaGlsZENvbnRhaW5lci5hcHBlbmQoZGUuJGRlYnVnZ2VyRWxlbWVudCk7XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy50eXBlIGluc3RhbmNlb2YgU3RhdGljQ2xhc3MpIHtcclxuXHJcbiAgICAgICAgICAgIGZvciAobGV0IGEgb2YgdGhpcy50eXBlLmdldEF0dHJpYnV0ZXMoVmlzaWJpbGl0eS5wcml2YXRlKSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHJvID0gdGhpcy50eXBlLmNsYXNzT2JqZWN0O1xyXG4gICAgICAgICAgICAgICAgbGV0IGRlID0gbmV3IERlYnVnZ2VyRWxlbWVudChudWxsLCB0aGlzLCBhLmlkZW50aWZpZXIsIHJvLmdldFZhbHVlKGEuaW5kZXgpLCBhLnR5cGUsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgZGUucmVuZGVyKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuZmluZCgnLmpvX2RlQ2hpbGRDb250YWluZXInKS5hcHBlbmQoZGUuJGRlYnVnZ2VyRWxlbWVudCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnR5cGUgaW5zdGFuY2VvZiBJbnRlcmZhY2UpIHtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLnZhbHVlLnZhbHVlICE9IG51bGwgJiYgdGhpcy52YWx1ZS52YWx1ZSBpbnN0YW5jZW9mIFJ1bnRpbWVPYmplY3QpIHtcclxuICAgICAgICAgICAgICAgIGxldCBybzogUnVudGltZU9iamVjdCA9IHRoaXMudmFsdWUudmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgYSBvZiAoPEtsYXNzPnJvLmNsYXNzKS5nZXRBdHRyaWJ1dGVzKFZpc2liaWxpdHkucHJpdmF0ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZGUgPSBuZXcgRGVidWdnZXJFbGVtZW50KG51bGwsIHRoaXMsIGEuaWRlbnRpZmllciwgcm8uZ2V0VmFsdWUoYS5pbmRleCksIGEudHlwZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGUucmVuZGVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmZpbmQoJy5qb19kZUNoaWxkQ29udGFpbmVyJykuYXBwZW5kKGRlLiRkZWJ1Z2dlckVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPT0gW107XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICByZW5kZXJMaXN0RWxlbWVudHMobGlzdEhlbHBlcjogTGlzdEhlbHBlcikge1xyXG5cclxuICAgICAgICBsZXQgdmFsdWVBcnJheSA9IGxpc3RIZWxwZXIudmFsdWVBcnJheTtcclxuICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPiB2YWx1ZUFycmF5Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdmFsdWVBcnJheS5sZW5ndGg7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2hpbGRFbGVtZW50ID0gdGhpcy5jaGlsZHJlbltpXTtcclxuICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudC4kZGVidWdnZXJFbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKHZhbHVlQXJyYXkubGVuZ3RoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA8IHZhbHVlQXJyYXkubGVuZ3RoICYmIHRoaXMuY2hpbGRyZW4ubGVuZ3RoIDwgMTAwKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSA8IHZhbHVlQXJyYXkubGVuZ3RoICYmIGkgPD0gMTAwOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGxldCB2OiBWYWx1ZSA9IHZhbHVlQXJyYXlbaV07XHJcbiAgICAgICAgICAgICAgICBsZXQgdGl0bGUgPSBcIlwiICsgaTtcclxuICAgICAgICAgICAgICAgIGlmIChpID09IDEwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHYgPSB7IHR5cGU6IHN0cmluZ1ByaW1pdGl2ZVR5cGUsIHZhbHVlOiBcIlwiICsgKGxpc3RIZWxwZXIudmFsdWVBcnJheS5sZW5ndGggLSAxMDApICsgXCIgd2VpdGVyZS4uLlwiIH07XHJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSBcIi4uLlwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbGV0IGRlID0gbmV3IERlYnVnZ2VyRWxlbWVudChudWxsLCB0aGlzLCB0aXRsZSwgdiwgdi50eXBlLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIGRlLnJlbmRlcigpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmZpbmQoJy5qb19kZUNoaWxkQ29udGFpbmVyJykuZmlyc3QoKS5hcHBlbmQoZGUuJGRlYnVnZ2VyRWxlbWVudCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlclZhbHVlKCkge1xyXG4gICAgICAgIGxldCBzOiBzdHJpbmc7XHJcbiAgICAgICAgbGV0IHYgPSB0aGlzLnZhbHVlO1xyXG5cclxuICAgICAgICBpZiAodiA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5oaWRlKCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5zaG93KCk7XHJcbiAgICAgICAgaWYgKHYudmFsdWUgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBzID0gXCJudWxsXCI7XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQWxsQ2hpbGRyZW4oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgaWYgKHYudXBkYXRlVmFsdWUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdi51cGRhdGVWYWx1ZSh2KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcyA9IHYudHlwZS5kZWJ1Z091dHB1dCh2KTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgaW5zdGFuY2VvZiBLbGFzcykge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBybzogUnVudGltZU9iamVjdCA9IHRoaXMudmFsdWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGlzdEhlbHBlcjogTGlzdEhlbHBlciA9IHJvLmludHJpbnNpY0RhdGEgPT0gbnVsbCA/IG51bGwgOiByby5pbnRyaW5zaWNEYXRhW1wiTGlzdEhlbHBlclwiXTtcclxuICAgICAgICAgICAgICAgIGlmIChsaXN0SGVscGVyICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckxpc3RFbGVtZW50cyhsaXN0SGVscGVyKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihsaXN0SGVscGVyLmFsbEVsZW1lbnRzUHJpbWl0aXZlKCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzID0gXCJcIiArbGlzdEhlbHBlci52YWx1ZUFycmF5Lmxlbmd0aCArIFwiIEVsOiBcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzICs9IFwiW1wiICsgbGlzdEhlbHBlci5vYmplY3RBcnJheS5zbGljZSgwLCAyMCkubWFwKG8gPT4gXCJcIiArIG8pLmpvaW4oXCIsIFwiKSArIFwiXVwiXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHYudHlwZS5pZGVudGlmaWVyICsgXCIgKFwiICtsaXN0SGVscGVyLnZhbHVlQXJyYXkubGVuZ3RoICsgXCIgRWxlbWVudGUpXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICBcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5maW5kKCcuam9fZGVWYWx1ZScpLmZpcnN0KCkuaHRtbChzKTtcclxuXHJcblxyXG4gICAgICAgIGZvciAobGV0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgY2hpbGQucmVuZGVyVmFsdWUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQWxsQ2hpbGRyZW4oKSB7XHJcbiAgICAgICAgZm9yIChsZXQgZGUgb2YgdGhpcy5jaGlsZHJlbikge1xyXG4gICAgICAgICAgICBkZS4kZGVidWdnZXJFbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNoaWxkcmVuID0gW11cclxuICAgIH1cclxuXHJcbn0iXX0=