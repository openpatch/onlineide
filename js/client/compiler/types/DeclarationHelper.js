import { Klass, Interface, Visibility } from "./Class.js";
import { Method, Attribute } from "./Types.js";
import { objectType } from "./PrimitiveTypes.js";
import { formatAsJavadocComment } from "../../tools/StringTools.js";
export function getDeclarationAsString(element, indent = "", short = false) {
    if (element instanceof Klass) {
        if (element.isTypeVariable) {
            return getTypeVariableDeclaration(element);
        }
        let s = "";
        if (element.documentation != null && element.documentation != "") {
            if (element.documentation.startsWith("/*")) {
                s += (indent + element.documentation).replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                // s += indent + "/**  \n" + element.documentation + "  \n**/  \n" + indent;
                s += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        if (element.visibility != null)
            s += Visibility[element.visibility] + " ";
        if (element.isAbstract)
            s += "abstract ";
        s += "class " + element.identifier + " ";
        if (element.typeVariables.length > 0) {
            s += getGenericParameterDefinition(element);
        }
        if (element.baseClass != null && element.baseClass.identifier != "Object") {
            s += "extends " + element.baseClass.identifier + " ";
            if (element.baseClass.typeVariables.length > 0) {
                s += getGenericParameterDefinition(element.baseClass);
            }
        }
        if (element.implements != null && element.implements.length > 0) {
            s += "implements ";
            for (let i = 0; i < element.implements.length; i++) {
                s += element.implements[i].identifier;
                if (element.implements[i].typeVariables.length > 0) {
                    s += getGenericParameterDefinition(element.implements[i]);
                }
                if (i < element.implements.length - 1) {
                    s += ", ";
                }
            }
        }
        if (short)
            return s;
        s += indent + "{\n  ";
        for (let a of element.getAttributes(Visibility.protected)) {
            s += indent + "\n" + getDeclarationAsString(a, "  ") + ";\n";
        }
        if (element.staticClass != null) {
            for (let a of element.staticClass.getAttributes(Visibility.protected)) {
                s += indent + "\n" + getDeclarationAsString(a, "  ") + ";\n";
            }
        }
        for (let m of element.getMethods(Visibility.protected)) {
            s += indent + "\n" + getDeclarationAsString(m, "  ") + ";\n";
        }
        if (element.staticClass != null) {
            for (let m of element.staticClass.getMethods(Visibility.protected)) {
                s += indent + "\n" + getDeclarationAsString(m, "  ") + ";\n";
            }
        }
        s += "\n}";
        return s;
    }
    if (element instanceof Interface) {
        let decl = "";
        if (element.documentation != null && element.documentation != "" && !short) {
            if (element.documentation.startsWith("/*")) {
                decl += (indent + element.documentation).replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                decl += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        decl += indent + "interface " + element.identifier;
        if (element.typeVariables.length > 0) {
            decl += getGenericParameterDefinition(element);
        }
        if (element.extends != null && element.extends.length > 0) {
            decl += "extends ";
            for (let i = 0; i < element.extends.length; i++) {
                decl += element.extends[i].identifier;
                if (element.extends[i].typeVariables.length > 0) {
                    decl += getGenericParameterDefinition(element.extends[i]);
                }
                if (i < element.extends.length - 1) {
                    decl += ", ";
                }
            }
        }
        if (!short) {
            decl += "{\n";
            for (let m of element.getMethods()) {
                decl += indent + "\n" + getDeclarationAsString(m, "  ") + ";\n";
            }
            decl += "\n}";
        }
        return decl;
    }
    if (element instanceof Attribute) {
        let s = "";
        if (element.documentation != null && element.documentation != "" && !short) {
            if (element.documentation.startsWith("/*")) {
                s += indent + element.documentation.replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                s += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        s += indent;
        if (element.visibility != null)
            s += Visibility[element.visibility] + " ";
        if (element.isStatic)
            s += "static ";
        s += getTypeIdentifier(element.type) + " " + element.identifier;
        return s;
    }
    if (element instanceof Method) {
        let s = "";
        if (element.documentation != null && element.documentation != "" && !short) {
            if (element.documentation.startsWith("/*")) {
                s += indent + element.documentation.replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                s += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        s += indent;
        if (element.visibility != null)
            s += Visibility[element.visibility] + " ";
        if (element.isStatic)
            s += "static ";
        if (element.getReturnType() != null) {
            s += getTypeIdentifier(element.getReturnType()) + " ";
        }
        else {
            s += element.isConstructor ? "" : "void ";
        }
        s += element.identifier + "(";
        let parameters = element.getParameterList().parameters;
        for (let i = 0; i < parameters.length; i++) {
            let p = parameters[i];
            let type = element.getParameterType(i);
            if (p.isEllipsis) {
                type = type.arrayOfType;
            }
            s += getTypeIdentifier(type) + (p.isEllipsis ? "..." : "") + " " + p.identifier;
            if (i < parameters.length - 1) {
                s += ", ";
            }
        }
        s += ")";
        return s;
    }
    return "";
}
function getTypeVariableDeclaration(element) {
    let s = element.identifier;
    if (element.isGenericVariantFrom != objectType)
        s += " extends " + getTypeIdentifier(element.isGenericVariantFrom);
    if (element.implements.length > 0) {
        let implList = element.implements.filter(impl => element.isGenericVariantFrom.implements.indexOf(impl) < 0)
            .map(impl => getTypeIdentifier(impl)).join(", ");
        if (implList != "") {
            s += " implements " + implList;
        }
    }
    return s;
}
export function getTypeIdentifier(type) {
    var _a, _b;
    if (type instanceof Klass || type instanceof Interface) {
        if (type.typeVariables.length > 0) {
            let s = (type["isTypeVariable"] ? (type.identifier + " extends " + ((_a = type.isGenericVariantFrom) === null || _a === void 0 ? void 0 : _a.identifier)) : type.identifier)
                + "<";
            s += type.typeVariables.map(tv => getTypeIdentifier(tv.type)).join(", ");
            return s + ">";
        }
    }
    return type["isTypeVariable"] ? (type.identifier + " extends " + ((_b = type["isGenericVariantFrom"]) === null || _b === void 0 ? void 0 : _b.identifier)) : type.identifier;
}
export function getGenericParameterDefinition(element) {
    let s = "";
    if (element.typeVariables.length > 0) {
        s = "<";
        let typeList = [];
        for (let tv of element.typeVariables) {
            let t = tv.type.identifier;
            let k = tv.type;
            if (k.isGenericVariantFrom != null && k.isGenericVariantFrom.identifier != "Object") {
                t += " extends " + k.isGenericVariantFrom.identifier;
            }
            if (k.implements != null) {
                let implList = k.implements;
                if (k.isGenericVariantFrom != null) {
                    implList = implList.filter(impl => k.isGenericVariantFrom.implements.indexOf(impl) < 0);
                }
                for (let im of implList) {
                    t += " & " + im.identifier;
                }
            }
            typeList.push(t);
        }
        s += typeList.join(", ");
        s += "> ";
    }
    return s;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVjbGFyYXRpb25IZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvbXBpbGVyL3R5cGVzL0RlY2xhcmF0aW9uSGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBaUMsTUFBTSxZQUFZLENBQUM7QUFDOUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWpELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXBFLE1BQU0sVUFBVSxzQkFBc0IsQ0FBQyxPQUEwRCxFQUM3RixTQUFpQixFQUFFLEVBQUUsUUFBaUIsS0FBSztJQUUzQyxJQUFJLE9BQU8sWUFBWSxLQUFLLEVBQUU7UUFFMUIsSUFBSSxPQUFPLENBQUMsY0FBYyxFQUFFO1lBQ3hCLE9BQU8sMEJBQTBCLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDOUM7UUFFRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFWCxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksRUFBRSxFQUFFO1lBQzlELElBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUM7Z0JBQ3RDLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLEdBQUcsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQzlFO2lCQUFNO2dCQUNILDRFQUE0RTtnQkFDNUUsQ0FBQyxJQUFJLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO2FB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NUIsSUFBSSxDQUFDLENBQUMsb0JBQW9CLElBQUksSUFBSSxFQUFFO29CQUNoQyxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUMzRjtnQkFFRCxLQUFLLElBQUksRUFBRSxJQUFJLFFBQVEsRUFBRTtvQkFDckIsQ0FBQyxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDO2lCQUM5QjthQUNKO1lBQ0QsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNwQjtRQUVELENBQUMsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pCLENBQUMsSUFBSSxJQUFJLENBQUM7S0FDYjtJQUVELE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtsYXNzLCBJbnRlcmZhY2UsIFZpc2liaWxpdHkgfSBmcm9tIFwiLi9DbGFzcy5qc1wiO1xyXG5pbXBvcnQgeyBNZXRob2QsIEF0dHJpYnV0ZSwgVHlwZSwgUHJpbWl0aXZlVHlwZSwgVmFyaWFibGUgfSBmcm9tIFwiLi9UeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBvYmplY3RUeXBlIH0gZnJvbSBcIi4vUHJpbWl0aXZlVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgQXJyYXlUeXBlIH0gZnJvbSBcIi4vQXJyYXkuanNcIjtcclxuaW1wb3J0IHsgZm9ybWF0QXNKYXZhZG9jQ29tbWVudCB9IGZyb20gXCIuLi8uLi90b29scy9TdHJpbmdUb29scy5qc1wiO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uQXNTdHJpbmcoZWxlbWVudDogS2xhc3MgfCBJbnRlcmZhY2UgfCBNZXRob2QgfCBBdHRyaWJ1dGUgfCBWYXJpYWJsZSxcclxuICAgIGluZGVudDogc3RyaW5nID0gXCJcIiwgc2hvcnQ6IGJvb2xlYW4gPSBmYWxzZSk6IHN0cmluZyB7XHJcblxyXG4gICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBLbGFzcykge1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5pc1R5cGVWYXJpYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZ2V0VHlwZVZhcmlhYmxlRGVjbGFyYXRpb24oZWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcyA9IFwiXCI7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmRvY3VtZW50YXRpb24gIT0gbnVsbCAmJiBlbGVtZW50LmRvY3VtZW50YXRpb24gIT0gXCJcIikge1xyXG4gICAgICAgICAgICBpZihlbGVtZW50LmRvY3VtZW50YXRpb24uc3RhcnRzV2l0aChcIi8qXCIpKXtcclxuICAgICAgICAgICAgICAgIHMgKz0gKGluZGVudCArIGVsZW1lbnQuZG9jdW1lbnRhdGlvbikucmVwbGFjZSgvXFxuL2csIFwiXFxuXCIgKyBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIHMgKz0gaW5kZW50ICsgXCIvKiogIFxcblwiICsgZWxlbWVudC5kb2N1bWVudGF0aW9uICsgXCIgIFxcbioqLyAgXFxuXCIgKyBpbmRlbnQ7XHJcbiAgICAgICAgICAgICAgICBzICs9IGZvcm1hdEFzSmF2YWRvY0NvbW1lbnQoZWxlbWVudC5kb2N1bWVudGF0aW9uLCBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQudmlzaWJpbGl0eSAhPSBudWxsKSBzICs9IFZpc2liaWxpdHlbZWxlbWVudC52aXNpYmlsaXR5XSArIFwiIFwiO1xyXG4gICAgICAgIGlmIChlbGVtZW50LmlzQWJzdHJhY3QpIHMgKz0gXCJhYnN0cmFjdCBcIjtcclxuICAgICAgICBzICs9IFwiY2xhc3MgXCIgKyBlbGVtZW50LmlkZW50aWZpZXIgKyBcIiBcIjtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQudHlwZVZhcmlhYmxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHMgKz0gZ2V0R2VuZXJpY1BhcmFtZXRlckRlZmluaXRpb24oZWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuYmFzZUNsYXNzICE9IG51bGwgJiYgZWxlbWVudC5iYXNlQ2xhc3MuaWRlbnRpZmllciAhPSBcIk9iamVjdFwiKSB7XHJcbiAgICAgICAgICAgIHMgKz0gXCJleHRlbmRzIFwiICsgZWxlbWVudC5iYXNlQ2xhc3MuaWRlbnRpZmllciArIFwiIFwiO1xyXG4gICAgICAgICAgICBpZiAoZWxlbWVudC5iYXNlQ2xhc3MudHlwZVZhcmlhYmxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBzICs9IGdldEdlbmVyaWNQYXJhbWV0ZXJEZWZpbml0aW9uKGVsZW1lbnQuYmFzZUNsYXNzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuaW1wbGVtZW50cyAhPSBudWxsICYmIGVsZW1lbnQuaW1wbGVtZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHMgKz0gXCJpbXBsZW1lbnRzIFwiO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1lbnQuaW1wbGVtZW50cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgcyArPSBlbGVtZW50LmltcGxlbWVudHNbaV0uaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmltcGxlbWVudHNbaV0udHlwZVZhcmlhYmxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcyArPSBnZXRHZW5lcmljUGFyYW1ldGVyRGVmaW5pdGlvbihlbGVtZW50LmltcGxlbWVudHNbaV0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGkgPCBlbGVtZW50LmltcGxlbWVudHMubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHMgKz0gXCIsIFwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc2hvcnQpIHJldHVybiBzO1xyXG5cclxuICAgICAgICBzICs9IGluZGVudCArIFwie1xcbiAgXCI7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGEgb2YgZWxlbWVudC5nZXRBdHRyaWJ1dGVzKFZpc2liaWxpdHkucHJvdGVjdGVkKSkge1xyXG4gICAgICAgICAgICBzICs9IGluZGVudCArIFwiXFxuXCIgKyBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKGEsIFwiICBcIikgKyBcIjtcXG5cIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LnN0YXRpY0NsYXNzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgYSBvZiBlbGVtZW50LnN0YXRpY0NsYXNzLmdldEF0dHJpYnV0ZXMoVmlzaWJpbGl0eS5wcm90ZWN0ZWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzICs9IGluZGVudCArIFwiXFxuXCIgKyBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKGEsIFwiICBcIikgKyBcIjtcXG5cIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChsZXQgbSBvZiBlbGVtZW50LmdldE1ldGhvZHMoVmlzaWJpbGl0eS5wcm90ZWN0ZWQpKSB7XHJcbiAgICAgICAgICAgIHMgKz0gaW5kZW50ICsgXCJcXG5cIiArIGdldERlY2xhcmF0aW9uQXNTdHJpbmcobSwgXCIgIFwiKSArIFwiO1xcblwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuc3RhdGljQ2xhc3MgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBtIG9mIGVsZW1lbnQuc3RhdGljQ2xhc3MuZ2V0TWV0aG9kcyhWaXNpYmlsaXR5LnByb3RlY3RlZCkpIHtcclxuICAgICAgICAgICAgICAgIHMgKz0gaW5kZW50ICsgXCJcXG5cIiArIGdldERlY2xhcmF0aW9uQXNTdHJpbmcobSwgXCIgIFwiKSArIFwiO1xcblwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgcyArPSBcIlxcbn1cIjtcclxuXHJcbiAgICAgICAgcmV0dXJuIHM7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSW50ZXJmYWNlKSB7XHJcblxyXG4gICAgICAgIGxldCBkZWNsID0gXCJcIjtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuZG9jdW1lbnRhdGlvbiAhPSBudWxsICYmIGVsZW1lbnQuZG9jdW1lbnRhdGlvbiAhPSBcIlwiICYmICFzaG9ydCkge1xyXG4gICAgICAgICAgICBpZihlbGVtZW50LmRvY3VtZW50YXRpb24uc3RhcnRzV2l0aChcIi8qXCIpKXtcclxuICAgICAgICAgICAgICAgIGRlY2wgKz0gKGluZGVudCArIGVsZW1lbnQuZG9jdW1lbnRhdGlvbikucmVwbGFjZSgvXFxuL2csIFwiXFxuXCIgKyBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRlY2wgKz0gZm9ybWF0QXNKYXZhZG9jQ29tbWVudChlbGVtZW50LmRvY3VtZW50YXRpb24sIGluZGVudCkgKyBcIlxcblwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBkZWNsICs9IGluZGVudCArIFwiaW50ZXJmYWNlIFwiICsgZWxlbWVudC5pZGVudGlmaWVyO1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC50eXBlVmFyaWFibGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZGVjbCArPSBnZXRHZW5lcmljUGFyYW1ldGVyRGVmaW5pdGlvbihlbGVtZW50KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmV4dGVuZHMgIT0gbnVsbCAmJiBlbGVtZW50LmV4dGVuZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBkZWNsICs9IFwiZXh0ZW5kcyBcIjtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtZW50LmV4dGVuZHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGRlY2wgKz0gZWxlbWVudC5leHRlbmRzW2ldLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5leHRlbmRzW2ldLnR5cGVWYXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlY2wgKz0gZ2V0R2VuZXJpY1BhcmFtZXRlckRlZmluaXRpb24oZWxlbWVudC5leHRlbmRzW2ldKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpIDwgZWxlbWVudC5leHRlbmRzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWNsICs9IFwiLCBcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFzaG9ydCkge1xyXG5cclxuICAgICAgICAgICAgZGVjbCArPSBcIntcXG5cIjtcclxuXHJcbiAgICAgICAgICAgIGZvciAobGV0IG0gb2YgZWxlbWVudC5nZXRNZXRob2RzKCkpIHtcclxuICAgICAgICAgICAgICAgIGRlY2wgKz0gaW5kZW50ICsgXCJcXG5cIiArIGdldERlY2xhcmF0aW9uQXNTdHJpbmcobSwgXCIgIFwiKSArIFwiO1xcblwiO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBkZWNsICs9IFwiXFxufVwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGRlY2w7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgQXR0cmlidXRlKSB7XHJcbiAgICAgICAgbGV0IHMgPSBcIlwiO1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5kb2N1bWVudGF0aW9uICE9IG51bGwgJiYgZWxlbWVudC5kb2N1bWVudGF0aW9uICE9IFwiXCIgJiYgIXNob3J0KSB7XHJcbiAgICAgICAgICAgIGlmKGVsZW1lbnQuZG9jdW1lbnRhdGlvbi5zdGFydHNXaXRoKFwiLypcIikpe1xyXG4gICAgICAgICAgICAgICAgcyArPSBpbmRlbnQgKyBlbGVtZW50LmRvY3VtZW50YXRpb24ucmVwbGFjZSgvXFxuL2csIFwiXFxuXCIgKyBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHMgKz0gZm9ybWF0QXNKYXZhZG9jQ29tbWVudChlbGVtZW50LmRvY3VtZW50YXRpb24sIGluZGVudCkgKyBcIlxcblwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzICs9IGluZGVudDtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQudmlzaWJpbGl0eSAhPSBudWxsKSBzICs9IFZpc2liaWxpdHlbZWxlbWVudC52aXNpYmlsaXR5XSArIFwiIFwiO1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5pc1N0YXRpYykgcyArPSBcInN0YXRpYyBcIjtcclxuXHJcbiAgICAgICAgcyArPSBnZXRUeXBlSWRlbnRpZmllcihlbGVtZW50LnR5cGUpICsgXCIgXCIgKyBlbGVtZW50LmlkZW50aWZpZXI7XHJcblxyXG4gICAgICAgIHJldHVybiBzO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgTWV0aG9kKSB7XHJcblxyXG4gICAgICAgIGxldCBzID0gXCJcIjtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuZG9jdW1lbnRhdGlvbiAhPSBudWxsICYmIGVsZW1lbnQuZG9jdW1lbnRhdGlvbiAhPSBcIlwiICYmICFzaG9ydCkge1xyXG4gICAgICAgICAgICBpZihlbGVtZW50LmRvY3VtZW50YXRpb24uc3RhcnRzV2l0aChcIi8qXCIpKXtcclxuICAgICAgICAgICAgICAgIHMgKz0gaW5kZW50ICsgZWxlbWVudC5kb2N1bWVudGF0aW9uLnJlcGxhY2UoL1xcbi9nLCBcIlxcblwiICsgaW5kZW50KSArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzICs9IGZvcm1hdEFzSmF2YWRvY0NvbW1lbnQoZWxlbWVudC5kb2N1bWVudGF0aW9uLCBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcyArPSBpbmRlbnQ7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LnZpc2liaWxpdHkgIT0gbnVsbCkgcyArPSBWaXNpYmlsaXR5W2VsZW1lbnQudmlzaWJpbGl0eV0gKyBcIiBcIjtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuaXNTdGF0aWMpIHMgKz0gXCJzdGF0aWMgXCI7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmdldFJldHVyblR5cGUoKSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHMgKz0gZ2V0VHlwZUlkZW50aWZpZXIoZWxlbWVudC5nZXRSZXR1cm5UeXBlKCkpICsgXCIgXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcyArPSBlbGVtZW50LmlzQ29uc3RydWN0b3IgPyBcIlwiIDogXCJ2b2lkIFwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcyArPSBlbGVtZW50LmlkZW50aWZpZXIgKyBcIihcIjtcclxuXHJcbiAgICAgICAgbGV0IHBhcmFtZXRlcnMgPSBlbGVtZW50LmdldFBhcmFtZXRlckxpc3QoKS5wYXJhbWV0ZXJzO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1ldGVycy5sZW5ndGg7IGkrKykge1xyXG5cclxuICAgICAgICAgICAgbGV0IHAgPSBwYXJhbWV0ZXJzW2ldO1xyXG4gICAgICAgICAgICBsZXQgdHlwZTogVHlwZSA9IGVsZW1lbnQuZ2V0UGFyYW1ldGVyVHlwZShpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChwLmlzRWxsaXBzaXMpIHtcclxuICAgICAgICAgICAgICAgIHR5cGUgPSAoPEFycmF5VHlwZT50eXBlKS5hcnJheU9mVHlwZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcyArPSBnZXRUeXBlSWRlbnRpZmllcih0eXBlKSArIChwLmlzRWxsaXBzaXMgPyBcIi4uLlwiIDogXCJcIikgKyBcIiBcIiArIHAuaWRlbnRpZmllcjtcclxuXHJcbiAgICAgICAgICAgIGlmIChpIDwgcGFyYW1ldGVycy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICBzICs9IFwiLCBcIjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHMgKz0gXCIpXCI7XHJcblxyXG4gICAgICAgIHJldHVybiBzO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIFwiXCI7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFR5cGVWYXJpYWJsZURlY2xhcmF0aW9uKGVsZW1lbnQ6IEtsYXNzKSB7XHJcbiAgICBsZXQgczogc3RyaW5nID0gZWxlbWVudC5pZGVudGlmaWVyO1xyXG5cclxuICAgIGlmIChlbGVtZW50LmlzR2VuZXJpY1ZhcmlhbnRGcm9tICE9IG9iamVjdFR5cGUpIHMgKz0gXCIgZXh0ZW5kcyBcIiArIGdldFR5cGVJZGVudGlmaWVyKGVsZW1lbnQuaXNHZW5lcmljVmFyaWFudEZyb20pO1xyXG4gICAgaWYgKGVsZW1lbnQuaW1wbGVtZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgbGV0IGltcGxMaXN0ID0gZWxlbWVudC5pbXBsZW1lbnRzLmZpbHRlcihpbXBsID0+IGVsZW1lbnQuaXNHZW5lcmljVmFyaWFudEZyb20uaW1wbGVtZW50cy5pbmRleE9mKGltcGwpIDwgMClcclxuICAgICAgICAgICAgLm1hcChpbXBsID0+IGdldFR5cGVJZGVudGlmaWVyKGltcGwpKS5qb2luKFwiLCBcIik7XHJcbiAgICAgICAgaWYgKGltcGxMaXN0ICE9IFwiXCIpIHtcclxuICAgICAgICAgICAgcyArPSBcIiBpbXBsZW1lbnRzIFwiICsgaW1wbExpc3Q7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VHlwZUlkZW50aWZpZXIodHlwZTogVHlwZSk6IHN0cmluZyB7XHJcbiAgICBpZiAodHlwZSBpbnN0YW5jZW9mIEtsYXNzIHx8IHR5cGUgaW5zdGFuY2VvZiBJbnRlcmZhY2UpIHtcclxuICAgICAgICBpZiAodHlwZS50eXBlVmFyaWFibGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgbGV0IHM6IHN0cmluZyA9ICh0eXBlW1wiaXNUeXBlVmFyaWFibGVcIl0gPyAodHlwZS5pZGVudGlmaWVyICsgXCIgZXh0ZW5kcyBcIiArIHR5cGUuaXNHZW5lcmljVmFyaWFudEZyb20/LmlkZW50aWZpZXIpIDogdHlwZS5pZGVudGlmaWVyKVxyXG4gICAgICAgICAgICAgICAgKyBcIjxcIjtcclxuICAgICAgICAgICAgcyArPSB0eXBlLnR5cGVWYXJpYWJsZXMubWFwKHR2ID0+IGdldFR5cGVJZGVudGlmaWVyKHR2LnR5cGUpKS5qb2luKFwiLCBcIik7XHJcbiAgICAgICAgICAgIHJldHVybiBzICsgXCI+XCI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0eXBlW1wiaXNUeXBlVmFyaWFibGVcIl0gPyAodHlwZS5pZGVudGlmaWVyICsgXCIgZXh0ZW5kcyBcIiArIHR5cGVbXCJpc0dlbmVyaWNWYXJpYW50RnJvbVwiXT8uaWRlbnRpZmllcikgOiB0eXBlLmlkZW50aWZpZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRHZW5lcmljUGFyYW1ldGVyRGVmaW5pdGlvbihlbGVtZW50OiBLbGFzcyB8IEludGVyZmFjZSk6IHN0cmluZyB7XHJcblxyXG4gICAgbGV0IHM6IHN0cmluZyA9IFwiXCI7XHJcblxyXG4gICAgaWYgKGVsZW1lbnQudHlwZVZhcmlhYmxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcyA9IFwiPFwiO1xyXG5cclxuICAgICAgICBsZXQgdHlwZUxpc3Q6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgdHYgb2YgZWxlbWVudC50eXBlVmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgIGxldCB0OiBzdHJpbmcgPSB0di50eXBlLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgIGxldCBrOiBLbGFzcyA9IHR2LnR5cGU7XHJcbiAgICAgICAgICAgIGlmIChrLmlzR2VuZXJpY1ZhcmlhbnRGcm9tICE9IG51bGwgJiYgay5pc0dlbmVyaWNWYXJpYW50RnJvbS5pZGVudGlmaWVyICE9IFwiT2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgICAgIHQgKz0gXCIgZXh0ZW5kcyBcIiArIGsuaXNHZW5lcmljVmFyaWFudEZyb20uaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoay5pbXBsZW1lbnRzICE9IG51bGwpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgaW1wbExpc3QgPSBrLmltcGxlbWVudHM7XHJcbiAgICAgICAgICAgICAgICBpZiAoay5pc0dlbmVyaWNWYXJpYW50RnJvbSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW1wbExpc3QgPSBpbXBsTGlzdC5maWx0ZXIoaW1wbCA9PiBrLmlzR2VuZXJpY1ZhcmlhbnRGcm9tLmltcGxlbWVudHMuaW5kZXhPZihpbXBsKSA8IDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGltIG9mIGltcGxMaXN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdCArPSBcIiAmIFwiICsgaW0uaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0eXBlTGlzdC5wdXNoKHQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcyArPSB0eXBlTGlzdC5qb2luKFwiLCBcIik7XHJcbiAgICAgICAgcyArPSBcIj4gXCI7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHM7XHJcbn0iXX0=