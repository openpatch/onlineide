import { ArrayType } from "./Array.js";
import { Interface, Klass } from "./Class.js";
import { Enum } from "./Enum.js";
export class JsonTool {
    toJson(value) {
        this.objectToIndexMap = new Map();
        this.nextIndex = 0;
        let json = JSON.stringify(this.toJsonObj(value));
        this.objectToIndexMap = null; // free memory
        return json;
    }
    toJsonObj(value) {
        let type = value.type;
        let v = value.value;
        if (v == null)
            return null;
        if ((type instanceof Klass || type instanceof Interface) && type.identifier != "String") {
            if (type instanceof Enum) {
                let enumObj = v;
                return enumObj.enumValue.ordinal;
            }
            let rto = v;
            return this.objectToJsonObj(rto);
        }
        else if (type instanceof ArrayType) {
            let arrayValues = v;
            return arrayValues.map(value => this.toJsonObj(value));
        }
        else {
            // primitive Type
            return value.value;
        }
    }
    objectToJsonObj(rto) {
        // We solve circular object references by serializing an index when the same object occurs more than once.
        let index = this.objectToIndexMap.get(rto);
        if (index != null) {
            return { "!i": index };
        }
        index = this.nextIndex++;
        this.objectToIndexMap.set(rto, index);
        let klass = rto.class;
        // Don't serialize system classes unless they are explicitely serializable
        if (klass.module.isSystemModule && klass.getMethodBySignature("String toJson()") == null) {
            return null;
        }
        let serializedObject = { "!k": klass.identifier, "!i": index };
        while (klass != null) {
            let first = true;
            let serializedAttributes;
            for (let attribute of klass.attributes) {
                if (!attribute.isStatic && !attribute.isTransient) {
                    if (first) {
                        first = false;
                        serializedAttributes = {};
                        serializedObject[klass.identifier] = serializedAttributes;
                    }
                    serializedAttributes[attribute.identifier] = this.toJsonObj(rto.attributes[attribute.index]);
                }
            }
            klass = klass.baseClass;
        }
        return serializedObject;
    }
    fromJson(jsonString, type, moduleStore, interpreter) {
        this.indexToObjectMap = {};
        this.valuesToResolve = [];
        let obj = JSON.parse(jsonString);
        let ret = this.fromJsonObj(obj, type, moduleStore, interpreter);
        for (let vtr of this.valuesToResolve) {
            let value = this.indexToObjectMap[vtr.i];
            if (value != null) {
                vtr.v.type = value.type;
                vtr.v.value = value.value;
            }
        }
        this.indexToObjectMap = null; // free memory
        this.valuesToResolve = null;
        return ret.value;
    }
    fromJsonObj(obj, type, moduleStore, interpreter) {
        if (obj == null)
            return { type: type, value: null };
        if ((type instanceof Klass || type instanceof Interface) && type.identifier != "String") {
            if (type instanceof Enum) {
                return {
                    type: type,
                    value: type.indexToInfoMap[obj].object
                };
            }
            let serializedObject = obj;
            return this.objectFromJsonObj(serializedObject, type, moduleStore, interpreter);
        }
        else if (type instanceof ArrayType) {
            let jsonArray = obj;
            return {
                type: type,
                value: jsonArray.map(v => this.fromJsonObj(v, type.arrayOfType, moduleStore, interpreter))
            };
        }
        else {
            // primitive Type
            return { type: type, value: obj };
        }
    }
    objectFromJsonObj(serializedObject, type, moduleStore, interpreter) {
        let identifier = serializedObject["!k"];
        let index = serializedObject["!i"];
        if (identifier != null) {
            let klass1 = moduleStore.getType(identifier).type;
            let klass = klass1;
            let rto = interpreter.instantiateObjectImmediately(klass);
            while (klass != null) {
                let attributes = rto.attributes;
                let serializedAttributes = serializedObject[klass.identifier];
                if (attributes != null && serializedObject != null) {
                    for (let attribute of klass.attributes) {
                        if (!attribute.isStatic && !attribute.isTransient) {
                            attributes[attribute.index] = this.fromJsonObj(serializedAttributes[attribute.identifier], attribute.type, moduleStore, interpreter);
                        }
                    }
                }
                klass = klass.baseClass;
            }
            let value = { type: klass1, value: rto };
            this.indexToObjectMap[index] = value;
            return value;
        }
        else {
            let index = serializedObject["!i"];
            let value = this.indexToObjectMap[index];
            if (value == null) {
                value = { type: type, value: null };
                this.valuesToResolve.push({ v: value, i: index });
                return value;
            }
            else {
                return { type: value.type, value: value.value }; // return copy
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZVRvb2xzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9jb21waWxlci90eXBlcy9UeXBlVG9vbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN2QyxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM5QyxPQUFPLEVBQUUsSUFBSSxFQUFxQixNQUFNLFdBQVcsQ0FBQztBQVFwRCxNQUFNLE9BQU8sUUFBUTtJQVNqQixNQUFNLENBQUMsS0FBWTtRQUNmLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsQ0FBQyxjQUFjO1FBQzVDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxTQUFTLENBQUMsS0FBWTtRQUNsQixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDcEIsSUFBSSxDQUFDLElBQUksSUFBSTtZQUFFLE9BQU8sSUFBSSxDQUFDO1FBRTNCLElBQUksQ0FBQyxJQUFJLFlBQVksS0FBSyxJQUFJLElBQUksWUFBWSxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLFFBQVEsRUFBRTtZQUVyRixJQUFJLElBQUksWUFBWSxJQUFJLEVBQUU7Z0JBQ3RCLElBQUksT0FBTyxHQUFzQixDQUFDLENBQUM7Z0JBQ25DLE9BQU8sT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFP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QUFFLFNBQVMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO3lCQUN4STtxQkFDSjtpQkFDSjtnQkFFRCxLQUFLLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQzthQUMzQjtZQUVELElBQUksS0FBSyxHQUFVLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFDaEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNyQyxPQUFPLEtBQUssQ0FBQztTQUVoQjthQUFNO1lBQ0gsSUFBSSxLQUFLLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbkMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3pDLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtnQkFDZixLQUFLLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQztnQkFDcEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUNsRCxPQUFPLEtBQUssQ0FBQzthQUNoQjtpQkFBTTtnQkFDSCxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLGNBQWM7YUFDbEU7U0FDSjtJQUVMLENBQUM7Q0FJSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEludGVycHJldGVyIH0gZnJvbSBcIi4uLy4uL2ludGVycHJldGVyL0ludGVycHJldGVyLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvUnVudGltZU9iamVjdC5qc1wiO1xyXG5pbXBvcnQgeyBNb2R1bGVTdG9yZSB9IGZyb20gXCIuLi9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IEFycmF5VHlwZSB9IGZyb20gXCIuL0FycmF5LmpzXCI7XHJcbmltcG9ydCB7IEludGVyZmFjZSwgS2xhc3MgfSBmcm9tIFwiLi9DbGFzcy5qc1wiO1xyXG5pbXBvcnQgeyBFbnVtLCBFbnVtUnVudGltZU9iamVjdCB9IGZyb20gXCIuL0VudW0uanNcIjtcclxuaW1wb3J0IHsgUHJpbWl0aXZlVHlwZSwgVHlwZSwgVmFsdWUgfSBmcm9tIFwiLi9UeXBlcy5qc1wiO1xyXG5cclxudHlwZSBTZXJpYWxpemVkT2JqZWN0ID0ge1xyXG4gICAgXCIha1wiPzogc3RyaW5nLCAvLyBDbGFzcyBpZGVudGlmaWVyIG9yIG9iamVjdCBpbmRleFxyXG4gICAgXCIhaVwiOiBudW1iZXIgIC8vIGluZGV4XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBKc29uVG9vbCB7XHJcbiAgICAvLyB0byBkZXNlcmlhbGl6ZTpcclxuICAgIGluZGV4VG9PYmplY3RNYXA6IHsgW2luZGV4OiBudW1iZXJdOiBWYWx1ZSB9O1xyXG4gICAgdmFsdWVzVG9SZXNvbHZlOiB7IHY6IFZhbHVlLCBpOiBudW1iZXIgfVtdO1xyXG5cclxuICAgIC8vIHRvIHNlcmlhbGl6ZTpcclxuICAgIG9iamVjdFRvSW5kZXhNYXA6IE1hcDxSdW50aW1lT2JqZWN0LCBudW1iZXI+O1xyXG4gICAgbmV4dEluZGV4OiBudW1iZXI7XHJcblxyXG4gICAgdG9Kc29uKHZhbHVlOiBWYWx1ZSk6IHN0cmluZyB7XHJcbiAgICAgICAgdGhpcy5vYmplY3RUb0luZGV4TWFwID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIHRoaXMubmV4dEluZGV4ID0gMDtcclxuICAgICAgICBsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KHRoaXMudG9Kc29uT2JqKHZhbHVlKSk7XHJcbiAgICAgICAgdGhpcy5vYmplY3RUb0luZGV4TWFwID0gbnVsbDsgLy8gZnJlZSBtZW1vcnlcclxuICAgICAgICByZXR1cm4ganNvbjtcclxuICAgIH1cclxuXHJcbiAgICB0b0pzb25PYmoodmFsdWU6IFZhbHVlKTogYW55IHtcclxuICAgICAgICBsZXQgdHlwZSA9IHZhbHVlLnR5cGU7XHJcbiAgICAgICAgbGV0IHYgPSB2YWx1ZS52YWx1ZTtcclxuICAgICAgICBpZiAodiA9PSBudWxsKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKCh0eXBlIGluc3RhbmNlb2YgS2xhc3MgfHwgdHlwZSBpbnN0YW5jZW9mIEludGVyZmFjZSkgJiYgdHlwZS5pZGVudGlmaWVyICE9IFwiU3RyaW5nXCIpIHtcclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlIGluc3RhbmNlb2YgRW51bSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGVudW1PYmogPSA8RW51bVJ1bnRpbWVPYmplY3Q+djtcclxuICAgICAgICAgICAgICAgIHJldHVybiBlbnVtT2JqLmVudW1WYWx1ZS5vcmRpbmFsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgcnRvID0gPFJ1bnRpbWVPYmplY3Q+djtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub2JqZWN0VG9Kc29uT2JqKHJ0byk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlIGluc3RhbmNlb2YgQXJyYXlUeXBlKSB7XHJcbiAgICAgICAgICAgIGxldCBhcnJheVZhbHVlczogVmFsdWVbXSA9IHY7XHJcbiAgICAgICAgICAgIHJldHVybiBhcnJheVZhbHVlcy5tYXAodmFsdWUgPT4gdGhpcy50b0pzb25PYmoodmFsdWUpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBwcmltaXRpdmUgVHlwZVxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9iamVjdFRvSnNvbk9iaihydG86IFJ1bnRpbWVPYmplY3QpOiBTZXJpYWxpemVkT2JqZWN0IHtcclxuICAgICAgICAvLyBXZSBzb2x2ZSBjaXJjdWxhciBvYmplY3QgcmVmZXJlbmNlcyBieSBzZXJpYWxpemluZyBhbiBpbmRleCB3aGVuIHRoZSBzYW1lIG9iamVjdCBvY2N1cnMgbW9yZSB0aGFuIG9uY2UuXHJcbiAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5vYmplY3RUb0luZGV4TWFwLmdldChydG8pO1xyXG4gICAgICAgIGlmIChpbmRleCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IFwiIWlcIjogaW5kZXggfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGluZGV4ID0gdGhpcy5uZXh0SW5kZXgrKztcclxuICAgICAgICB0aGlzLm9iamVjdFRvSW5kZXhNYXAuc2V0KHJ0bywgaW5kZXgpO1xyXG4gICAgICAgIGxldCBrbGFzczogS2xhc3MgPSA8S2xhc3M+cnRvLmNsYXNzO1xyXG5cclxuICAgICAgICAvLyBEb24ndCBzZXJpYWxpemUgc3lzdGVtIGNsYXNzZXMgdW5sZXNzIHRoZXkgYXJlIGV4cGxpY2l0ZWx5IHNlcmlhbGl6YWJsZVxyXG4gICAgICAgIGlmIChrbGFzcy5tb2R1bGUuaXNTeXN0ZW1Nb2R1bGUgJiYga2xhc3MuZ2V0TWV0aG9kQnlTaWduYXR1cmUoXCJTdHJpbmcgdG9Kc29uKClcIikgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBzZXJpYWxpemVkT2JqZWN0OiBTZXJpYWxpemVkT2JqZWN0ID0geyBcIiFrXCI6IGtsYXNzLmlkZW50aWZpZXIsIFwiIWlcIjogaW5kZXggfTtcclxuICAgICAgICB3aGlsZSAoa2xhc3MgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBsZXQgZmlyc3Q6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgICAgICAgICBsZXQgc2VyaWFsaXplZEF0dHJpYnV0ZXM6IGFueTtcclxuICAgICAgICAgICAgZm9yIChsZXQgYXR0cmlidXRlIG9mIGtsYXNzLmF0dHJpYnV0ZXMpIHtcclxuICAgICAgICAgICAgICAgIGlmICghYXR0cmlidXRlLmlzU3RhdGljICYmICFhdHRyaWJ1dGUuaXNUcmFuc2llbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VyaWFsaXplZEF0dHJpYnV0ZXMgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VyaWFsaXplZE9iamVjdFtrbGFzcy5pZGVudGlmaWVyXSA9IHNlcmlhbGl6ZWRBdHRyaWJ1dGVzO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzZXJpYWxpemVkQXR0cmlidXRlc1thdHRyaWJ1dGUuaWRlbnRpZmllcl0gPSB0aGlzLnRvSnNvbk9iaihydG8uYXR0cmlidXRlc1thdHRyaWJ1dGUuaW5kZXhdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAga2xhc3MgPSBrbGFzcy5iYXNlQ2xhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gc2VyaWFsaXplZE9iamVjdDtcclxuICAgIH1cclxuXHJcbiAgICBmcm9tSnNvbihqc29uU3RyaW5nOiBzdHJpbmcsIHR5cGU6IFR5cGUsIG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyKTogYW55IHtcclxuICAgICAgICB0aGlzLmluZGV4VG9PYmplY3RNYXAgPSB7fTtcclxuICAgICAgICB0aGlzLnZhbHVlc1RvUmVzb2x2ZSA9IFtdO1xyXG5cclxuICAgICAgICBsZXQgb2JqOiBhbnkgPSBKU09OLnBhcnNlKGpzb25TdHJpbmcpO1xyXG4gICAgICAgIGxldCByZXQgPSB0aGlzLmZyb21Kc29uT2JqKG9iaiwgdHlwZSwgbW9kdWxlU3RvcmUsIGludGVycHJldGVyKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgdnRyIG9mIHRoaXMudmFsdWVzVG9SZXNvbHZlKSB7XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuaW5kZXhUb09iamVjdE1hcFt2dHIuaV07XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB2dHIudi50eXBlID0gdmFsdWUudHlwZTtcclxuICAgICAgICAgICAgICAgIHZ0ci52LnZhbHVlID0gdmFsdWUudmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5kZXhUb09iamVjdE1hcCA9IG51bGw7IC8vIGZyZWUgbWVtb3J5XHJcbiAgICAgICAgdGhpcy52YWx1ZXNUb1Jlc29sdmUgPSBudWxsO1xyXG4gICAgICAgIHJldHVybiByZXQudmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZnJvbUpzb25PYmoob2JqOiBhbnksIHR5cGU6IFR5cGUsIG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyKTogVmFsdWUge1xyXG4gICAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHsgdHlwZTogdHlwZSwgdmFsdWU6IG51bGwgfTtcclxuXHJcbiAgICAgICAgaWYgKCh0eXBlIGluc3RhbmNlb2YgS2xhc3MgfHwgdHlwZSBpbnN0YW5jZW9mIEludGVyZmFjZSkgJiYgdHlwZS5pZGVudGlmaWVyICE9IFwiU3RyaW5nXCIpIHtcclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlIGluc3RhbmNlb2YgRW51bSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0eXBlLmluZGV4VG9JbmZvTWFwW29ial0ub2JqZWN0XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBzZXJpYWxpemVkT2JqZWN0ID0gPFNlcmlhbGl6ZWRPYmplY3Q+b2JqO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vYmplY3RGcm9tSnNvbk9iaihzZXJpYWxpemVkT2JqZWN0LCB0eXBlLCBtb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXIpO1xyXG5cclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGUgaW5zdGFuY2VvZiBBcnJheVR5cGUpIHtcclxuICAgICAgICAgICAgbGV0IGpzb25BcnJheTogYW55W10gPSBvYmo7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IGpzb25BcnJheS5tYXAodiA9PiB0aGlzLmZyb21Kc29uT2JqKHYsIHR5cGUuYXJyYXlPZlR5cGUsIG1vZHVsZVN0b3JlLCBpbnRlcnByZXRlcikpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBwcmltaXRpdmUgVHlwZVxyXG4gICAgICAgICAgICByZXR1cm4geyB0eXBlOiB0eXBlLCB2YWx1ZTogb2JqIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG9iamVjdEZyb21Kc29uT2JqKHNlcmlhbGl6ZWRPYmplY3Q6IFNlcmlhbGl6ZWRPYmplY3QsIHR5cGU6IEtsYXNzIHwgSW50ZXJmYWNlLCBtb2R1bGVTdG9yZTogTW9kdWxlU3RvcmUsXHJcbiAgICAgICAgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyKTogVmFsdWUge1xyXG5cclxuICAgICAgICBsZXQgaWRlbnRpZmllcjogc3RyaW5nID0gc2VyaWFsaXplZE9iamVjdFtcIiFrXCJdO1xyXG4gICAgICAgIGxldCBpbmRleCA9IHNlcmlhbGl6ZWRPYmplY3RbXCIhaVwiXTtcclxuICAgICAgICBpZiAoaWRlbnRpZmllciAhPSBudWxsKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQga2xhc3MxOiBLbGFzcyA9IDxLbGFzcz5tb2R1bGVTdG9yZS5nZXRUeXBlKGlkZW50aWZpZXIpLnR5cGU7XHJcbiAgICAgICAgICAgIGxldCBrbGFzcyA9IGtsYXNzMTtcclxuXHJcbiAgICAgICAgICAgIGxldCBydG86IFJ1bnRpbWVPYmplY3QgPSBpbnRlcnByZXRlci5pbnN0YW50aWF0ZU9iamVjdEltbWVkaWF0ZWx5KGtsYXNzKTtcclxuXHJcbiAgICAgICAgICAgIHdoaWxlIChrbGFzcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYXR0cmlidXRlcyA9IHJ0by5hdHRyaWJ1dGVzO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNlcmlhbGl6ZWRBdHRyaWJ1dGVzID0gc2VyaWFsaXplZE9iamVjdFtrbGFzcy5pZGVudGlmaWVyXTtcclxuICAgICAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzICE9IG51bGwgJiYgc2VyaWFsaXplZE9iamVjdCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgYXR0cmlidXRlIG9mIGtsYXNzLmF0dHJpYnV0ZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhdHRyaWJ1dGUuaXNTdGF0aWMgJiYgIWF0dHJpYnV0ZS5pc1RyYW5zaWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlc1thdHRyaWJ1dGUuaW5kZXhdID0gdGhpcy5mcm9tSnNvbk9iaihzZXJpYWxpemVkQXR0cmlidXRlc1thdHRyaWJ1dGUuaWRlbnRpZmllcl0sIGF0dHJpYnV0ZS50eXBlLCBtb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGtsYXNzID0ga2xhc3MuYmFzZUNsYXNzO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgdmFsdWU6IFZhbHVlID0geyB0eXBlOiBrbGFzczEsIHZhbHVlOiBydG8gfTtcclxuICAgICAgICAgICAgdGhpcy5pbmRleFRvT2JqZWN0TWFwW2luZGV4XSA9IHZhbHVlO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBpbmRleCA9IHNlcmlhbGl6ZWRPYmplY3RbXCIhaVwiXTtcclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5pbmRleFRvT2JqZWN0TWFwW2luZGV4XTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0geyB0eXBlOiB0eXBlLCB2YWx1ZTogbnVsbCB9O1xyXG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZXNUb1Jlc29sdmUucHVzaCh7IHY6IHZhbHVlLCBpOiBpbmRleCB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IHR5cGU6IHZhbHVlLnR5cGUsIHZhbHVlOiB2YWx1ZS52YWx1ZSB9OyAvLyByZXR1cm4gY29weVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcblxyXG5cclxufVxyXG5cclxuXHJcbiJdfQ==