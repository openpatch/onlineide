import { TokenType, TokenTypeReadable } from "../lexer/Token.js";
import { Klass } from "../types/Class.js";
export class ProgramPrinter {
    constructor(main, $bottomDiv) {
        this.main = main;
        this.$bottomDiv = $bottomDiv;
        this.$pcodeTab = this.$bottomDiv.find('.jo_tabs>.jo_pcodeTab');
    }
    showNode(node) {
        if (!this.$pcodeTab.hasClass('jo_active'))
            return;
        let $pCodeTab = this.$bottomDiv.find('.jo_tabs>.jo_pcodeTab');
        $pCodeTab.find('div').removeClass("jo_revealProgramPointer");
        let $div = node["$div"];
        if ($div != null) {
            $div.addClass("jo_revealProgramPointer");
            let pos = $div.position().top + this.$pcodeTab.scrollTop();
            pos -= this.$pcodeTab.height() / 2;
            this.$pcodeTab.scrollTop(pos);
            // $div[0].scrollIntoView({behavior: "smooth", block: "end", inline: "nearest"});
        }
    }
    initGUI() {
        this.$pcodeTab.on('myshow', () => {
            this.main.printProgram();
        });
    }
    printModuleToBottomDiv(workspace, m) {
        if (m == null)
            return;
        if (!this.$pcodeTab.hasClass('jo_active'))
            return;
        let $pcode = this.$bottomDiv.find('.jo_tabs>.jo_pcodeTab');
        $pcode.html("");
        $pcode.append(this.printModule(m));
        if (workspace != null && workspace.compilerMessage != null) {
            $pcode.prepend("<div>" + workspace.compilerMessage + "</div>");
        }
        $pcode.find('.jo_label_destination').on("click", (ev) => {
            let dest = jQuery(ev.target).data('destination');
            if (dest == null) {
                dest = jQuery(ev.target).parent().data('destination');
            }
            if (dest != null) {
                let $dest = this.$pcodeTab.find('.' + dest);
                $dest[0].scrollIntoView();
            }
        });
    }
    printModule(m) {
        if (m == null) {
            return [jQuery("<div></div>")];
        }
        let s = [];
        if (m.mainProgram != null) {
            s.push(jQuery("<h3>Main Program: </h3>"));
            s = s.concat(this.print(m.mainProgram.statements));
        }
        if (m.typeStore != null && m.typeStore.typeList != null) {
            for (let c of m.typeStore.typeList) {
                if (c instanceof Klass) {
                    s.push(jQuery("<h2>Class " + c.identifier + ":</h2>"));
                    if (c.attributeInitializationProgram.statements.length > 0) {
                        s.push(jQuery("<h3>Attribute-initialization:</h3>"));
                        s = s.concat(this.print(c.attributeInitializationProgram.statements));
                    }
                    for (let m of c.methods) {
                        if (m.program != null) {
                            s.push(jQuery("<h3>Method " + m.signature + ":</h3>"));
                            s = s.concat(this.print(m.program.statements));
                        }
                    }
                    for (let m of c.staticClass.methods) {
                        if (m.program != null) {
                            s.push(jQuery("<h3>Static Method " + m.signature + ":</h3>"));
                            s = s.concat(this.print(m.program.statements));
                        }
                    }
                }
            }
        }
        return s;
    }
    print(statements, indent = "") {
        let labels = new Map();
        let lastLabelNumber = 0;
        for (let statement of statements) {
            if (statement.type == TokenType.jumpAlways || statement.type == TokenType.jumpIfFalse ||
                statement.type == TokenType.jumpIfTrue || statement.type == TokenType.jumpIfFalseAndLeaveOnStack ||
                statement.type == TokenType.jumpIfTrueAndLeaveOnStack || statement.type == TokenType.extendedForLoopCheckCounterAndGetElement) {
                let dest = statement.destination;
                let label = labels.get(dest);
                if (label == null) {
                    labels.set(dest, {
                        number: lastLabelNumber++
                    });
                }
            }
            if (statement.type == TokenType.keywordSwitch) {
                for (let value in statement.destinationMap) {
                    let dest = statement.destinationMap[value];
                    let label = labels.get(dest);
                    if (label == null) {
                        labels.set(dest, {
                            number: lastLabelNumber++
                        });
                    }
                }
                if (statement.defaultDestination != null) {
                    let label = labels.get(statement.defaultDestination);
                    if (label == null) {
                        labels.set(statement.defaultDestination, {
                            number: lastLabelNumber++
                        });
                    }
                }
            }
        }
        let s = [];
        let i = 0;
        for (let statement of statements) {
            s.push(this.printNode(statement, indent, i, labels));
            i++;
        }
        return s;
    }
    printNode(node, indent, n, labels) {
        let s = indent;
        let label = labels.get(n);
        if (label != null) {
            s += "<span style='font-weight: bold' class='label" + label.number + "'>Label&nbsp;<span style='color: green'>" + label.number + ":</span></span><br>";
        }
        if (node.position != null) {
            s += "(l" + this.format3(node.position.line) + ",&nbsp;c" + this.format3(node.position.column) + "): ";
        }
        else {
            s += "(l&nbsp;xxx,&nbsp;c&nbsp;xxx):";
        }
        // s += "<span style='fontweight: bold; color: darkgreen'>[" + n + "]</span>&nbsp;";
        s += "<span style='fontweight: bold; color: #8080ff'>" + TokenType[node.type] + "</span>&nbsp;";
        let s1 = "";
        switch (node.type) {
            case TokenType.localVariableDeclaration:
                s1 += "V: " + this.printVariable(node.variable) + "&nbsp;&nbsp;pushToStackTop: " + node.pushOnTopOfStackForInitialization;
                break;
            case TokenType.heapVariableDeclaration:
                s1 += "V: " + this.printVariable(node.variable) + "&nbsp;&nbsp;pushToStackTop: " + node.pushOnTopOfStackForInitialization;
                break;
            case TokenType.pushLocalVariableToStack:
                s1 += "StackPos: " + node.stackposOfVariable;
                break;
            case TokenType.pushFromHeapToStack:
                s1 += "v: " + node.identifier;
                break;
            case TokenType.pushAttribute:
                s1 += "Attribut: " + node.attributeIdentifier + ", use THIS-Object: " + node.useThisObject;
                break;
            case TokenType.assignment:
            case TokenType.plusAssignment:
            case TokenType.minusAssignment:
            case TokenType.multiplicationAssignment:
            case TokenType.divisionAssignment:
                s1 += "Assignmenttype: " + TokenTypeReadable[node.type] + "&nbsp;&nbsp;";
                if (node.type == TokenType.assignment) {
                    s1 += ", leaveValueOnStack: " + node.leaveValueOnStack;
                }
                break;
            case TokenType.binaryOp:
            case TokenType.unaryOp:
                s1 += "Operator: " + TokenTypeReadable[node.operator];
                break;
            case TokenType.pushConstant:
                s1 += "Value: " + node.value;
                break;
            case TokenType.pushStaticClassObject:
                s1 += "Static class: " + node.klass.identifier;
                break;
            case TokenType.castValue:
                s1 += "New Type: " + node.newType.identifier;
                break;
            case TokenType.selectArrayElement:
                break;
            case TokenType.callMethod:
                s1 += node.method.identifier;
                s1 += ", StackframeBegin: " + node.stackframeBegin;
                break;
            case TokenType.decreaseStackpointer:
                s1 += "count: " + node.popCount;
                break;
            case TokenType.return:
                s1 += "copyReturnValueToStackframePos0: " + node.copyReturnValueToStackframePos0;
                break;
            case TokenType.extendedForLoopCheckCounterAndGetElement:
            case TokenType.jumpAlways:
            case TokenType.jumpIfFalse:
            case TokenType.jumpIfTrue:
            case TokenType.jumpIfFalseAndLeaveOnStack:
            case TokenType.jumpIfTrueAndLeaveOnStack:
                let number = labels.get(node.destination).number;
                s1 += "destination: <span style='font-weight: bold' class='jo_label_destination' data-destination='label" + number + "'>Label<span style='color: green'>&nbsp;" + number + "</span></span>";
                break;
            case TokenType.incrementDecrementBefore:
            case TokenType.incrementDecrementAfter:
                s1 += "amount: " + node.incrementDecrementBy;
                break;
            case TokenType.beginArray:
                s1 += "type: " + node.arrayType.identifier;
                break;
            case TokenType.addToArray:
                s1 += "count: " + node.numberOfElementsToAdd;
                break;
            case TokenType.pushEmptyArray:
                s1 += "type: " + node.arrayType.identifier;
                s1 += ", dimension: " + node.dimension;
                break;
            case TokenType.keywordSwitch:
                s1 += "destinationMap: {";
                for (let key in node.destinationMap) {
                    let number = labels.get(node.destinationMap[key]).number;
                    s1 += key + ": <span style='font-weight: bold' class='jo_label_destination' data-destination='label" + number + "'>Label<span style='color: green'>&nbsp;" + number + "</span></span>" + ", ";
                }
                if (s1.endsWith(", "))
                    s1 = s1.substring(0, s1.length - 2);
                s1 += "}";
                if (node.defaultDestination != null) {
                    let number = labels.get(node.defaultDestination).number;
                    s1 += ", defaultDestination: <span style='font-weight: bold' class='jo_label_destination' data-destination='label" + number + "'>Label<span style='color: green'>&nbsp;" + number + "</span></span>";
                }
                break;
            case TokenType.pushStaticAttribute:
                if (node.klass != null)
                    s1 += "class: " + node.klass.identifier + ", attribute: " + node.attributeIdentifier;
                break;
            case TokenType.newObject:
                s1 += "class: " + node.class.identifier;
                break;
        }
        if (s1 != "")
            s += ` [${s1}]`;
        if (node.stepFinished == true) {
            s += "::";
        }
        s = "<div>" + s + "</div>";
        let $div = jQuery(s);
        node["$div"] = $div;
        return $div;
    }
    printVariable(v) {
        return v.type.identifier + " " + v.identifier + (v.stackPos == null ? "" : " (sp: " + v.stackPos + ")");
    }
    format3(n) {
        if (n >= 100)
            return "" + n;
        if (n >= 10)
            return "&nbsp;" + n;
        return "&nbsp;&nbsp;" + n;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvZ3JhbVByaW50ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvbXBpbGVyL3BhcnNlci9Qcm9ncmFtUHJpbnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFJakUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBUzFDLE1BQU0sT0FBTyxjQUFjO0lBTXZCLFlBQW9CLElBQWMsRUFBVSxVQUErQjtRQUF2RCxTQUFJLEdBQUosSUFBSSxDQUFVO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBcUI7UUFDdkUsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBRW5FLENBQUM7SUFFRCxRQUFRLENBQUMsSUFBZTtRQUVwQixJQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO1lBQUUsT0FBTztRQUVqRCxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQzlELFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDN0QsSUFBSSxJQUFJLEdBQXVCLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QyxJQUFHLElBQUksSUFBSSxJQUFJLEVBQUM7WUFDWixJQUFJLENBQUMsUUFBUSxDQUFDLHlCQUF5QixDQUFDLENBQUM7WUFDekMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQzNELEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxD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QUFLLENBQUMsVUFBVSxDQUFDO2dCQUN4QyxNQUFNO1NBQ2I7UUFHRCxJQUFHLEVBQUUsSUFBSSxFQUFFO1lBQUUsQ0FBQyxJQUFJLEtBQUssRUFBRSxHQUFHLENBQUM7UUFFN0IsSUFBSSxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksRUFBRTtZQUMzQixDQUFDLElBQUksSUFBSSxDQUFBO1NBQ1o7UUFFRCxDQUFDLEdBQUcsT0FBTyxHQUFHLENBQUMsR0FBRyxRQUFRLENBQUM7UUFFM0IsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXJCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7UUFFcEIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELGFBQWEsQ0FBQyxDQUFXO1FBQ3JCLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQSxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUMzRyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQVM7UUFDYixJQUFHLENBQUMsSUFBSSxHQUFHO1lBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzNCLElBQUcsQ0FBQyxJQUFJLEVBQUU7WUFBRSxPQUFPLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDaEMsT0FBTyxjQUFjLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRva2VuVHlwZSwgVG9rZW5UeXBlUmVhZGFibGUgfSBmcm9tIFwiLi4vbGV4ZXIvVG9rZW4uanNcIjtcclxuaW1wb3J0IHsgVmFyaWFibGUgfSBmcm9tIFwiLi4vdHlwZXMvVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgU3RhdGVtZW50IH0gZnJvbSBcIi4vUHJvZ3JhbS5qc1wiO1xyXG5pbXBvcnQgeyBNb2R1bGUgfSBmcm9tIFwiLi9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MgfSBmcm9tIFwiLi4vdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgV29ya3NwYWNlIH0gZnJvbSBcIi4uLy4uL3dvcmtzcGFjZS9Xb3Jrc3BhY2UuanNcIjtcclxuaW1wb3J0IHsgTWFpbiB9IGZyb20gXCIuLi8uLi9tYWluL01haW4uanNcIjtcclxuaW1wb3J0IHsgTWFpbkJhc2UgfSBmcm9tIFwiLi4vLi4vbWFpbi9NYWluQmFzZS5qc1wiO1xyXG5cclxudHlwZSBMYWJlbCA9IHtcclxuICAgIG51bWJlcjogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUHJvZ3JhbVByaW50ZXIge1xyXG5cclxuXHJcblxyXG4gICAgcHJpdmF0ZSAkcGNvZGVUYWI6IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBtYWluOiBNYWluQmFzZSwgcHJpdmF0ZSAkYm90dG9tRGl2OiBKUXVlcnk8SFRNTEVsZW1lbnQ+KXtcclxuICAgICAgICB0aGlzLiRwY29kZVRhYiA9IHRoaXMuJGJvdHRvbURpdi5maW5kKCcuam9fdGFicz4uam9fcGNvZGVUYWInKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2hvd05vZGUobm9kZTogU3RhdGVtZW50KSB7XHJcblxyXG4gICAgICAgIGlmKCF0aGlzLiRwY29kZVRhYi5oYXNDbGFzcygnam9fYWN0aXZlJykpIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0ICRwQ29kZVRhYiA9IHRoaXMuJGJvdHRvbURpdi5maW5kKCcuam9fdGFicz4uam9fcGNvZGVUYWInKTtcclxuICAgICAgICAkcENvZGVUYWIuZmluZCgnZGl2JykucmVtb3ZlQ2xhc3MoXCJqb19yZXZlYWxQcm9ncmFtUG9pbnRlclwiKTtcclxuICAgICAgICBsZXQgJGRpdjpKUXVlcnk8SFRNTEVsZW1lbnQ+ID0gbm9kZVtcIiRkaXZcIl07XHJcbiAgICAgICAgaWYoJGRpdiAhPSBudWxsKXtcclxuICAgICAgICAgICAgJGRpdi5hZGRDbGFzcyhcImpvX3JldmVhbFByb2dyYW1Qb2ludGVyXCIpO1xyXG4gICAgICAgICAgICBsZXQgcG9zID0gJGRpdi5wb3NpdGlvbigpLnRvcCArIHRoaXMuJHBjb2RlVGFiLnNjcm9sbFRvcCgpO1xyXG4gICAgICAgICAgICBwb3MgLT0gdGhpcy4kcGNvZGVUYWIuaGVpZ2h0KCkvMjtcclxuICAgICAgICAgICAgdGhpcy4kcGNvZGVUYWIuc2Nyb2xsVG9wKHBvcyk7XHJcblxyXG4gICAgICAgICAgICAvLyAkZGl2WzBdLnNjcm9sbEludG9WaWV3KHtiZWhhdmlvcjogXCJzbW9vdGhcIiwgYmxvY2s6IFwiZW5kXCIsIGlubGluZTogXCJuZWFyZXN0XCJ9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEdVSSgpe1xyXG4gICAgICAgIHRoaXMuJHBjb2RlVGFiLm9uKCdteXNob3cnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubWFpbi5wcmludFByb2dyYW0oKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpbnRNb2R1bGVUb0JvdHRvbURpdih3b3Jrc3BhY2U6IFdvcmtzcGFjZSwgbTogTW9kdWxlKXtcclxuXHJcbiAgICAgICAgaWYobSA9PSBudWxsKSByZXR1cm47XHJcblxyXG4gICAgICAgIGlmKCF0aGlzLiRwY29kZVRhYi5oYXNDbGFzcygnam9fYWN0aXZlJykpIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0ICRwY29kZSA9IHRoaXMuJGJvdHRvbURpdi5maW5kKCcuam9fdGFicz4uam9fcGNvZGVUYWInKTtcclxuXHJcbiAgICAgICAgJHBjb2RlLmh0bWwoXCJcIik7XHJcbiAgICAgICAgJHBjb2RlLmFwcGVuZCh0aGlzLnByaW50TW9kdWxlKG0pKTtcclxuXHJcbiAgICAgICAgaWYod29ya3NwYWNlICE9IG51bGwgJiYgd29ya3NwYWNlLmNvbXBpbGVyTWVzc2FnZSAhPSBudWxsKXtcclxuICAgICAgICAgICAgJHBjb2RlLnByZXBlbmQoXCI8ZGl2PlwiICsgd29ya3NwYWNlLmNvbXBpbGVyTWVzc2FnZSArIFwiPC9kaXY+XCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuXHJcbiAgICAgICAgJHBjb2RlLmZpbmQoJy5qb19sYWJlbF9kZXN0aW5hdGlvbicpLm9uKFwiY2xpY2tcIiwgKGV2KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBkZXN0ID0galF1ZXJ5KGV2LnRhcmdldCkuZGF0YSgnZGVzdGluYXRpb24nKTtcclxuICAgICAgICAgICAgaWYoZGVzdCA9PSBudWxsKXtcclxuICAgICAgICAgICAgICAgIGRlc3QgPSBqUXVlcnkoZXYudGFyZ2V0KS5wYXJlbnQoKS5kYXRhKCdkZXN0aW5hdGlvbicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKGRlc3QgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICBsZXQgJGRlc3QgPSB0aGlzLiRwY29kZVRhYi5maW5kKCcuJyArIGRlc3QpO1xyXG4gICAgICAgICAgICAgICAgJGRlc3RbMF0uc2Nyb2xsSW50b1ZpZXcoKTsgICAgICAgICAgICBcclxuICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcmludE1vZHVsZShtOiBNb2R1bGUpOiBKUXVlcnk8SFRNTEVsZW1lbnQ+W10ge1xyXG5cclxuICAgICAgICBpZiAobSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbalF1ZXJ5KFwiPGRpdj48L2Rpdj5cIildO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHM6IEpRdWVyeTxIVE1MRWxlbWVudD5bXSA9IFtdO1xyXG5cclxuICAgICAgICBpZiAobS5tYWluUHJvZ3JhbSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHMucHVzaChqUXVlcnkoXCI8aDM+TWFpbiBQcm9ncmFtOiA8L2gzPlwiKSk7XHJcbiAgICAgICAgICAgIHMgPSBzLmNvbmNhdCh0aGlzLnByaW50KG0ubWFpblByb2dyYW0uc3RhdGVtZW50cykpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG0udHlwZVN0b3JlICE9IG51bGwgJiYgbS50eXBlU3RvcmUudHlwZUxpc3QgIT0gbnVsbCkge1xyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgYyBvZiBtLnR5cGVTdG9yZS50eXBlTGlzdCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGMgaW5zdGFuY2VvZiBLbGFzcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHMucHVzaChqUXVlcnkoXCI8aDI+Q2xhc3MgXCIgKyBjLmlkZW50aWZpZXIgKyBcIjo8L2gyPlwiKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKGMuYXR0cmlidXRlSW5pdGlhbGl6YXRpb25Qcm9ncmFtLnN0YXRlbWVudHMubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHMucHVzaChqUXVlcnkoXCI8aDM+QXR0cmlidXRlLWluaXRpYWxpemF0aW9uOjwvaDM+XCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuY29uY2F0KHRoaXMucHJpbnQoYy5hdHRyaWJ1dGVJbml0aWFsaXphdGlvblByb2dyYW0uc3RhdGVtZW50cykpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBtIG9mIGMubWV0aG9kcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobS5wcm9ncmFtICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMucHVzaChqUXVlcnkoXCI8aDM+TWV0aG9kIFwiICsgbS5zaWduYXR1cmUgKyBcIjo8L2gzPlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gcy5jb25jYXQodGhpcy5wcmludChtLnByb2dyYW0uc3RhdGVtZW50cykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IG0gb2YgYy5zdGF0aWNDbGFzcy5tZXRob2RzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtLnByb2dyYW0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5wdXNoKGpRdWVyeShcIjxoMz5TdGF0aWMgTWV0aG9kIFwiICsgbS5zaWduYXR1cmUgKyBcIjo8L2gzPlwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gcy5jb25jYXQodGhpcy5wcmludChtLnByb2dyYW0uc3RhdGVtZW50cykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHM7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaW50KHN0YXRlbWVudHM6IFN0YXRlbWVudFtdLCBpbmRlbnQ6IHN0cmluZyA9IFwiXCIpOiBKUXVlcnk8SFRNTEVsZW1lbnQ+W10ge1xyXG5cclxuICAgICAgICBsZXQgbGFiZWxzOiBNYXA8bnVtYmVyLCBMYWJlbD4gPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgbGV0IGxhc3RMYWJlbE51bWJlcjogbnVtYmVyID0gMDtcclxuXHJcbiAgICAgICAgZm9yKGxldCBzdGF0ZW1lbnQgb2Ygc3RhdGVtZW50cyl7XHJcbiAgICAgICAgICAgIGlmKHN0YXRlbWVudC50eXBlID09IFRva2VuVHlwZS5qdW1wQWx3YXlzIHx8IHN0YXRlbWVudC50eXBlID09IFRva2VuVHlwZS5qdW1wSWZGYWxzZSB8fCBcclxuICAgICAgICAgICAgICAgIHN0YXRlbWVudC50eXBlID09IFRva2VuVHlwZS5qdW1wSWZUcnVlIHx8IHN0YXRlbWVudC50eXBlID09IFRva2VuVHlwZS5qdW1wSWZGYWxzZUFuZExlYXZlT25TdGFjayB8fCBcclxuICAgICAgICAgICAgICAgIHN0YXRlbWVudC50eXBlID09IFRva2VuVHlwZS5qdW1wSWZUcnVlQW5kTGVhdmVPblN0YWNrIHx8IHN0YXRlbWVudC50eXBlID09VG9rZW5UeXBlLmV4dGVuZGVkRm9yTG9vcENoZWNrQ291bnRlckFuZEdldEVsZW1lbnQgKXtcclxuICAgICAgICAgICAgICAgIGxldCBkZXN0ID0gc3RhdGVtZW50LmRlc3RpbmF0aW9uO1xyXG4gICAgICAgICAgICAgICAgbGV0IGxhYmVsID0gbGFiZWxzLmdldChkZXN0KTtcclxuICAgICAgICAgICAgICAgIGlmKGxhYmVsID09IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgICAgIGxhYmVscy5zZXQoZGVzdCwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBudW1iZXI6IGxhc3RMYWJlbE51bWJlcisrXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYoc3RhdGVtZW50LnR5cGUgPT0gVG9rZW5UeXBlLmtleXdvcmRTd2l0Y2gpe1xyXG4gICAgICAgICAgICAgICAgZm9yKGxldCB2YWx1ZSBpbiBzdGF0ZW1lbnQuZGVzdGluYXRpb25NYXApe1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBkZXN0ID0gc3RhdGVtZW50LmRlc3RpbmF0aW9uTWFwW3ZhbHVlXTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbGFiZWwgPSBsYWJlbHMuZ2V0KGRlc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGxhYmVsID09IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbHMuc2V0KGRlc3QsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogbGFzdExhYmVsTnVtYmVyKytcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYoc3RhdGVtZW50LmRlZmF1bHREZXN0aW5hdGlvbiAhPSBudWxsKXtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbGFiZWwgPSBsYWJlbHMuZ2V0KHN0YXRlbWVudC5kZWZhdWx0RGVzdGluYXRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGxhYmVsID09IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbHMuc2V0KHN0YXRlbWVudC5kZWZhdWx0RGVzdGluYXRpb24sIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogbGFzdExhYmVsTnVtYmVyKytcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBzOiBKUXVlcnk8SFRNTEVsZW1lbnQ+W10gPSBbXTtcclxuICAgICAgICBsZXQgaSA9IDA7XHJcblxyXG4gICAgICAgIGZvciAobGV0IHN0YXRlbWVudCBvZiBzdGF0ZW1lbnRzKSB7XHJcbiAgICAgICAgICAgIHMucHVzaCh0aGlzLnByaW50Tm9kZShzdGF0ZW1lbnQsIGluZGVudCwgaSwgbGFiZWxzKSk7XHJcbiAgICAgICAgICAgIGkrKztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaW50Tm9kZShub2RlOiBTdGF0ZW1lbnQsIGluZGVudDogc3RyaW5nLCBuOiBudW1iZXIsIGxhYmVsczogTWFwPG51bWJlciwgTGFiZWw+KTogSlF1ZXJ5PEhUTUxFbGVtZW50PiB7XHJcblxyXG4gICAgICAgIGxldCBzID0gaW5kZW50O1xyXG5cclxuICAgICAgICBsZXQgbGFiZWwgPSBsYWJlbHMuZ2V0KG4pO1xyXG4gICAgICAgIGlmKGxhYmVsICE9IG51bGwpe1xyXG4gICAgICAgICAgICBzICs9IFwiPHNwYW4gc3R5bGU9J2ZvbnQtd2VpZ2h0OiBib2xkJyBjbGFzcz0nbGFiZWxcIiArIGxhYmVsLm51bWJlciArIFwiJz5MYWJlbCZuYnNwOzxzcGFuIHN0eWxlPSdjb2xvcjogZ3JlZW4nPlwiICsgbGFiZWwubnVtYmVyICsgXCI6PC9zcGFuPjwvc3Bhbj48YnI+XCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobm9kZS5wb3NpdGlvbiAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHMgKz0gXCIobFwiICsgdGhpcy5mb3JtYXQzKG5vZGUucG9zaXRpb24ubGluZSkgKyBcIiwmbmJzcDtjXCIgKyB0aGlzLmZvcm1hdDMobm9kZS5wb3NpdGlvbi5jb2x1bW4pICsgXCIpOiBcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzICs9IFwiKGwmbmJzcDt4eHgsJm5ic3A7YyZuYnNwO3h4eCk6XCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHMgKz0gXCI8c3BhbiBzdHlsZT0nZm9udHdlaWdodDogYm9sZDsgY29sb3I6IGRhcmtncmVlbic+W1wiICsgbiArIFwiXTwvc3Bhbj4mbmJzcDtcIjtcclxuICAgICAgICBzICs9IFwiPHNwYW4gc3R5bGU9J2ZvbnR3ZWlnaHQ6IGJvbGQ7IGNvbG9yOiAjODA4MGZmJz5cIiArIFRva2VuVHlwZVtub2RlLnR5cGVdICsgXCI8L3NwYW4+Jm5ic3A7XCI7XHJcblxyXG4gICAgICAgIGxldCBzMTogc3RyaW5nID0gXCJcIjtcclxuICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5sb2NhbFZhcmlhYmxlRGVjbGFyYXRpb246XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcIlY6IFwiICsgdGhpcy5wcmludFZhcmlhYmxlKG5vZGUudmFyaWFibGUpICsgXCImbmJzcDsmbmJzcDtwdXNoVG9TdGFja1RvcDogXCIgKyBub2RlLnB1c2hPblRvcE9mU3RhY2tGb3JJbml0aWFsaXphdGlvbjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5oZWFwVmFyaWFibGVEZWNsYXJhdGlvbjpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiVjogXCIgKyB0aGlzLnByaW50VmFyaWFibGUobm9kZS52YXJpYWJsZSkgKyBcIiZuYnNwOyZuYnNwO3B1c2hUb1N0YWNrVG9wOiBcIiArIG5vZGUucHVzaE9uVG9wT2ZTdGFja0ZvckluaXRpYWxpemF0aW9uO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLnB1c2hMb2NhbFZhcmlhYmxlVG9TdGFjazpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiU3RhY2tQb3M6IFwiICsgbm9kZS5zdGFja3Bvc09mVmFyaWFibGU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUucHVzaEZyb21IZWFwVG9TdGFjazpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwidjogXCIgKyBub2RlLmlkZW50aWZpZXI7ICAgIFxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUucHVzaEF0dHJpYnV0ZTpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiQXR0cmlidXQ6IFwiICsgbm9kZS5hdHRyaWJ1dGVJZGVudGlmaWVyICsgXCIsIHVzZSBUSElTLU9iamVjdDogXCIgKyBub2RlLnVzZVRoaXNPYmplY3RcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5hc3NpZ25tZW50OlxyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5wbHVzQXNzaWdubWVudDpcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUubWludXNBc3NpZ25tZW50OlxyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5tdWx0aXBsaWNhdGlvbkFzc2lnbm1lbnQ6XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLmRpdmlzaW9uQXNzaWdubWVudDpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiQXNzaWdubWVudHR5cGU6IFwiICsgVG9rZW5UeXBlUmVhZGFibGVbbm9kZS50eXBlXSArIFwiJm5ic3A7Jm5ic3A7XCI7XHJcbiAgICAgICAgICAgICAgICBpZihub2RlLnR5cGUgPT0gVG9rZW5UeXBlLmFzc2lnbm1lbnQpe1xyXG4gICAgICAgICAgICAgICAgICAgIHMxICs9IFwiLCBsZWF2ZVZhbHVlT25TdGFjazogXCIgKyBub2RlLmxlYXZlVmFsdWVPblN0YWNrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuYmluYXJ5T3A6XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLnVuYXJ5T3A6XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcIk9wZXJhdG9yOiBcIiArIFRva2VuVHlwZVJlYWRhYmxlW25vZGUub3BlcmF0b3JdO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLnB1c2hDb25zdGFudDpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiVmFsdWU6IFwiICsgbm9kZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5wdXNoU3RhdGljQ2xhc3NPYmplY3Q6XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcIlN0YXRpYyBjbGFzczogXCIgKyBub2RlLmtsYXNzLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuY2FzdFZhbHVlOlxyXG4gICAgICAgICAgICAgICAgczEgKz0gXCJOZXcgVHlwZTogXCIgKyBub2RlLm5ld1R5cGUuaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5zZWxlY3RBcnJheUVsZW1lbnQ6XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuY2FsbE1ldGhvZDpcclxuICAgICAgICAgICAgICAgIHMxICs9IG5vZGUubWV0aG9kLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcIiwgU3RhY2tmcmFtZUJlZ2luOiBcIiArIG5vZGUuc3RhY2tmcmFtZUJlZ2luXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuZGVjcmVhc2VTdGFja3BvaW50ZXI6XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcImNvdW50OiBcIiArIG5vZGUucG9wQ291bnQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUucmV0dXJuOlxyXG4gICAgICAgICAgICAgICAgczEgKz0gXCJjb3B5UmV0dXJuVmFsdWVUb1N0YWNrZnJhbWVQb3MwOiBcIiArIG5vZGUuY29weVJldHVyblZhbHVlVG9TdGFja2ZyYW1lUG9zMDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5leHRlbmRlZEZvckxvb3BDaGVja0NvdW50ZXJBbmRHZXRFbGVtZW50OlxyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5qdW1wQWx3YXlzOlxyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5qdW1wSWZGYWxzZTpcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuanVtcElmVHJ1ZTpcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuanVtcElmRmFsc2VBbmRMZWF2ZU9uU3RhY2s6XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLmp1bXBJZlRydWVBbmRMZWF2ZU9uU3RhY2s6XHJcbiAgICAgICAgICAgICAgICBsZXQgbnVtYmVyOiBudW1iZXIgPSBsYWJlbHMuZ2V0KG5vZGUuZGVzdGluYXRpb24pLm51bWJlcjtcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiZGVzdGluYXRpb246IDxzcGFuIHN0eWxlPSdmb250LXdlaWdodDogYm9sZCcgY2xhc3M9J2pvX2xhYmVsX2Rlc3RpbmF0aW9uJyBkYXRhLWRlc3RpbmF0aW9uPSdsYWJlbFwiICsgbnVtYmVyICsgXCInPkxhYmVsPHNwYW4gc3R5bGU9J2NvbG9yOiBncmVlbic+Jm5ic3A7XCIgKyBudW1iZXIgKyBcIjwvc3Bhbj48L3NwYW4+XCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuaW5jcmVtZW50RGVjcmVtZW50QmVmb3JlOlxyXG4gICAgICAgICAgICBjYXNlIFRva2VuVHlwZS5pbmNyZW1lbnREZWNyZW1lbnRBZnRlcjpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwiYW1vdW50OiBcIiArIG5vZGUuaW5jcmVtZW50RGVjcmVtZW50Qnk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBUb2tlblR5cGUuYmVnaW5BcnJheTpcclxuICAgICAgICAgICAgICAgIHMxICs9IFwidHlwZTogXCIgKyBub2RlLmFycmF5VHlwZS5pZGVudGlmaWVyO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLmFkZFRvQXJyYXk6XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcImNvdW50OiBcIiArIG5vZGUubnVtYmVyT2ZFbGVtZW50c1RvQWRkO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLnB1c2hFbXB0eUFycmF5OlxyXG4gICAgICAgICAgICAgICAgczEgKz0gXCJ0eXBlOiBcIiArIG5vZGUuYXJyYXlUeXBlLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcIiwgZGltZW5zaW9uOiBcIiArIG5vZGUuZGltZW5zaW9uO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLmtleXdvcmRTd2l0Y2g6XHJcbiAgICAgICAgICAgICAgICBzMSArPSBcImRlc3RpbmF0aW9uTWFwOiB7XCI7XHJcbiAgICAgICAgICAgICAgICBmb3IobGV0IGtleSBpbiBub2RlLmRlc3RpbmF0aW9uTWFwKXtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbnVtYmVyOiBudW1iZXIgPSBsYWJlbHMuZ2V0KG5vZGUuZGVzdGluYXRpb25NYXBba2V5XSkubnVtYmVyO1xyXG4gICAgICAgICAgICAgICAgICAgIHMxICs9IGtleSArIFwiOiA8c3BhbiBzdHlsZT0nZm9udC13ZWlnaHQ6IGJvbGQnIGNsYXNzPSdqb19sYWJlbF9kZXN0aW5hdGlvbicgZGF0YS1kZXN0aW5hdGlvbj0nbGFiZWxcIiArIG51bWJlciArIFwiJz5MYWJlbDxzcGFuIHN0eWxlPSdjb2xvcjogZ3JlZW4nPiZuYnNwO1wiICsgbnVtYmVyICsgXCI8L3NwYW4+PC9zcGFuPlwiICsgXCIsIFwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmKHMxLmVuZHNXaXRoKFwiLCBcIikpIHMxID0gczEuc3Vic3RyaW5nKDAsIHMxLmxlbmd0aCAtIDIpO1xyXG5cclxuICAgICAgICAgICAgICAgIHMxICs9IFwifVwiO1xyXG4gICAgICAgICAgICAgICAgaWYobm9kZS5kZWZhdWx0RGVzdGluYXRpb24gIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG51bWJlciA9IGxhYmVscy5nZXQobm9kZS5kZWZhdWx0RGVzdGluYXRpb24pLm51bWJlcjtcclxuICAgICAgICAgICAgICAgICAgICBzMSArPSBcIiwgZGVmYXVsdERlc3RpbmF0aW9uOiA8c3BhbiBzdHlsZT0nZm9udC13ZWlnaHQ6IGJvbGQnIGNsYXNzPSdqb19sYWJlbF9kZXN0aW5hdGlvbicgZGF0YS1kZXN0aW5hdGlvbj0nbGFiZWxcIiArIG51bWJlciArIFwiJz5MYWJlbDxzcGFuIHN0eWxlPSdjb2xvcjogZ3JlZW4nPiZuYnNwO1wiICsgbnVtYmVyICsgXCI8L3NwYW4+PC9zcGFuPlwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLnB1c2hTdGF0aWNBdHRyaWJ1dGU6XHJcbiAgICAgICAgICAgICAgICBpZihub2RlLmtsYXNzICE9IG51bGwpXHJcbiAgICAgICAgICAgICAgICBzMSArPSBcImNsYXNzOiBcIiArIG5vZGUua2xhc3MuaWRlbnRpZmllciArIFwiLCBhdHRyaWJ1dGU6IFwiICsgbm9kZS5hdHRyaWJ1dGVJZGVudGlmaWVyO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVG9rZW5UeXBlLm5ld09iamVjdDogXHJcbiAgICAgICAgICAgICAgICBzMSArPSBcImNsYXNzOiBcIiArIG5vZGUuY2xhc3MuaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIGlmKHMxICE9IFwiXCIpIHMgKz0gYCBbJHtzMX1dYDtcclxuXHJcbiAgICAgICAgaWYgKG5vZGUuc3RlcEZpbmlzaGVkID09IHRydWUpIHtcclxuICAgICAgICAgICAgcyArPSBcIjo6XCJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHMgPSBcIjxkaXY+XCIgKyBzICsgXCI8L2Rpdj5cIjtcclxuXHJcbiAgICAgICAgbGV0ICRkaXYgPSBqUXVlcnkocyk7XHJcblxyXG4gICAgICAgIG5vZGVbXCIkZGl2XCJdID0gJGRpdjtcclxuXHJcbiAgICAgICAgcmV0dXJuICRkaXY7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpbnRWYXJpYWJsZSh2OiBWYXJpYWJsZSk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHYudHlwZS5pZGVudGlmaWVyICsgXCIgXCIgKyB2LmlkZW50aWZpZXIgKyAodi5zdGFja1BvcyA9PSBudWxsID8gXCJcIiA6XCIgKHNwOiBcIiArIHYuc3RhY2tQb3MgKyBcIilcIik7XHJcbiAgICB9XHJcblxyXG4gICAgZm9ybWF0MyhuOiBudW1iZXIpOnN0cmluZ3tcclxuICAgICAgICBpZihuID49IDEwMCkgcmV0dXJuIFwiXCIgKyBuO1xyXG4gICAgICAgIGlmKG4gPj0gMTApIHJldHVybiBcIiZuYnNwO1wiICsgbjtcclxuICAgICAgICByZXR1cm4gXCImbmJzcDsmbmJzcDtcIiArIG47XHJcbiAgICB9XHJcblxyXG59Il19