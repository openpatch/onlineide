import { TokenType } from "../lexer/Token.js";
export class LabelManager {
    constructor(program) {
        this.maxLabelIndex = 0;
        this.labeledNodes = [];
        this.labelMap = new Map();
        this.jumpNodesToResolve = [];
        this.switchStatements = [];
        this.program = program;
    }
    registerSwitchStatement(switchStatement) {
        this.switchStatements.push(switchStatement);
    }
    insertJumpNode(type, position, codeGenerator, labelIndex) {
        let statementList = this.program.statements;
        if (position == null) {
            if (statementList.length > 0) {
                position = statementList[statementList.length - 1].position;
            }
        }
        let node = {
            type: type,
            position: position,
            stepFinished: true
        };
        codeGenerator.pushStatements(node);
        return this.registerJumpNode(node, labelIndex);
    }
    markJumpDestination(offset, labelIndex) {
        let position = this.program.statements.length - 1 + offset;
        if (labelIndex == null) {
            labelIndex = this.maxLabelIndex++;
        }
        let labeledNode = {
            position: position,
            labelIndex: labelIndex
        };
        this.labeledNodes.push(labeledNode);
        this.labelMap.set(labelIndex, labeledNode);
        return labelIndex;
    }
    removeNode(node) {
        for (let i = 0; i < this.labeledNodes.length; i++) {
            let n = this.labeledNodes[i];
            if (n.node == node) {
                let index = this.program.statements.indexOf(node);
                if (index < this.program.statements.length - 1) {
                    let newNode = this.program.statements[index + 1];
                    n.node = newNode;
                }
            }
            else {
                i++;
            }
        }
    }
    registerJumpDestination(node, labelIndex) {
        if (labelIndex == null) {
            labelIndex = this.maxLabelIndex++;
        }
        let label = {
            node: node,
            labelIndex: labelIndex
        };
        this.labeledNodes.push(label);
        this.labelMap.set(labelIndex, label);
        return labelIndex;
    }
    registerJumpNode(node, labelIndex) {
        if (labelIndex == null) {
            labelIndex = this.maxLabelIndex++;
        }
        let ntr = {
            labelIndex: labelIndex,
            node: node
        };
        this.jumpNodesToResolve.push(ntr);
        return labelIndex;
    }
    resolveNodes() {
        for (let ln of this.labeledNodes) {
            if (ln.position == null) {
                ln.position = this.program.statements.indexOf(ln.node);
            }
            else {
                while (ln.position > this.program.statements.length - 1) {
                    this.program.statements.push({
                        type: TokenType.noOp,
                        position: null
                    });
                }
                ln.node = this.program.statements[this.program.statements.length - 1];
            }
        }
        for (let jn of this.jumpNodesToResolve) {
            let dest = this.labelMap.get(jn.labelIndex);
            if (dest != null) {
                jn.node.destination = dest.position;
            }
        }
        for (let sw of this.switchStatements) {
            for (let dl of sw.destinationLabels) {
                sw.destinationMap[dl.constant] = this.labelMap.get(dl.label).position;
            }
            sw.destinationLabels = null;
            if (sw.defaultDestination != null) {
                sw.defaultDestination = this.labelMap.get(sw.defaultDestination).position;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGFiZWxNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9jb21waWxlci9wYXJzZXIvTGFiZWxNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQWdCLE1BQU0sbUJBQW1CLENBQUM7QUFlNUQsTUFBTSxPQUFPLFlBQVk7SUFhckIsWUFBWSxPQUFnQjtRQVg1QixrQkFBYSxHQUFXLENBQUMsQ0FBQztRQUUxQixpQkFBWSxHQUFrQixFQUFFLENBQUM7UUFFakMsYUFBUSxHQUE2QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQy9DLHVCQUFrQixHQUFvQixFQUFFLENBQUM7UUFFekMscUJBQWdCLEdBQTRCLEVBQUUsQ0FBQztRQUszQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUMzQixDQUFDO0lBRUQsdUJBQXVCLENBQUMsZUFBc0M7UUFDMUQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsY0FBYyxDQUFDLElBQzZELEVBQ3ZFLFFBQXNCLEVBQUUsYUFBNEIsRUFBRSxVQUFtQjtRQUUxRSxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztRQUU1QyxJQUFHLFFBQVEsSUFBSSxJQUFJLEVBQUM7WUFDaEIsSUFBRyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBQztnQkFDeEIsUUFBUSxHQUFHLGFBQWEsQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQzthQUMvRDtTQUNKO1FBRUQsSUFBSSxJQUFJLEdBQWE7WUFDakIsSUFBSSxFQUFFLElBQUk7WUFDVixRQUFRLEVBQUUsUUFBUTtZQUNsQixZQUFZLEVBQUUsSUFBSTtTQUNyQixDQUFDO1FBRUYsYUFBYSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVuQyxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFFbkQsQ0FBQztJQUVELG1CQUFtQixDQUFDLE1BQWMsRUFBRSxVQUFrQjtRQUVsRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUUzRCxJQUFHLFVBQVUsSUFBSSxJQUFJLEVBQUM7WUFDbEIsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUNyQztRQUVELElBQUksV0FBVyxHQUFHO1lBQ2QsUUFBUSxFQUFFLFFBQVE7WUFDbEIsVUFBVSxFQUFFLFVBQVU7U0FDekIsQ0FBQztRQUVGLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXBDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUUzQyxPQUFPLFVBQVUsQ0FBQztJQUV0QixDQUFDO0lBRUQsVUFBVSxDQUFDLElBQWU7UUFDdEIsS0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFDO1lBQzdDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0IsSUFBRyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksRUFBQztnQkFFZCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBRWxELElBQUcsS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUM7b0JBQzFDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDakQsQ0FBQyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7aUJBQ3BCO2FBRUo7aUJBQU07Z0JBQ0gsQ0FBQyxFQUFFLENBQUM7YUFDUDtTQUNKO0lBQ0wsQ0FBQztJQUVPLHVCQUF1QixDQUFDLElBQWUsRUFBRSxVQUFtQjtRQUVoRSxJQUFHLFVBQVUsSUFBSSxJQUFJLEVBQUM7WUFDbEIsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUNyQztRQUVELElBQUksS0FBSyxHQUFnQjtZQUNyQixJQUFJLEVBQUUsSUFBSTtZQUNWLFVBQVUsRUFBRSxVQUFVO1NBQ3pCLENBQUE7UUFFRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFckMsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQztJQUVNLGdCQUFnQixDQUFDLElBQWMsRUFBRSxVQUFtQjtRQUV2RCxJQUFHLFVBQVUsSUFBSSxJQUFJLEVBQUM7WUFDbEIsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUNyQztRQUVELElBQUksR0FBRyxHQUFrQjtZQUNyQixVQUFVLEVBQUUsVUFBVTtZQUN0QixJQUFJLEVBQUUsSUFBSTtTQUNiLENBQUE7UUFFRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxDLE9BQU8sVUFBVSxDQUFDO0lBRXRCLENBQUM7SUFFRCxZQUFZO1FBQ1IsS0FBSSxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFDO1lBRTVCLElBQUcsRUFBRSxDQUFDLFFBQVEsSUFBSSxJQUFJLEVBQUM7Z0JBQ25CLEVBQUUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMxRDtpQkFBTTtnQkFDSCxPQUFNLEVBQUUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBQztvQkFDbkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO3dCQUN6QixJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUk7d0JBQ3BCLFFBQVEsRUFBRSxJQUFJO3FCQUNqQixDQUFDLENBQUM7aUJBQ047Z0JBQ0QsRUFBRSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDekU7U0FFSjtRQUVELEtBQUksSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFDO1lBQ2xDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM1QyxJQUFHLElBQUksSUFBSSxJQUFJLEVBQUM7Z0JBQ1osRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQzthQUN2QztTQUNKO1FBRUQsS0FBSSxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUM7WUFDaEMsS0FBSSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsaUJBQWlCLEVBQUM7Z0JBQy9CLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUM7YUFDekU7WUFDRCxFQUFFLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1lBQzVCLElBQUcsRUFBRSxDQUFDLGtCQUFrQixJQUFJLElBQUksRUFBQztnQkFDN0IsRUFBRSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQzthQUM3RTtTQUNKO0lBRUwsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3RhdGVtZW50LCBKdW1wTm9kZSwgUHJvZ3JhbSwgSnVtcE9uU3dpdGNoU3RhdGVtZW50IH0gZnJvbSBcIi4vUHJvZ3JhbS5qc1wiO1xyXG5pbXBvcnQgeyBUb2tlblR5cGUsIFRleHRQb3NpdGlvbiB9IGZyb20gXCIuLi9sZXhlci9Ub2tlbi5qc1wiO1xyXG5pbXBvcnQgeyBDb2RlR2VuZXJhdG9yIH0gZnJvbSBcIi4vQ29kZUdlbmVyYXRvci5qc1wiO1xyXG5cclxudHlwZSBub2RlVG9SZXNvbHZlID0ge1xyXG4gICAgbm9kZTogSnVtcE5vZGUsXHJcbiAgICBsYWJlbEluZGV4OiBudW1iZXJcclxufVxyXG5cclxudHlwZSBMYWJlbGVkTm9kZSA9IHtcclxuICAgIG5vZGU/OiBTdGF0ZW1lbnQsXHJcbiAgICBsYWJlbEluZGV4OiBudW1iZXIsXHJcbiAgICBwb3NpdGlvbj86IG51bWJlclxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIExhYmVsTWFuYWdlciB7XHJcblxyXG4gICAgbWF4TGFiZWxJbmRleDogbnVtYmVyID0gMDtcclxuXHJcbiAgICBsYWJlbGVkTm9kZXM6IExhYmVsZWROb2RlW10gPSBbXTtcclxuICAgIFxyXG4gICAgbGFiZWxNYXA6IE1hcDxudW1iZXIsIExhYmVsZWROb2RlPiA9IG5ldyBNYXAoKTtcclxuICAgIGp1bXBOb2Rlc1RvUmVzb2x2ZTogbm9kZVRvUmVzb2x2ZVtdID0gW107XHJcblxyXG4gICAgc3dpdGNoU3RhdGVtZW50czogSnVtcE9uU3dpdGNoU3RhdGVtZW50W10gPSBbXTtcclxuXHJcbiAgICBwcm9ncmFtOiBQcm9ncmFtO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByb2dyYW06IFByb2dyYW0pe1xyXG4gICAgICAgIHRoaXMucHJvZ3JhbSA9IHByb2dyYW07XHJcbiAgICB9XHJcblxyXG4gICAgcmVnaXN0ZXJTd2l0Y2hTdGF0ZW1lbnQoc3dpdGNoU3RhdGVtZW50OiBKdW1wT25Td2l0Y2hTdGF0ZW1lbnQpIHtcclxuICAgICAgICB0aGlzLnN3aXRjaFN0YXRlbWVudHMucHVzaChzd2l0Y2hTdGF0ZW1lbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIGluc2VydEp1bXBOb2RlKHR5cGU6IFRva2VuVHlwZS5qdW1wSWZUcnVlfFRva2VuVHlwZS5qdW1wSWZGYWxzZXxUb2tlblR5cGUuanVtcEFsd2F5c3xcclxuICAgICAgICBUb2tlblR5cGUuanVtcElmRmFsc2VBbmRMZWF2ZU9uU3RhY2t8VG9rZW5UeXBlLmp1bXBJZlRydWVBbmRMZWF2ZU9uU3RhY2ssXHJcbiAgICAgICAgIHBvc2l0aW9uOiBUZXh0UG9zaXRpb24sIGNvZGVHZW5lcmF0b3I6IENvZGVHZW5lcmF0b3IsIGxhYmVsSW5kZXg/OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBzdGF0ZW1lbnRMaXN0ID0gdGhpcy5wcm9ncmFtLnN0YXRlbWVudHM7XHJcblxyXG4gICAgICAgIGlmKHBvc2l0aW9uID09IG51bGwpe1xyXG4gICAgICAgICAgICBpZihzdGF0ZW1lbnRMaXN0Lmxlbmd0aCA+IDApe1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb24gPSBzdGF0ZW1lbnRMaXN0W3N0YXRlbWVudExpc3QubGVuZ3RoIC0gMV0ucG9zaXRpb247XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBub2RlOiBKdW1wTm9kZSA9IHtcclxuICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgcG9zaXRpb246IHBvc2l0aW9uLFxyXG4gICAgICAgICAgICBzdGVwRmluaXNoZWQ6IHRydWVcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb2RlR2VuZXJhdG9yLnB1c2hTdGF0ZW1lbnRzKG5vZGUpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5yZWdpc3Rlckp1bXBOb2RlKG5vZGUsIGxhYmVsSW5kZXgpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBtYXJrSnVtcERlc3RpbmF0aW9uKG9mZnNldDogbnVtYmVyLCBsYWJlbEluZGV4PzpudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBwb3NpdGlvbiA9IHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzLmxlbmd0aCAtIDEgKyBvZmZzZXQ7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYobGFiZWxJbmRleCA9PSBudWxsKXtcclxuICAgICAgICAgICAgbGFiZWxJbmRleCA9IHRoaXMubWF4TGFiZWxJbmRleCsrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGxhYmVsZWROb2RlID0ge1xyXG4gICAgICAgICAgICBwb3NpdGlvbjogcG9zaXRpb24sXHJcbiAgICAgICAgICAgIGxhYmVsSW5kZXg6IGxhYmVsSW5kZXhcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmxhYmVsZWROb2Rlcy5wdXNoKGxhYmVsZWROb2RlKTtcclxuXHJcbiAgICAgICAgdGhpcy5sYWJlbE1hcC5zZXQobGFiZWxJbmRleCwgbGFiZWxlZE5vZGUpO1xyXG5cclxuICAgICAgICByZXR1cm4gbGFiZWxJbmRleDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlTm9kZShub2RlOiBTdGF0ZW1lbnQpe1xyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLmxhYmVsZWROb2Rlcy5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgIGxldCBuID0gdGhpcy5sYWJlbGVkTm9kZXNbaV07XHJcbiAgICAgICAgICAgIGlmKG4ubm9kZSA9PSBub2RlKXtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSB0aGlzLnByb2dyYW0uc3RhdGVtZW50cy5pbmRleE9mKG5vZGUpO1xyXG4gICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGlmKGluZGV4IDwgdGhpcy5wcm9ncmFtLnN0YXRlbWVudHMubGVuZ3RoIC0gMSl7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld05vZGUgPSB0aGlzLnByb2dyYW0uc3RhdGVtZW50c1tpbmRleCArIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgIG4ubm9kZSA9IG5ld05vZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJKdW1wRGVzdGluYXRpb24obm9kZTogU3RhdGVtZW50LCBsYWJlbEluZGV4PzogbnVtYmVyKTogbnVtYmVyIHtcclxuXHJcbiAgICAgICAgaWYobGFiZWxJbmRleCA9PSBudWxsKXtcclxuICAgICAgICAgICAgbGFiZWxJbmRleCA9IHRoaXMubWF4TGFiZWxJbmRleCsrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGxhYmVsOiBMYWJlbGVkTm9kZSA9IHtcclxuICAgICAgICAgICAgbm9kZTogbm9kZSxcclxuICAgICAgICAgICAgbGFiZWxJbmRleDogbGFiZWxJbmRleFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5sYWJlbGVkTm9kZXMucHVzaChsYWJlbCk7XHJcbiAgICAgICAgdGhpcy5sYWJlbE1hcC5zZXQobGFiZWxJbmRleCwgbGFiZWwpO1xyXG5cclxuICAgICAgICByZXR1cm4gbGFiZWxJbmRleDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVnaXN0ZXJKdW1wTm9kZShub2RlOiBKdW1wTm9kZSwgbGFiZWxJbmRleD86IG51bWJlcik6IG51bWJlciB7XHJcblxyXG4gICAgICAgIGlmKGxhYmVsSW5kZXggPT0gbnVsbCl7XHJcbiAgICAgICAgICAgIGxhYmVsSW5kZXggPSB0aGlzLm1heExhYmVsSW5kZXgrKztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBudHI6IG5vZGVUb1Jlc29sdmUgPSB7XHJcbiAgICAgICAgICAgIGxhYmVsSW5kZXg6IGxhYmVsSW5kZXgsXHJcbiAgICAgICAgICAgIG5vZGU6IG5vZGVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuanVtcE5vZGVzVG9SZXNvbHZlLnB1c2gobnRyKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGxhYmVsSW5kZXg7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlc29sdmVOb2Rlcygpe1xyXG4gICAgICAgIGZvcihsZXQgbG4gb2YgdGhpcy5sYWJlbGVkTm9kZXMpe1xyXG5cclxuICAgICAgICAgICAgaWYobG4ucG9zaXRpb24gPT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICBsbi5wb3NpdGlvbiA9IHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzLmluZGV4T2YobG4ubm9kZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB3aGlsZShsbi5wb3NpdGlvbiA+IHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzLmxlbmd0aCAtIDEpe1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUb2tlblR5cGUubm9PcCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IG51bGxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxuLm5vZGUgPSB0aGlzLnByb2dyYW0uc3RhdGVtZW50c1t0aGlzLnByb2dyYW0uc3RhdGVtZW50cy5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvcihsZXQgam4gb2YgdGhpcy5qdW1wTm9kZXNUb1Jlc29sdmUpe1xyXG4gICAgICAgICAgICBsZXQgZGVzdCA9IHRoaXMubGFiZWxNYXAuZ2V0KGpuLmxhYmVsSW5kZXgpO1xyXG4gICAgICAgICAgICBpZihkZXN0ICE9IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgam4ubm9kZS5kZXN0aW5hdGlvbiA9IGRlc3QucG9zaXRpb247XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvcihsZXQgc3cgb2YgdGhpcy5zd2l0Y2hTdGF0ZW1lbnRzKXtcclxuICAgICAgICAgICAgZm9yKGxldCBkbCBvZiBzdy5kZXN0aW5hdGlvbkxhYmVscyl7XHJcbiAgICAgICAgICAgICAgICBzdy5kZXN0aW5hdGlvbk1hcFtkbC5jb25zdGFudF0gPSB0aGlzLmxhYmVsTWFwLmdldChkbC5sYWJlbCkucG9zaXRpb247XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3cuZGVzdGluYXRpb25MYWJlbHMgPSBudWxsO1xyXG4gICAgICAgICAgICBpZihzdy5kZWZhdWx0RGVzdGluYXRpb24gIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICBzdy5kZWZhdWx0RGVzdGluYXRpb24gPSB0aGlzLmxhYmVsTWFwLmdldChzdy5kZWZhdWx0RGVzdGluYXRpb24pLnBvc2l0aW9uO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbn1cclxuXHJcbiJdfQ==