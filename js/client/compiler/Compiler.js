import { Lexer } from "./lexer/Lexer.js";
import { CodeGenerator } from "./parser/CodeGenerator.js";
import { Parser } from "./parser/Parser.js";
import { TypeResolver } from "./parser/TypeResolver.js";
import { MainEmbedded } from "../embedded/MainEmbedded.js";
export var CompilerStatus;
(function (CompilerStatus) {
    CompilerStatus[CompilerStatus["compiling"] = 0] = "compiling";
    CompilerStatus[CompilerStatus["error"] = 1] = "error";
    CompilerStatus[CompilerStatus["compiledButNothingToRun"] = 2] = "compiledButNothingToRun";
    CompilerStatus[CompilerStatus["readyToRun"] = 3] = "readyToRun";
})(CompilerStatus || (CompilerStatus = {}));
export class Compiler {
    constructor(main) {
        this.main = main;
        this.compilerStatus = CompilerStatus.compiledButNothingToRun;
    }
    compile(moduleStore) {
        this.compilerStatus = CompilerStatus.compiling;
        let t0 = performance.now();
        moduleStore.clearUsagePositions();
        let lexer = new Lexer();
        // 1st pass: lexing
        for (let m of moduleStore.getModules(false)) {
            m.file.dirty = false;
            m.clear();
            let lexed = lexer.lex(m.getProgramTextFromMonacoModel());
            m.errors[0] = lexed.errors;
            m.tokenList = lexed.tokens;
            m.bracketError = lexed.bracketError;
            if (m.file.name == this.main.getCurrentlyEditedModule().file.name) {
                if (this.main.getBottomDiv() != null)
                    this.main.getBottomDiv().errorManager.showParenthesisWarning(lexed.bracketError);
            }
        }
        // 2nd pass: parse tokenlist and generate AST
        this.main.getSemicolonAngel().startRegistering();
        let parser = new Parser(false);
        for (let m of moduleStore.getModules(false)) {
            parser.parse(m);
        }
        // 3rd pass: resolve types and populate typeStores; checks intermodular dependencies
        let typeResolver = new TypeResolver(this.main);
        // Klass.count = 0;
        // Interface.count = 0;
        typeResolver.start(moduleStore);
        // console.log("Klass-Klone: " + Klass.count + ", Interface-Klone: " + Interface.count);
        // 4th pass: code generation
        let codeGenerator = new CodeGenerator();
        for (let m of moduleStore.getModules(false)) {
            codeGenerator.start(m, moduleStore);
        }
        let errorfree = true;
        for (let m of moduleStore.getModules(false)) {
            m.dependsOnModulesWithErrors = m.hasErrors();
            if (m.dependsOnModulesWithErrors)
                errorfree = false;
        }
        let done = false;
        while (!done) {
            done = true;
            for (let m of moduleStore.getModules(false)) {
                if (!m.dependsOnModulesWithErrors)
                    for (let m1 of moduleStore.getModules(false)) {
                        if (m.dependsOnModules.get(m1) && m1.dependsOnModulesWithErrors) {
                            m.dependsOnModulesWithErrors = true;
                            done = false;
                            break;
                        }
                    }
            }
        }
        this.atLeastOneModuleIsStartable = false;
        for (let m of moduleStore.getModules(false)) {
            m.isStartable = m.hasMainProgram() && !m.dependsOnModulesWithErrors;
            if (m.isStartable) {
                this.atLeastOneModuleIsStartable = true;
            }
            if (!(this.main instanceof MainEmbedded) || this.main.config.withFileList) {
                m.renderStartButton();
            }
        }
        if (this.atLeastOneModuleIsStartable) {
            this.compilerStatus = CompilerStatus.readyToRun;
        }
        else {
            this.compilerStatus = errorfree ? CompilerStatus.error : CompilerStatus.compiledButNothingToRun;
        }
        let dt = performance.now() - t0;
        dt = Math.round(dt * 100) / 100;
        let message = "Compiled in " + dt + " ms.";
        this.main.getCurrentWorkspace().compilerMessage = message;
        this.main.getSemicolonAngel().healSemicolons();
        return null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvbXBpbGVyL0NvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBUyxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFMUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUd4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFJM0QsTUFBTSxDQUFOLElBQVksY0FFWDtBQUZELFdBQVksY0FBYztJQUN0Qiw2REFBUyxDQUFBO0lBQUUscURBQUssQ0FBQTtJQUFFLHlGQUF1QixDQUFBO0lBQUUsK0RBQVUsQ0FBQTtBQUN6RCxDQUFDLEVBRlcsY0FBYyxLQUFkLGNBQWMsUUFFekI7QUFFRCxNQUFNLE9BQU8sUUFBUTtJQU1qQixZQUFvQixJQUFjO1FBQWQsU0FBSSxHQUFKLElBQUksQ0FBVTtRQUpsQyxtQkFBYyxHQUFtQixjQUFjLENBQUMsdUJBQXVCLENBQUM7SUFLeEUsQ0FBQztJQUVELE9BQU8sQ0FBQyxXQUF3QjtRQUU1QixJQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQyxTQUFTLENBQUM7UUFFL0MsSUFBSSxFQUFFLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTNCLFdBQVcsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBRWxDLElBQUksS0FBSyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFFeEIsbUJBQW1CO1FBQ25CLEtBQUssSUFBSSxDQUFDLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN6QyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxL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LENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQywwQkFBMEIsQ0FBQztZQUNwRSxJQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUM7Z0JBQ2IsSUFBSSxDQUFDLDJCQUEyQixHQUFHLElBQUksQ0FBQzthQUMzQztZQUNELElBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLFlBQVksWUFBWSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFDO2dCQUNyRSxDQUFDLENBQUMsaUJBQWlCLEVBQUUsQ0FBQzthQUN6QjtTQUNKO1FBRUQsSUFBSSxJQUFJLENBQUMsMkJBQTJCLEVBQUU7WUFFbEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUMsVUFBVSxDQUFDO1NBRW5EO2FBQU07WUFFSCxJQUFJLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLHVCQUF1QixDQUFDO1NBRW5HO1FBRUQsSUFBSSxFQUFFLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNoQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBRWhDLElBQUksT0FBTyxHQUFHLGNBQWMsR0FBRyxFQUFFLEdBQUcsTUFBTSxDQUFDO1FBRTNDLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxlQUFlLEdBQUcsT0FBTyxDQUFDO1FBRTFELElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUUvQyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFcnJvciwgTGV4ZXIgfSBmcm9tIFwiLi9sZXhlci9MZXhlci5qc1wiO1xyXG5pbXBvcnQgeyBDb2RlR2VuZXJhdG9yIH0gZnJvbSBcIi4vcGFyc2VyL0NvZGVHZW5lcmF0b3IuanNcIjtcclxuaW1wb3J0IHsgRmlsZSwgTW9kdWxlLCBNb2R1bGVTdG9yZSB9IGZyb20gXCIuL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgUGFyc2VyIH0gZnJvbSBcIi4vcGFyc2VyL1BhcnNlci5qc1wiO1xyXG5pbXBvcnQgeyBUeXBlUmVzb2x2ZXIgfSBmcm9tIFwiLi9wYXJzZXIvVHlwZVJlc29sdmVyLmpzXCI7XHJcbmltcG9ydCB7IE1haW4gfSBmcm9tIFwiLi4vbWFpbi9NYWluLmpzXCI7XHJcbmltcG9ydCB7IE1haW5CYXNlIH0gZnJvbSBcIi4uL21haW4vTWFpbkJhc2UuanNcIjtcclxuaW1wb3J0IHsgTWFpbkVtYmVkZGVkIH0gZnJvbSBcIi4uL2VtYmVkZGVkL01haW5FbWJlZGRlZC5qc1wiO1xyXG5pbXBvcnQgeyBLbGFzcywgSW50ZXJmYWNlIH0gZnJvbSBcIi4vdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgU2VtaWNvbG9uQW5nZWwgfSBmcm9tIFwiLi9wYXJzZXIvU2VtaWNvbG9uQW5nZWwuanNcIjtcclxuXHJcbmV4cG9ydCBlbnVtIENvbXBpbGVyU3RhdHVzIHtcclxuICAgIGNvbXBpbGluZywgZXJyb3IsIGNvbXBpbGVkQnV0Tm90aGluZ1RvUnVuLCByZWFkeVRvUnVuXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDb21waWxlciB7XHJcblxyXG4gICAgY29tcGlsZXJTdGF0dXM6IENvbXBpbGVyU3RhdHVzID0gQ29tcGlsZXJTdGF0dXMuY29tcGlsZWRCdXROb3RoaW5nVG9SdW47XHJcblxyXG4gICAgYXRMZWFzdE9uZU1vZHVsZUlzU3RhcnRhYmxlOiBib29sZWFuO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFpbjogTWFpbkJhc2UpIHtcclxuICAgIH1cclxuXHJcbiAgICBjb21waWxlKG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZSk6IEVycm9yW10ge1xyXG5cclxuICAgICAgICB0aGlzLmNvbXBpbGVyU3RhdHVzID0gQ29tcGlsZXJTdGF0dXMuY29tcGlsaW5nO1xyXG5cclxuICAgICAgICBsZXQgdDAgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHJcbiAgICAgICAgbW9kdWxlU3RvcmUuY2xlYXJVc2FnZVBvc2l0aW9ucygpO1xyXG5cclxuICAgICAgICBsZXQgbGV4ZXIgPSBuZXcgTGV4ZXIoKTtcclxuXHJcbiAgICAgICAgLy8gMXN0IHBhc3M6IGxleGluZ1xyXG4gICAgICAgIGZvciAobGV0IG0gb2YgbW9kdWxlU3RvcmUuZ2V0TW9kdWxlcyhmYWxzZSkpIHtcclxuICAgICAgICAgICAgbS5maWxlLmRpcnR5ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIG0uY2xlYXIoKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBsZXhlZCA9IGxleGVyLmxleChtLmdldFByb2dyYW1UZXh0RnJvbU1vbmFjb01vZGVsKCkpO1xyXG4gICAgICAgICAgICBtLmVycm9yc1swXSA9IGxleGVkLmVycm9ycztcclxuICAgICAgICAgICAgbS50b2tlbkxpc3QgPSBsZXhlZC50b2tlbnM7XHJcbiAgICAgICAgICAgIG0uYnJhY2tldEVycm9yID0gbGV4ZWQuYnJhY2tldEVycm9yO1xyXG4gICAgICAgICAgICBpZihtLmZpbGUubmFtZSA9PSB0aGlzLm1haW4uZ2V0Q3VycmVudGx5RWRpdGVkTW9kdWxlKCkuZmlsZS5uYW1lKXtcclxuICAgICAgICAgICAgICAgIGlmKHRoaXMubWFpbi5nZXRCb3R0b21EaXYoKSAhPSBudWxsKSB0aGlzLm1haW4uZ2V0Qm90dG9tRGl2KCkuZXJyb3JNYW5hZ2VyLnNob3dQYXJlbnRoZXNpc1dhcm5pbmcobGV4ZWQuYnJhY2tldEVycm9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gMm5kIHBhc3M6IHBhcnNlIHRva2VubGlzdCBhbmQgZ2VuZXJhdGUgQVNUXHJcblxyXG4gICAgICAgIHRoaXMubWFpbi5nZXRTZW1pY29sb25BbmdlbCgpLnN0YXJ0UmVnaXN0ZXJpbmcoKTtcclxuXHJcbiAgICAgICAgbGV0IHBhcnNlcjogUGFyc2VyID0gbmV3IFBhcnNlcihmYWxzZSk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IG0gb2YgbW9kdWxlU3RvcmUuZ2V0TW9kdWxlcyhmYWxzZSkpIHtcclxuICAgICAgICAgICAgcGFyc2VyLnBhcnNlKG0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gM3JkIHBhc3M6IHJlc29sdmUgdHlwZXMgYW5kIHBvcHVsYXRlIHR5cGVTdG9yZXM7IGNoZWNrcyBpbnRlcm1vZHVsYXIgZGVwZW5kZW5jaWVzXHJcblxyXG4gICAgICAgIGxldCB0eXBlUmVzb2x2ZXI6IFR5cGVSZXNvbHZlciA9IG5ldyBUeXBlUmVzb2x2ZXIodGhpcy5tYWluKTtcclxuXHJcbiAgICAgICAgLy8gS2xhc3MuY291bnQgPSAwO1xyXG4gICAgICAgIC8vIEludGVyZmFjZS5jb3VudCA9IDA7XHJcbiAgICAgICAgdHlwZVJlc29sdmVyLnN0YXJ0KG1vZHVsZVN0b3JlKTtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIktsYXNzLUtsb25lOiBcIiArIEtsYXNzLmNvdW50ICsgXCIsIEludGVyZmFjZS1LbG9uZTogXCIgKyBJbnRlcmZhY2UuY291bnQpO1xyXG5cclxuICAgICAgICAvLyA0dGggcGFzczogY29kZSBnZW5lcmF0aW9uXHJcblxyXG4gICAgICAgIGxldCBjb2RlR2VuZXJhdG9yID0gbmV3IENvZGVHZW5lcmF0b3IoKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgbSBvZiBtb2R1bGVTdG9yZS5nZXRNb2R1bGVzKGZhbHNlKSkge1xyXG4gICAgICAgICAgICBjb2RlR2VuZXJhdG9yLnN0YXJ0KG0sIG1vZHVsZVN0b3JlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBlcnJvcmZyZWUgPSB0cnVlO1xyXG4gICAgICAgIGZvciAobGV0IG0gb2YgbW9kdWxlU3RvcmUuZ2V0TW9kdWxlcyhmYWxzZSkpIHtcclxuICAgICAgICAgICAgbS5kZXBlbmRzT25Nb2R1bGVzV2l0aEVycm9ycyA9IG0uaGFzRXJyb3JzKCk7XHJcbiAgICAgICAgICAgIGlmKG0uZGVwZW5kc09uTW9kdWxlc1dpdGhFcnJvcnMpIGVycm9yZnJlZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGRvbmUgPSBmYWxzZTtcclxuICAgICAgICB3aGlsZSghZG9uZSl7XHJcbiAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBtIG9mIG1vZHVsZVN0b3JlLmdldE1vZHVsZXMoZmFsc2UpKSB7XHJcbiAgICAgICAgICAgICAgICBpZighbS5kZXBlbmRzT25Nb2R1bGVzV2l0aEVycm9ycylcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IG0xIG9mIG1vZHVsZVN0b3JlLmdldE1vZHVsZXMoZmFsc2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYobS5kZXBlbmRzT25Nb2R1bGVzLmdldChtMSkgJiYgbTEuZGVwZW5kc09uTW9kdWxlc1dpdGhFcnJvcnMpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtLmRlcGVuZHNPbk1vZHVsZXNXaXRoRXJyb3JzID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9ICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMuYXRMZWFzdE9uZU1vZHVsZUlzU3RhcnRhYmxlID0gZmFsc2U7ICAgICAgICBcclxuICAgICAgICBmb3IgKGxldCBtIG9mIG1vZHVsZVN0b3JlLmdldE1vZHVsZXMoZmFsc2UpKSB7XHJcbiAgICAgICAgICAgIG0uaXNTdGFydGFibGUgPSBtLmhhc01haW5Qcm9ncmFtKCkgJiYgIW0uZGVwZW5kc09uTW9kdWxlc1dpdGhFcnJvcnM7XHJcbiAgICAgICAgICAgIGlmKG0uaXNTdGFydGFibGUpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdExlYXN0T25lTW9kdWxlSXNTdGFydGFibGUgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKCEodGhpcy5tYWluIGluc3RhbmNlb2YgTWFpbkVtYmVkZGVkKSB8fCB0aGlzLm1haW4uY29uZmlnLndpdGhGaWxlTGlzdCl7XHJcbiAgICAgICAgICAgICAgICBtLnJlbmRlclN0YXJ0QnV0dG9uKCk7XHJcbiAgICAgICAgICAgIH0gXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5hdExlYXN0T25lTW9kdWxlSXNTdGFydGFibGUpIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY29tcGlsZXJTdGF0dXMgPSBDb21waWxlclN0YXR1cy5yZWFkeVRvUnVuO1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jb21waWxlclN0YXR1cyA9IGVycm9yZnJlZSA/IENvbXBpbGVyU3RhdHVzLmVycm9yIDogQ29tcGlsZXJTdGF0dXMuY29tcGlsZWRCdXROb3RoaW5nVG9SdW47XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGR0ID0gcGVyZm9ybWFuY2Uubm93KCkgLSB0MDtcclxuICAgICAgICBkdCA9IE1hdGgucm91bmQoZHQgKiAxMDApIC8gMTAwO1xyXG5cclxuICAgICAgICBsZXQgbWVzc2FnZSA9IFwiQ29tcGlsZWQgaW4gXCIgKyBkdCArIFwiIG1zLlwiO1xyXG5cclxuICAgICAgICB0aGlzLm1haW4uZ2V0Q3VycmVudFdvcmtzcGFjZSgpLmNvbXBpbGVyTWVzc2FnZSA9IG1lc3NhZ2U7XHJcblxyXG4gICAgICAgIHRoaXMubWFpbi5nZXRTZW1pY29sb25BbmdlbCgpLmhlYWxTZW1pY29sb25zKCk7XHJcblxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxufSJdfQ==