import { TokenType } from "../lexer/Token.js";
export class LabelManager {
    constructor(program) {
        this.maxLabelIndex = 0;
        this.labeledNodes = [];
        this.labelMap = new Map();
        this.jumpNodesToResolve = [];
        this.switchStatements = [];
        this.program = program;
    }
    correctPositionsAfterInsert(insertPosition, insertedLength) {
        for (let ln of this.labeledNodes) {
            if (ln.position != null && ln.position >= insertPosition) {
                ln.position += insertedLength;
            }
        }
    }
    registerSwitchStatement(switchStatement) {
        this.switchStatements.push(switchStatement);
    }
    insertJumpNode(type, position, codeGenerator, labelIndex) {
        let statementList = this.program.statements;
        if (position == null) {
            if (statementList.length > 0) {
                position = statementList[statementList.length - 1].position;
            }
        }
        let node = {
            type: type,
            position: position,
            stepFinished: true
        };
        codeGenerator.pushStatements(node);
        return this.registerJumpNode(node, labelIndex);
    }
    markJumpDestination(offset, labelIndex) {
        let position = this.program.statements.length - 1 + offset;
        if (labelIndex == null) {
            labelIndex = this.maxLabelIndex++;
        }
        let labeledNode = {
            position: position,
            labelIndex: labelIndex
        };
        this.labeledNodes.push(labeledNode);
        this.labelMap.set(labelIndex, labeledNode);
        return labelIndex;
    }
    removeNode(node) {
        for (let i = 0; i < this.labeledNodes.length; i++) {
            let n = this.labeledNodes[i];
            if (n.node == node) {
                let index = this.program.statements.indexOf(node);
                if (index < this.program.statements.length - 1) {
                    let newNode = this.program.statements[index + 1];
                    n.node = newNode;
                }
            }
            else {
                i++;
            }
        }
    }
    registerJumpDestination(node, labelIndex) {
        if (labelIndex == null) {
            labelIndex = this.maxLabelIndex++;
        }
        let label = {
            node: node,
            labelIndex: labelIndex
        };
        this.labeledNodes.push(label);
        this.labelMap.set(labelIndex, label);
        return labelIndex;
    }
    registerJumpNode(node, labelIndex) {
        if (labelIndex == null) {
            labelIndex = this.maxLabelIndex++;
        }
        let ntr = {
            labelIndex: labelIndex,
            node: node
        };
        this.jumpNodesToResolve.push(ntr);
        return labelIndex;
    }
    resolveNodes() {
        for (let ln of this.labeledNodes) {
            if (ln.position == null) {
                ln.position = this.program.statements.indexOf(ln.node);
            }
            else {
                while (ln.position > this.program.statements.length - 1) {
                    this.program.statements.push({
                        type: TokenType.noOp,
                        position: null
                    });
                }
                ln.node = this.program.statements[ln.position];
            }
        }
        for (let jn of this.jumpNodesToResolve) {
            let dest = this.labelMap.get(jn.labelIndex);
            if (dest != null) {
                jn.node.destination = dest.position;
            }
        }
        for (let sw of this.switchStatements) {
            for (let dl of sw.destinationLabels) {
                sw.destinationMap[dl.constant] = this.labelMap.get(dl.label).position;
            }
            sw.destinationLabels = null;
            if (sw.defaultDestination != null) {
                sw.defaultDestination = this.labelMap.get(sw.defaultDestination).position;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGFiZWxNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9jb21waWxlci9wYXJzZXIvTGFiZWxNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQWdCLE1BQU0sbUJBQW1CLENBQUM7QUFlNUQsTUFBTSxPQUFPLFlBQVk7SUFhckIsWUFBWSxPQUFnQjtRQVg1QixrQkFBYSxHQUFXLENBQUMsQ0FBQztRQUUxQixpQkFBWSxHQUFrQixFQUFFLENBQUM7UUFFakMsYUFBUSxHQUE2QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQy9DLHVCQUFrQixHQUFvQixFQUFFLENBQUM7UUFFekMscUJBQWdCLEdBQTRCLEVBQUUsQ0FBQztRQUszQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUMzQixDQUFDO0lBRUQsMkJBQTJCLENBQUMsY0FBc0IsRUFBRSxjQUFzQjtRQUN0RSxLQUFJLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUM7WUFDNUIsSUFBRyxFQUFFLENBQUMsUUFBUSxJQUFJLElBQUksSUFBSSxFQUFFLENBQUMsUUFBUSxJQUFJLGNBQWMsRUFBQztnQkFDcEQsRUFBRSxDQUFDLFFBQVEsSUFBSSxjQUFjLENBQUM7YUFDakM7U0FDSjtJQUNMLENBQUM7SUFHRCx1QkFBdUIsQ0FBQyxlQUFzQztRQUMxRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxjQUFjLENBQUMsSUFDNkQsRUFDdkUsUUFBc0IsRUFBRSxhQUE0QixFQUFFLFVBQW1CO1FBRTFFLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO1FBRTVDLElBQUcsUUFBUSxJQUFJLElBQUksRUFBQztZQUNoQixJQUFHLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFDO2dC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QUFHLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQzthQUN6RTtZQUNELEVBQUUsQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7WUFDNUIsSUFBRyxFQUFFLENBQUMsa0JBQWtCLElBQUksSUFBSSxFQUFDO2dCQUM3QixFQUFFLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGtCQUFrQixDQUFDLENBQUMsUUFBUSxDQUFDO2FBQzdFO1NBQ0o7SUFFTCxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGF0ZW1lbnQsIEp1bXBOb2RlLCBQcm9ncmFtLCBKdW1wT25Td2l0Y2hTdGF0ZW1lbnQgfSBmcm9tIFwiLi9Qcm9ncmFtLmpzXCI7XHJcbmltcG9ydCB7IFRva2VuVHlwZSwgVGV4dFBvc2l0aW9uIH0gZnJvbSBcIi4uL2xleGVyL1Rva2VuLmpzXCI7XHJcbmltcG9ydCB7IENvZGVHZW5lcmF0b3IgfSBmcm9tIFwiLi9Db2RlR2VuZXJhdG9yLmpzXCI7XHJcblxyXG50eXBlIG5vZGVUb1Jlc29sdmUgPSB7XHJcbiAgICBub2RlOiBKdW1wTm9kZSxcclxuICAgIGxhYmVsSW5kZXg6IG51bWJlclxyXG59XHJcblxyXG50eXBlIExhYmVsZWROb2RlID0ge1xyXG4gICAgbm9kZT86IFN0YXRlbWVudCxcclxuICAgIGxhYmVsSW5kZXg6IG51bWJlcixcclxuICAgIHBvc2l0aW9uPzogbnVtYmVyXHJcbn1cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgTGFiZWxNYW5hZ2VyIHtcclxuXHJcbiAgICBtYXhMYWJlbEluZGV4OiBudW1iZXIgPSAwO1xyXG5cclxuICAgIGxhYmVsZWROb2RlczogTGFiZWxlZE5vZGVbXSA9IFtdO1xyXG4gICAgXHJcbiAgICBsYWJlbE1hcDogTWFwPG51bWJlciwgTGFiZWxlZE5vZGU+ID0gbmV3IE1hcCgpO1xyXG4gICAganVtcE5vZGVzVG9SZXNvbHZlOiBub2RlVG9SZXNvbHZlW10gPSBbXTtcclxuXHJcbiAgICBzd2l0Y2hTdGF0ZW1lbnRzOiBKdW1wT25Td2l0Y2hTdGF0ZW1lbnRbXSA9IFtdO1xyXG5cclxuICAgIHByb2dyYW06IFByb2dyYW07XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJvZ3JhbTogUHJvZ3JhbSl7XHJcbiAgICAgICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTtcclxuICAgIH1cclxuXHJcbiAgICBjb3JyZWN0UG9zaXRpb25zQWZ0ZXJJbnNlcnQoaW5zZXJ0UG9zaXRpb246IG51bWJlciwgaW5zZXJ0ZWRMZW5ndGg6IG51bWJlcikge1xyXG4gICAgICAgIGZvcihsZXQgbG4gb2YgdGhpcy5sYWJlbGVkTm9kZXMpe1xyXG4gICAgICAgICAgICBpZihsbi5wb3NpdGlvbiAhPSBudWxsICYmIGxuLnBvc2l0aW9uID49IGluc2VydFBvc2l0aW9uKXtcclxuICAgICAgICAgICAgICAgIGxuLnBvc2l0aW9uICs9IGluc2VydGVkTGVuZ3RoO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICByZWdpc3RlclN3aXRjaFN0YXRlbWVudChzd2l0Y2hTdGF0ZW1lbnQ6IEp1bXBPblN3aXRjaFN0YXRlbWVudCkge1xyXG4gICAgICAgIHRoaXMuc3dpdGNoU3RhdGVtZW50cy5wdXNoKHN3aXRjaFN0YXRlbWVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgaW5zZXJ0SnVtcE5vZGUodHlwZTogVG9rZW5UeXBlLmp1bXBJZlRydWV8VG9rZW5UeXBlLmp1bXBJZkZhbHNlfFRva2VuVHlwZS5qdW1wQWx3YXlzfFxyXG4gICAgICAgIFRva2VuVHlwZS5qdW1wSWZGYWxzZUFuZExlYXZlT25TdGFja3xUb2tlblR5cGUuanVtcElmVHJ1ZUFuZExlYXZlT25TdGFjayxcclxuICAgICAgICAgcG9zaXRpb246IFRleHRQb3NpdGlvbiwgY29kZUdlbmVyYXRvcjogQ29kZUdlbmVyYXRvciwgbGFiZWxJbmRleD86IG51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHN0YXRlbWVudExpc3QgPSB0aGlzLnByb2dyYW0uc3RhdGVtZW50cztcclxuXHJcbiAgICAgICAgaWYocG9zaXRpb24gPT0gbnVsbCl7XHJcbiAgICAgICAgICAgIGlmKHN0YXRlbWVudExpc3QubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHN0YXRlbWVudExpc3Rbc3RhdGVtZW50TGlzdC5sZW5ndGggLSAxXS5wb3NpdGlvbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG5vZGU6IEp1bXBOb2RlID0ge1xyXG4gICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICBwb3NpdGlvbjogcG9zaXRpb24sXHJcbiAgICAgICAgICAgIHN0ZXBGaW5pc2hlZDogdHJ1ZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvZGVHZW5lcmF0b3IucHVzaFN0YXRlbWVudHMobm9kZSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLnJlZ2lzdGVySnVtcE5vZGUobm9kZSwgbGFiZWxJbmRleCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG1hcmtKdW1wRGVzdGluYXRpb24ob2Zmc2V0OiBudW1iZXIsIGxhYmVsSW5kZXg/Om51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHBvc2l0aW9uID0gdGhpcy5wcm9ncmFtLnN0YXRlbWVudHMubGVuZ3RoIC0gMSArIG9mZnNldDtcclxuICAgICAgICBcclxuICAgICAgICBpZihsYWJlbEluZGV4ID09IG51bGwpe1xyXG4gICAgICAgICAgICBsYWJlbEluZGV4ID0gdGhpcy5tYXhMYWJlbEluZGV4Kys7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbGFiZWxlZE5vZGUgPSB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uOiBwb3NpdGlvbixcclxuICAgICAgICAgICAgbGFiZWxJbmRleDogbGFiZWxJbmRleFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMubGFiZWxlZE5vZGVzLnB1c2gobGFiZWxlZE5vZGUpO1xyXG5cclxuICAgICAgICB0aGlzLmxhYmVsTWFwLnNldChsYWJlbEluZGV4LCBsYWJlbGVkTm9kZSk7XHJcblxyXG4gICAgICAgIHJldHVybiBsYWJlbEluZGV4O1xyXG5cclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVOb2RlKG5vZGU6IFN0YXRlbWVudCl7XHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMubGFiZWxlZE5vZGVzLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgbGV0IG4gPSB0aGlzLmxhYmVsZWROb2Rlc1tpXTtcclxuICAgICAgICAgICAgaWYobi5ub2RlID09IG5vZGUpe1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzLmluZGV4T2Yobm9kZSk7XHJcbiAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYoaW5kZXggPCB0aGlzLnByb2dyYW0uc3RhdGVtZW50cy5sZW5ndGggLSAxKXtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3Tm9kZSA9IHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzW2luZGV4ICsgMV07XHJcbiAgICAgICAgICAgICAgICAgICAgbi5ub2RlID0gbmV3Tm9kZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpKys7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZWdpc3Rlckp1bXBEZXN0aW5hdGlvbihub2RlOiBTdGF0ZW1lbnQsIGxhYmVsSW5kZXg/OiBudW1iZXIpOiBudW1iZXIge1xyXG5cclxuICAgICAgICBpZihsYWJlbEluZGV4ID09IG51bGwpe1xyXG4gICAgICAgICAgICBsYWJlbEluZGV4ID0gdGhpcy5tYXhMYWJlbEluZGV4Kys7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbGFiZWw6IExhYmVsZWROb2RlID0ge1xyXG4gICAgICAgICAgICBub2RlOiBub2RlLFxyXG4gICAgICAgICAgICBsYWJlbEluZGV4OiBsYWJlbEluZGV4XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxhYmVsZWROb2Rlcy5wdXNoKGxhYmVsKTtcclxuICAgICAgICB0aGlzLmxhYmVsTWFwLnNldChsYWJlbEluZGV4LCBsYWJlbCk7XHJcblxyXG4gICAgICAgIHJldHVybiBsYWJlbEluZGV4O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZWdpc3Rlckp1bXBOb2RlKG5vZGU6IEp1bXBOb2RlLCBsYWJlbEluZGV4PzogbnVtYmVyKTogbnVtYmVyIHtcclxuXHJcbiAgICAgICAgaWYobGFiZWxJbmRleCA9PSBudWxsKXtcclxuICAgICAgICAgICAgbGFiZWxJbmRleCA9IHRoaXMubWF4TGFiZWxJbmRleCsrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG50cjogbm9kZVRvUmVzb2x2ZSA9IHtcclxuICAgICAgICAgICAgbGFiZWxJbmRleDogbGFiZWxJbmRleCxcclxuICAgICAgICAgICAgbm9kZTogbm9kZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5qdW1wTm9kZXNUb1Jlc29sdmUucHVzaChudHIpO1xyXG5cclxuICAgICAgICByZXR1cm4gbGFiZWxJbmRleDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcmVzb2x2ZU5vZGVzKCl7XHJcbiAgICAgICAgZm9yKGxldCBsbiBvZiB0aGlzLmxhYmVsZWROb2Rlcyl7XHJcblxyXG4gICAgICAgICAgICBpZihsbi5wb3NpdGlvbiA9PSBudWxsKXtcclxuICAgICAgICAgICAgICAgIGxuLnBvc2l0aW9uID0gdGhpcy5wcm9ncmFtLnN0YXRlbWVudHMuaW5kZXhPZihsbi5ub2RlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHdoaWxlKGxuLnBvc2l0aW9uID4gdGhpcy5wcm9ncmFtLnN0YXRlbWVudHMubGVuZ3RoIC0gMSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9ncmFtLnN0YXRlbWVudHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRva2VuVHlwZS5ub09wLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogbnVsbFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbG4ubm9kZSA9IHRoaXMucHJvZ3JhbS5zdGF0ZW1lbnRzW2xuLnBvc2l0aW9uXTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvcihsZXQgam4gb2YgdGhpcy5qdW1wTm9kZXNUb1Jlc29sdmUpe1xyXG4gICAgICAgICAgICBsZXQgZGVzdCA9IHRoaXMubGFiZWxNYXAuZ2V0KGpuLmxhYmVsSW5kZXgpO1xyXG4gICAgICAgICAgICBpZihkZXN0ICE9IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgam4ubm9kZS5kZXN0aW5hdGlvbiA9IGRlc3QucG9zaXRpb247XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvcihsZXQgc3cgb2YgdGhpcy5zd2l0Y2hTdGF0ZW1lbnRzKXtcclxuICAgICAgICAgICAgZm9yKGxldCBkbCBvZiBzdy5kZXN0aW5hdGlvbkxhYmVscyl7XHJcbiAgICAgICAgICAgICAgICBzdy5kZXN0aW5hdGlvbk1hcFtkbC5jb25zdGFudF0gPSB0aGlzLmxhYmVsTWFwLmdldChkbC5sYWJlbCkucG9zaXRpb247XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3cuZGVzdGluYXRpb25MYWJlbHMgPSBudWxsO1xyXG4gICAgICAgICAgICBpZihzdy5kZWZhdWx0RGVzdGluYXRpb24gIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICBzdy5kZWZhdWx0RGVzdGluYXRpb24gPSB0aGlzLmxhYmVsTWFwLmdldChzdy5kZWZhdWx0RGVzdGluYXRpb24pLnBvc2l0aW9uO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbn1cclxuXHJcbiJdfQ==