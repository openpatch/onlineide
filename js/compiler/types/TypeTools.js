import { ArrayType } from "./Array.js";
import { Interface, Klass } from "./Class.js";
import { Enum } from "./Enum.js";
export class JsonTool {
    constructor() {
        this.primitiveTypes = ["String", "Integer", "Double", "Boolean", "Float", "Character"];
    }
    toJson(value) {
        this.objectToIndexMap = new Map();
        this.nextIndex = 0;
        let json = JSON.stringify(this.toJsonObj(value));
        this.objectToIndexMap = null; // free memory
        return json;
    }
    toJsonObj(value) {
        let type = value.type;
        let v = value.value;
        if (v == null)
            return null;
        if ((type instanceof Klass || type instanceof Interface) && this.primitiveTypes.indexOf(type.identifier) < 0) {
            if (type instanceof Enum) {
                let enumObj = v;
                return enumObj.enumValue.ordinal;
            }
            let rto = v;
            return this.objectToJsonObj(rto);
        }
        else if (type instanceof ArrayType) {
            let arrayValues = v;
            return arrayValues.map(value => this.toJsonObj(value));
        }
        else {
            // primitive Type
            return value.value;
        }
    }
    objectToJsonObj(rto) {
        // We solve circular object references by serializing an index when the same object occurs more than once.
        let index = this.objectToIndexMap.get(rto);
        if (index != null) {
            return { "!i": index };
        }
        index = this.nextIndex++;
        this.objectToIndexMap.set(rto, index);
        let klass = rto.class;
        let serializedObject = { "!k": klass.identifier, "!i": index };
        // Don't serialize system classes unless they are explicitely serializable
        if (klass.module.isSystemModule) {
            return null;
        }
        while (klass != null) {
            let first = true;
            let serializedAttributes;
            for (let attribute of klass.attributes) {
                if (!attribute.isStatic && !attribute.isTransient) {
                    if (first) {
                        first = false;
                        serializedAttributes = {};
                        serializedObject[klass.identifier] = serializedAttributes;
                    }
                    serializedAttributes[attribute.identifier] = this.toJsonObj(rto.attributes[attribute.index]);
                }
            }
            klass = klass.baseClass;
        }
        return serializedObject;
    }
    fromJson(jsonString, type, moduleStore, interpreter) {
        this.indexToObjectMap = {};
        this.valuesToResolve = [];
        let obj = JSON.parse(jsonString);
        let ret = this.fromJsonObj(obj, type, moduleStore, interpreter);
        for (let vtr of this.valuesToResolve) {
            let value = this.indexToObjectMap[vtr.i];
            if (value != null) {
                vtr.v.type = value.type;
                vtr.v.value = value.value;
            }
        }
        this.indexToObjectMap = null; // free memory
        this.valuesToResolve = null;
        return ret.value;
    }
    fromJsonObj(obj, type, moduleStore, interpreter) {
        if (obj == null)
            return { type: type, value: null };
        if ((type instanceof Klass || type instanceof Interface) && this.primitiveTypes.indexOf(type.identifier) < 0) {
            if (type instanceof Enum) {
                return {
                    type: type,
                    value: type.indexToInfoMap[obj].object
                };
            }
            let serializedObject = obj;
            return this.objectFromJsonObj(serializedObject, type, moduleStore, interpreter);
        }
        else if (type instanceof ArrayType) {
            let jsonArray = obj;
            return {
                type: type,
                value: jsonArray.map(v => this.fromJsonObj(v, type.arrayOfType, moduleStore, interpreter))
            };
        }
        else {
            // primitive Type
            return { type: type, value: obj };
        }
    }
    objectFromJsonObj(serializedObject, type, moduleStore, interpreter) {
        let identifier = serializedObject["!k"];
        let index = serializedObject["!i"];
        if (identifier != null) {
            let klass1 = moduleStore.getType(identifier).type;
            let klass = klass1;
            let rto = interpreter.instantiateObjectImmediately(klass);
            while (klass != null) {
                let attributes = rto.attributes;
                let serializedAttributes = serializedObject[klass.identifier];
                if (attributes != null && serializedObject != null) {
                    for (let attribute of klass.attributes) {
                        if (!attribute.isStatic && !attribute.isTransient) {
                            attributes[attribute.index] = this.fromJsonObj(serializedAttributes[attribute.identifier], attribute.type, moduleStore, interpreter);
                        }
                    }
                }
                klass = klass.baseClass;
            }
            let value = { type: klass1, value: rto };
            this.indexToObjectMap[index] = value;
            return value;
        }
        else {
            let index = serializedObject["!i"];
            let value = this.indexToObjectMap[index];
            if (value == null) {
                value = { type: type, value: null };
                this.valuesToResolve.push({ v: value, i: index });
                return value;
            }
            else {
                return { type: value.type, value: value.value }; // return copy
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZVRvb2xzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9jb21waWxlci90eXBlcy9UeXBlVG9vbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN2QyxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM5QyxPQUFPLEVBQUUsSUFBSSxFQUFxQixNQUFNLFdBQVcsQ0FBQztBQVFwRCxNQUFNLE9BQU8sUUFBUTtJQUFyQjtRQVNJLG1CQUFjLEdBQWEsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBb0toRyxDQUFDO0lBbEtHLE1BQU0sQ0FBQyxLQUFZO1FBQ2YsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDbkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxDQUFDLGNBQWM7UUFDNUMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUFZO1FBQ2xCLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsSUFBSSxJQUFJO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFM0IsSUFBSSxDQUFDLElBQUksWUFBWSxLQUFLLElBQUksSUFBSSxZQUFZLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFD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SW50ZXJwcmV0ZXIuanNcIjtcclxuaW1wb3J0IHsgUnVudGltZU9iamVjdCB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9SdW50aW1lT2JqZWN0LmpzXCI7XHJcbmltcG9ydCB7IE1vZHVsZVN0b3JlIH0gZnJvbSBcIi4uL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgQXJyYXlUeXBlIH0gZnJvbSBcIi4vQXJyYXkuanNcIjtcclxuaW1wb3J0IHsgSW50ZXJmYWNlLCBLbGFzcyB9IGZyb20gXCIuL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IEVudW0sIEVudW1SdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4vRW51bS5qc1wiO1xyXG5pbXBvcnQgeyBQcmltaXRpdmVUeXBlLCBUeXBlLCBWYWx1ZSB9IGZyb20gXCIuL1R5cGVzLmpzXCI7XHJcblxyXG50eXBlIFNlcmlhbGl6ZWRPYmplY3QgPSB7XHJcbiAgICBcIiFrXCI/OiBzdHJpbmcsIC8vIENsYXNzIGlkZW50aWZpZXIgb3Igb2JqZWN0IGluZGV4XHJcbiAgICBcIiFpXCI6IG51bWJlciAgLy8gaW5kZXhcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEpzb25Ub29sIHtcclxuICAgIC8vIHRvIGRlc2VyaWFsaXplOlxyXG4gICAgaW5kZXhUb09iamVjdE1hcDogeyBbaW5kZXg6IG51bWJlcl06IFZhbHVlIH07XHJcbiAgICB2YWx1ZXNUb1Jlc29sdmU6IHsgdjogVmFsdWUsIGk6IG51bWJlciB9W107XHJcblxyXG4gICAgLy8gdG8gc2VyaWFsaXplOlxyXG4gICAgb2JqZWN0VG9JbmRleE1hcDogTWFwPFJ1bnRpbWVPYmplY3QsIG51bWJlcj47XHJcbiAgICBuZXh0SW5kZXg6IG51bWJlcjtcclxuXHJcbiAgICBwcmltaXRpdmVUeXBlczogU3RyaW5nW10gPSBbXCJTdHJpbmdcIiwgXCJJbnRlZ2VyXCIsIFwiRG91YmxlXCIsIFwiQm9vbGVhblwiLCBcIkZsb2F0XCIsIFwiQ2hhcmFjdGVyXCJdO1xyXG5cclxuICAgIHRvSnNvbih2YWx1ZTogVmFsdWUpOiBzdHJpbmcge1xyXG4gICAgICAgIHRoaXMub2JqZWN0VG9JbmRleE1hcCA9IG5ldyBNYXAoKTtcclxuICAgICAgICB0aGlzLm5leHRJbmRleCA9IDA7XHJcbiAgICAgICAgbGV0IGpzb24gPSBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSnNvbk9iaih2YWx1ZSkpO1xyXG4gICAgICAgIHRoaXMub2JqZWN0VG9JbmRleE1hcCA9IG51bGw7IC8vIGZyZWUgbWVtb3J5XHJcbiAgICAgICAgcmV0dXJuIGpzb247XHJcbiAgICB9XHJcblxyXG4gICAgdG9Kc29uT2JqKHZhbHVlOiBWYWx1ZSk6IGFueSB7XHJcbiAgICAgICAgbGV0IHR5cGUgPSB2YWx1ZS50eXBlO1xyXG4gICAgICAgIGxldCB2ID0gdmFsdWUudmFsdWU7XHJcbiAgICAgICAgaWYgKHYgPT0gbnVsbCkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgIGlmICgodHlwZSBpbnN0YW5jZW9mIEtsYXNzIHx8IHR5cGUgaW5zdGFuY2VvZiBJbnRlcmZhY2UpICYmIHRoaXMucHJpbWl0aXZlVHlwZXMuaW5kZXhPZih0eXBlLmlkZW50aWZpZXIpIDwgMCkge1xyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGUgaW5zdGFuY2VvZiBFbnVtKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZW51bU9iaiA9IDxFbnVtUnVudGltZU9iamVjdD52O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVudW1PYmouZW51bVZhbHVlLm9yZGluYWw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBydG8gPSA8UnVudGltZU9iamVjdD52O1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vYmplY3RUb0pzb25PYmoocnRvKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGUgaW5zdGFuY2VvZiBBcnJheVR5cGUpIHtcclxuICAgICAgICAgICAgbGV0IGFycmF5VmFsdWVzOiBWYWx1ZVtdID0gdjtcclxuICAgICAgICAgICAgcmV0dXJuIGFycmF5VmFsdWVzLm1hcCh2YWx1ZSA9PiB0aGlzLnRvSnNvbk9iaih2YWx1ZSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIHByaW1pdGl2ZSBUeXBlXHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS52YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb2JqZWN0VG9Kc29uT2JqKHJ0bzogUnVudGltZU9iamVjdCk6IFNlcmlhbGl6ZWRPYmplY3Qge1xyXG4gICAgICAgIC8vIFdlIHNvbHZlIGNpcmN1bGFyIG9iamVjdCByZWZlcmVuY2VzIGJ5IHNlcmlhbGl6aW5nIGFuIGluZGV4IHdoZW4gdGhlIHNhbWUgb2JqZWN0IG9jY3VycyBtb3JlIHRoYW4gb25jZS5cclxuICAgICAgICBsZXQgaW5kZXggPSB0aGlzLm9iamVjdFRvSW5kZXhNYXAuZ2V0KHJ0byk7XHJcbiAgICAgICAgaWYgKGluZGV4ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgXCIhaVwiOiBpbmRleCB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaW5kZXggPSB0aGlzLm5leHRJbmRleCsrO1xyXG4gICAgICAgIHRoaXMub2JqZWN0VG9JbmRleE1hcC5zZXQocnRvLCBpbmRleCk7XHJcbiAgICAgICAgbGV0IGtsYXNzOiBLbGFzcyA9IDxLbGFzcz5ydG8uY2xhc3M7XHJcblxyXG4gICAgICAgIGxldCBzZXJpYWxpemVkT2JqZWN0OiBTZXJpYWxpemVkT2JqZWN0ID0geyBcIiFrXCI6IGtsYXNzLmlkZW50aWZpZXIsIFwiIWlcIjogaW5kZXggfTtcclxuICAgICAgICAvLyBEb24ndCBzZXJpYWxpemUgc3lzdGVtIGNsYXNzZXMgdW5sZXNzIHRoZXkgYXJlIGV4cGxpY2l0ZWx5IHNlcmlhbGl6YWJsZVxyXG4gICAgICAgIGlmIChrbGFzcy5tb2R1bGUuaXNTeXN0ZW1Nb2R1bGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3aGlsZSAoa2xhc3MgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBsZXQgZmlyc3Q6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgICAgICAgICBsZXQgc2VyaWFsaXplZEF0dHJpYnV0ZXM6IGFueTtcclxuICAgICAgICAgICAgZm9yIChsZXQgYXR0cmlidXRlIG9mIGtsYXNzLmF0dHJpYnV0ZXMpIHtcclxuICAgICAgICAgICAgICAgIGlmICghYXR0cmlidXRlLmlzU3RhdGljICYmICFhdHRyaWJ1dGUuaXNUcmFuc2llbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VyaWFsaXplZEF0dHJpYnV0ZXMgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VyaWFsaXplZE9iamVjdFtrbGFzcy5pZGVudGlmaWVyXSA9IHNlcmlhbGl6ZWRBdHRyaWJ1dGVzO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzZXJpYWxpemVkQXR0cmlidXRlc1thdHRyaWJ1dGUuaWRlbnRpZmllcl0gPSB0aGlzLnRvSnNvbk9iaihydG8uYXR0cmlidXRlc1thdHRyaWJ1dGUuaW5kZXhdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAga2xhc3MgPSBrbGFzcy5iYXNlQ2xhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gc2VyaWFsaXplZE9iamVjdDtcclxuICAgIH1cclxuXHJcbiAgICBmcm9tSnNvbihqc29uU3RyaW5nOiBzdHJpbmcsIHR5cGU6IFR5cGUsIG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyKTogYW55IHtcclxuICAgICAgICB0aGlzLmluZGV4VG9PYmplY3RNYXAgPSB7fTtcclxuICAgICAgICB0aGlzLnZhbHVlc1RvUmVzb2x2ZSA9IFtdO1xyXG5cclxuICAgICAgICBsZXQgb2JqOiBhbnkgPSBKU09OLnBhcnNlKGpzb25TdHJpbmcpO1xyXG4gICAgICAgIGxldCByZXQgPSB0aGlzLmZyb21Kc29uT2JqKG9iaiwgdHlwZSwgbW9kdWxlU3RvcmUsIGludGVycHJldGVyKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgdnRyIG9mIHRoaXMudmFsdWVzVG9SZXNvbHZlKSB7XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuaW5kZXhUb09iamVjdE1hcFt2dHIuaV07XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB2dHIudi50eXBlID0gdmFsdWUudHlwZTtcclxuICAgICAgICAgICAgICAgIHZ0ci52LnZhbHVlID0gdmFsdWUudmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5kZXhUb09iamVjdE1hcCA9IG51bGw7IC8vIGZyZWUgbWVtb3J5XHJcbiAgICAgICAgdGhpcy52YWx1ZXNUb1Jlc29sdmUgPSBudWxsO1xyXG4gICAgICAgIHJldHVybiByZXQudmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZnJvbUpzb25PYmoob2JqOiBhbnksIHR5cGU6IFR5cGUsIG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyKTogVmFsdWUge1xyXG4gICAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHsgdHlwZTogdHlwZSwgdmFsdWU6IG51bGwgfTtcclxuXHJcbiAgICAgICAgaWYgKCh0eXBlIGluc3RhbmNlb2YgS2xhc3MgfHwgdHlwZSBpbnN0YW5jZW9mIEludGVyZmFjZSkgJiYgdGhpcy5wcmltaXRpdmVUeXBlcy5pbmRleE9mKHR5cGUuaWRlbnRpZmllcikgPCAwKSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodHlwZSBpbnN0YW5jZW9mIEVudW0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdHlwZS5pbmRleFRvSW5mb01hcFtvYmpdLm9iamVjdFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgc2VyaWFsaXplZE9iamVjdCA9IDxTZXJpYWxpemVkT2JqZWN0Pm9iajtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub2JqZWN0RnJvbUpzb25PYmooc2VyaWFsaXplZE9iamVjdCwgdHlwZSwgbW9kdWxlU3RvcmUsIGludGVycHJldGVyKTtcclxuXHJcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlIGluc3RhbmNlb2YgQXJyYXlUeXBlKSB7XHJcbiAgICAgICAgICAgIGxldCBqc29uQXJyYXk6IGFueVtdID0gb2JqO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiBqc29uQXJyYXkubWFwKHYgPT4gdGhpcy5mcm9tSnNvbk9iaih2LCB0eXBlLmFycmF5T2ZUeXBlLCBtb2R1bGVTdG9yZSwgaW50ZXJwcmV0ZXIpKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gcHJpbWl0aXZlIFR5cGVcclxuICAgICAgICAgICAgcmV0dXJuIHsgdHlwZTogdHlwZSwgdmFsdWU6IG9iaiB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBvYmplY3RGcm9tSnNvbk9iaihzZXJpYWxpemVkT2JqZWN0OiBTZXJpYWxpemVkT2JqZWN0LCB0eXBlOiBLbGFzcyB8IEludGVyZmFjZSwgbW9kdWxlU3RvcmU6IE1vZHVsZVN0b3JlLFxyXG4gICAgICAgIGludGVycHJldGVyOiBJbnRlcnByZXRlcik6IFZhbHVlIHtcclxuXHJcbiAgICAgICAgbGV0IGlkZW50aWZpZXI6IHN0cmluZyA9IHNlcmlhbGl6ZWRPYmplY3RbXCIha1wiXTtcclxuICAgICAgICBsZXQgaW5kZXggPSBzZXJpYWxpemVkT2JqZWN0W1wiIWlcIl07XHJcbiAgICAgICAgaWYgKGlkZW50aWZpZXIgIT0gbnVsbCkge1xyXG5cclxuICAgICAgICAgICAgbGV0IGtsYXNzMTogS2xhc3MgPSA8S2xhc3M+bW9kdWxlU3RvcmUuZ2V0VHlwZShpZGVudGlmaWVyKS50eXBlO1xyXG4gICAgICAgICAgICBsZXQga2xhc3MgPSBrbGFzczE7XHJcblxyXG4gICAgICAgICAgICBsZXQgcnRvOiBSdW50aW1lT2JqZWN0ID0gaW50ZXJwcmV0ZXIuaW5zdGFudGlhdGVPYmplY3RJbW1lZGlhdGVseShrbGFzcyk7XHJcblxyXG4gICAgICAgICAgICB3aGlsZSAoa2xhc3MgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGF0dHJpYnV0ZXMgPSBydG8uYXR0cmlidXRlcztcclxuICAgICAgICAgICAgICAgIGxldCBzZXJpYWxpemVkQXR0cmlidXRlcyA9IHNlcmlhbGl6ZWRPYmplY3Rba2xhc3MuaWRlbnRpZmllcl07XHJcbiAgICAgICAgICAgICAgICBpZiAoYXR0cmlidXRlcyAhPSBudWxsICYmIHNlcmlhbGl6ZWRPYmplY3QgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGF0dHJpYnV0ZSBvZiBrbGFzcy5hdHRyaWJ1dGVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXR0cmlidXRlLmlzU3RhdGljICYmICFhdHRyaWJ1dGUuaXNUcmFuc2llbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXNbYXR0cmlidXRlLmluZGV4XSA9IHRoaXMuZnJvbUpzb25PYmooc2VyaWFsaXplZEF0dHJpYnV0ZXNbYXR0cmlidXRlLmlkZW50aWZpZXJdLCBhdHRyaWJ1dGUudHlwZSwgbW9kdWxlU3RvcmUsIGludGVycHJldGVyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBrbGFzcyA9IGtsYXNzLmJhc2VDbGFzcztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHZhbHVlOiBWYWx1ZSA9IHsgdHlwZToga2xhc3MxLCB2YWx1ZTogcnRvIH07XHJcbiAgICAgICAgICAgIHRoaXMuaW5kZXhUb09iamVjdE1hcFtpbmRleF0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgaW5kZXggPSBzZXJpYWxpemVkT2JqZWN0W1wiIWlcIl07XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuaW5kZXhUb09iamVjdE1hcFtpbmRleF07XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHsgdHlwZTogdHlwZSwgdmFsdWU6IG51bGwgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMudmFsdWVzVG9SZXNvbHZlLnB1c2goeyB2OiB2YWx1ZSwgaTogaW5kZXggfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyB0eXBlOiB2YWx1ZS50eXBlLCB2YWx1ZTogdmFsdWUudmFsdWUgfTsgLy8gcmV0dXJuIGNvcHlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG5cclxuXHJcbn1cclxuXHJcblxyXG4iXX0=