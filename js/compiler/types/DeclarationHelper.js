import { Klass, Interface, Visibility } from "./Class.js";
import { Method, Attribute } from "./Types.js";
import { objectType } from "./PrimitiveTypes.js";
import { formatAsJavadocComment } from "../../tools/StringTools.js";
export function getDeclarationAsString(element, indent = "", short = false) {
    if (element instanceof Klass) {
        if (element.isTypeVariable) {
            return getTypeVariableDeclaration(element);
        }
        let s = "";
        if (element.documentation != null && element.documentation != "") {
            if (element.documentation.startsWith("/*")) {
                s += (indent + element.documentation).replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                // s += indent + "/**  \n" + element.documentation + "  \n**/  \n" + indent;
                s += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        if (element.visibility != null)
            s += Visibility[element.visibility] + " ";
        if (element.isAbstract)
            s += "abstract ";
        s += "class " + element.identifier + " ";
        if (element.typeVariables.length > 0) {
            s += getGenericParameterDefinition(element);
        }
        if (element.baseClass != null && element.baseClass.identifier != "Object") {
            s += "extends " + element.baseClass.identifier + " ";
            if (element.baseClass.typeVariables.length > 0) {
                s += getGenericParameterDefinition(element.baseClass);
            }
        }
        if (element.implements != null && element.implements.length > 0) {
            s += "implements ";
            for (let i = 0; i < element.implements.length; i++) {
                s += element.implements[i].identifier;
                if (element.implements[i].typeVariables.length > 0) {
                    s += getGenericParameterDefinition(element.implements[i]);
                }
                if (i < element.implements.length - 1) {
                    s += ", ";
                }
            }
        }
        if (short)
            return s;
        s += indent + "{\n  ";
        for (let a of element.getAttributes(Visibility.protected)) {
            s += indent + "\n" + getDeclarationAsString(a, "  ") + ";\n";
        }
        if (element.staticClass != null) {
            for (let a of element.staticClass.getAttributes(Visibility.protected)) {
                s += indent + "\n" + getDeclarationAsString(a, "  ") + ";\n";
            }
        }
        for (let m of element.getMethods(Visibility.protected)) {
            s += indent + "\n" + getDeclarationAsString(m, "  ") + ";\n";
        }
        if (element.staticClass != null) {
            for (let m of element.staticClass.getMethods(Visibility.protected)) {
                s += indent + "\n" + getDeclarationAsString(m, "  ") + ";\n";
            }
        }
        s += "\n}";
        return s;
    }
    if (element instanceof Interface) {
        let decl = "";
        if (element.documentation != null && element.documentation != "" && !short) {
            if (element.documentation.startsWith("/*")) {
                decl += (indent + element.documentation).replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                decl += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        decl += indent + "interface " + element.identifier;
        if (element.typeVariables.length > 0) {
            decl += getGenericParameterDefinition(element);
        }
        if (element.extends != null && element.extends.length > 0) {
            decl += "extends ";
            for (let i = 0; i < element.extends.length; i++) {
                decl += element.extends[i].identifier;
                if (element.extends[i].typeVariables.length > 0) {
                    decl += getGenericParameterDefinition(element.extends[i]);
                }
                if (i < element.extends.length - 1) {
                    decl += ", ";
                }
            }
        }
        if (!short) {
            decl += "{\n";
            for (let m of element.methods) {
                decl += indent + "\n" + getDeclarationAsString(m, "  ") + ";\n";
            }
            decl += "\n}";
        }
        return decl;
    }
    if (element instanceof Attribute) {
        let s = "";
        if (element.documentation != null && element.documentation != "" && !short) {
            if (element.documentation.startsWith("/*")) {
                s += indent + element.documentation.replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                s += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        s += indent;
        if (element.visibility != null)
            s += Visibility[element.visibility] + " ";
        if (element.isStatic)
            s += "static ";
        s += getTypeIdentifier(element.type) + " " + element.identifier;
        return s;
    }
    if (element instanceof Method) {
        let s = "";
        if (element.documentation != null && element.documentation != "" && !short) {
            if (element.documentation.startsWith("/*")) {
                s += indent + element.documentation.replace(/\n/g, "\n" + indent) + "\n";
            }
            else {
                s += formatAsJavadocComment(element.documentation, indent) + "\n";
            }
        }
        s += indent;
        if (element.visibility != null)
            s += Visibility[element.visibility] + " ";
        if (element.isStatic)
            s += "static ";
        if (element.getReturnType() != null) {
            s += getTypeIdentifier(element.getReturnType()) + " ";
        }
        else {
            s += element.isConstructor ? "" : "void ";
        }
        s += element.identifier + "(";
        let parameters = element.getParameterList().parameters;
        for (let i = 0; i < parameters.length; i++) {
            let p = parameters[i];
            let type = element.getParameterType(i);
            if (p.isEllipsis) {
                type = type.arrayOfType;
            }
            s += getTypeIdentifier(type) + (p.isEllipsis ? "..." : "") + " " + p.identifier;
            if (i < parameters.length - 1) {
                s += ", ";
            }
        }
        s += ")";
        return s;
    }
    return "";
}
function getTypeVariableDeclaration(element) {
    let s = element.identifier;
    if (element.isGenericVariantFrom != objectType)
        s += " extends " + getTypeIdentifier(element.isGenericVariantFrom);
    if (element.implements.length > 0) {
        let implList = element.implements.filter(impl => element.isGenericVariantFrom.implements.indexOf(impl) < 0)
            .map(impl => getTypeIdentifier(impl)).join(", ");
        if (implList != "") {
            s += " implements " + implList;
        }
    }
    return s;
}
export function getTypeIdentifier(type) {
    var _a, _b;
    if (type instanceof Klass || type instanceof Interface) {
        if (type.typeVariables.length > 0) {
            let s = (type["isTypeVariable"] ? (type.identifier + " extends " + ((_a = type.isGenericVariantFrom) === null || _a === void 0 ? void 0 : _a.identifier)) : type.identifier)
                + "<";
            s += type.typeVariables.map(tv => getTypeIdentifier(tv.type)).join(", ");
            return s + ">";
        }
    }
    return type["isTypeVariable"] ? (type.identifier + " extends " + ((_b = type["isGenericVariantFrom"]) === null || _b === void 0 ? void 0 : _b.identifier)) : type.identifier;
}
export function getGenericParameterDefinition(element) {
    let s = "";
    if (element.typeVariables.length > 0) {
        s = "<";
        let typeList = [];
        for (let tv of element.typeVariables) {
            let t = tv.type.identifier;
            let k = tv.type;
            if (k.isGenericVariantFrom != null && k.isGenericVariantFrom.identifier != "Object") {
                t += " extends " + k.isGenericVariantFrom.identifier;
            }
            if (k.implements != null) {
                let implList = k.implements;
                if (k.isGenericVariantFrom != null) {
                    implList = implList.filter(impl => k.isGenericVariantFrom.implements.indexOf(impl) < 0);
                }
                for (let im of implList) {
                    t += " & " + im.identifier;
                }
            }
            typeList.push(t);
        }
        s += typeList.join(", ");
        s += "> ";
    }
    return s;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVjbGFyYXRpb25IZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvbXBpbGVyL3R5cGVzL0RlY2xhcmF0aW9uSGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBaUMsTUFBTSxZQUFZLENBQUM7QUFDOUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWpELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXBFLE1BQU0sVUFBVSxzQkFBc0IsQ0FBQyxPQUEwRCxFQUM3RixTQUFpQixFQUFFLEVBQUUsUUFBaUIsS0FBSztJQUUzQyxJQUFJLE9BQU8sWUFBWSxLQUFLLEVBQUU7UUFFMUIsSUFBSSxPQUFPLENBQUMsY0FBYyxFQUFFO1lBQ3hCLE9BQU8sMEJBQTBCLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDOUM7UUFFRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFWCxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksRUFBRSxFQUFFO1lBQzlELElBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUM7Z0JBQ3RDLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLEdBQUcsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQzlFO2lCQUFNO2dCQUNILDRFQUE0RTtnQkFDNUUsQ0FBQyxJQUFJLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQ3JF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Q0FBQyxDQUFDLG9CQUFvQixJQUFJLElBQUksRUFBRTtvQkFDaEMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDM0Y7Z0JBRUQsS0FBSyxJQUFJLEVBQUUsSUFBSSxRQUFRLEVBQUU7b0JBQ3JCLENBQUMsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQztpQkFDOUI7YUFDSjtZQUNELFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDcEI7UUFFRCxDQUFDLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDLElBQUksSUFBSSxDQUFDO0tBQ2I7SUFFRCxPQUFPLENBQUMsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBLbGFzcywgSW50ZXJmYWNlLCBWaXNpYmlsaXR5IH0gZnJvbSBcIi4vQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgTWV0aG9kLCBBdHRyaWJ1dGUsIFR5cGUsIFByaW1pdGl2ZVR5cGUsIFZhcmlhYmxlIH0gZnJvbSBcIi4vVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgb2JqZWN0VHlwZSB9IGZyb20gXCIuL1ByaW1pdGl2ZVR5cGVzLmpzXCI7XHJcbmltcG9ydCB7IEFycmF5VHlwZSB9IGZyb20gXCIuL0FycmF5LmpzXCI7XHJcbmltcG9ydCB7IGZvcm1hdEFzSmF2YWRvY0NvbW1lbnQgfSBmcm9tIFwiLi4vLi4vdG9vbHMvU3RyaW5nVG9vbHMuanNcIjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKGVsZW1lbnQ6IEtsYXNzIHwgSW50ZXJmYWNlIHwgTWV0aG9kIHwgQXR0cmlidXRlIHwgVmFyaWFibGUsXHJcbiAgICBpbmRlbnQ6IHN0cmluZyA9IFwiXCIsIHNob3J0OiBib29sZWFuID0gZmFsc2UpOiBzdHJpbmcge1xyXG5cclxuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgS2xhc3MpIHtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuaXNUeXBlVmFyaWFibGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdldFR5cGVWYXJpYWJsZURlY2xhcmF0aW9uKGVsZW1lbnQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHMgPSBcIlwiO1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5kb2N1bWVudGF0aW9uICE9IG51bGwgJiYgZWxlbWVudC5kb2N1bWVudGF0aW9uICE9IFwiXCIpIHtcclxuICAgICAgICAgICAgaWYoZWxlbWVudC5kb2N1bWVudGF0aW9uLnN0YXJ0c1dpdGgoXCIvKlwiKSl7XHJcbiAgICAgICAgICAgICAgICBzICs9IChpbmRlbnQgKyBlbGVtZW50LmRvY3VtZW50YXRpb24pLnJlcGxhY2UoL1xcbi9nLCBcIlxcblwiICsgaW5kZW50KSArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBzICs9IGluZGVudCArIFwiLyoqICBcXG5cIiArIGVsZW1lbnQuZG9jdW1lbnRhdGlvbiArIFwiICBcXG4qKi8gIFxcblwiICsgaW5kZW50O1xyXG4gICAgICAgICAgICAgICAgcyArPSBmb3JtYXRBc0phdmFkb2NDb21tZW50KGVsZW1lbnQuZG9jdW1lbnRhdGlvbiwgaW5kZW50KSArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LnZpc2liaWxpdHkgIT0gbnVsbCkgcyArPSBWaXNpYmlsaXR5W2VsZW1lbnQudmlzaWJpbGl0eV0gKyBcIiBcIjtcclxuICAgICAgICBpZiAoZWxlbWVudC5pc0Fic3RyYWN0KSBzICs9IFwiYWJzdHJhY3QgXCI7XHJcbiAgICAgICAgcyArPSBcImNsYXNzIFwiICsgZWxlbWVudC5pZGVudGlmaWVyICsgXCIgXCI7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LnR5cGVWYXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBzICs9IGdldEdlbmVyaWNQYXJhbWV0ZXJEZWZpbml0aW9uKGVsZW1lbnQpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmJhc2VDbGFzcyAhPSBudWxsICYmIGVsZW1lbnQuYmFzZUNsYXNzLmlkZW50aWZpZXIgIT0gXCJPYmplY3RcIikge1xyXG4gICAgICAgICAgICBzICs9IFwiZXh0ZW5kcyBcIiArIGVsZW1lbnQuYmFzZUNsYXNzLmlkZW50aWZpZXIgKyBcIiBcIjtcclxuICAgICAgICAgICAgaWYgKGVsZW1lbnQuYmFzZUNsYXNzLnR5cGVWYXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgcyArPSBnZXRHZW5lcmljUGFyYW1ldGVyRGVmaW5pdGlvbihlbGVtZW50LmJhc2VDbGFzcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmltcGxlbWVudHMgIT0gbnVsbCAmJiBlbGVtZW50LmltcGxlbWVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBzICs9IFwiaW1wbGVtZW50cyBcIjtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtZW50LmltcGxlbWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHMgKz0gZWxlbWVudC5pbXBsZW1lbnRzW2ldLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5pbXBsZW1lbnRzW2ldLnR5cGVWYXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHMgKz0gZ2V0R2VuZXJpY1BhcmFtZXRlckRlZmluaXRpb24oZWxlbWVudC5pbXBsZW1lbnRzW2ldKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpIDwgZWxlbWVudC5pbXBsZW1lbnRzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBzICs9IFwiLCBcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHNob3J0KSByZXR1cm4gcztcclxuXHJcbiAgICAgICAgcyArPSBpbmRlbnQgKyBcIntcXG4gIFwiO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBhIG9mIGVsZW1lbnQuZ2V0QXR0cmlidXRlcyhWaXNpYmlsaXR5LnByb3RlY3RlZCkpIHtcclxuICAgICAgICAgICAgcyArPSBpbmRlbnQgKyBcIlxcblwiICsgZ2V0RGVjbGFyYXRpb25Bc1N0cmluZyhhLCBcIiAgXCIpICsgXCI7XFxuXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5zdGF0aWNDbGFzcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGEgb2YgZWxlbWVudC5zdGF0aWNDbGFzcy5nZXRBdHRyaWJ1dGVzKFZpc2liaWxpdHkucHJvdGVjdGVkKSkge1xyXG4gICAgICAgICAgICAgICAgcyArPSBpbmRlbnQgKyBcIlxcblwiICsgZ2V0RGVjbGFyYXRpb25Bc1N0cmluZyhhLCBcIiAgXCIpICsgXCI7XFxuXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAobGV0IG0gb2YgZWxlbWVudC5nZXRNZXRob2RzKFZpc2liaWxpdHkucHJvdGVjdGVkKSkge1xyXG4gICAgICAgICAgICBzICs9IGluZGVudCArIFwiXFxuXCIgKyBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKG0sIFwiICBcIikgKyBcIjtcXG5cIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LnN0YXRpY0NsYXNzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgbSBvZiBlbGVtZW50LnN0YXRpY0NsYXNzLmdldE1ldGhvZHMoVmlzaWJpbGl0eS5wcm90ZWN0ZWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzICs9IGluZGVudCArIFwiXFxuXCIgKyBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKG0sIFwiICBcIikgKyBcIjtcXG5cIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHMgKz0gXCJcXG59XCI7XHJcblxyXG4gICAgICAgIHJldHVybiBzO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEludGVyZmFjZSkge1xyXG5cclxuICAgICAgICBsZXQgZGVjbCA9IFwiXCI7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmRvY3VtZW50YXRpb24gIT0gbnVsbCAmJiBlbGVtZW50LmRvY3VtZW50YXRpb24gIT0gXCJcIiAmJiAhc2hvcnQpIHtcclxuICAgICAgICAgICAgaWYoZWxlbWVudC5kb2N1bWVudGF0aW9uLnN0YXJ0c1dpdGgoXCIvKlwiKSl7XHJcbiAgICAgICAgICAgICAgICBkZWNsICs9IChpbmRlbnQgKyBlbGVtZW50LmRvY3VtZW50YXRpb24pLnJlcGxhY2UoL1xcbi9nLCBcIlxcblwiICsgaW5kZW50KSArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkZWNsICs9IGZvcm1hdEFzSmF2YWRvY0NvbW1lbnQoZWxlbWVudC5kb2N1bWVudGF0aW9uLCBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZGVjbCArPSBpbmRlbnQgKyBcImludGVyZmFjZSBcIiArIGVsZW1lbnQuaWRlbnRpZmllcjtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQudHlwZVZhcmlhYmxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGRlY2wgKz0gZ2V0R2VuZXJpY1BhcmFtZXRlckRlZmluaXRpb24oZWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5leHRlbmRzICE9IG51bGwgJiYgZWxlbWVudC5leHRlbmRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZGVjbCArPSBcImV4dGVuZHMgXCI7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbWVudC5leHRlbmRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBkZWNsICs9IGVsZW1lbnQuZXh0ZW5kc1tpXS5pZGVudGlmaWVyO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZXh0ZW5kc1tpXS50eXBlVmFyaWFibGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWNsICs9IGdldEdlbmVyaWNQYXJhbWV0ZXJEZWZpbml0aW9uKGVsZW1lbnQuZXh0ZW5kc1tpXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaSA8IGVsZW1lbnQuZXh0ZW5kcy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjbCArPSBcIiwgXCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghc2hvcnQpIHtcclxuXHJcbiAgICAgICAgICAgIGRlY2wgKz0gXCJ7XFxuXCI7XHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBtIG9mIGVsZW1lbnQubWV0aG9kcykge1xyXG4gICAgICAgICAgICAgICAgZGVjbCArPSBpbmRlbnQgKyBcIlxcblwiICsgZ2V0RGVjbGFyYXRpb25Bc1N0cmluZyhtLCBcIiAgXCIpICsgXCI7XFxuXCI7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGRlY2wgKz0gXCJcXG59XCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZGVjbDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBBdHRyaWJ1dGUpIHtcclxuICAgICAgICBsZXQgcyA9IFwiXCI7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmRvY3VtZW50YXRpb24gIT0gbnVsbCAmJiBlbGVtZW50LmRvY3VtZW50YXRpb24gIT0gXCJcIiAmJiAhc2hvcnQpIHtcclxuICAgICAgICAgICAgaWYoZWxlbWVudC5kb2N1bWVudGF0aW9uLnN0YXJ0c1dpdGgoXCIvKlwiKSl7XHJcbiAgICAgICAgICAgICAgICBzICs9IGluZGVudCArIGVsZW1lbnQuZG9jdW1lbnRhdGlvbi5yZXBsYWNlKC9cXG4vZywgXCJcXG5cIiArIGluZGVudCkgKyBcIlxcblwiO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcyArPSBmb3JtYXRBc0phdmFkb2NDb21tZW50KGVsZW1lbnQuZG9jdW1lbnRhdGlvbiwgaW5kZW50KSArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHMgKz0gaW5kZW50O1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC52aXNpYmlsaXR5ICE9IG51bGwpIHMgKz0gVmlzaWJpbGl0eVtlbGVtZW50LnZpc2liaWxpdHldICsgXCIgXCI7XHJcblxyXG4gICAgICAgIGlmIChlbGVtZW50LmlzU3RhdGljKSBzICs9IFwic3RhdGljIFwiO1xyXG5cclxuICAgICAgICBzICs9IGdldFR5cGVJZGVudGlmaWVyKGVsZW1lbnQudHlwZSkgKyBcIiBcIiArIGVsZW1lbnQuaWRlbnRpZmllcjtcclxuXHJcbiAgICAgICAgcmV0dXJuIHM7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBNZXRob2QpIHtcclxuXHJcbiAgICAgICAgbGV0IHMgPSBcIlwiO1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5kb2N1bWVudGF0aW9uICE9IG51bGwgJiYgZWxlbWVudC5kb2N1bWVudGF0aW9uICE9IFwiXCIgJiYgIXNob3J0KSB7XHJcbiAgICAgICAgICAgIGlmKGVsZW1lbnQuZG9jdW1lbnRhdGlvbi5zdGFydHNXaXRoKFwiLypcIikpe1xyXG4gICAgICAgICAgICAgICAgcyArPSBpbmRlbnQgKyBlbGVtZW50LmRvY3VtZW50YXRpb24ucmVwbGFjZSgvXFxuL2csIFwiXFxuXCIgKyBpbmRlbnQpICsgXCJcXG5cIjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHMgKz0gZm9ybWF0QXNKYXZhZG9jQ29tbWVudChlbGVtZW50LmRvY3VtZW50YXRpb24sIGluZGVudCkgKyBcIlxcblwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzICs9IGluZGVudDtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQudmlzaWJpbGl0eSAhPSBudWxsKSBzICs9IFZpc2liaWxpdHlbZWxlbWVudC52aXNpYmlsaXR5XSArIFwiIFwiO1xyXG5cclxuICAgICAgICBpZiAoZWxlbWVudC5pc1N0YXRpYykgcyArPSBcInN0YXRpYyBcIjtcclxuXHJcbiAgICAgICAgaWYgKGVsZW1lbnQuZ2V0UmV0dXJuVHlwZSgpICE9IG51bGwpIHtcclxuICAgICAgICAgICAgcyArPSBnZXRUeXBlSWRlbnRpZmllcihlbGVtZW50LmdldFJldHVyblR5cGUoKSkgKyBcIiBcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzICs9IGVsZW1lbnQuaXNDb25zdHJ1Y3RvciA/IFwiXCIgOiBcInZvaWQgXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzICs9IGVsZW1lbnQuaWRlbnRpZmllciArIFwiKFwiO1xyXG5cclxuICAgICAgICBsZXQgcGFyYW1ldGVycyA9IGVsZW1lbnQuZ2V0UGFyYW1ldGVyTGlzdCgpLnBhcmFtZXRlcnM7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJhbWV0ZXJzLmxlbmd0aDsgaSsrKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQgcCA9IHBhcmFtZXRlcnNbaV07XHJcbiAgICAgICAgICAgIGxldCB0eXBlOiBUeXBlID0gZWxlbWVudC5nZXRQYXJhbWV0ZXJUeXBlKGkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHAuaXNFbGxpcHNpcykge1xyXG4gICAgICAgICAgICAgICAgdHlwZSA9ICg8QXJyYXlUeXBlPnR5cGUpLmFycmF5T2ZUeXBlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBzICs9IGdldFR5cGVJZGVudGlmaWVyKHR5cGUpICsgKHAuaXNFbGxpcHNpcyA/IFwiLi4uXCIgOiBcIlwiKSArIFwiIFwiICsgcC5pZGVudGlmaWVyO1xyXG5cclxuICAgICAgICAgICAgaWYgKGkgPCBwYXJhbWV0ZXJzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgIHMgKz0gXCIsIFwiO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcyArPSBcIilcIjtcclxuXHJcbiAgICAgICAgcmV0dXJuIHM7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gXCJcIjtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0VHlwZVZhcmlhYmxlRGVjbGFyYXRpb24oZWxlbWVudDogS2xhc3MpIHtcclxuICAgIGxldCBzOiBzdHJpbmcgPSBlbGVtZW50LmlkZW50aWZpZXI7XHJcblxyXG4gICAgaWYgKGVsZW1lbnQuaXNHZW5lcmljVmFyaWFudEZyb20gIT0gb2JqZWN0VHlwZSkgcyArPSBcIiBleHRlbmRzIFwiICsgZ2V0VHlwZUlkZW50aWZpZXIoZWxlbWVudC5pc0dlbmVyaWNWYXJpYW50RnJvbSk7XHJcbiAgICBpZiAoZWxlbWVudC5pbXBsZW1lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBsZXQgaW1wbExpc3QgPSBlbGVtZW50LmltcGxlbWVudHMuZmlsdGVyKGltcGwgPT4gZWxlbWVudC5pc0dlbmVyaWNWYXJpYW50RnJvbS5pbXBsZW1lbnRzLmluZGV4T2YoaW1wbCkgPCAwKVxyXG4gICAgICAgICAgICAubWFwKGltcGwgPT4gZ2V0VHlwZUlkZW50aWZpZXIoaW1wbCkpLmpvaW4oXCIsIFwiKTtcclxuICAgICAgICBpZiAoaW1wbExpc3QgIT0gXCJcIikge1xyXG4gICAgICAgICAgICBzICs9IFwiIGltcGxlbWVudHMgXCIgKyBpbXBsTGlzdDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRUeXBlSWRlbnRpZmllcih0eXBlOiBUeXBlKTogc3RyaW5nIHtcclxuICAgIGlmICh0eXBlIGluc3RhbmNlb2YgS2xhc3MgfHwgdHlwZSBpbnN0YW5jZW9mIEludGVyZmFjZSkge1xyXG4gICAgICAgIGlmICh0eXBlLnR5cGVWYXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBsZXQgczogc3RyaW5nID0gKHR5cGVbXCJpc1R5cGVWYXJpYWJsZVwiXSA/ICh0eXBlLmlkZW50aWZpZXIgKyBcIiBleHRlbmRzIFwiICsgdHlwZS5pc0dlbmVyaWNWYXJpYW50RnJvbT8uaWRlbnRpZmllcikgOiB0eXBlLmlkZW50aWZpZXIpXHJcbiAgICAgICAgICAgICAgICArIFwiPFwiO1xyXG4gICAgICAgICAgICBzICs9IHR5cGUudHlwZVZhcmlhYmxlcy5tYXAodHYgPT4gZ2V0VHlwZUlkZW50aWZpZXIodHYudHlwZSkpLmpvaW4oXCIsIFwiKTtcclxuICAgICAgICAgICAgcmV0dXJuIHMgKyBcIj5cIjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHR5cGVbXCJpc1R5cGVWYXJpYWJsZVwiXSA/ICh0eXBlLmlkZW50aWZpZXIgKyBcIiBleHRlbmRzIFwiICsgdHlwZVtcImlzR2VuZXJpY1ZhcmlhbnRGcm9tXCJdPy5pZGVudGlmaWVyKSA6IHR5cGUuaWRlbnRpZmllcjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEdlbmVyaWNQYXJhbWV0ZXJEZWZpbml0aW9uKGVsZW1lbnQ6IEtsYXNzIHwgSW50ZXJmYWNlKTogc3RyaW5nIHtcclxuXHJcbiAgICBsZXQgczogc3RyaW5nID0gXCJcIjtcclxuXHJcbiAgICBpZiAoZWxlbWVudC50eXBlVmFyaWFibGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBzID0gXCI8XCI7XHJcblxyXG4gICAgICAgIGxldCB0eXBlTGlzdDogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICBmb3IgKGxldCB0diBvZiBlbGVtZW50LnR5cGVWYXJpYWJsZXMpIHtcclxuICAgICAgICAgICAgbGV0IHQ6IHN0cmluZyA9IHR2LnR5cGUuaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgbGV0IGs6IEtsYXNzID0gdHYudHlwZTtcclxuICAgICAgICAgICAgaWYgKGsuaXNHZW5lcmljVmFyaWFudEZyb20gIT0gbnVsbCAmJiBrLmlzR2VuZXJpY1ZhcmlhbnRGcm9tLmlkZW50aWZpZXIgIT0gXCJPYmplY3RcIikge1xyXG4gICAgICAgICAgICAgICAgdCArPSBcIiBleHRlbmRzIFwiICsgay5pc0dlbmVyaWNWYXJpYW50RnJvbS5pZGVudGlmaWVyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChrLmltcGxlbWVudHMgIT0gbnVsbCkge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBpbXBsTGlzdCA9IGsuaW1wbGVtZW50cztcclxuICAgICAgICAgICAgICAgIGlmIChrLmlzR2VuZXJpY1ZhcmlhbnRGcm9tICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBpbXBsTGlzdCA9IGltcGxMaXN0LmZpbHRlcihpbXBsID0+IGsuaXNHZW5lcmljVmFyaWFudEZyb20uaW1wbGVtZW50cy5pbmRleE9mKGltcGwpIDwgMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaW0gb2YgaW1wbExpc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICB0ICs9IFwiICYgXCIgKyBpbS5pZGVudGlmaWVyO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHR5cGVMaXN0LnB1c2godCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzICs9IHR5cGVMaXN0LmpvaW4oXCIsIFwiKTtcclxuICAgICAgICBzICs9IFwiPiBcIjtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcztcclxufSJdfQ==