import { Module, ModuleStore } from "../compiler/parser/Module.js";
import { Evaluator } from "../interpreter/Evaluator.js";
export class Workspace {
    constructor(name, main, owner_id) {
        this.main = main;
        this.saved = true;
        this.settings = {
            libraries: []
        };
        this.name = name;
        this.owner_id = owner_id;
        this.moduleStore = new ModuleStore(main, true, this.settings.libraries);
        this.evaluator = new Evaluator(this, main);
    }
    toExportedWorkspace() {
        return {
            name: this.name,
            modules: this.moduleStore.getModules(false).map(m => m.toExportedModule()),
            settings: this.settings
        };
    }
    alterAdditionalLibraries() {
        this.moduleStore.setAdditionalLibraries(this.settings.libraries);
        this.moduleStore.dirty = true;
    }
    getWorkspaceData(withFiles) {
        let wd = {
            name: this.name,
            path: this.path,
            isFolder: this.isFolder,
            id: this.id,
            owner_id: this.owner_id,
            currentFileId: this.currentlyOpenModule == null ? null : this.currentlyOpenModule.file.id,
            files: [],
            version: this.version,
            repository_id: this.repository_id,
            has_write_permission_to_repository: this.has_write_permission_to_repository,
            language: 0,
            sql_baseDatabase: "",
            sql_history: "",
            sql_manipulateDatabaseStatements: "",
            settings: JSON.stringify(this.settings)
        };
        if (withFiles) {
            for (let m of this.moduleStore.getModules(false)) {
                wd.files.push(m.getFileData(this));
            }
        }
        return wd;
    }
    renderSynchronizeButton(panelElement) {
        var _a;
        let $buttonDiv = (_a = panelElement === null || panelElement === void 0 ? void 0 : panelElement.$htmlFirstLine) === null || _a === void 0 ? void 0 : _a.find('.jo_additionalButtonRepository');
        if ($buttonDiv == null)
            return;
        let that = this;
        let myMain = this.main;
        if (this.repository_id != null && this.owner_id == myMain.user.id) {
            let $button = jQuery('<div class="jo_startButton img_open-change jo_button jo_active" title="Workspace mit Repository synchronisieren"></div>');
            $buttonDiv.append($button);
            let that = this;
            $button.on('mousedown', (e) => e.stopPropagation());
            $button.on('click', (e) => {
                e.stopPropagation();
                that.synchronizeWithRepository();
            });
        }
        else {
            $buttonDiv.find('.jo_startButton').remove();
        }
    }
    synchronizeWithRepository() {
        let myMain = this.main;
        if (this.repository_id != null && this.owner_id == myMain.user.id) {
            myMain.networkManager.sendUpdates(() => {
                myMain.synchronizationManager.synchronizeWithWorkspace(this);
            }, true);
        }
    }
    static restoreFromData(ws, main) {
        let settings = (ws.settings != null && ws.settings.startsWith("{")) ? JSON.parse(ws.settings) : { libraries: [] };
        //@ts-ignore
        if (settings.libaries) {
            //@ts-ignore
            settings.libraries = settings.libaries;
        }
        let w = new Workspace(ws.name, main, ws.owner_id);
        w.id = ws.id;
        w.path = ws.path;
        w.isFolder = ws.isFolder;
        w.owner_id = ws.owner_id;
        w.version = ws.version;
        w.repository_id = ws.repository_id;
        w.has_write_permission_to_repository = ws.has_write_permission_to_repository;
        w.settings = settings;
        if (w.settings.libraries == null) {
            w.settings.libraries = [];
        }
        if (w.settings.libraries.length > 0) {
            w.moduleStore.setAdditionalLibraries(w.settings.libraries);
        }
        for (let f of ws.files) {
            let m = Module.restoreFromData(f, main);
            w.moduleStore.putModule(m);
            if (f.id == ws.currentFileId) {
                w.currentlyOpenModule = m;
            }
        }
        return w;
    }
    hasErrors() {
        return this.moduleStore.hasErrors();
    }
    getModuleByMonacoModel(model) {
        for (let m of this.moduleStore.getModules(false)) {
            if (m.model == model) {
                return m;
            }
        }
        return null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya3NwYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NsaWVudC93b3Jrc3BhY2UvV29ya3NwYWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBcUIsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQU14RCxNQUFNLE9BQU8sU0FBUztJQTRCbEIsWUFBWSxJQUFZLEVBQVUsSUFBYyxFQUFFLFFBQWdCO1FBQWhDLFNBQUksR0FBSixJQUFJLENBQVU7UUFWaEQsVUFBSyxHQUFZLElBQUksQ0FBQztRQU10QixhQUFRLEdBQXNCO1lBQzFCLFNBQVMsRUFBRSxFQUFFO1NBQ2hCLENBQUM7UUFHRSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4RSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQsbUJBQW1CO1FBQ2YsT0FBTztZQUNILElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLE9BQU8sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMxRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7U0FDMUIsQ0FBQTtJQUNMLENBQUM7SUFHRCx3QkFBd0I7UUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FB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QUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUV0QixJQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxJQUFJLElBQUksRUFBQztZQUM1QixDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7U0FDN0I7UUFFRCxJQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUM7WUFDL0IsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQzlEO1FBRUQsS0FBSSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFDO1lBRWxCLElBQUksQ0FBQyxHQUFXLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTNCLElBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsYUFBYSxFQUFDO2dCQUN4QixDQUFDLENBQUMsbUJBQW1CLEdBQUcsQ0FBQyxDQUFDO2FBQzdCO1NBRUo7UUFFRCxPQUFPLENBQUMsQ0FBQztJQUViLENBQUM7SUFFRCxTQUFTO1FBRUwsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBRXhDLENBQUM7SUFFRCxzQkFBc0IsQ0FBQyxLQUErQjtRQUNsRCxLQUFJLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFDO1lBQzVDLElBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxLQUFLLEVBQUM7Z0JBQ2hCLE9BQU8sQ0FBQyxDQUFDO2FBQ1o7U0FDSjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFdvcmtzcGFjZURhdGEsIFdvcmtzcGFjZVNldHRpbmdzIH0gZnJvbSBcIi4uL2NvbW11bmljYXRpb24vRGF0YS5qc1wiO1xyXG5pbXBvcnQgeyBFeHBvcnRlZFdvcmtzcGFjZSwgTW9kdWxlLCBNb2R1bGVTdG9yZSB9IGZyb20gXCIuLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IEV2YWx1YXRvciB9IGZyb20gXCIuLi9pbnRlcnByZXRlci9FdmFsdWF0b3IuanNcIjtcclxuaW1wb3J0IHsgQWNjb3JkaW9uRWxlbWVudCB9IGZyb20gXCIuLi9tYWluL2d1aS9BY2NvcmRpb24uanNcIjtcclxuaW1wb3J0IHsgTWFpbiB9IGZyb20gXCIuLi9tYWluL01haW4uanNcIjtcclxuaW1wb3J0IHsgTWFpbkJhc2UgfSBmcm9tIFwiLi4vbWFpbi9NYWluQmFzZS5qc1wiO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBXb3Jrc3BhY2Uge1xyXG4gICAgXHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcbiAgICBwYXRoOiBzdHJpbmc7XHJcbiAgICBpc0ZvbGRlcjogYm9vbGVhbjtcclxuICAgIGlkOiBudW1iZXI7XHJcbiAgICBvd25lcl9pZDogbnVtYmVyO1xyXG5cclxuICAgIHZlcnNpb246IG51bWJlcjtcclxuICAgIC8vIHB1Ymxpc2hlZF90byAwOiBub25lOyAxOiBjbGFzczsgMjogc2Nob29sOyAzOiBhbGxcclxuICAgIHB1Ymxpc2hlZF90bzogbnVtYmVyO1xyXG4gICAgXHJcbiAgICByZXBvc2l0b3J5X2lkOiBudW1iZXI7ICAgIC8vIGlkIG9mIHJlcG9zaXRvcnktd29ya3NwYWNlXHJcbiAgICBoYXNfd3JpdGVfcGVybWlzc2lvbl90b19yZXBvc2l0b3J5OiBib29sZWFuOyAvLyB0cnVlIGlmIG93bmVyIG9mIHRoaXMgd29ya2luZyBjb3B5IGhhcyB3cml0ZSBwZXJtaXNzaW9uIHRvIHJlcG9zaXRvcnkgd29ya3NwYWNlXHJcblxyXG4gICAgbW9kdWxlU3RvcmU6IE1vZHVsZVN0b3JlO1xyXG4gICAgcGFuZWxFbGVtZW50OiBBY2NvcmRpb25FbGVtZW50O1xyXG4gICAgY3VycmVudGx5T3Blbk1vZHVsZTogTW9kdWxlO1xyXG4gICAgc2F2ZWQ6IGJvb2xlYW4gPSB0cnVlO1xyXG5cclxuICAgIGNvbXBpbGVyTWVzc2FnZTogc3RyaW5nO1xyXG5cclxuICAgIGV2YWx1YXRvcjogRXZhbHVhdG9yO1xyXG5cclxuICAgIHNldHRpbmdzOiBXb3Jrc3BhY2VTZXR0aW5ncyA9IHtcclxuICAgICAgICBsaWJyYXJpZXM6IFtdXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIHByaXZhdGUgbWFpbjogTWFpbkJhc2UsIG93bmVyX2lkOiBudW1iZXIpe1xyXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgdGhpcy5vd25lcl9pZCA9IG93bmVyX2lkO1xyXG4gICAgICAgIHRoaXMubW9kdWxlU3RvcmUgPSBuZXcgTW9kdWxlU3RvcmUobWFpbiwgdHJ1ZSwgdGhpcy5zZXR0aW5ncy5saWJyYXJpZXMpO1xyXG4gICAgICAgIHRoaXMuZXZhbHVhdG9yID0gbmV3IEV2YWx1YXRvcih0aGlzLCBtYWluKTtcclxuICAgIH1cclxuXHJcbiAgICB0b0V4cG9ydGVkV29ya3NwYWNlKCk6IEV4cG9ydGVkV29ya3NwYWNlIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXHJcbiAgICAgICAgICAgIG1vZHVsZXM6IHRoaXMubW9kdWxlU3RvcmUuZ2V0TW9kdWxlcyhmYWxzZSkubWFwKG0gPT4gbS50b0V4cG9ydGVkTW9kdWxlKCkpLFxyXG4gICAgICAgICAgICBzZXR0aW5nczogdGhpcy5zZXR0aW5nc1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgYWx0ZXJBZGRpdGlvbmFsTGlicmFyaWVzKCkge1xyXG4gICAgICAgIHRoaXMubW9kdWxlU3RvcmUuc2V0QWRkaXRpb25hbExpYnJhcmllcyh0aGlzLnNldHRpbmdzLmxpYnJhcmllcyk7XHJcbiAgICAgICAgdGhpcy5tb2R1bGVTdG9yZS5kaXJ0eSA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0V29ya3NwYWNlRGF0YSh3aXRoRmlsZXM6IGJvb2xlYW4pOiBXb3Jrc3BhY2VEYXRhIHtcclxuICAgICAgICBsZXQgd2Q6IFdvcmtzcGFjZURhdGEgPSB7XHJcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcclxuICAgICAgICAgICAgcGF0aDogdGhpcy5wYXRoLFxyXG4gICAgICAgICAgICBpc0ZvbGRlcjogdGhpcy5pc0ZvbGRlcixcclxuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXHJcbiAgICAgICAgICAgIG93bmVyX2lkOiB0aGlzLm93bmVyX2lkLFxyXG4gICAgICAgICAgICBjdXJyZW50RmlsZUlkOiB0aGlzLmN1cnJlbnRseU9wZW5Nb2R1bGUgPT0gbnVsbCA/IG51bGwgOiB0aGlzLmN1cnJlbnRseU9wZW5Nb2R1bGUuZmlsZS5pZCxcclxuICAgICAgICAgICAgZmlsZXM6IFtdLFxyXG4gICAgICAgICAgICB2ZXJzaW9uOiB0aGlzLnZlcnNpb24sXHJcbiAgICAgICAgICAgIHJlcG9zaXRvcnlfaWQ6IHRoaXMucmVwb3NpdG9yeV9pZCxcclxuICAgICAgICAgICAgaGFzX3dyaXRlX3Blcm1pc3Npb25fdG9fcmVwb3NpdG9yeTogdGhpcy5oYXNfd3JpdGVfcGVybWlzc2lvbl90b19yZXBvc2l0b3J5LFxyXG4gICAgICAgICAgICBsYW5ndWFnZTogMCxcclxuICAgICAgICAgICAgc3FsX2Jhc2VEYXRhYmFzZTogXCJcIixcclxuICAgICAgICAgICAgc3FsX2hpc3Rvcnk6IFwiXCIsXHJcbiAgICAgICAgICAgIHNxbF9tYW5pcHVsYXRlRGF0YWJhc2VTdGF0ZW1lbnRzOiBcIlwiLFxyXG4gICAgICAgICAgICBzZXR0aW5nczogSlNPTi5zdHJpbmdpZnkodGhpcy5zZXR0aW5ncylcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHdpdGhGaWxlcyl7XHJcbiAgICAgICAgICAgIGZvcihsZXQgbSBvZiB0aGlzLm1vZHVsZVN0b3JlLmdldE1vZHVsZXMoZmFsc2UpKXtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgd2QuZmlsZXMucHVzaChtLmdldEZpbGVEYXRhKHRoaXMpKTtcclxuICAgIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gd2Q7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJlbmRlclN5bmNocm9uaXplQnV0dG9uKHBhbmVsRWxlbWVudDogQWNjb3JkaW9uRWxlbWVudCkge1xyXG4gICAgICAgIGxldCAkYnV0dG9uRGl2ID0gcGFuZWxFbGVtZW50Py4kaHRtbEZpcnN0TGluZT8uZmluZCgnLmpvX2FkZGl0aW9uYWxCdXR0b25SZXBvc2l0b3J5Jyk7XHJcbiAgICAgICAgaWYgKCRidXR0b25EaXYgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBsZXQgbXlNYWluOiBNYWluID0gPE1haW4+dGhpcy5tYWluO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5yZXBvc2l0b3J5X2lkICE9IG51bGwgJiYgdGhpcy5vd25lcl9pZCA9PSBteU1haW4udXNlci5pZCkge1xyXG4gICAgICAgICAgICBsZXQgJGJ1dHRvbiA9IGpRdWVyeSgnPGRpdiBjbGFzcz1cImpvX3N0YXJ0QnV0dG9uIGltZ19vcGVuLWNoYW5nZSBqb19idXR0b24gam9fYWN0aXZlXCIgdGl0bGU9XCJXb3Jrc3BhY2UgbWl0IFJlcG9zaXRvcnkgc3luY2hyb25pc2llcmVuXCI+PC9kaXY+Jyk7XHJcbiAgICAgICAgICAgICRidXR0b25EaXYuYXBwZW5kKCRidXR0b24pO1xyXG4gICAgICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgICAgICRidXR0b24ub24oJ21vdXNlZG93bicsIChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpKTtcclxuICAgICAgICAgICAgJGJ1dHRvbi5vbignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGF0LnN5bmNocm9uaXplV2l0aFJlcG9zaXRvcnkoKTtcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkYnV0dG9uRGl2LmZpbmQoJy5qb19zdGFydEJ1dHRvbicpLnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzeW5jaHJvbml6ZVdpdGhSZXBvc2l0b3J5KCl7XHJcbiAgICAgICAgbGV0IG15TWFpbjogTWFpbiA9IDxNYWluPnRoaXMubWFpbjtcclxuICAgICAgICBpZih0aGlzLnJlcG9zaXRvcnlfaWQgIT0gbnVsbCAmJiB0aGlzLm93bmVyX2lkID09IG15TWFpbi51c2VyLmlkKXtcclxuICAgICAgICAgICAgbXlNYWluLm5ldHdvcmtNYW5hZ2VyLnNlbmRVcGRhdGVzKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIG15TWFpbi5zeW5jaHJvbml6YXRpb25NYW5hZ2VyLnN5bmNocm9uaXplV2l0aFdvcmtzcGFjZSh0aGlzKTtcclxuICAgICAgICAgICAgfSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyByZXN0b3JlRnJvbURhdGEod3M6IFdvcmtzcGFjZURhdGEsIG1haW46IE1haW4pOiBXb3Jrc3BhY2Uge1xyXG5cclxuICAgICAgICBsZXQgc2V0dGluZ3M6IFdvcmtzcGFjZVNldHRpbmdzID0gKHdzLnNldHRpbmdzICE9IG51bGwgJiYgd3Muc2V0dGluZ3Muc3RhcnRzV2l0aChcIntcIikpID8gSlNPTi5wYXJzZSh3cy5zZXR0aW5ncykgOiB7bGlicmFyaWVzOiBbXX07IFxyXG5cclxuICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICBpZihzZXR0aW5ncy5saWJhcmllcyl7XHJcbiAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICBzZXR0aW5ncy5saWJyYXJpZXMgPSBzZXR0aW5ncy5saWJhcmllcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB3ID0gbmV3IFdvcmtzcGFjZSh3cy5uYW1lLCBtYWluLCB3cy5vd25lcl9pZCk7XHJcbiAgICAgICAgdy5pZCA9IHdzLmlkO1xyXG4gICAgICAgIHcucGF0aCA9IHdzLnBhdGg7XHJcbiAgICAgICAgdy5pc0ZvbGRlciA9IHdzLmlzRm9sZGVyO1xyXG4gICAgICAgIHcub3duZXJfaWQgPSB3cy5vd25lcl9pZDtcclxuICAgICAgICB3LnZlcnNpb24gPSB3cy52ZXJzaW9uO1xyXG4gICAgICAgIHcucmVwb3NpdG9yeV9pZCA9IHdzLnJlcG9zaXRvcnlfaWQ7XHJcbiAgICAgICAgdy5oYXNfd3JpdGVfcGVybWlzc2lvbl90b19yZXBvc2l0b3J5ID0gd3MuaGFzX3dyaXRlX3Blcm1pc3Npb25fdG9fcmVwb3NpdG9yeTtcclxuICAgICAgICB3LnNldHRpbmdzID0gc2V0dGluZ3M7XHJcblxyXG4gICAgICAgIGlmKHcuc2V0dGluZ3MubGlicmFyaWVzID09IG51bGwpe1xyXG4gICAgICAgICAgICB3LnNldHRpbmdzLmxpYnJhcmllcyA9IFtdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYody5zZXR0aW5ncy5saWJyYXJpZXMubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgIHcubW9kdWxlU3RvcmUuc2V0QWRkaXRpb25hbExpYnJhcmllcyh3LnNldHRpbmdzLmxpYnJhcmllcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IobGV0IGYgb2Ygd3MuZmlsZXMpe1xyXG5cclxuICAgICAgICAgICAgbGV0IG06IE1vZHVsZSA9IE1vZHVsZS5yZXN0b3JlRnJvbURhdGEoZiwgbWFpbik7XHJcbiAgICAgICAgICAgIHcubW9kdWxlU3RvcmUucHV0TW9kdWxlKG0pO1xyXG5cclxuICAgICAgICAgICAgaWYoZi5pZCA9PSB3cy5jdXJyZW50RmlsZUlkKXtcclxuICAgICAgICAgICAgICAgIHcuY3VycmVudGx5T3Blbk1vZHVsZSA9IG07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdztcclxuXHJcbiAgICB9XHJcblxyXG4gICAgaGFzRXJyb3JzKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiB0aGlzLm1vZHVsZVN0b3JlLmhhc0Vycm9ycygpO1xyXG4gICAgICAgIFxyXG4gICAgfVxyXG5cclxuICAgIGdldE1vZHVsZUJ5TW9uYWNvTW9kZWwobW9kZWw6IG1vbmFjby5lZGl0b3IuSVRleHRNb2RlbCk6IE1vZHVsZSB7XHJcbiAgICAgICAgZm9yKGxldCBtIG9mIHRoaXMubW9kdWxlU3RvcmUuZ2V0TW9kdWxlcyhmYWxzZSkpe1xyXG4gICAgICAgICAgICBpZihtLm1vZGVsID09IG1vZGVsKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=