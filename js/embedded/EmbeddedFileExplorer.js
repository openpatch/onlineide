import { openContextMenu, makeEditable } from "../tools/HtmlTools.js";
export class EmbeddedFileExplorer {
    constructor(moduleStore, $fileListDiv, main) {
        this.moduleStore = moduleStore;
        this.$fileListDiv = $fileListDiv;
        this.main = main;
        this.files = [];
        let that = this;
        for (let module of moduleStore.getModules(false)) {
            this.addModule(module);
        }
        if ($fileListDiv != null) {
            let $filesDiv = $fileListDiv.parent();
            let $addButton = jQuery('<div class="joe_addFileButton jo_button img_add-dark jo_active" title="Datei hinzufügen"></div>');
            $filesDiv.append($addButton);
            $addButton.on("click", () => {
                let module = this.main.addModule({ text: "", title: "Neue Datei.java", type: "java" });
                let fileData = this.addModule(module);
                this.renameElement(fileData, () => {
                    // if there's no file yet and then one is added and subsequently renamed: select it!
                    if (that.currentFile != fileData) {
                        that.selectFile(fileData);
                    }
                });
            });
        }
    }
    removeAllFiles() {
        this.files.forEach(f => this.removeFile(f));
    }
    addHint(script) {
        let that = this;
        let $fileDiv = jQuery('<div class="jo_file jo_hint" ><div class="jo_fileimage"></div><div class="jo_filename" style="line-height: 22px">' +
            script.title + '</div><div class="jo_additionalButtons"></div></div></div>');
        this.$fileListDiv.append($fileDiv);
        let fileData = {
            module: null,
            $fileDiv: $fileDiv,
            type: "hint",
            hint: script.text
        };
        this.files.push(fileData);
        $fileDiv.on("click", (event) => {
            that.selectFile(fileData);
        });
    }
    addModule(module) {
        let that = this;
        let $fileDiv = jQuery(`<div class="jo_file jo_java" >
        <div class="jo_fileimage"></div>
        <div class="jo_filename" style="line-height: 22px">${module.file.name}</div>
        <div class="jo_additionalButtonStart"></div>
        <div class="jo_delete img_delete jo_button jo_active" title="Datei löschen"></div></div></div>`);
        if (this.$fileListDiv != null) {
            this.$fileListDiv.append($fileDiv);
        }
        let fileData = {
            module: module,
            $fileDiv: $fileDiv,
            type: "java"
        };
        this.files.push(fileData);
        module.file.panelElement = {
            name: module.file.name,
            $htmlFirstLine: $fileDiv,
            isFolder: false,
            path: []
        };
        $fileDiv.find('.jo_delete').on("mousedown", (e) => {
            that.onDelete(fileData, e);
        });
        $fileDiv.find('.jo_delete').on("click", (e) => { e.preventDefault(); e.stopPropagation(); });
        $fileDiv.on("click", (event) => {
            that.selectFile(fileData);
        });
        $fileDiv[0].addEventListener("contextmenu", function (event) {
            event.preventDefault();
            openContextMenu([{
                    caption: "Umbenennen",
                    callback: () => {
                        that.renameElement(fileData, () => { });
                    }
                }], event.pageX, event.pageY);
        }, false);
        return fileData;
    }
    onDelete(fileData, ev) {
        ev.preventDefault();
        ev.stopPropagation();
        let that = this;
        openContextMenu([{
                caption: "Abbrechen",
                callback: () => {
                    // nothing to do.
                }
            }, {
                caption: "Ich bin mir sicher: löschen!",
                color: "#ff6060",
                callback: () => {
                    that.removeFile(fileData);
                }
            }], ev.pageX + 2, ev.pageY + 2);
    }
    removeFile(fileData) {
        fileData.$fileDiv.remove();
        this.main.removeModule(fileData.module);
        this.files = this.files.filter((fd) => fd != fileData);
        if (this.currentFile == fileData) {
            if (this.files.length > 0) {
                this.selectFile(this.files[0]);
            }
            else {
                this.main.getMonacoEditor().setValue("Keine Datei vorhanden.");
                this.main.getMonacoEditor().updateOptions({ readOnly: true });
            }
        }
        this.files.forEach((file) => {
            if (file.module != null) { // Hints have module == null
                file.module.file.saved = false;
            }
        });
    }
    removeModule(module) {
        for (let fileData of this.files) {
            if (fileData.module == module) {
                this.removeFile(fileData);
            }
        }
    }
    renameElement(fileData, callback) {
        let that = this;
        let $div = fileData.$fileDiv.find('.jo_filename');
        let pointPos = fileData.module.file.name.indexOf('.');
        let selection = pointPos == null ? null : { start: 0, end: pointPos };
        makeEditable($div, $div, (newText) => {
            fileData.module.file.name = newText;
            $div.html(newText);
            if (callback != null)
                callback();
        }, selection);
    }
    setFirstFileActive() {
        if (this.files.length > 0) {
            this.selectFile(this.files[0]);
        }
    }
    selectFile(fileData) {
        if (fileData == null)
            return;
        switch (fileData.type) {
            case "java":
                this.main.$hintDiv.hide();
                this.main.$monacoDiv.show();
                this.main.setModuleActive(fileData.module);
                this.main.getMonacoEditor().focus();
                break;
            case "hint":
                this.main.$monacoDiv.hide();
                this.main.$hintDiv.show();
                let syntaxMap = {};
                let code = [];
                //@ts-ignore
                let md1 = window.markdownit({
                    highlight: function (str, lang) {
                        code.push(str);
                        return "";
                    }
                });
                md1.renderer.rules.code_inline = function (tokens, idx, options, env, self) {
                    var token = tokens[idx];
                    code.push(token.content);
                    // pass token to default renderer.
                    return ""; //md1.renderer.rules.code_block(tokens, idx, options, env, self);
                };
                md1.render(fileData.hint);
                this.colorize(code, syntaxMap, () => {
                    //@ts-ignore
                    let md2 = window.markdownit({
                        highlight: function (str, lang) {
                            return syntaxMap[str];
                        }
                    });
                    md2.renderer.rules.code_inline = function (tokens, idx, options, env, self) {
                        var token = tokens[idx];
                        // pass token to default renderer.
                        return syntaxMap[token.content].replace("<br/>", "");
                    };
                    let html = md2.render(fileData.hint);
                    this.main.$hintDiv.html(html);
                });
                this.$fileListDiv.find('.jo_file').removeClass('jo_active');
                fileData.$fileDiv.addClass('jo_active');
                break;
        }
    }
    colorize(code, codeMap, callback) {
        let that = this;
        if (code.length > 0) {
            let uncoloredtext = code.pop();
            monaco.editor.colorize(uncoloredtext, 'myJava', { tabSize: 3 }).then((text) => {
                codeMap[uncoloredtext] = text;
                that.colorize(code, codeMap, callback);
            });
        }
        else {
            callback();
        }
    }
    markFile(module) {
        if (this.$fileListDiv == null)
            return;
        this.$fileListDiv.find('.jo_file').removeClass('jo_active');
        this.currentFile = this.files.find((fileData) => fileData.module == module);
        if (this.currentFile != null)
            this.currentFile.$fileDiv.addClass('jo_active');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW1iZWRkZWRGaWxlRXhwbG9yZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L2VtYmVkZGVkL0VtYmVkZGVkRmlsZUV4cGxvcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFVdEUsTUFBTSxPQUFPLG9CQUFvQjtJQUs3QixZQUFvQixXQUF3QixFQUFVLFlBQWlDLEVBQVUsSUFBa0I7UUFBL0YsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFjO1FBRm5ILFVBQUssR0FBZSxFQUFFLENBQUM7UUFJbkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWhCLEtBQUssSUFBSSxNQUFNLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUU5QyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBRTFCO1FBRUQsSUFBRyxZQUFZLElBQUksSUFBSSxFQUFDO1lBQ3BCLElBQUksU0FBUyxHQUFHLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN0QyxJQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsaUdBQWlHLENBQUMsQ0FBQztZQUMzSCxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTdCLFVBQVUsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtnQkFFeEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDdkYsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENB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RUFBRTtnQkFDMUUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQztnQkFDOUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzNDLENBQUMsQ0FDQSxDQUFDO1NBQ0w7YUFBTTtZQUNILFFBQVEsRUFBRSxDQUFDO1NBQ2Q7SUFFTCxDQUFDO0lBR0QsUUFBUSxDQUFDLE1BQWM7UUFDbkIsSUFBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUk7WUFBRSxPQUFPO1FBQ3JDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxDQUFDO1FBRTVFLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJO1lBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRWxGLENBQUM7Q0FJSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZHVsZSwgTW9kdWxlU3RvcmUgfSBmcm9tIFwiLi4vY29tcGlsZXIvcGFyc2VyL01vZHVsZS5qc1wiO1xyXG5pbXBvcnQgeyBNYWluRW1iZWRkZWQgfSBmcm9tIFwiLi9NYWluRW1iZWRkZWQuanNcIjtcclxuaW1wb3J0IHsgb3BlbkNvbnRleHRNZW51LCBtYWtlRWRpdGFibGUgfSBmcm9tIFwiLi4vdG9vbHMvSHRtbFRvb2xzLmpzXCI7XHJcbmltcG9ydCB7IEpPU2NyaXB0LCBTY3JpcHRUeXBlIH0gZnJvbSBcIi4vRW1iZWRkZWRTdGFydGVyLmpzXCI7XHJcblxyXG50eXBlIEZpbGVEYXRhID0ge1xyXG4gICAgdHlwZTogU2NyaXB0VHlwZSxcclxuICAgIG1vZHVsZT86IE1vZHVsZSxcclxuICAgIGhpbnQ/OiBzdHJpbmcsXHJcbiAgICAkZmlsZURpdjogSlF1ZXJ5PEhUTUxFbGVtZW50PlxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRW1iZWRkZWRGaWxlRXhwbG9yZXIge1xyXG5cclxuICAgIGN1cnJlbnRGaWxlOiBGaWxlRGF0YTtcclxuICAgIGZpbGVzOiBGaWxlRGF0YVtdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBtb2R1bGVTdG9yZTogTW9kdWxlU3RvcmUsIHByaXZhdGUgJGZpbGVMaXN0RGl2OiBKUXVlcnk8SFRNTEVsZW1lbnQ+LCBwcml2YXRlIG1haW46IE1haW5FbWJlZGRlZCkge1xyXG5cclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgICAgIGZvciAobGV0IG1vZHVsZSBvZiBtb2R1bGVTdG9yZS5nZXRNb2R1bGVzKGZhbHNlKSkge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5hZGRNb2R1bGUobW9kdWxlKTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZigkZmlsZUxpc3REaXYgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgIGxldCAkZmlsZXNEaXYgPSAkZmlsZUxpc3REaXYucGFyZW50KCk7XHJcbiAgICAgICAgICAgIGxldCAkYWRkQnV0dG9uID0galF1ZXJ5KCc8ZGl2IGNsYXNzPVwiam9lX2FkZEZpbGVCdXR0b24gam9fYnV0dG9uIGltZ19hZGQtZGFyayBqb19hY3RpdmVcIiB0aXRsZT1cIkRhdGVpIGhpbnp1ZsO8Z2VuXCI+PC9kaXY+Jyk7XHJcbiAgICAgICAgICAgICRmaWxlc0Rpdi5hcHBlbmQoJGFkZEJ1dHRvbik7XHJcbiAgICBcclxuICAgICAgICAgICAgJGFkZEJ1dHRvbi5vbihcImNsaWNrXCIsICgpID0+IHtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgbGV0IG1vZHVsZSA9IHRoaXMubWFpbi5hZGRNb2R1bGUoeyB0ZXh0OiBcIlwiLCB0aXRsZTogXCJOZXVlIERhdGVpLmphdmFcIiwgdHlwZTogXCJqYXZhXCIgfSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmlsZURhdGEgPSB0aGlzLmFkZE1vZHVsZShtb2R1bGUpO1xyXG4gICAgXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmFtZUVsZW1lbnQoZmlsZURhdGEsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSdzIG5vIGZpbGUgeWV0IGFuZCB0aGVuIG9uZSBpcyBhZGRlZCBhbmQgc3Vic2VxdWVudGx5IHJlbmFtZWQ6IHNlbGVjdCBpdCFcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5jdXJyZW50RmlsZSAhPSBmaWxlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnNlbGVjdEZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUFsbEZpbGVzKCkge1xyXG4gICAgICAgIHRoaXMuZmlsZXMuZm9yRWFjaChmID0+IHRoaXMucmVtb3ZlRmlsZShmKSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGFkZEhpbnQoc2NyaXB0OiBKT1NjcmlwdCk6IHZvaWQge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBsZXQgJGZpbGVEaXYgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19maWxlIGpvX2hpbnRcIiA+PGRpdiBjbGFzcz1cImpvX2ZpbGVpbWFnZVwiPjwvZGl2PjxkaXYgY2xhc3M9XCJqb19maWxlbmFtZVwiIHN0eWxlPVwibGluZS1oZWlnaHQ6IDIycHhcIj4nICtcclxuICAgICAgICAgICAgc2NyaXB0LnRpdGxlICsgJzwvZGl2PjxkaXYgY2xhc3M9XCJqb19hZGRpdGlvbmFsQnV0dG9uc1wiPjwvZGl2PjwvZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIHRoaXMuJGZpbGVMaXN0RGl2LmFwcGVuZCgkZmlsZURpdik7XHJcblxyXG4gICAgICAgIGxldCBmaWxlRGF0YTogRmlsZURhdGEgPSB7XHJcbiAgICAgICAgICAgIG1vZHVsZTogbnVsbCxcclxuICAgICAgICAgICAgJGZpbGVEaXY6ICRmaWxlRGl2LFxyXG4gICAgICAgICAgICB0eXBlOiBcImhpbnRcIixcclxuICAgICAgICAgICAgaGludDogc2NyaXB0LnRleHRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmZpbGVzLnB1c2goZmlsZURhdGEpO1xyXG5cclxuICAgICAgICAkZmlsZURpdi5vbihcImNsaWNrXCIsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICB0aGF0LnNlbGVjdEZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgYWRkTW9kdWxlKG1vZHVsZTogTW9kdWxlKTogRmlsZURhdGEge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBsZXQgJGZpbGVEaXYgPSBqUXVlcnkoYDxkaXYgY2xhc3M9XCJqb19maWxlIGpvX2phdmFcIiA+XHJcbiAgICAgICAgPGRpdiBjbGFzcz1cImpvX2ZpbGVpbWFnZVwiPjwvZGl2PlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJqb19maWxlbmFtZVwiIHN0eWxlPVwibGluZS1oZWlnaHQ6IDIycHhcIj4ke21vZHVsZS5maWxlLm5hbWV9PC9kaXY+XHJcbiAgICAgICAgPGRpdiBjbGFzcz1cImpvX2FkZGl0aW9uYWxCdXR0b25TdGFydFwiPjwvZGl2PlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJqb19kZWxldGUgaW1nX2RlbGV0ZSBqb19idXR0b24gam9fYWN0aXZlXCIgdGl0bGU9XCJEYXRlaSBsw7ZzY2hlblwiPjwvZGl2PjwvZGl2PjwvZGl2PmApO1xyXG4gICAgICAgIGlmKHRoaXMuJGZpbGVMaXN0RGl2ICE9IG51bGwpe1xyXG4gICAgICAgICAgICB0aGlzLiRmaWxlTGlzdERpdi5hcHBlbmQoJGZpbGVEaXYpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGZpbGVEYXRhOiBGaWxlRGF0YSA9IHtcclxuICAgICAgICAgICAgbW9kdWxlOiBtb2R1bGUsXHJcbiAgICAgICAgICAgICRmaWxlRGl2OiAkZmlsZURpdixcclxuICAgICAgICAgICAgdHlwZTogXCJqYXZhXCJcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmZpbGVzLnB1c2goZmlsZURhdGEpO1xyXG5cclxuICAgICAgICBtb2R1bGUuZmlsZS5wYW5lbEVsZW1lbnQgPSB7XHJcbiAgICAgICAgICAgIG5hbWU6IG1vZHVsZS5maWxlLm5hbWUsXHJcbiAgICAgICAgICAgICRodG1sRmlyc3RMaW5lOiAkZmlsZURpdixcclxuICAgICAgICAgICAgaXNGb2xkZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICBwYXRoOiBbXVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgJGZpbGVEaXYuZmluZCgnLmpvX2RlbGV0ZScpLm9uKFwibW91c2Vkb3duXCIsIChlOiBKUXVlcnkuTW91c2VEb3duRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgdGhhdC5vbkRlbGV0ZShmaWxlRGF0YSwgZSk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgJGZpbGVEaXYuZmluZCgnLmpvX2RlbGV0ZScpLm9uKFwiY2xpY2tcIiwgKGUpID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBlLnN0b3BQcm9wYWdhdGlvbigpIH0pO1xyXG5cclxuICAgICAgICAkZmlsZURpdi5vbihcImNsaWNrXCIsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICB0aGF0LnNlbGVjdEZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkZmlsZURpdlswXS5hZGRFdmVudExpc3RlbmVyKFwiY29udGV4dG1lbnVcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgIG9wZW5Db250ZXh0TWVudShbe1xyXG4gICAgICAgICAgICAgICAgY2FwdGlvbjogXCJVbWJlbmVubmVuXCIsXHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjazogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQucmVuYW1lRWxlbWVudChmaWxlRGF0YSwgKCkgPT4geyB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfV0sIGV2ZW50LnBhZ2VYLCBldmVudC5wYWdlWSk7XHJcbiAgICAgICAgfSwgZmFsc2UpO1xyXG5cclxuICAgICAgICByZXR1cm4gZmlsZURhdGE7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG9uRGVsZXRlKGZpbGVEYXRhOiBGaWxlRGF0YSwgZXY6IEpRdWVyeS5Nb3VzZURvd25FdmVudCkge1xyXG4gICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIG9wZW5Db250ZXh0TWVudShbe1xyXG4gICAgICAgICAgICBjYXB0aW9uOiBcIkFiYnJlY2hlblwiLFxyXG4gICAgICAgICAgICBjYWxsYmFjazogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gbm90aGluZyB0byBkby5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHtcclxuICAgICAgICAgICAgY2FwdGlvbjogXCJJY2ggYmluIG1pciBzaWNoZXI6IGzDtnNjaGVuIVwiLFxyXG4gICAgICAgICAgICBjb2xvcjogXCIjZmY2MDYwXCIsXHJcbiAgICAgICAgICAgIGNhbGxiYWNrOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGF0LnJlbW92ZUZpbGUoZmlsZURhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfV0sIGV2LnBhZ2VYICsgMiwgZXYucGFnZVkgKyAyKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlRmlsZShmaWxlRGF0YTogRmlsZURhdGEpIHtcclxuICAgICAgICBmaWxlRGF0YS4kZmlsZURpdi5yZW1vdmUoKTtcclxuICAgICAgICB0aGlzLm1haW4ucmVtb3ZlTW9kdWxlKGZpbGVEYXRhLm1vZHVsZSk7XHJcbiAgICAgICAgdGhpcy5maWxlcyA9IHRoaXMuZmlsZXMuZmlsdGVyKChmZCkgPT4gZmQgIT0gZmlsZURhdGEpO1xyXG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWxlID09IGZpbGVEYXRhKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpbGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RmlsZSh0aGlzLmZpbGVzWzBdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFpbi5nZXRNb25hY29FZGl0b3IoKS5zZXRWYWx1ZShcIktlaW5lIERhdGVpIHZvcmhhbmRlbi5cIik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1haW4uZ2V0TW9uYWNvRWRpdG9yKCkudXBkYXRlT3B0aW9ucyh7IHJlYWRPbmx5OiB0cnVlIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICAgICAgaWYoZmlsZS5tb2R1bGUgIT0gbnVsbCl7ICAgICAgICAgICAgICAgIC8vIEhpbnRzIGhhdmUgbW9kdWxlID09IG51bGxcclxuICAgICAgICAgICAgICAgIGZpbGUubW9kdWxlLmZpbGUuc2F2ZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZU1vZHVsZShtb2R1bGU6IE1vZHVsZSkge1xyXG4gICAgICAgIGZvciAobGV0IGZpbGVEYXRhIG9mIHRoaXMuZmlsZXMpIHtcclxuICAgICAgICAgICAgaWYgKGZpbGVEYXRhLm1vZHVsZSA9PSBtb2R1bGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRmlsZShmaWxlRGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVuYW1lRWxlbWVudChmaWxlRGF0YTogRmlsZURhdGEsIGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGxldCAkZGl2ID0gZmlsZURhdGEuJGZpbGVEaXYuZmluZCgnLmpvX2ZpbGVuYW1lJyk7XHJcbiAgICAgICAgbGV0IHBvaW50UG9zID0gZmlsZURhdGEubW9kdWxlLmZpbGUubmFtZS5pbmRleE9mKCcuJyk7XHJcbiAgICAgICAgbGV0IHNlbGVjdGlvbiA9IHBvaW50UG9zID09IG51bGwgPyBudWxsIDogeyBzdGFydDogMCwgZW5kOiBwb2ludFBvcyB9O1xyXG4gICAgICAgIG1ha2VFZGl0YWJsZSgkZGl2LCAkZGl2LCAobmV3VGV4dDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGZpbGVEYXRhLm1vZHVsZS5maWxlLm5hbWUgPSBuZXdUZXh0O1xyXG4gICAgICAgICAgICAkZGl2Lmh0bWwobmV3VGV4dCk7XHJcbiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSBjYWxsYmFjaygpO1xyXG4gICAgICAgIH0sIHNlbGVjdGlvbik7XHJcblxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBzZXRGaXJzdEZpbGVBY3RpdmUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdEZpbGUodGhpcy5maWxlc1swXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEZpbGUoZmlsZURhdGE6IEZpbGVEYXRhKSB7XHJcbiAgICAgICAgaWYgKGZpbGVEYXRhID09IG51bGwpIHJldHVybjtcclxuICAgICAgICBzd2l0Y2ggKGZpbGVEYXRhLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBcImphdmFcIjpcclxuICAgICAgICAgICAgICAgIHRoaXMubWFpbi4kaGludERpdi5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1haW4uJG1vbmFjb0Rpdi5zaG93KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1haW4uc2V0TW9kdWxlQWN0aXZlKGZpbGVEYXRhLm1vZHVsZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1haW4uZ2V0TW9uYWNvRWRpdG9yKCkuZm9jdXMoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiaGludFwiOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5tYWluLiRtb25hY29EaXYuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYWluLiRoaW50RGl2LnNob3coKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgc3ludGF4TWFwOiB7IFtjb2RlOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvZGU6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBsZXQgbWQxID0gd2luZG93Lm1hcmtkb3duaXQoe1xyXG4gICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodDogZnVuY3Rpb24gKHN0ciwgbGFuZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2RlLnB1c2goc3RyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbWQxLnJlbmRlcmVyLnJ1bGVzLmNvZGVfaW5saW5lID0gZnVuY3Rpb24gKHRva2VucywgaWR4LCBvcHRpb25zLCBlbnYsIHNlbGYpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnNbaWR4XTtcclxuICAgICAgICAgICAgICAgICAgICBjb2RlLnB1c2godG9rZW4uY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gcGFzcyB0b2tlbiB0byBkZWZhdWx0IHJlbmRlcmVyLlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcIlwiOyAvL21kMS5yZW5kZXJlci5ydWxlcy5jb2RlX2Jsb2NrKHRva2VucywgaWR4LCBvcHRpb25zLCBlbnYsIHNlbGYpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBtZDEucmVuZGVyKGZpbGVEYXRhLmhpbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JpemUoY29kZSwgc3ludGF4TWFwLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1kMiA9IHdpbmRvdy5tYXJrZG93bml0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0OiBmdW5jdGlvbiAoc3RyLCBsYW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3ludGF4TWFwW3N0cl07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbWQyLnJlbmRlcmVyLnJ1bGVzLmNvZGVfaW5saW5lID0gZnVuY3Rpb24gKHRva2VucywgaWR4LCBvcHRpb25zLCBlbnYsIHNlbGYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zW2lkeF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhc3MgdG9rZW4gdG8gZGVmYXVsdCByZW5kZXJlci5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bnRheE1hcFt0b2tlbi5jb250ZW50XS5yZXBsYWNlKFwiPGJyLz5cIiwgXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBodG1sID0gbWQyLnJlbmRlcihmaWxlRGF0YS5oaW50KTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1haW4uJGhpbnREaXYuaHRtbChodG1sKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy4kZmlsZUxpc3REaXYuZmluZCgnLmpvX2ZpbGUnKS5yZW1vdmVDbGFzcygnam9fYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICBmaWxlRGF0YS4kZmlsZURpdi5hZGRDbGFzcygnam9fYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29sb3JpemUoY29kZTogc3RyaW5nW10sIGNvZGVNYXA6IHsgW2NvZGU6IHN0cmluZ106IHN0cmluZyB9LCBjYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICBpZiAoY29kZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGxldCB1bmNvbG9yZWR0ZXh0ID0gY29kZS5wb3AoKTtcclxuICAgICAgICAgICAgbW9uYWNvLmVkaXRvci5jb2xvcml6ZSh1bmNvbG9yZWR0ZXh0LCAnbXlKYXZhJywgeyB0YWJTaXplOiAzIH0pLnRoZW4oKHRleHQpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvZGVNYXBbdW5jb2xvcmVkdGV4dF0gPSB0ZXh0O1xyXG4gICAgICAgICAgICAgICAgdGhhdC5jb2xvcml6ZShjb2RlLCBjb2RlTWFwLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIG1hcmtGaWxlKG1vZHVsZTogTW9kdWxlKSB7XHJcbiAgICAgICAgaWYodGhpcy4kZmlsZUxpc3REaXYgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIHRoaXMuJGZpbGVMaXN0RGl2LmZpbmQoJy5qb19maWxlJykucmVtb3ZlQ2xhc3MoJ2pvX2FjdGl2ZScpO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRGaWxlID0gdGhpcy5maWxlcy5maW5kKChmaWxlRGF0YSkgPT4gZmlsZURhdGEubW9kdWxlID09IG1vZHVsZSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWxlICE9IG51bGwpIHRoaXMuY3VycmVudEZpbGUuJGZpbGVEaXYuYWRkQ2xhc3MoJ2pvX2FjdGl2ZScpO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG5cclxufSJdfQ==