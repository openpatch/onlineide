import { Klass } from "../../compiler/types/Class.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { intPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { WorldHelper } from "../graphics/World.js";
export class GNGZeichenfensterClass extends Klass {
    constructor(module) {
        super("Zeichenfenster", module, "Grafische Zeichenfläche mit Koordinatensystem");
        this.module = module;
        this.setBaseClass(module.typeStore.getType("Object"));
        // let groupType = <GroupClass>module.typeStore.getType("Group");
        let aktionsempfaengerType = module.typeStore.getType("Aktionsempfaenger");
        let symbolArtType = module.typeStore.getType("SymbolArt");
        // this.addAttribute(new Attribute("PI", doublePrimitiveType, (object) => { return Math.PI }, true, Visibility.public, true, "Die Kreiszahl Pi (3.1415...)"));
        this.addMethod(new Method("MalflächenBreiteGeben", new Parameterlist([]), intPrimitiveType, (parameters) => {
            return Math.round(this.getWorldHelper().width);
        }, false, true, 'Gibt die Breite des Zeichenbereichs in Pixeln zurück.', false));
        this.addMethod(new Method("MalflächenHöheGeben", new Parameterlist([]), intPrimitiveType, (parameters) => {
            return Math.round(this.getWorldHelper().width);
        }, false, true, 'Gibt die Höhe des Zeichenbereichs in Pixeln zurück.', false));
        this.addMethod(new Method("AktionsEmpfängerEintragen", new Parameterlist([
            { identifier: "neu", type: aktionsempfaengerType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let wh = this.getWorldHelper();
            let aktionsempfaenger = parameters[1].value;
            let klass = aktionsempfaenger.class;
            let methodList = ["Ausführen()", "Taste(char)", "SonderTaste(int)", "Geklickt(int, int, int)"];
            for (let ms of methodList) {
                let method = klass.getMethodBySignature(ms);
                if ((method === null || method === void 0 ? void 0 : method.program) != null || (method === null || method === void 0 ? void 0 : method.invoke) != null) {
                    wh.aktionsempfaengerList.push({
                        //@ts-ignore
                        methodIdentifier: ms,
                        method: method,
                        runtimeObject: aktionsempfaenger
                    });
                }
            }
        }, false, true, 'Trägt einen neuen Aktionsempfänger ein.', false));
        this.addMethod(new Method("AktionsEmpfängerEntfernen", new Parameterlist([
            { identifier: "alt", type: aktionsempfaengerType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let wh = this.getWorldHelper();
            let aktionsempfaenger = parameters[1].value;
            wh.aktionsempfaengerList = wh.aktionsempfaengerList.filter(ae => ae.runtimeObject != aktionsempfaenger);
        }, false, true, 'Löscht einen Aktionsempfänger aus der Liste.', false));
        this.addMethod(new Method("TaktgeberStarten", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            this.getWorldHelper().gngTaktgeberEnabled = true;
        }, false, true, 'Startet den Taktgeber', false));
        this.addMethod(new Method("TaktgeberStoppen", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            this.getWorldHelper().gngTaktgeberEnabled = false;
        }, false, true, 'Stoppt den Taktgeber', false));
        this.addMethod(new Method("TaktdauerSetzen", new Parameterlist([
            { identifier: "dauer", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let wh = this.getWorldHelper();
            let dauer = parameters[1].value;
            wh.gngTaktdauer = dauer;
        }, false, true, 'Setzt die Taktdauer des Zeitgebers in Millisekunden', false));
    }
    getWorldHelper(breite = 800, höhe = 600) {
        var _a, _b, _c, _d;
        let wh = (_c = (_b = (_a = this.module) === null || _a === void 0 ? void 0 : _a.main) === null || _b === void 0 ? void 0 : _b.getInterpreter()) === null || _c === void 0 ? void 0 : _c.worldHelper;
        if (wh != null) {
            if (wh.width != breite || wh.height != höhe) {
                let ratio = Math.round(höhe / breite * 100);
                wh.$containerOuter.css('padding-bottom', ratio + "%");
                wh.stage.localTransform.scale(wh.width / breite, wh.height / höhe);
                wh.width = breite;
                wh.height = höhe;
                // this.stage.localTransform.rotate(45/180*Math.PI);
                // this.stage.localTransform.translate(400,300);
                wh.stage.transform.onChange();
                (_d = this.module.main.getRightDiv()) === null || _d === void 0 ? void 0 : _d.adjustWidthToWorld();
            }
            return wh;
        }
        else {
            let worldObject = new RuntimeObject(this.module.typeStore.getType("World"));
            let wh = new WorldHelper(breite, höhe, this.module, worldObject);
            worldObject.intrinsicData["World"] = wh;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWmVpY2hlbmZlbnN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L3J1bnRpbWVsaWJyYXJ5L2duZy9aZWljaGVuZmVuc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsS0FBSyxFQUFjLE1BQU0sK0JBQStCLENBQUM7QUFDbEUsT0FBTyxFQUFhLE1BQU0sRUFBRSxhQUFhLEVBQVMsTUFBTSwrQkFBK0IsQ0FBQztBQUN4RixPQUFPLEVBQTJDLGdCQUFnQixFQUFFLGlCQUFpQixFQUE2QyxNQUFNLHdDQUF3QyxDQUFDO0FBQ2pMLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUluRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHbkQsTUFBTSxPQUFPLHNCQUF1QixTQUFRLEtBQUs7SUFFN0MsWUFBbUIsTUFBYztRQUU3QixLQUFLLENBQUMsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLCtDQUErQyxDQUFDLENBQUE7UUFGakUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUk3QixJQUFJLENBQUMsWUFBWSxDQUFRLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFN0QsaUVBQWlFO1FBQ2pFLElBQUkscUJBQXFCLEdBQTJCLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDbEcsSUFBSSxhQUFhLEdBQXNCLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRTdFLDhKQUE4SjtRQUc5SixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLHVCQUF1QixFQUFFLElBQUksYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLGdCQUFnQixFQUN0RixDQUFDLFVBQVUsRUFBRSxFQUFFO1lBRVgsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVuRCxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSx1REFBdUQsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXJGLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMscUJBQXFCLEVBQUUsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDLEVBQUUsZ0JBQWdCLEVBQ3BGLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFFWCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRW5ELENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLHFEQUFxRCxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFbkYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQywyQkFBMkIsRUFBRSxJQUFJLGFBQWEsQ0FBQztZQUNyRSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLHFCQUFxQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO1NBQzdHLENBQUMsRUFBRSxpQkFBaUIsRUFDakIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUMvQixJQUFJLGlCQUFpQixHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNELElBQUksS0FBSyxHQUFVLGlCQUFpQixDQUFDLEtBQUssQ0FBQztZQUUzQyxJQUFJLFVBQVUsR0FBRyxDQUFDLGFBQWEsRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUseUJBQXlCLENBQUMsQ0FBQztZQUUvRixLQUFLLElBQUksRUFBRSxJQUFJLFVBQVUsRUFBRTtnQkFDdkIsSUFBSSxNQUFNLEdBQVcsS0FBSyxDQUFDLG9CQUFvQixDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUVwRCxJQUFJLENBQUEsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLE9BQU8sS0FBSSxJQUFJLElBQUksQ0FBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsTUFBTSxLQUFJLElBQUksRUFBRTtvQkFDbkQsRUFBRSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQzt3QkFDMUIsWUFBWTt3QkFDWixnQkFBZ0IsRUFBRSxFQUFFO3dCQUNwQixNQUFNLEVBQUUsTUFBTTt3QkFDZCxhQUFhLEVBQUUsaUJBQWlCO3FCQUNuQyxDQUFDLENBQUM7aUJBQ047YUFDSjtRQUVMLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLHlDQUF5QyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFdkUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQywyQkFBMkIsRUFBRSxJQUFJLGFBQWEsQ0FBQztZQUNyRSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLHFCQUFxQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO1NBQzdHLENBQUMsRUFBRSxpQkFBaUIsRUFDakIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUMvQixJQUFJLGlCQUFpQixHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRTNELEVBQUUsQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLGFBQWEsSUFBSSxpQkFBaUIsQ0FBQyxDQUFDO1FBRTVHLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLDhDQUE4QyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFNUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLGFBQWEsQ0FBQyxFQUFFLENBQUMsRUFBRSxpQkFBaUIsRUFDbEYsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7UUFFckQsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUVyRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGtCQUFrQixFQUFFLElBQUksYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLGlCQUFpQixFQUNsRixDQUFDLFVBQVUsRUFBRSxFQUFFO1lBRVgsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLG1CQUFtQixHQUFHLEtBQUssQ0FBQztRQUV0RCxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxzQkFBc0IsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXBELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxhQUFhLENBQUM7WUFDM0QsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtTQUMxRyxDQUFDLEVBQUUsaUJBQWlCLEVBQ2pCLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFFWCxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDL0IsSUFBSSxLQUFLLEdBQVcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUN4QyxFQUFFLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUU1QixDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxxREFBcUQsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBR3ZGLENBQUM7SUFFRCxjQUFjLENBQUMsU0FBaUIsR0FBRyxFQUFFLE9BQWUsR0FBRzs7UUFFbkQsSUFBSSxFQUFFLHFCQUFHLElBQUksQ0FBQyxNQUFNLDBDQUFFLElBQUksMENBQUUsY0FBYyw0Q0FBSSxXQUFXLENBQUM7UUFFMUQsSUFBSSxFQUFFLElBQUksSUFBSSxFQUFFO1lBRVosSUFBSSxFQUFFLENBQUMsS0FBSyxJQUFJLE1BQU0sSUFBSSxFQUFFLENBQUMsTUFBTSxJQUFJLElBQUksRUFBRTtnQkFFekMsSUFBSSxLQUFLLEdBQVcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDO2dCQUNwRCxFQUFFLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBRXRELEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUNuRSxFQUFFLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztnQkFDbEIsRUFBRSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7Z0JBQ2pCLG9EQUFvRDtnQkFDcEQsZ0RBQWdEO2dCQUNoRCxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFFOUIsTUFBQSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsMENBQUUsa0JBQWtCLEdBQUc7YUFFeEQ7WUFFRCxPQUFPLEVBQUUsQ0FBQztTQUViO2FBQU07WUFDSCxJQUFJLFdBQVcsR0FBa0IsSUFBSSxhQUFhLENBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbEcsSUFBSSxFQUFFLEdBQUcsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ2pFLFdBQVcsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1NBQzNDO0lBRUwsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kdWxlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MsIFZpc2liaWxpdHkgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgQXR0cmlidXRlLCBNZXRob2QsIFBhcmFtZXRlcmxpc3QsIFZhbHVlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IGRvdWJsZVByaW1pdGl2ZVR5cGUsIGZsb2F0UHJpbWl0aXZlVHlwZSwgaW50UHJpbWl0aXZlVHlwZSwgdm9pZFByaW1pdGl2ZVR5cGUsIHN0cmluZ1ByaW1pdGl2ZVR5cGUsIGJvb2xlYW5QcmltaXRpdmVUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1ByaW1pdGl2ZVR5cGVzLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvUnVudGltZU9iamVjdC5qc1wiO1xyXG5pbXBvcnQgeyBBY3RvckhlbHBlciB9IGZyb20gXCIuLi9ncmFwaGljcy9BY3Rvci5qc1wiO1xyXG5pbXBvcnQgeyBJbnRlcnByZXRlclN0YXRlLCBJbnRlcnByZXRlciB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9JbnRlcnByZXRlci5qc1wiO1xyXG5pbXBvcnQgeyBTaGFwZUhlbHBlciB9IGZyb20gXCIuLi9ncmFwaGljcy9TaGFwZS5qc1wiO1xyXG5pbXBvcnQgeyBXb3JsZEhlbHBlciB9IGZyb20gXCIuLi9ncmFwaGljcy9Xb3JsZC5qc1wiO1xyXG5pbXBvcnQgeyBHTkdTeW1ib2xBcnRDbGFzcyB9IGZyb20gXCIuL1N5bWJvbEFydC5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEdOR1plaWNoZW5mZW5zdGVyQ2xhc3MgZXh0ZW5kcyBLbGFzcyB7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHVibGljIG1vZHVsZTogTW9kdWxlKSB7XHJcblxyXG4gICAgICAgIHN1cGVyKFwiWmVpY2hlbmZlbnN0ZXJcIiwgbW9kdWxlLCBcIkdyYWZpc2NoZSBaZWljaGVuZmzDpGNoZSBtaXQgS29vcmRpbmF0ZW5zeXN0ZW1cIilcclxuXHJcbiAgICAgICAgdGhpcy5zZXRCYXNlQ2xhc3MoPEtsYXNzPm1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIk9iamVjdFwiKSk7XHJcblxyXG4gICAgICAgIC8vIGxldCBncm91cFR5cGUgPSA8R3JvdXBDbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJHcm91cFwiKTtcclxuICAgICAgICBsZXQgYWt0aW9uc2VtcGZhZW5nZXJUeXBlID0gPEdOR1plaWNoZW5mZW5zdGVyQ2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiQWt0aW9uc2VtcGZhZW5nZXJcIik7XHJcbiAgICAgICAgbGV0IHN5bWJvbEFydFR5cGUgPSA8R05HU3ltYm9sQXJ0Q2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiU3ltYm9sQXJ0XCIpO1xyXG5cclxuICAgICAgICAvLyB0aGlzLmFkZEF0dHJpYnV0ZShuZXcgQXR0cmlidXRlKFwiUElcIiwgZG91YmxlUHJpbWl0aXZlVHlwZSwgKG9iamVjdCkgPT4geyByZXR1cm4gTWF0aC5QSSB9LCB0cnVlLCBWaXNpYmlsaXR5LnB1YmxpYywgdHJ1ZSwgXCJEaWUgS3JlaXN6YWhsIFBpICgzLjE0MTUuLi4pXCIpKTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJNYWxmbMOkY2hlbkJyZWl0ZUdlYmVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgaW50UHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmdldFdvcmxkSGVscGVyKCkud2lkdGgpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsICdHaWJ0IGRpZSBCcmVpdGUgZGVzIFplaWNoZW5iZXJlaWNocyBpbiBQaXhlbG4genVyw7xjay4nLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiTWFsZmzDpGNoZW5Iw7ZoZUdlYmVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgaW50UHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmdldFdvcmxkSGVscGVyKCkud2lkdGgpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsICdHaWJ0IGRpZSBIw7ZoZSBkZXMgWmVpY2hlbmJlcmVpY2hzIGluIFBpeGVsbiB6dXLDvGNrLicsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJBa3Rpb25zRW1wZsOkbmdlckVpbnRyYWdlblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJuZXVcIiwgdHlwZTogYWt0aW9uc2VtcGZhZW5nZXJUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHdoID0gdGhpcy5nZXRXb3JsZEhlbHBlcigpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGFrdGlvbnNlbXBmYWVuZ2VyOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBrbGFzcyA9IDxLbGFzcz5ha3Rpb25zZW1wZmFlbmdlci5jbGFzcztcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbWV0aG9kTGlzdCA9IFtcIkF1c2bDvGhyZW4oKVwiLCBcIlRhc3RlKGNoYXIpXCIsIFwiU29uZGVyVGFzdGUoaW50KVwiLCBcIkdla2xpY2t0KGludCwgaW50LCBpbnQpXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IG1zIG9mIG1ldGhvZExpc3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbWV0aG9kOiBNZXRob2QgPSBrbGFzcy5nZXRNZXRob2RCeVNpZ25hdHVyZShtcyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2Q/LnByb2dyYW0gIT0gbnVsbCB8fCBtZXRob2Q/Lmludm9rZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoLmFrdGlvbnNlbXBmYWVuZ2VyTGlzdC5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kSWRlbnRpZmllcjogbXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bnRpbWVPYmplY3Q6IGFrdGlvbnNlbXBmYWVuZ2VyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCB0cnVlLCAnVHLDpGd0IGVpbmVuIG5ldWVuIEFrdGlvbnNlbXBmw6RuZ2VyIGVpbi4nLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiQWt0aW9uc0VtcGbDpG5nZXJFbnRmZXJuZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiYWx0XCIsIHR5cGU6IGFrdGlvbnNlbXBmYWVuZ2VyVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXHJcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCB3aCA9IHRoaXMuZ2V0V29ybGRIZWxwZXIoKTtcclxuICAgICAgICAgICAgICAgIGxldCBha3Rpb25zZW1wZmFlbmdlcjogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgd2guYWt0aW9uc2VtcGZhZW5nZXJMaXN0ID0gd2guYWt0aW9uc2VtcGZhZW5nZXJMaXN0LmZpbHRlcihhZSA9PiBhZS5ydW50aW1lT2JqZWN0ICE9IGFrdGlvbnNlbXBmYWVuZ2VyKTtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCB0cnVlLCAnTMO2c2NodCBlaW5lbiBBa3Rpb25zZW1wZsOkbmdlciBhdXMgZGVyIExpc3RlLicsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJUYWt0Z2ViZXJTdGFydGVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRXb3JsZEhlbHBlcigpLmduZ1Rha3RnZWJlckVuYWJsZWQgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsICdTdGFydGV0IGRlbiBUYWt0Z2ViZXInLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiVGFrdGdlYmVyU3RvcHBlblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0V29ybGRIZWxwZXIoKS5nbmdUYWt0Z2ViZXJFbmFibGVkID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSwgJ1N0b3BwdCBkZW4gVGFrdGdlYmVyJywgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlRha3RkYXVlclNldHplblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJkYXVlclwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHdoID0gdGhpcy5nZXRXb3JsZEhlbHBlcigpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGRhdWVyOiBudW1iZXIgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgd2guZ25nVGFrdGRhdWVyID0gZGF1ZXI7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSwgJ1NldHp0IGRpZSBUYWt0ZGF1ZXIgZGVzIFplaXRnZWJlcnMgaW4gTWlsbGlzZWt1bmRlbicsIGZhbHNlKSk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBnZXRXb3JsZEhlbHBlcihicmVpdGU6IG51bWJlciA9IDgwMCwgaMO2aGU6IG51bWJlciA9IDYwMCk6IFdvcmxkSGVscGVyIHtcclxuXHJcbiAgICAgICAgbGV0IHdoID0gdGhpcy5tb2R1bGU/Lm1haW4/LmdldEludGVycHJldGVyKCk/LndvcmxkSGVscGVyO1xyXG5cclxuICAgICAgICBpZiAod2ggIT0gbnVsbCkge1xyXG5cclxuICAgICAgICAgICAgaWYgKHdoLndpZHRoICE9IGJyZWl0ZSB8fCB3aC5oZWlnaHQgIT0gaMO2aGUpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcmF0aW86IG51bWJlciA9IE1hdGgucm91bmQoaMO2aGUgLyBicmVpdGUgKiAxMDApO1xyXG4gICAgICAgICAgICAgICAgd2guJGNvbnRhaW5lck91dGVyLmNzcygncGFkZGluZy1ib3R0b20nLCByYXRpbyArIFwiJVwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICB3aC5zdGFnZS5sb2NhbFRyYW5zZm9ybS5zY2FsZSh3aC53aWR0aCAvIGJyZWl0ZSwgd2guaGVpZ2h0IC8gaMO2aGUpO1xyXG4gICAgICAgICAgICAgICAgd2gud2lkdGggPSBicmVpdGU7XHJcbiAgICAgICAgICAgICAgICB3aC5oZWlnaHQgPSBow7ZoZTtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMuc3RhZ2UubG9jYWxUcmFuc2Zvcm0ucm90YXRlKDQ1LzE4MCpNYXRoLlBJKTtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMuc3RhZ2UubG9jYWxUcmFuc2Zvcm0udHJhbnNsYXRlKDQwMCwzMDApO1xyXG4gICAgICAgICAgICAgICAgd2guc3RhZ2UudHJhbnNmb3JtLm9uQ2hhbmdlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5tb2R1bGUubWFpbi5nZXRSaWdodERpdigpPy5hZGp1c3RXaWR0aFRvV29ybGQoKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB3aDtcclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHdvcmxkT2JqZWN0OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3QoPEtsYXNzPnRoaXMubW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiV29ybGRcIikpO1xyXG4gICAgICAgICAgICBsZXQgd2ggPSBuZXcgV29ybGRIZWxwZXIoYnJlaXRlLCBow7ZoZSwgdGhpcy5tb2R1bGUsIHdvcmxkT2JqZWN0KTtcclxuICAgICAgICAgICAgd29ybGRPYmplY3QuaW50cmluc2ljRGF0YVtcIldvcmxkXCJdID0gd2g7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcblxyXG59XHJcblxyXG4iXX0=