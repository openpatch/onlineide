import { Klass } from "../../compiler/types/Class.js";
import { charPrimitiveType, intPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
export class GNGEreignisbehandlung extends Klass {
    constructor(module, moduleStore) {
        super("Ereignisbehandlung", module, "Zugriff auf Ereignisse einschließlich Taktgeber (Graphics'n Games-Bibliothek (Cornelsen-Verlag))");
        this.moduleStore = moduleStore;
        this.addMethod(new Method("Ereignisbehandlung", new Parameterlist([]), null, (parameters) => {
            let o = parameters[0].value;
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.registerEvents(o);
        }, false, false, 'Instanziert ein neues Ereignisbehandlungs-Objekt.', true));
        // this.addMethod(new Method("GrößeSetzen", new Parameterlist([
        //     { identifier: "größe", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        // ]), null,
        //     (parameters) => {
        //         let o: RuntimeObject = parameters[0].value;
        //         let sh: GroupHelper = o.intrinsicData["Actor"];
        //         let groesse: number = parameters[1].value;
        //     }, false, false, "Setzt die Größe der Figur.", false));
        this.addMethod(new Method("Starten", new Parameterlist([]), null, (parameters) => {
            GNGEreignisbehandlung.getHelper(module).startTimer();
        }, false, false, "Zeitgeber starten.", false));
        this.addMethod(new Method("Anhalten", new Parameterlist([]), null, (parameters) => {
            GNGEreignisbehandlung.getHelper(module).stopTimer();
        }, false, false, "Zeitgeber anhalten.", false));
        this.addMethod(new Method("TaktdauerSetzen", new Parameterlist([
            { identifier: "dauer", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let dauer = parameters[1].value;
            GNGEreignisbehandlung.getHelper(module).taktdauer = dauer;
        }, false, true, 'Setzt die Taktdauer des Zeitgebers in Millisekunden', false));
        this.addMethod(new Method("TaktImpulsAusführen", new Parameterlist([]), voidPrimitiveType, null, // no implementation!
        false, false, "Diese Methode wird vom Taktgeber aufgerufen."));
        this.addMethod(new Method("TasteGedrückt", new Parameterlist([
            { identifier: "taste", type: charPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine Taste gedrückt wird."));
        this.addMethod(new Method("SonderTasteGedrückt", new Parameterlist([
            { identifier: "taste", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine Sondertaste gedrückt wird."));
        this.addMethod(new Method("MausGeklickt", new Parameterlist([
            { identifier: "x", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "y", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "anzahl", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine die linke Maustaste gedrückt wird."));
    }
    static getHelper(module) {
        let interpreter = module.main.getInterpreter();
        if (interpreter.gngEreignisbehandlungHelper == null) {
            interpreter.gngEreignisbehandlungHelper = new GNGEreignisbehandlungHelper(module);
            interpreter.gngEreignisbehandlungHelper.bindEvents();
        }
        return interpreter.gngEreignisbehandlungHelper;
    }
}
export class GNGEreignisbehandlungHelper {
    constructor(module) {
        this.module = module;
        this.aktionsempfaengerTypes = ["ausführen", "taste", "sondertaste", "geklickt"];
        this.methodSignatureList = ["TaktImpulsAusführen()", "AktionAusführen()", "MausGeklickt(int, int, int)", "TasteGedrückt(char)", "SonderTasteGedrückt(int)"];
        this.methodToAktionsempfaengerTypeMap = {
            "TaktImpulsAusführen()": "ausführen",
            "AktionAusführen()": "ausführen",
            "MausGeklickt(int, int, int)": "geklickt",
            "TasteGedrückt(char)": "taste",
            "SonderTasteGedrückt(int)": "sondertaste"
        };
        // see https://www.freecodecamp.org/news/javascript-keycode-list-keypress-event-key-codes/
        this.keyToKeyCodeMap = {
            "Enter": 13,
            "ArrowLeft": 37,
            "ArrowRight": 39,
            "ArrowUp": 38,
            "ArrowDown": 40,
            "F1": 112,
            "F2": 113,
            "F3": 114,
            "F4": 115,
            "F5": 116,
            "F6": 117,
            "F7": 118,
            "F8": 119,
            "F9": 120,
            "F10": 121,
            "F11": 122,
            "F12": 123,
            "PageUp": 33,
            "PageDown": 34,
            "Insert": 155
        };
        // For gng library (Cornelsen-Verlag):
        this.aktionsempfaengerMap = {};
        this.timerRunning = false;
        this.taktdauer = 300;
        this.remainingTime = 0;
        for (let type of this.aktionsempfaengerTypes) {
            this.aktionsempfaengerMap[type] = [];
        }
    }
    hasAktionsEmpfaenger() {
        for (let type of this.aktionsempfaengerTypes) {
            if (this.aktionsempfaengerMap[type].length > 0) {
                return true;
            }
        }
        return false;
    }
    registerEvents(o) {
        let klass = o.class; // This might be a child class of Ereignisbehandlung!
        for (let ms of this.methodSignatureList) {
            let method = klass.getMethodBySignature(ms);
            let type = this.methodToAktionsempfaengerTypeMap[ms];
            if ((method === null || method === void 0 ? void 0 : method.program) != null || (method === null || method === void 0 ? void 0 : method.invoke) != null) {
                this.aktionsempfaengerMap[type].push({
                    type: type,
                    method: method,
                    runtimeObject: o
                });
            }
        }
    }
    unregisterEvents(o) {
        let klass = o.class; // This might be a child class of Ereignisbehandlung!
        for (let ms of this.methodSignatureList) {
            let type = this.methodToAktionsempfaengerTypeMap[ms];
            this.aktionsempfaengerMap[type] =
                this.aktionsempfaengerMap[type].filter(ae => ae.runtimeObject != o);
        }
    }
    bindEvents() {
        let interpreter = this.module.main.getInterpreter();
        this.onKeyDownMethod = (key) => {
            if (key.length == 1) {
                for (let ae of this.aktionsempfaengerMap["taste"]) {
                    this.invokeMethod(ae.method, ae.runtimeObject, [{ type: charPrimitiveType, value: key }]);
                }
            }
            else {
                let keyCode = this.keyToKeyCodeMap[key];
                if (keyCode != null) {
                    for (let ae of this.aktionsempfaengerMap["sondertaste"]) {
                        this.invokeMethod(ae.method, ae.runtimeObject, [{ type: charPrimitiveType, value: keyCode }]);
                    }
                }
            }
        };
        interpreter.keyboardTool.keyDownCallbacks.push(this.onKeyDownMethod);
        // this.startTimer();
    }
    detachEvents() {
        let interpreter = this.module.main.getInterpreter();
        let index = interpreter.keyboardTool.keyDownCallbacks.indexOf(this.onKeyDownMethod);
        if (index >= 0)
            interpreter.keyboardTool.keyDownCallbacks.splice(index, 1);
        this.stopTimer();
    }
    invokeMethod(method, runtimeObject, parameters = [], callback) {
        let program = method.program;
        let invoke = method.invoke;
        parameters = parameters.slice(0);
        parameters.unshift({ type: runtimeObject.class, value: runtimeObject });
        if (program != null) {
            this.module.main.getInterpreter().runTimer(method, parameters, callback, false);
        }
        else if (invoke != null) {
            invoke(parameters);
        }
    }
    stopTimer() {
        this.timerRunning = false;
    }
    startTimer() {
        if (!this.timerRunning) {
            this.timerRunning = true;
            this.processTimerEntries();
        }
    }
    processTimerEntries() {
        if (!this.timerRunning)
            return;
        let dt = 10;
        this.remainingTime += dt;
        if (this.remainingTime > this.taktdauer) {
            this.remainingTime -= this.taktdauer;
            let liste = this.aktionsempfaengerMap["ausführen"];
            for (let ae of liste) {
                this.invokeMethod(ae.method, ae.runtimeObject, []);
            }
        }
        let that = this;
        setTimeout(() => {
            that.processTimerEntries();
        }, dt);
    }
    handleMouseClickedEvent(x, y) {
        let parameters = [
            { type: intPrimitiveType, value: Math.round(x) },
            { type: intPrimitiveType, value: Math.round(y) },
            { type: intPrimitiveType, value: 1 }
        ];
        let liste = this.aktionsempfaengerMap["geklickt"];
        for (let ae of liste) {
            this.invokeMethod(ae.method, ae.runtimeObject, parameters);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR05HRXJlaWduaXNiZWhhbmRsdW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9ydW50aW1lbGlicmFyeS9nbmcvR05HRXJlaWduaXNiZWhhbmRsdW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNoSCxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBUyxNQUFNLCtCQUErQixDQUFDO0FBWTdFLE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxLQUFLO0lBRTVDLFlBQVksTUFBYyxFQUFVLFdBQXdCO1FBRXhELEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsa0dBQWtHLENBQUMsQ0FBQztRQUZ4RyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUt4RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLG9CQUFvQixFQUFFLElBQUksYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFDdkUsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRTNDLElBQUksTUFBTSxHQUFHLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVyRCxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTdCLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLG1EQUFtRCxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFakYsK0RBQStEO1FBQy9ELDhHQUE4RztRQUM5RyxZQUFZO1FBQ1osd0JBQXdCO1FBRXhCLHNEQUFzRDtRQUN0RCwwREFBMEQ7UUFDMUQscURBQXFEO1FBR3JELDhEQUE4RDtRQUU5RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRSxJQUFJLGFBQWEsQ0FBQyxFQUN0RCxDQUFDLEVBQUUsSUFBSSxFQUNKLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDVixxQkFBcUIsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFMUQsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUVuRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLGFBQWEsQ0FBQyxFQUN2RCxDQUFDLEVBQUUsSUFBSSxFQUNKLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDWCxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFeEQsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUscUJBQXFCLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUVwRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGlCQUFpQixFQUFFLElBQUksYUFBYSxDQUFDO1lBQzNELEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUU7U0FDMUcsQ0FBQyxFQUFFLGlCQUFpQixFQUNqQixDQUFDLFVBQVUsRUFBRSxFQUFFO1lBRVgsSUFBSSxLQUFLLEdBQVcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUN4QyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUU5RCxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxxREFBcUQsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBR25GLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMscUJBQXFCLEVBQUUsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDLEVBQUUsaUJBQWlCLEVBQ3JGLElBQUksRUFBRyxxQkFBcUI7UUFDNUIsS0FBSyxFQUFFLEtBQUssRUFBRSw4Q0FBOEMsQ0FBQyxDQUFDLENBQUM7UUFFbkUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUUsSUFBSSxhQUFhLENBQUM7WUFDekQsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtTQUMzRyxDQUFDLEVBQUUsaUJBQWlCLEVBQ2pCLElBQUksRUFBRyxxQkFBcUI7UUFDNUIsS0FBSyxFQUFFLEtBQUssRUFBRSxpREFBaUQsQ0FBQyxDQUFDLENBQUM7UUFFdEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLGFBQWEsQ0FBQztZQUMvRCxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO1NBQzFHLENBQUMsRUFBRSxpQkFBaUIsRUFDakIsSUFBSSxFQUFHLHFCQUFxQjtRQUM1QixLQUFLLEVBQUUsS0FBSyxFQUFFLHVEQUF1RCxDQUFDLENBQUMsQ0FBQztRQUU1RSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGNBQWMsRUFBRSxJQUFJLGFBQWEsQ0FBQztZQUN4RCxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO1lBQ25HLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUU7WUFDbkcsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtTQUMzRyxDQUFDLEVBQUUsaUJBQWlCLEVBQ2pCLElBQUksRUFBRyxxQkFBcUI7UUFDNUIsS0FBSyxFQUFFLEtBQUssRUFBRSwrREFBK0QsQ0FBQyxDQUFDLENBQUM7SUFFeEYsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBYztRQUMzQixJQUFJLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQy9DLElBQUksV0FBVyxDQUFDLDJCQUEyQixJQUFJLElBQUksRUFBRTtZQUNqRCxXQUFXLENBQUMsMkJBQTJCLEdBQUcsSUFBSSwyQkFBMkIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsRixXQUFXLENBQUMsMkJBQTJCLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDeEQ7UUFFRCxPQUFPLFdBQVcsQ0FBQywyQkFBMkIsQ0FBQztJQUVuRCxDQUFDO0NBRUo7QUFHRCxNQUFNLE9BQU8sMkJBQTJCO0lBNkNwQyxZQUFvQixNQUFhO1FBQWIsV0FBTSxHQUFOLE1BQU0sQ0FBTztRQTNDakMsMkJBQXNCLEdBQWEsQ0FBQyxXQUFXLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNyRix3QkFBbUIsR0FBYSxDQUFDLHVCQUF1QixFQUFFLG1CQUFtQixFQUFFLDZCQUE2QixFQUFFLHFCQUFxQixFQUFFLDBCQUEwQixDQUFDLENBQUM7UUFDaksscUNBQWdDLEdBQW9DO1lBQ2hFLHVCQUF1QixFQUFFLFdBQVc7WUFDcEMsbUJBQW1CLEVBQUUsV0FBVztZQUNoQyw2QkFBNkIsRUFBRSxVQUFVO1lBQ3pDLHFCQUFxQixFQUFFLE9BQU87WUFDOUIsMEJBQTBCLEVBQUUsYUFBYTtTQUM1QyxDQUFDO1FBRUYsMEZBQTBGO1FBQzFGLG9CQUFlLEdBQThCO1lBQ3pDLE9BQU8sRUFBRSxFQUFFO1lBQ1gsV0FBVyxFQUFFLEVBQUU7WUFDZixZQUFZLEVBQUUsRUFBRTtZQUNoQixTQUFTLEVBQUUsRUFBRTtZQUNiLFdBQVcsRUFBRSxFQUFFO1lBQ2YsSUFBSSxFQUFFLEdBQUc7WUFDVCxJQUFJLEVBQUUsR0FBRztZQUNULElBQUksRUFBRSxHQUFHO1lBQ1QsSUFBSSxFQUFFLEdBQUc7WUFDVCxJQUFJLEVBQUUsR0FBRztZQUNULElBQUksRUFBRSxHQUFHO1lBQ1QsSUFBSSxFQUFFLEdBQUc7WUFDVCxJQUFJLEVBQUUsR0FBRztZQUNULElBQUksRUFBRSxHQUFHO1lBQ1QsS0FBSyxFQUFFLEdBQUc7WUFDVixLQUFLLEVBQUUsR0FBRztZQUNWLEtBQUssRUFBRSxHQUFHO1lBQ1YsUUFBUSxFQUFFLEVBQUU7WUFDWixVQUFVLEVBQUUsRUFBRTtZQUNkLFFBQVEsRUFBRSxHQUFHO1NBQ2hCLENBQUE7UUFFRCxzQ0FBc0M7UUFDdEMseUJBQW9CLEdBQW9FLEVBQUUsQ0FBQztRQUUzRixpQkFBWSxHQUFZLEtBQUssQ0FBQztRQUM5QixjQUFTLEdBQVcsR0FBRyxDQUFDO1FBQ3hCLGtCQUFhLEdBQVcsQ0FBQyxDQUFDO1FBS3RCLEtBQUssSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLHNCQUFzQixFQUFFO1lBQzFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDeEM7SUFFTCxDQUFDO0lBRUQsb0JBQW9CO1FBRWhCLEtBQUksSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLHNCQUFzQixFQUFDO1lBQ3hDLElBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUM7Z0JBQzFDLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7U0FDSjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBRWpCLENBQUM7SUFHRCxjQUFjLENBQUMsQ0FBZ0I7UUFDM0IsSUFBSSxLQUFLLEdBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFHLHFEQUFxRDtRQUVuRixLQUFLLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUNyQyxJQUFJLE1BQU0sR0FBVyxLQUFLLENBQUMsb0JBQW9CLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXJELElBQUksQ0FBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsT0FBTyxLQUFJLElBQUksSUFBSSxDQUFBLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxNQUFNLEtBQUksSUFBSSxFQUFFO2dCQUNuRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNqQyxJQUFJLEVBQTRCLElBQUk7b0JBQ3BDLE1BQU0sRUFBRSxNQUFNO29CQUNkLGFBQWEsRUFBRSxDQUFDO2lCQUNuQixDQUFDLENBQUM7YUFDTjtTQUNKO0lBRUwsQ0FBQztJQUVELGdCQUFnQixDQUFDLENBQWdCO1FBQzdCLElBQUksS0FBSyxHQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBRyxxREFBcUQ7UUFFbkYsS0FBSyxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDckMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXJELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsYUFBYSxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQzNFO0lBQ0wsQ0FBQztJQUdELFVBQVU7UUFDTixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUVwRCxJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsR0FBVyxFQUFFLEVBQUU7WUFDbkMsSUFBSSxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtnQkFDakIsS0FBSyxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQy9DLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsYUFBYSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDN0Y7YUFDSjtpQkFBTTtnQkFDSCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUN4QyxJQUFJLE9BQU8sSUFBSSxJQUFJLEVBQUU7b0JBQ2pCLEtBQUssSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxFQUFFO3dCQUNyRCxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLGFBQWEsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7cUJBQ2pHO2lCQUNKO2FBQ0o7UUFFTCxDQUFDLENBQUM7UUFFRixXQUFXLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFckUscUJBQXFCO0lBRXpCLENBQUM7SUFFRCxZQUFZO1FBQ1IsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDcEQsSUFBSSxLQUFLLEdBQUcsV0FBVyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3BGLElBQUksS0FBSyxJQUFJLENBQUM7WUFBRSxXQUFXLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFHRCxZQUFZLENBQUMsTUFBYyxFQUFFLGFBQTRCLEVBQUUsYUFBc0IsRUFBRSxFQUFFLFFBQXFCO1FBQ3RHLElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFDN0IsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUUzQixVQUFVLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLGFBQWEsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFFeEUsSUFBSSxPQUFPLElBQUksSUFBSSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNuRjthQUFNLElBQUksTUFBTSxJQUFJLElBQUksRUFBRTtZQUN2QixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDdEI7SUFFTCxDQUFDO0lBRUQsU0FBUztRQUNMLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBQzlCLENBQUM7SUFFRCxVQUFVO1FBRU4sSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7WUFDekIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7U0FDOUI7SUFFTCxDQUFDO0lBRUQsbUJBQW1CO1FBRWYsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZO1lBQUUsT0FBTztRQUUvQixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFFWixJQUFJLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQztRQUN6QixJQUFJLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNyQyxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUM7WUFFckMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ25ELEtBQUssSUFBSSxFQUFFLElBQUksS0FBSyxFQUFFO2dCQUVsQixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUV0RDtTQUVKO1FBRUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMvQixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFWCxDQUFDO0lBRUQsdUJBQXVCLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDeEMsSUFBSSxVQUFVLEdBQVk7WUFDdEIsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDaEQsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDaEQsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRTtTQUN2QyxDQUFBO1FBRUQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2xELEtBQUssSUFBSSxFQUFFLElBQUksS0FBSyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsYUFBYSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBRTlEO0lBRUwsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kdWxlLCBNb2R1bGVTdG9yZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XG5pbXBvcnQgeyBLbGFzcyB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9DbGFzcy5qc1wiO1xuaW1wb3J0IHsgY2hhclByaW1pdGl2ZVR5cGUsIGludFByaW1pdGl2ZVR5cGUsIHZvaWRQcmltaXRpdmVUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1ByaW1pdGl2ZVR5cGVzLmpzXCI7XG5pbXBvcnQgeyBNZXRob2QsIFBhcmFtZXRlcmxpc3QsIFZhbHVlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XG5pbXBvcnQgeyBSdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4uLy4uL2ludGVycHJldGVyL1J1bnRpbWVPYmplY3QuanNcIjtcblxuXG5leHBvcnQgdHlwZSBHTkdBa3Rpb25zZW1wZmFlbmdlclR5cGUgPSBcImF1c2bDvGhyZW5cIiB8IFwidGFzdGVcIiB8IFwic29uZGVydGFzdGVcIiB8IFwiZ2VrbGlja3RcIjtcblxuZXhwb3J0IHR5cGUgR05HQWt0aW9uc2VtcGZhZW5nZXJEYXRhID0ge1xuICAgIHR5cGU6IEdOR0FrdGlvbnNlbXBmYWVuZ2VyVHlwZSxcbiAgICBtZXRob2Q6IE1ldGhvZCxcbiAgICBydW50aW1lT2JqZWN0OiBSdW50aW1lT2JqZWN0XG59XG5cbmV4cG9ydCBjbGFzcyBHTkdFcmVpZ25pc2JlaGFuZGx1bmcgZXh0ZW5kcyBLbGFzcyB7XG5cbiAgICBjb25zdHJ1Y3Rvcihtb2R1bGU6IE1vZHVsZSwgcHJpdmF0ZSBtb2R1bGVTdG9yZTogTW9kdWxlU3RvcmUpIHtcblxuICAgICAgICBzdXBlcihcIkVyZWlnbmlzYmVoYW5kbHVuZ1wiLCBtb2R1bGUsIFwiWnVncmlmZiBhdWYgRXJlaWduaXNzZSBlaW5zY2hsaWXDn2xpY2ggVGFrdGdlYmVyIChHcmFwaGljcyduIEdhbWVzLUJpYmxpb3RoZWsgKENvcm5lbHNlbi1WZXJsYWcpKVwiKTtcblxuXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJFcmVpZ25pc2JlaGFuZGx1bmdcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW10pLCBudWxsLFxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcblxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcblxuICAgICAgICAgICAgICAgIGxldCBoZWxwZXIgPSBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSk7XG5cbiAgICAgICAgICAgICAgICBoZWxwZXIucmVnaXN0ZXJFdmVudHMobyk7XG5cbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ0luc3RhbnppZXJ0IGVpbiBuZXVlcyBFcmVpZ25pc2JlaGFuZGx1bmdzLU9iamVrdC4nLCB0cnVlKSk7XG5cbiAgICAgICAgLy8gdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIkdyw7bDn2VTZXR6ZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xuICAgICAgICAvLyAgICAgeyBpZGVudGlmaWVyOiBcImdyw7bDn2VcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cbiAgICAgICAgLy8gXSksIG51bGwsXG4gICAgICAgIC8vICAgICAocGFyYW1ldGVycykgPT4ge1xuXG4gICAgICAgIC8vICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xuICAgICAgICAvLyAgICAgICAgIGxldCBzaDogR3JvdXBIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXTtcbiAgICAgICAgLy8gICAgICAgICBsZXQgZ3JvZXNzZTogbnVtYmVyID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcblxuXG4gICAgICAgIC8vICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiU2V0enQgZGllIEdyw7bDn2UgZGVyIEZpZ3VyLlwiLCBmYWxzZSkpO1xuXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJTdGFydGVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcbiAgICAgICAgXSksIG51bGwsXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xuICAgICAgICAgICAgICAgICBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSkuc3RhcnRUaW1lcigpO1xuXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiWmVpdGdlYmVyIHN0YXJ0ZW4uXCIsIGZhbHNlKSk7XG5cbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIkFuaGFsdGVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcbiAgICAgICAgXSksIG51bGwsXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xuICAgICAgICAgICAgICAgIEdOR0VyZWlnbmlzYmVoYW5kbHVuZy5nZXRIZWxwZXIobW9kdWxlKS5zdG9wVGltZXIoKTtcblxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIlplaXRnZWJlciBhbmhhbHRlbi5cIiwgZmFsc2UpKTtcblxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiVGFrdGRhdWVyU2V0emVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJkYXVlclwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcblxuICAgICAgICAgICAgICAgIGxldCBkYXVlcjogbnVtYmVyID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcbiAgICAgICAgICAgICAgICBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSkudGFrdGRhdWVyID0gZGF1ZXI7XG5cbiAgICAgICAgICAgIH0sIGZhbHNlLCB0cnVlLCAnU2V0enQgZGllIFRha3RkYXVlciBkZXMgWmVpdGdlYmVycyBpbiBNaWxsaXNla3VuZGVuJywgZmFsc2UpKTtcblxuXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJUYWt0SW1wdWxzQXVzZsO8aHJlblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXSksIHZvaWRQcmltaXRpdmVUeXBlLFxuICAgICAgICAgICAgbnVsbCwgIC8vIG5vIGltcGxlbWVudGF0aW9uIVxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIkRpZXNlIE1ldGhvZGUgd2lyZCB2b20gVGFrdGdlYmVyIGF1ZmdlcnVmZW4uXCIpKTtcblxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiVGFzdGVHZWRyw7xja3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInRhc3RlXCIsIHR5cGU6IGNoYXJQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXG4gICAgICAgICAgICBudWxsLCAgLy8gbm8gaW1wbGVtZW50YXRpb24hXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiV2lyZCBhdWZnZXJ1ZmVuLCB3ZW5uIGVpbmUgVGFzdGUgZ2VkcsO8Y2t0IHdpcmQuXCIpKTtcblxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiU29uZGVyVGFzdGVHZWRyw7xja3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInRhc3RlXCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcbiAgICAgICAgICAgIG51bGwsICAvLyBubyBpbXBsZW1lbnRhdGlvbiFcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIHdlbm4gZWluZSBTb25kZXJ0YXN0ZSBnZWRyw7xja3Qgd2lyZC5cIikpO1xuXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJNYXVzR2VrbGlja3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInhcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwieVwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJhbnphaGxcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcbiAgICAgICAgICAgIG51bGwsICAvLyBubyBpbXBsZW1lbnRhdGlvbiFcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIHdlbm4gZWluZSBkaWUgbGlua2UgTWF1c3Rhc3RlIGdlZHLDvGNrdCB3aXJkLlwiKSk7XG5cbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0SGVscGVyKG1vZHVsZTogTW9kdWxlKTpHTkdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXJ7XG4gICAgICAgIGxldCBpbnRlcnByZXRlciA9IG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCk7XG4gICAgICAgIGlmIChpbnRlcnByZXRlci5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgaW50ZXJwcmV0ZXIuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID0gbmV3IEdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlcihtb2R1bGUpO1xuICAgICAgICAgICAgaW50ZXJwcmV0ZXIuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyLmJpbmRFdmVudHMoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpbnRlcnByZXRlci5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXI7XG5cbiAgICB9XG5cbn1cblxuXG5leHBvcnQgY2xhc3MgR05HRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyIHtcblxuICAgIGFrdGlvbnNlbXBmYWVuZ2VyVHlwZXM6IHN0cmluZ1tdID0gW1wiYXVzZsO8aHJlblwiLCBcInRhc3RlXCIsIFwic29uZGVydGFzdGVcIiwgXCJnZWtsaWNrdFwiXTtcbiAgICBtZXRob2RTaWduYXR1cmVMaXN0OiBzdHJpbmdbXSA9IFtcIlRha3RJbXB1bHNBdXNmw7xocmVuKClcIiwgXCJBa3Rpb25BdXNmw7xocmVuKClcIiwgXCJNYXVzR2VrbGlja3QoaW50LCBpbnQsIGludClcIiwgXCJUYXN0ZUdlZHLDvGNrdChjaGFyKVwiLCBcIlNvbmRlclRhc3RlR2VkcsO8Y2t0KGludClcIl07XG4gICAgbWV0aG9kVG9Ba3Rpb25zZW1wZmFlbmdlclR5cGVNYXA6IHsgW3NpZ25hdHVyZTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gICAgICAgIFwiVGFrdEltcHVsc0F1c2bDvGhyZW4oKVwiOiBcImF1c2bDvGhyZW5cIixcbiAgICAgICAgXCJBa3Rpb25BdXNmw7xocmVuKClcIjogXCJhdXNmw7xocmVuXCIsXG4gICAgICAgIFwiTWF1c0dla2xpY2t0KGludCwgaW50LCBpbnQpXCI6IFwiZ2VrbGlja3RcIixcbiAgICAgICAgXCJUYXN0ZUdlZHLDvGNrdChjaGFyKVwiOiBcInRhc3RlXCIsXG4gICAgICAgIFwiU29uZGVyVGFzdGVHZWRyw7xja3QoaW50KVwiOiBcInNvbmRlcnRhc3RlXCJcbiAgICB9O1xuXG4gICAgLy8gc2VlIGh0dHBzOi8vd3d3LmZyZWVjb2RlY2FtcC5vcmcvbmV3cy9qYXZhc2NyaXB0LWtleWNvZGUtbGlzdC1rZXlwcmVzcy1ldmVudC1rZXktY29kZXMvXG4gICAga2V5VG9LZXlDb2RlTWFwOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9ID0ge1xuICAgICAgICBcIkVudGVyXCI6IDEzLFxuICAgICAgICBcIkFycm93TGVmdFwiOiAzNyxcbiAgICAgICAgXCJBcnJvd1JpZ2h0XCI6IDM5LFxuICAgICAgICBcIkFycm93VXBcIjogMzgsXG4gICAgICAgIFwiQXJyb3dEb3duXCI6IDQwLFxuICAgICAgICBcIkYxXCI6IDExMixcbiAgICAgICAgXCJGMlwiOiAxMTMsXG4gICAgICAgIFwiRjNcIjogMTE0LFxuICAgICAgICBcIkY0XCI6IDExNSxcbiAgICAgICAgXCJGNVwiOiAxMTYsXG4gICAgICAgIFwiRjZcIjogMTE3LFxuICAgICAgICBcIkY3XCI6IDExOCxcbiAgICAgICAgXCJGOFwiOiAxMTksXG4gICAgICAgIFwiRjlcIjogMTIwLFxuICAgICAgICBcIkYxMFwiOiAxMjEsXG4gICAgICAgIFwiRjExXCI6IDEyMixcbiAgICAgICAgXCJGMTJcIjogMTIzLFxuICAgICAgICBcIlBhZ2VVcFwiOiAzMyxcbiAgICAgICAgXCJQYWdlRG93blwiOiAzNCxcbiAgICAgICAgXCJJbnNlcnRcIjogMTU1XG4gICAgfVxuXG4gICAgLy8gRm9yIGduZyBsaWJyYXJ5IChDb3JuZWxzZW4tVmVybGFnKTpcbiAgICBha3Rpb25zZW1wZmFlbmdlck1hcDogeyBbYWt0aW9uc2VtcGZhZW5nZXJUeXBlOiBzdHJpbmddOiBHTkdBa3Rpb25zZW1wZmFlbmdlckRhdGFbXSB9ID0ge307XG5cbiAgICB0aW1lclJ1bm5pbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICB0YWt0ZGF1ZXI6IG51bWJlciA9IDMwMDtcbiAgICByZW1haW5pbmdUaW1lOiBudW1iZXIgPSAwO1xuXG4gICAgb25LZXlEb3duTWV0aG9kOiAoa2V5OiBzdHJpbmcpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1vZHVsZTpNb2R1bGUpe1xuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJUeXBlcykge1xuICAgICAgICAgICAgdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFt0eXBlXSA9IFtdO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBoYXNBa3Rpb25zRW1wZmFlbmdlcigpOiBib29sZWFuIHtcblxuICAgICAgICBmb3IobGV0IHR5cGUgb2YgdGhpcy5ha3Rpb25zZW1wZmFlbmdlclR5cGVzKXtcbiAgICAgICAgICAgIGlmKHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbdHlwZV0ubGVuZ3RoID4gMCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICB9XG5cblxuICAgIHJlZ2lzdGVyRXZlbnRzKG86IFJ1bnRpbWVPYmplY3QpIHtcbiAgICAgICAgbGV0IGtsYXNzID0gPEtsYXNzPm8uY2xhc3M7ICAgLy8gVGhpcyBtaWdodCBiZSBhIGNoaWxkIGNsYXNzIG9mIEVyZWlnbmlzYmVoYW5kbHVuZyFcblxuICAgICAgICBmb3IgKGxldCBtcyBvZiB0aGlzLm1ldGhvZFNpZ25hdHVyZUxpc3QpIHtcbiAgICAgICAgICAgIGxldCBtZXRob2Q6IE1ldGhvZCA9IGtsYXNzLmdldE1ldGhvZEJ5U2lnbmF0dXJlKG1zKTtcbiAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5tZXRob2RUb0FrdGlvbnNlbXBmYWVuZ2VyVHlwZU1hcFttc107XG5cbiAgICAgICAgICAgIGlmIChtZXRob2Q/LnByb2dyYW0gIT0gbnVsbCB8fCBtZXRob2Q/Lmludm9rZSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFt0eXBlXS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogPEdOR0FrdGlvbnNlbXBmYWVuZ2VyVHlwZT50eXBlLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgcnVudGltZU9iamVjdDogb1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICB1bnJlZ2lzdGVyRXZlbnRzKG86IFJ1bnRpbWVPYmplY3QpIHtcbiAgICAgICAgbGV0IGtsYXNzID0gPEtsYXNzPm8uY2xhc3M7ICAgLy8gVGhpcyBtaWdodCBiZSBhIGNoaWxkIGNsYXNzIG9mIEVyZWlnbmlzYmVoYW5kbHVuZyFcblxuICAgICAgICBmb3IgKGxldCBtcyBvZiB0aGlzLm1ldGhvZFNpZ25hdHVyZUxpc3QpIHtcbiAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5tZXRob2RUb0FrdGlvbnNlbXBmYWVuZ2VyVHlwZU1hcFttc107XG5cbiAgICAgICAgICAgIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbdHlwZV0gPVxuICAgICAgICAgICAgICAgIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbdHlwZV0uZmlsdGVyKGFlID0+IGFlLnJ1bnRpbWVPYmplY3QgIT0gbyk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIGJpbmRFdmVudHMoKSB7XG4gICAgICAgIGxldCBpbnRlcnByZXRlciA9IHRoaXMubW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcblxuICAgICAgICB0aGlzLm9uS2V5RG93bk1ldGhvZCA9IChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgaWYgKGtleS5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJ0YXN0ZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9rZU1ldGhvZChhZS5tZXRob2QsIGFlLnJ1bnRpbWVPYmplY3QsIFt7IHR5cGU6IGNoYXJQcmltaXRpdmVUeXBlLCB2YWx1ZToga2V5IH1dKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCBrZXlDb2RlID0gdGhpcy5rZXlUb0tleUNvZGVNYXBba2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoa2V5Q29kZSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJzb25kZXJ0YXN0ZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZva2VNZXRob2QoYWUubWV0aG9kLCBhZS5ydW50aW1lT2JqZWN0LCBbeyB0eXBlOiBjaGFyUHJpbWl0aXZlVHlwZSwgdmFsdWU6IGtleUNvZGUgfV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH07XG5cbiAgICAgICAgaW50ZXJwcmV0ZXIua2V5Ym9hcmRUb29sLmtleURvd25DYWxsYmFja3MucHVzaCh0aGlzLm9uS2V5RG93bk1ldGhvZCk7XG5cbiAgICAgICAgLy8gdGhpcy5zdGFydFRpbWVyKCk7XG5cbiAgICB9XG5cbiAgICBkZXRhY2hFdmVudHMoKSB7XG4gICAgICAgIGxldCBpbnRlcnByZXRlciA9IHRoaXMubW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcbiAgICAgICAgbGV0IGluZGV4ID0gaW50ZXJwcmV0ZXIua2V5Ym9hcmRUb29sLmtleURvd25DYWxsYmFja3MuaW5kZXhPZih0aGlzLm9uS2V5RG93bk1ldGhvZCk7XG4gICAgICAgIGlmIChpbmRleCA+PSAwKSBpbnRlcnByZXRlci5rZXlib2FyZFRvb2wua2V5RG93bkNhbGxiYWNrcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB0aGlzLnN0b3BUaW1lcigpO1xuICAgIH1cblxuXG4gICAgaW52b2tlTWV0aG9kKG1ldGhvZDogTWV0aG9kLCBydW50aW1lT2JqZWN0OiBSdW50aW1lT2JqZWN0LCBwYXJhbWV0ZXJzOiBWYWx1ZVtdID0gW10sIGNhbGxiYWNrPzogKCkgPT4gdm9pZCkge1xuICAgICAgICBsZXQgcHJvZ3JhbSA9IG1ldGhvZC5wcm9ncmFtO1xuICAgICAgICBsZXQgaW52b2tlID0gbWV0aG9kLmludm9rZTtcblxuICAgICAgICBwYXJhbWV0ZXJzID0gcGFyYW1ldGVycy5zbGljZSgwKTtcbiAgICAgICAgcGFyYW1ldGVycy51bnNoaWZ0KHsgdHlwZTogcnVudGltZU9iamVjdC5jbGFzcywgdmFsdWU6IHJ1bnRpbWVPYmplY3QgfSk7XG5cbiAgICAgICAgaWYgKHByb2dyYW0gIT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5tb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnJ1blRpbWVyKG1ldGhvZCwgcGFyYW1ldGVycywgY2FsbGJhY2ssIGZhbHNlKTtcbiAgICAgICAgfSBlbHNlIGlmIChpbnZva2UgIT0gbnVsbCkge1xuICAgICAgICAgICAgaW52b2tlKHBhcmFtZXRlcnMpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBzdG9wVGltZXIoKSB7XG4gICAgICAgIHRoaXMudGltZXJSdW5uaW5nID0gZmFsc2U7XG4gICAgfVxuXG4gICAgc3RhcnRUaW1lcigpIHtcblxuICAgICAgICBpZiAoIXRoaXMudGltZXJSdW5uaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnRpbWVyUnVubmluZyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NUaW1lckVudHJpZXMoKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJvY2Vzc1RpbWVyRW50cmllcygpIHtcblxuICAgICAgICBpZiAoIXRoaXMudGltZXJSdW5uaW5nKSByZXR1cm47XG5cbiAgICAgICAgbGV0IGR0ID0gMTA7XG5cbiAgICAgICAgdGhpcy5yZW1haW5pbmdUaW1lICs9IGR0O1xuICAgICAgICBpZiAodGhpcy5yZW1haW5pbmdUaW1lID4gdGhpcy50YWt0ZGF1ZXIpIHtcbiAgICAgICAgICAgIHRoaXMucmVtYWluaW5nVGltZSAtPSB0aGlzLnRha3RkYXVlcjtcblxuICAgICAgICAgICAgbGV0IGxpc3RlID0gdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFtcImF1c2bDvGhyZW5cIl07XG4gICAgICAgICAgICBmb3IgKGxldCBhZSBvZiBsaXN0ZSkge1xuXG4gICAgICAgICAgICAgICAgdGhpcy5pbnZva2VNZXRob2QoYWUubWV0aG9kLCBhZS5ydW50aW1lT2JqZWN0LCBbXSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoYXQucHJvY2Vzc1RpbWVyRW50cmllcygpO1xuICAgICAgICB9LCBkdCk7XG5cbiAgICB9XG5cbiAgICBoYW5kbGVNb3VzZUNsaWNrZWRFdmVudCh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgICAgICBsZXQgcGFyYW1ldGVyczogVmFsdWVbXSA9IFtcbiAgICAgICAgICAgIHsgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgdmFsdWU6IE1hdGgucm91bmQoeCkgfSxcbiAgICAgICAgICAgIHsgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgdmFsdWU6IE1hdGgucm91bmQoeSkgfSxcbiAgICAgICAgICAgIHsgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgdmFsdWU6IDEgfVxuICAgICAgICBdXG5cbiAgICAgICAgbGV0IGxpc3RlID0gdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFtcImdla2xpY2t0XCJdO1xuICAgICAgICBmb3IgKGxldCBhZSBvZiBsaXN0ZSkge1xuICAgICAgICAgICAgdGhpcy5pbnZva2VNZXRob2QoYWUubWV0aG9kLCBhZS5ydW50aW1lT2JqZWN0LCBwYXJhbWV0ZXJzKTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cblxufVxuXG4iXX0=