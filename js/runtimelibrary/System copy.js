import { Method, Parameterlist, Attribute } from "../compiler/types/Types.js";
import { Klass, Visibility, Interface } from "../compiler/types/Class.js";
import { stringPrimitiveType, intPrimitiveType, voidPrimitiveType } from "../compiler/types/PrimitiveTypes.js";
import { RuntimeObject } from "../interpreter/RuntimeObject.js";
export class SystemClass extends Klass {
    constructor(module) {
        super("System", module, "Klasse mit statischen Methoden für Systemfunktionen, z.B. Sound, Löschen der Ausgabe usw.");
        this.deltaTimeMillis = 0; // when using WebSocket then the Server sends time synchronization
        this.printStream = new RuntimeObject(module.typeStore.getType("PrintStream"));
        this.setBaseClass(module.typeStore.getType("Object"));
        this.addAttribute(new Attribute("out", module.typeStore.getType("PrintStream"), (value) => { value.value = this.printStream; }, true, Visibility.public, true, "PrintStream-Objekt, mit dem Text ausgegeben werden kann."));
        this.staticClass.classObject = new RuntimeObject(this.staticClass);
        this.staticClass.classObject.initializeAttributeValues();
        this.addMethod(new Method("clearScreen", new Parameterlist([]), null, (parameters) => {
            module.main.getInterpreter().printManager.clear();
        }, false, true, "Löscht den Bildschirm"));
        this.addMethod(new Method("addKeyListener", new Parameterlist([
            { identifier: "keyListener", type: module.typeStore.getType("KeyListener"), declaration: null, usagePositions: null, isFinal: true }
        ]), null, (parameters) => {
            let r = parameters[1].value;
            let method = r.class.getMethodBySignature("onKeyTyped(String)");
            if (method != null) {
                module.main.getInterpreter().keyboardTool.keyPressedCallbacks.push((key) => {
                    let program = method === null || method === void 0 ? void 0 : method.program;
                    let invoke = method === null || method === void 0 ? void 0 : method.invoke;
                    let stackElements = [
                        {
                            type: r.class,
                            value: r
                        },
                        {
                            type: stringPrimitiveType,
                            value: key
                        }
                    ];
                    if (program != null) {
                        module.main.getInterpreter().runTimer(method, stackElements, null, false);
                    }
                    else if (invoke != null) {
                        invoke([]);
                    }
                });
            }
        }, false, true, "Fügt einen KeyListener hinzu, dessen Methode keyTyped immer dann aufgerufen wird, wenn eine Taste gedrückt und anschließend losgelassen wird."));
        // this.addMethod(new Method("playSound", new Parameterlist([
        //     { identifier: "sound", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        // ]), null,
        // (parameters) => {
        //     let sound: string = parameters[1].value;
        //     SoundTools.play(sound);
        // }    
        // , false, true, "Spielt einen Sound ab. Die Möglichen Sounds sind als statische Variablen der Klasse Sound hinterlegt. Tippe als Parameter also Sound gefolgt von einem Punkt ein, um eine Auswahl zu sehen!"));
        this.addMethod(new Method("currentTimeMillis", new Parameterlist([]), intPrimitiveType, (parameters) => {
            return Date.now() + this.deltaTimeMillis;
        }, false, true, "Gibt die Anzahl der Millisekunden, die seit dem 01.01.1970 00:00:00 UTC vergangen sind, zurück."));
    }
}
export class KeyListener extends Interface {
    constructor(module) {
        super("KeyListener", module, "Interface mit Methode onKeyTyped. Eine Klasse, die dieses Interface implementiert, kann auf Tastatureingaben reagieren. Ein Objekt dieser Klasse muss zuvor aber mit System.addKeyListener() registriert werden.");
        this.addMethod(new Method("onKeyTyped", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, nachdem eine Taste gedrückt wurde."));
    }
}
export class PrintStreamClass extends Klass {
    constructor(module) {
        super("PrintStream", module, "Interne Hilfsklasse, um System.out.println zu ermöglichen. Das Objekt System.out ist von der Klasse PrintStream.");
        this.setBaseClass(module.typeStore.getType("Object"));
        this.addMethod(new Method("print", new Parameterlist([
            { identifier: "text", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), null, (parameters) => {
            module.main.getInterpreter().printManager.print(parameters[1].value);
        }, false, true, "Gibt den Text aus."));
        this.addMethod(new Method("println", new Parameterlist([
            { identifier: "text", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), null, (parameters) => {
            module.main.getInterpreter().printManager.println(parameters[1].value);
        }, false, true, "Gibt den Text aus, gefolgt von einem Zeilensprung."));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3lzdGVtIGNvcHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L3J1bnRpbWVsaWJyYXJ5L1N5c3RlbSBjb3B5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBUSxNQUFNLEVBQUUsYUFBYSxFQUFTLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzNGLE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzFFLE9BQU8sRUFBRSxtQkFBbUIsRUFBMkMsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUd4SixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFJaEUsTUFBTSxPQUFPLFdBQVksU0FBUSxLQUFLO0lBTWxDLFlBQVksTUFBYztRQUN0QixLQUFLLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSwyRkFBMkYsQ0FBQyxDQUFDO1FBSHpILG9CQUFlLEdBQVcsQ0FBQyxDQUFDLENBQUMsa0VBQWtFO1FBSzNGLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxhQUFhLENBQVEsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUVyRixJQUFJLENBQUMsWUFBWSxDQUFRLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFN0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQzFFLENBQUMsS0FBSyxFQUFFLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUEsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFF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UUFDekUsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO1FBRTNDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFLElBQUksYUFBYSxDQUFDO1lBQ25ELEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUU7U0FDNUcsQ0FBQyxFQUFFLElBQUksRUFDSixDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQ1gsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzRSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxvREFBb0QsQ0FBQyxDQUFDLENBQUM7SUFHL0UsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHlwZSwgTWV0aG9kLCBQYXJhbWV0ZXJsaXN0LCBWYWx1ZSwgQXR0cmlidXRlIH0gZnJvbSBcIi4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IEtsYXNzLCBWaXNpYmlsaXR5LCBJbnRlcmZhY2UgfSBmcm9tIFwiLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgc3RyaW5nUHJpbWl0aXZlVHlwZSwgZG91YmxlUHJpbWl0aXZlVHlwZSwgZmxvYXRQcmltaXRpdmVUeXBlLCBpbnRQcmltaXRpdmVUeXBlLCB2b2lkUHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBNb2R1bGUgfSBmcm9tIFwiLi4vY29tcGlsZXIvcGFyc2VyL01vZHVsZS5qc1wiO1xyXG5pbXBvcnQgeyBQcmludE1hbmFnZXIgfSBmcm9tIFwiLi4vbWFpbi9ndWkvUHJpbnRNYW5hZ2VyLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi4vaW50ZXJwcmV0ZXIvUnVudGltZU9iamVjdC5qc1wiO1xyXG5pbXBvcnQgeyBFbnVtUnVudGltZU9iamVjdCB9IGZyb20gXCIuLi9jb21waWxlci90eXBlcy9FbnVtLmpzXCI7XHJcbmltcG9ydCB7IFNvdW5kVG9vbHMgfSBmcm9tIFwiLi4vdG9vbHMvU291bmRUb29scy5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFN5c3RlbUNsYXNzIGV4dGVuZHMgS2xhc3Mge1xyXG5cclxuICAgIHByaW50U3RyZWFtOiBSdW50aW1lT2JqZWN0O1xyXG5cclxuICAgIGRlbHRhVGltZU1pbGxpczogbnVtYmVyID0gMDsgLy8gd2hlbiB1c2luZyBXZWJTb2NrZXQgdGhlbiB0aGUgU2VydmVyIHNlbmRzIHRpbWUgc3luY2hyb25pemF0aW9uXHJcblxyXG4gICAgY29uc3RydWN0b3IobW9kdWxlOiBNb2R1bGUpIHtcclxuICAgICAgICBzdXBlcihcIlN5c3RlbVwiLCBtb2R1bGUsIFwiS2xhc3NlIG1pdCBzdGF0aXNjaGVuIE1ldGhvZGVuIGbDvHIgU3lzdGVtZnVua3Rpb25lbiwgei5CLiBTb3VuZCwgTMO2c2NoZW4gZGVyIEF1c2dhYmUgdXN3LlwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5wcmludFN0cmVhbSA9IG5ldyBSdW50aW1lT2JqZWN0KDxLbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJQcmludFN0cmVhbVwiKSk7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0QmFzZUNsYXNzKDxLbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJPYmplY3RcIikpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZEF0dHJpYnV0ZShuZXcgQXR0cmlidXRlKFwib3V0XCIsIG1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIlByaW50U3RyZWFtXCIpLFxyXG4gICAgICAgICAgICAodmFsdWUpID0+IHsgdmFsdWUudmFsdWUgPSB0aGlzLnByaW50U3RyZWFtIH0sIHRydWUsIFZpc2liaWxpdHkucHVibGljLCB0cnVlLCBcIlByaW50U3RyZWFtLU9iamVrdCwgbWl0IGRlbSBUZXh0IGF1c2dlZ2ViZW4gd2VyZGVuIGthbm4uXCIpKTtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0aWNDbGFzcy5jbGFzc09iamVjdCA9IG5ldyBSdW50aW1lT2JqZWN0KHRoaXMuc3RhdGljQ2xhc3MpO1xyXG4gICAgICAgIHRoaXMuc3RhdGljQ2xhc3MuY2xhc3NPYmplY3QuaW5pdGlhbGl6ZUF0dHJpYnV0ZVZhbHVlcygpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiY2xlYXJTY3JlZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKS5wcmludE1hbmFnZXIuY2xlYXIoKTtcclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsIFwiTMO2c2NodCBkZW4gQmlsZHNjaGlybVwiKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJhZGRLZXlMaXN0ZW5lclwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJrZXlMaXN0ZW5lclwiLCB0eXBlOiBtb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJLZXlMaXN0ZW5lclwiKSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgbnVsbCxcclxuICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcjogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcbiAgICAgICAgICAgIGxldCBtZXRob2QgPSAoPEtsYXNzPnIuY2xhc3MpLmdldE1ldGhvZEJ5U2lnbmF0dXJlKFwib25LZXlUeXBlZChTdHJpbmcpXCIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKG1ldGhvZCAhPSBudWxsKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKS5rZXlib2FyZFRvb2wua2V5UHJlc3NlZENhbGxiYWNrcy5wdXNoKChrZXkpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHByb2dyYW0gPSBtZXRob2Q/LnByb2dyYW07XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGludm9rZSA9IG1ldGhvZD8uaW52b2tlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhY2tFbGVtZW50czogVmFsdWVbXSA9IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogci5jbGFzcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiByXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IHN0cmluZ1ByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZToga2V5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAocHJvZ3JhbSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCkucnVuVGltZXIobWV0aG9kLCBzdGFja0VsZW1lbnRzLCBudWxsLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnZva2UgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnZva2UoW10pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9ICAgIFxyXG4gICAgICAgICwgZmFsc2UsIHRydWUsIFwiRsO8Z3QgZWluZW4gS2V5TGlzdGVuZXIgaGluenUsIGRlc3NlbiBNZXRob2RlIGtleVR5cGVkIGltbWVyIGRhbm4gYXVmZ2VydWZlbiB3aXJkLCB3ZW5uIGVpbmUgVGFzdGUgZ2VkcsO8Y2t0IHVuZCBhbnNjaGxpZcOfZW5kIGxvc2dlbGFzc2VuIHdpcmQuXCIpKTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcInBsYXlTb3VuZFwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgLy8gICAgIHsgaWRlbnRpZmllcjogXCJzb3VuZFwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIC8vIF0pLCBudWxsLFxyXG4gICAgICAgIC8vIChwYXJhbWV0ZXJzKSA9PiB7XHJcbiAgICAgICAgLy8gICAgIGxldCBzb3VuZDogc3RyaW5nID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuICAgICAgICAvLyAgICAgU291bmRUb29scy5wbGF5KHNvdW5kKTtcclxuICAgICAgICAvLyB9ICAgIFxyXG4gICAgICAgIC8vICwgZmFsc2UsIHRydWUsIFwiU3BpZWx0IGVpbmVuIFNvdW5kIGFiLiBEaWUgTcO2Z2xpY2hlbiBTb3VuZHMgc2luZCBhbHMgc3RhdGlzY2hlIFZhcmlhYmxlbiBkZXIgS2xhc3NlIFNvdW5kIGhpbnRlcmxlZ3QuIFRpcHBlIGFscyBQYXJhbWV0ZXIgYWxzbyBTb3VuZCBnZWZvbGd0IHZvbiBlaW5lbSBQdW5rdCBlaW4sIHVtIGVpbmUgQXVzd2FobCB6dSBzZWhlbiFcIikpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiY3VycmVudFRpbWVNaWxsaXNcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBpbnRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBEYXRlLm5vdygpICsgdGhpcy5kZWx0YVRpbWVNaWxsaXM7XHJcbiAgICAgICAgfSAgICBcclxuICAgICAgICAsIGZhbHNlLCB0cnVlLCBcIkdpYnQgZGllIEFuemFobCBkZXIgTWlsbGlzZWt1bmRlbiwgZGllIHNlaXQgZGVtIDAxLjAxLjE5NzAgMDA6MDA6MDAgVVRDIHZlcmdhbmdlbiBzaW5kLCB6dXLDvGNrLlwiKSk7XHJcblxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEtleUxpc3RlbmVyIGV4dGVuZHMgSW50ZXJmYWNlIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihtb2R1bGU6IE1vZHVsZSkge1xyXG4gICAgICAgIHN1cGVyKFwiS2V5TGlzdGVuZXJcIiwgbW9kdWxlLCBcIkludGVyZmFjZSBtaXQgTWV0aG9kZSBvbktleVR5cGVkLiBFaW5lIEtsYXNzZSwgZGllIGRpZXNlcyBJbnRlcmZhY2UgaW1wbGVtZW50aWVydCwga2FubiBhdWYgVGFzdGF0dXJlaW5nYWJlbiByZWFnaWVyZW4uIEVpbiBPYmpla3QgZGllc2VyIEtsYXNzZSBtdXNzIHp1dm9yIGFiZXIgbWl0IFN5c3RlbS5hZGRLZXlMaXN0ZW5lcigpIHJlZ2lzdHJpZXJ0IHdlcmRlbi5cIik7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJvbktleVR5cGVkXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImtleVwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgbnVsbCwgIC8vIG5vIGltcGxlbWVudGF0aW9uIVxyXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiV2lyZCBhdWZnZXJ1ZmVuLCBuYWNoZGVtIGVpbmUgVGFzdGUgZ2VkcsO8Y2t0IHd1cmRlLlwiKSk7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFByaW50U3RyZWFtQ2xhc3MgZXh0ZW5kcyBLbGFzcyB7XHJcblxyXG4gICAgY29uc3RydWN0b3IobW9kdWxlOiBNb2R1bGUpIHtcclxuICAgICAgICBzdXBlcihcIlByaW50U3RyZWFtXCIsIG1vZHVsZSwgXCJJbnRlcm5lIEhpbGZza2xhc3NlLCB1bSBTeXN0ZW0ub3V0LnByaW50bG4genUgZXJtw7ZnbGljaGVuLiBEYXMgT2JqZWt0IFN5c3RlbS5vdXQgaXN0IHZvbiBkZXIgS2xhc3NlIFByaW50U3RyZWFtLlwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5zZXRCYXNlQ2xhc3MoPEtsYXNzPm1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIk9iamVjdFwiKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJwcmludFwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJ0ZXh0XCIsIHR5cGU6IHN0cmluZ1ByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIG51bGwsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnByaW50TWFuYWdlci5wcmludChwYXJhbWV0ZXJzWzFdLnZhbHVlKTtcclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsIFwiR2lidCBkZW4gVGV4dCBhdXMuXCIpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcInByaW50bG5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwidGV4dFwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKS5wcmludE1hbmFnZXIucHJpbnRsbihwYXJhbWV0ZXJzWzFdLnZhbHVlKTtcclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsIFwiR2lidCBkZW4gVGV4dCBhdXMsIGdlZm9sZ3Qgdm9uIGVpbmVtIFplaWxlbnNwcnVuZy5cIikpO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG59Il19