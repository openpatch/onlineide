import { makeDiv } from "../../tools/HtmlTools.js";
import { ajax } from "../../communication/AjaxHelper.js";
export class RepositoryCreateManager {
    constructor(main) {
        this.main = main;
        this.guiReady = false;
        this.publishedToItems = [
            { value: "0", object: 0, caption: "Keine Veröffentlichung (privates Repository)" },
            { value: "1", object: 1, caption: "Veröffentlicht für alls Schüler/innen der Klasse" },
            { value: "2", object: 2, caption: "Veröffentlicht für alls Schüler/innen der Schule" },
        ];
        this.repositoryOwnerItems = [];
        this.users = [];
    }
    initGUI() {
        this.guiReady = true;
        let that = this;
        let $updateDiv = jQuery('#updateRepo-div');
        $updateDiv.append(this.$mainHeading = makeDiv("updateRepo-mainHeading"));
        $updateDiv.append(this.$settingsDiv = makeDiv("updateRepo-settingsDiv"));
        this.$settingsDiv.append(jQuery('<div class="updateRepo-settingsLabel">Name des Repositorys:</div>'));
        this.$settingsDiv.append(this.$repoName = jQuery('<input type="text" class="updateRepo-inputcolumn"></input>'));
        this.$settingsDiv.append(jQuery('<div class="updateRepo-settingsLabel">Beschreibung:</div>'));
        this.$settingsDiv.append(this.$repoDescription = jQuery('<textarea class="updateRepo-inputcolumn" style="min-height: 4em"></textarea>'));
        this.$settingsDiv.append(jQuery('<div class="updateRepo-settingsLabel">Veröffentlicht für:</div>'));
        this.$settingsDiv.append(this.$repoPublishedTo = jQuery('<select class="updateRepo-inputcolumn"></select>'));
        this.setItems(this.$repoPublishedTo, this.publishedToItems);
        this.$settingsDiv.append(jQuery('<div class="updateRepo-settingsLabel">Eigentümer:</div>'));
        this.$settingsDiv.append(this.$repoOwner = jQuery('<select class="updateRepo-inputcolumn"></select>'));
        $updateDiv.append(this.$userlistDiv = makeDiv("updateRepo-userlistDiv"));
        this.$userlistDiv.append(makeDiv(null, "updateRepo-userlistheading", "Benutzer, die das Repository nutzen", { "grid-column": 1, "position": "sticky", "top": 0 }));
        this.$userlistDiv.append(makeDiv(null, "updateRepo-userlistheading", "Schreibberechtigung", { "grid-column": 2, "position": "sticky", "top": 0 }));
        let $buttonDiv = makeDiv("updateRepo-buttonDiv");
        $buttonDiv.append(this.$saveUpdateButton = makeDiv("", "jo_synchro_button", "Änderungen speichern", { "background-color": "var(--updateButtonBackground)", "color": "var(--updateButtonColor)" }));
        this.$saveUpdateButton.on("click", () => { that.saveButtonClicked(); });
        $buttonDiv.append(this.$createButton = makeDiv("", "jo_synchro_button", "Repository erstellen", { "background-color": "var(--createButtonBackground)", "color": "var(--createButtonColor)" }));
        this.$createButton.on("click", () => { that.createButtonClicked(); });
        $buttonDiv.append(this.$cancelButton = makeDiv("", "jo_synchro_button", "Abbrechen", { "background-color": "var(--cancelButtonBackground)", "color": "var(--cancelButtonColor)" }));
        this.$cancelButton.on("click", () => { that.cancelButtonClicked(); });
        $updateDiv.append($buttonDiv);
    }
    setItems($selectElement, items) {
        items.forEach(item => {
            let element = jQuery(`<option value=${item.value}>${item.caption}</option>`);
            $selectElement.append(element);
            element.data('object', item.object);
        });
        $selectElement.data('items', items);
    }
    show(mode, workspace, repository_id) {
        this.workspace = workspace;
        if (!this.guiReady) {
            this.initGUI();
        }
        let $synchroDiv = jQuery('#updateRepo-div');
        $synchroDiv.css('visibility', 'visible');
        let $mainDiv = jQuery('#main');
        $mainDiv.css('visibility', 'hidden');
        if (mode == "create") {
            this.initCreateMode(workspace);
        }
        else {
            this.initUpdateMode(repository_id);
        }
    }
    initUpdateMode(repository_id) {
        let user = this.main.user;
        this.$mainHeading.text("Bitte warten...");
        this.$createButton.hide();
        this.$saveUpdateButton.show();
        let grq = { repository_id: repository_id, workspace_id: null };
        let that = this;
        ajax('getRepository', grq, (response) => {
            let repository = response.repository;
            that.$repoName.val(repository.name);
            that.$repoDescription.val(repository.description);
            that.$repoPublishedTo.val("" + repository.published_to);
            that.$mainHeading.text(`Eigenschaften des Repositorys "${repository.name}" bearbeiten:`);
            let grlq = {
                repository_id: repository_id
            };
            ajax('getRepositoryUserList', grlq, (response) => {
                that.users = response.repositoryUserList;
                that.$userlistDiv.find('div').not('.updateRepo-userlistheading').remove();
                response.repositoryUserList.forEach(userData => {
                    let $userDiv = makeDiv("", "updateRepo-userDiv", `${userData.firstName} ${userData.lastName} (${userData.username})`, { 'grid-column': 1 });
                    let $canWriteDiv = makeDiv("", "canWriteDiv", "", { 'grid-column': 2 });
                    let $canWriteCheckBox = jQuery('<input type="checkbox">');
                    $canWriteDiv.append($canWriteCheckBox);
                    //@ts-ignore
                    $canWriteCheckBox.attr('checked', userData.canWrite);
                    $canWriteCheckBox.data('user', userData);
                    that.$userlistDiv.append($userDiv, $canWriteDiv);
                });
                that.$repoOwner.empty();
                that.setItems(that.$repoOwner, response.repositoryUserList.map(userData => {
                    let se = {
                        caption: `${userData.firstName} ${userData.lastName} (${userData.username})`,
                        object: userData,
                        value: userData.user_id + ""
                    };
                    return se;
                }));
            });
        });
    }
    initCreateMode(workspace) {
        let user = this.main.user;
        let userInfo = {
            firstName: user.rufname,
            lastName: user.familienname,
            username: user.username,
            user_id: user.id,
            canWrite: true,
            klasse: ""
        };
        this.$mainHeading.text(`Repository anlegen und mit Workspace "${workspace.name}" verknüpfen:`);
        this.$createButton.show();
        this.$saveUpdateButton.hide();
        this.repositoryOwnerItems = [{
                caption: user.rufname + " " + user.familienname + " (" + user.username + ")",
                object: userInfo,
                value: "0"
            }];
        this.setItems(this.$repoOwner, this.repositoryOwnerItems);
        this.$repoName.val(workspace.name);
        this.$userlistDiv.append(makeDiv("", "updateRepo-tutorial", `Sobald das Repository angelegt ist, 
        können die anderen Schüler/innen Deiner Klasse/Schule es finden und über Repoitory->Checkout mit ihren Workspaces verbinden. 
        Sie werden dann in dieser Liste erscheinen.`, { "grid-column": "1 / span 2", "align-self": "start", "padding-left": "10px" }));
    }
    hide() {
        let $synchroDiv = jQuery('#updateRepo-div');
        $synchroDiv.css('visibility', 'hidden');
        let $mainDiv = jQuery('#main');
        $mainDiv.css('visibility', 'visible');
    }
    saveButtonClicked() {
    }
    createButtonClicked() {
        let publishedTo = this.getSelectedObject(this.$repoPublishedTo);
        let repoName = this.$repoName.val();
        let repoDescription = this.$repoDescription.val();
        this.main.networkManager.sendCreateRepository(this.workspace, publishedTo, repoName, repoDescription, (error, repository_id) => {
            if (error == null) {
                let projectExplorer = this.main.projectExplorer;
                let element = projectExplorer.workspaceListPanel.findElement(this.workspace);
                projectExplorer.workspaceListPanel.setElementClass(element, "repository");
                this.workspace.renderSynchronizeButton();
                projectExplorer.showRepositoryButtonIfNeeded(this.workspace);
                this.hide();
            }
            else {
                alert(error);
            }
        });
    }
    cancelButtonClicked() {
        this.hide();
    }
    getSelectedObject($selectDiv) {
        var _a;
        let items = $selectDiv.data('items');
        let selectedValue = $selectDiv.val();
        return (_a = items.find(item => item.value == selectedValue)) === null || _a === void 0 ? void 0 : _a.object;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVwb3NpdG9yeUNyZWF0ZU1hbmFnZXIgY29weS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvcmVwb3NpdG9yeS91cGRhdGUvUmVwb3NpdG9yeUNyZWF0ZU1hbmFnZXIgY29weS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFbkQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBV3pELE1BQU0sT0FBTyx1QkFBdUI7SUErQmhDLFlBQW1CLElBQVU7UUFBVixTQUFJLEdBQUosSUFBSSxDQUFNO1FBN0I3QixhQUFRLEdBQVksS0FBSyxDQUFDO1FBaUIxQixxQkFBZ0IsR0FBaUI7WUFDN0IsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLDhDQUE4QyxFQUFFO1lBQ2xGLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxrREFBa0QsRUFBRTtZQUN0RixFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsa0RBQWtELEVBQUU7U0FDekYsQ0FBQztRQUVGLHlCQUFvQixHQUFpQixFQUFFLENBQUM7UUFFeEMsVUFBSyxHQUFxQixFQUFFLENBQUM7SUFLN0IsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFM0MsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLENBQUM7UUFFekUsVUFBVSxDQUFDLE1BQU0sQ0FB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QUFFLENBQUMsS0FBYSxFQUFFLGFBQXNCLEVBQUUsRUFBRTtZQUM1SSxJQUFJLEtBQUssSUFBSSxJQUFJLEVBQUU7Z0JBQ2YsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7Z0JBQ2hELElBQUksT0FBTyxHQUFHLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUM3RSxlQUFlLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDMUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO2dCQUN6QyxlQUFlLENBQUMsNEJBQTRCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUM3RCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDZjtpQkFBTTtnQkFDSCxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDaEI7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUdQLENBQUM7SUFFRCxtQkFBbUI7UUFDZixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELGlCQUFpQixDQUFDLFVBQXFDOztRQUVuRCxJQUFJLEtBQUssR0FBaUIsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVuRCxJQUFJLGFBQWEsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFckMsYUFBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxhQUFhLENBQUMsMENBQUUsTUFBTSxDQUFDO0lBRW5FLENBQUM7Q0FJSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1haW4gfSBmcm9tIFwiLi4vLi4vbWFpbi9NYWluLmpzXCI7XHJcbmltcG9ydCB7IFdvcmtzcGFjZSB9IGZyb20gXCIuLi8uLi93b3Jrc3BhY2UvV29ya3NwYWNlLmpzXCI7XHJcbmltcG9ydCB7IG1ha2VEaXYgfSBmcm9tIFwiLi4vLi4vdG9vbHMvSHRtbFRvb2xzLmpzXCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnlVc2VyLCBHZXRSZXBvc2l0b3J5UmVxdWVzdCwgR2V0UmVwb3NpdG9yeVJlc3BvbnNlLCBHZXRSZXBvc2l0b3J5VXNlckxpc3RSZXF1ZXN0LCBHZXRSZXBvc2l0b3J5VXNlckxpc3RSZXNwb25zZSwgVXNlckRhdGEgfSBmcm9tIFwiLi4vLi4vY29tbXVuaWNhdGlvbi9EYXRhLmpzXCI7XHJcbmltcG9ydCB7IGFqYXggfSBmcm9tIFwiLi4vLi4vY29tbXVuaWNhdGlvbi9BamF4SGVscGVyLmpzXCI7XHJcbmltcG9ydCB7IFRlYWNoZXJzV2l0aENsYXNzZXNNSSB9IGZyb20gXCIuLi8uLi9hZG1pbmlzdHJhdGlvbi9UZWFjaGVyc1dpdGhDbGFzc2VzLmpzXCI7XHJcblxyXG5cclxuZXhwb3J0IHR5cGUgUmVwb3NpdG9yeVVwZGF0ZU1vZGUgPSBcInVwZGF0ZVwiIHwgXCJjcmVhdGVcIjtcclxudHlwZSBTZWxlY3RJdGVtID0ge1xyXG4gICAgdmFsdWU6IHN0cmluZyxcclxuICAgIG9iamVjdDogYW55LFxyXG4gICAgY2FwdGlvbjogc3RyaW5nXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBSZXBvc2l0b3J5Q3JlYXRlTWFuYWdlciB7XHJcblxyXG4gICAgZ3VpUmVhZHk6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAkbWFpbkhlYWRpbmc6IEpRdWVyeTxIVE1MRGl2RWxlbWVudD47XHJcbiAgICAkc2V0dGluZ3NEaXY6IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgJHJlcG9OYW1lOiBKUXVlcnk8SFRNTElucHV0RWxlbWVudD47XHJcbiAgICAkcmVwb0Rlc2NyaXB0aW9uOiBKUXVlcnk8SFRNTFRleHRBcmVhRWxlbWVudD47XHJcbiAgICAkcmVwb1B1Ymxpc2hlZFRvOiBKUXVlcnk8SFRNTFNlbGVjdEVsZW1lbnQ+O1xyXG4gICAgJHJlcG9Pd25lcjogSlF1ZXJ5PEhUTUxTZWxlY3RFbGVtZW50PjtcclxuXHJcbiAgICAkdXNlcmxpc3REaXY6IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgJGNhbmNlbEJ1dHRvbjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuICAgICRzYXZlVXBkYXRlQnV0dG9uOiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG4gICAgJGNyZWF0ZUJ1dHRvbjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuXHJcblxyXG4gICAgcHVibGlzaGVkVG9JdGVtczogU2VsZWN0SXRlbVtdID0gW1xyXG4gICAgICAgIHsgdmFsdWU6IFwiMFwiLCBvYmplY3Q6IDAsIGNhcHRpb246IFwiS2VpbmUgVmVyw7ZmZmVudGxpY2h1bmcgKHByaXZhdGVzIFJlcG9zaXRvcnkpXCIgfSxcclxuICAgICAgICB7IHZhbHVlOiBcIjFcIiwgb2JqZWN0OiAxLCBjYXB0aW9uOiBcIlZlcsO2ZmZlbnRsaWNodCBmw7xyIGFsbHMgU2Now7xsZXIvaW5uZW4gZGVyIEtsYXNzZVwiIH0sXHJcbiAgICAgICAgeyB2YWx1ZTogXCIyXCIsIG9iamVjdDogMiwgY2FwdGlvbjogXCJWZXLDtmZmZW50bGljaHQgZsO8ciBhbGxzIFNjaMO8bGVyL2lubmVuIGRlciBTY2h1bGVcIiB9LFxyXG4gICAgXTtcclxuXHJcbiAgICByZXBvc2l0b3J5T3duZXJJdGVtczogU2VsZWN0SXRlbVtdID0gW107XHJcblxyXG4gICAgdXNlcnM6IFJlcG9zaXRvcnlVc2VyW10gPSBbXTtcclxuXHJcbiAgICB3b3Jrc3BhY2U6IFdvcmtzcGFjZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgbWFpbjogTWFpbikge1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRHVUkoKSB7XHJcbiAgICAgICAgdGhpcy5ndWlSZWFkeSA9IHRydWU7XHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGxldCAkdXBkYXRlRGl2ID0galF1ZXJ5KCcjdXBkYXRlUmVwby1kaXYnKTtcclxuXHJcbiAgICAgICAgJHVwZGF0ZURpdi5hcHBlbmQodGhpcy4kbWFpbkhlYWRpbmcgPSBtYWtlRGl2KFwidXBkYXRlUmVwby1tYWluSGVhZGluZ1wiKSk7XHJcblxyXG4gICAgICAgICR1cGRhdGVEaXYuYXBwZW5kKHRoaXMuJHNldHRpbmdzRGl2ID0gbWFrZURpdihcInVwZGF0ZVJlcG8tc2V0dGluZ3NEaXZcIikpO1xyXG5cclxuICAgICAgICB0aGlzLiRzZXR0aW5nc0Rpdi5hcHBlbmQoalF1ZXJ5KCc8ZGl2IGNsYXNzPVwidXBkYXRlUmVwby1zZXR0aW5nc0xhYmVsXCI+TmFtZSBkZXMgUmVwb3NpdG9yeXM6PC9kaXY+JykpO1xyXG4gICAgICAgIHRoaXMuJHNldHRpbmdzRGl2LmFwcGVuZCh0aGlzLiRyZXBvTmFtZSA9IGpRdWVyeSgnPGlucHV0IHR5cGU9XCJ0ZXh0XCIgY2xhc3M9XCJ1cGRhdGVSZXBvLWlucHV0Y29sdW1uXCI+PC9pbnB1dD4nKSk7XHJcblxyXG4gICAgICAgIHRoaXMuJHNldHRpbmdzRGl2LmFwcGVuZChqUXVlcnkoJzxkaXYgY2xhc3M9XCJ1cGRhdGVSZXBvLXNldHRpbmdzTGFiZWxcIj5CZXNjaHJlaWJ1bmc6PC9kaXY+JykpO1xyXG4gICAgICAgIHRoaXMuJHNldHRpbmdzRGl2LmFwcGVuZCh0aGlzLiRyZXBvRGVzY3JpcHRpb24gPSBqUXVlcnkoJzx0ZXh0YXJlYSBjbGFzcz1cInVwZGF0ZVJlcG8taW5wdXRjb2x1bW5cIiBzdHlsZT1cIm1pbi1oZWlnaHQ6IDRlbVwiPjwvdGV4dGFyZWE+JykpO1xyXG5cclxuICAgICAgICB0aGlzLiRzZXR0aW5nc0Rpdi5hcHBlbmQoalF1ZXJ5KCc8ZGl2IGNsYXNzPVwidXBkYXRlUmVwby1zZXR0aW5nc0xhYmVsXCI+VmVyw7ZmZmVudGxpY2h0IGbDvHI6PC9kaXY+JykpO1xyXG4gICAgICAgIHRoaXMuJHNldHRpbmdzRGl2LmFwcGVuZCh0aGlzLiRyZXBvUHVibGlzaGVkVG8gPSBqUXVlcnkoJzxzZWxlY3QgY2xhc3M9XCJ1cGRhdGVSZXBvLWlucHV0Y29sdW1uXCI+PC9zZWxlY3Q+JykpO1xyXG4gICAgICAgIHRoaXMuc2V0SXRlbXModGhpcy4kcmVwb1B1Ymxpc2hlZFRvLCB0aGlzLnB1Ymxpc2hlZFRvSXRlbXMpO1xyXG5cclxuICAgICAgICB0aGlzLiRzZXR0aW5nc0Rpdi5hcHBlbmQoalF1ZXJ5KCc8ZGl2IGNsYXNzPVwidXBkYXRlUmVwby1zZXR0aW5nc0xhYmVsXCI+RWlnZW50w7xtZXI6PC9kaXY+JykpO1xyXG4gICAgICAgIHRoaXMuJHNldHRpbmdzRGl2LmFwcGVuZCh0aGlzLiRyZXBvT3duZXIgPSBqUXVlcnkoJzxzZWxlY3QgY2xhc3M9XCJ1cGRhdGVSZXBvLWlucHV0Y29sdW1uXCI+PC9zZWxlY3Q+JykpO1xyXG5cclxuICAgICAgICAkdXBkYXRlRGl2LmFwcGVuZCh0aGlzLiR1c2VybGlzdERpdiA9IG1ha2VEaXYoXCJ1cGRhdGVSZXBvLXVzZXJsaXN0RGl2XCIpKTtcclxuXHJcbiAgICAgICAgdGhpcy4kdXNlcmxpc3REaXYuYXBwZW5kKG1ha2VEaXYobnVsbCwgXCJ1cGRhdGVSZXBvLXVzZXJsaXN0aGVhZGluZ1wiLCBcIkJlbnV0emVyLCBkaWUgZGFzIFJlcG9zaXRvcnkgbnV0emVuXCIsIHsgXCJncmlkLWNvbHVtblwiOiAxLCBcInBvc2l0aW9uXCI6IFwic3RpY2t5XCIsIFwidG9wXCI6IDAgfSkpXHJcbiAgICAgICAgdGhpcy4kdXNlcmxpc3REaXYuYXBwZW5kKG1ha2VEaXYobnVsbCwgXCJ1cGRhdGVSZXBvLXVzZXJsaXN0aGVhZGluZ1wiLCBcIlNjaHJlaWJiZXJlY2h0aWd1bmdcIiwgeyBcImdyaWQtY29sdW1uXCI6IDIsIFwicG9zaXRpb25cIjogXCJzdGlja3lcIiwgXCJ0b3BcIjogMCB9KSlcclxuXHJcbiAgICAgICAgbGV0ICRidXR0b25EaXYgPSBtYWtlRGl2KFwidXBkYXRlUmVwby1idXR0b25EaXZcIik7XHJcblxyXG5cclxuICAgICAgICAkYnV0dG9uRGl2LmFwcGVuZCh0aGlzLiRzYXZlVXBkYXRlQnV0dG9uID0gbWFrZURpdihcIlwiLCBcImpvX3N5bmNocm9fYnV0dG9uXCIsIFwiw4RuZGVydW5nZW4gc3BlaWNoZXJuXCIsIHsgXCJiYWNrZ3JvdW5kLWNvbG9yXCI6IFwidmFyKC0tdXBkYXRlQnV0dG9uQmFja2dyb3VuZClcIiwgXCJjb2xvclwiOiBcInZhcigtLXVwZGF0ZUJ1dHRvbkNvbG9yKVwiIH0pKTtcclxuICAgICAgICB0aGlzLiRzYXZlVXBkYXRlQnV0dG9uLm9uKFwiY2xpY2tcIiwgKCkgPT4geyB0aGF0LnNhdmVCdXR0b25DbGlja2VkKCkgfSlcclxuXHJcbiAgICAgICAgJGJ1dHRvbkRpdi5hcHBlbmQodGhpcy4kY3JlYXRlQnV0dG9uID0gbWFrZURpdihcIlwiLCBcImpvX3N5bmNocm9fYnV0dG9uXCIsIFwiUmVwb3NpdG9yeSBlcnN0ZWxsZW5cIiwgeyBcImJhY2tncm91bmQtY29sb3JcIjogXCJ2YXIoLS1jcmVhdGVCdXR0b25CYWNrZ3JvdW5kKVwiLCBcImNvbG9yXCI6IFwidmFyKC0tY3JlYXRlQnV0dG9uQ29sb3IpXCIgfSkpO1xyXG4gICAgICAgIHRoaXMuJGNyZWF0ZUJ1dHRvbi5vbihcImNsaWNrXCIsICgpID0+IHsgdGhhdC5jcmVhdGVCdXR0b25DbGlja2VkKCkgfSlcclxuXHJcbiAgICAgICAgJGJ1dHRvbkRpdi5hcHBlbmQodGhpcy4kY2FuY2VsQnV0dG9uID0gbWFrZURpdihcIlwiLCBcImpvX3N5bmNocm9fYnV0dG9uXCIsIFwiQWJicmVjaGVuXCIsIHsgXCJiYWNrZ3JvdW5kLWNvbG9yXCI6IFwidmFyKC0tY2FuY2VsQnV0dG9uQmFja2dyb3VuZClcIiwgXCJjb2xvclwiOiBcInZhcigtLWNhbmNlbEJ1dHRvbkNvbG9yKVwiIH0pKTtcclxuICAgICAgICB0aGlzLiRjYW5jZWxCdXR0b24ub24oXCJjbGlja1wiLCAoKSA9PiB7IHRoYXQuY2FuY2VsQnV0dG9uQ2xpY2tlZCgpIH0pXHJcblxyXG4gICAgICAgICR1cGRhdGVEaXYuYXBwZW5kKCRidXR0b25EaXYpO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2V0SXRlbXMoJHNlbGVjdEVsZW1lbnQ6IEpRdWVyeTxIVE1MU2VsZWN0RWxlbWVudD4sIGl0ZW1zOiBTZWxlY3RJdGVtW10pIHtcclxuICAgICAgICBpdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBsZXQgZWxlbWVudCA9IGpRdWVyeShgPG9wdGlvbiB2YWx1ZT0ke2l0ZW0udmFsdWV9PiR7aXRlbS5jYXB0aW9ufTwvb3B0aW9uPmApO1xyXG4gICAgICAgICAgICAkc2VsZWN0RWxlbWVudC5hcHBlbmQoZWxlbWVudCk7XHJcbiAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnb2JqZWN0JywgaXRlbS5vYmplY3QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAkc2VsZWN0RWxlbWVudC5kYXRhKCdpdGVtcycsIGl0ZW1zKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93KG1vZGU6IFJlcG9zaXRvcnlVcGRhdGVNb2RlLCB3b3Jrc3BhY2U6IFdvcmtzcGFjZSwgcmVwb3NpdG9yeV9pZDogbnVtYmVyKSB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy53b3Jrc3BhY2UgPSB3b3Jrc3BhY2U7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5ndWlSZWFkeSkge1xyXG4gICAgICAgICAgICB0aGlzLmluaXRHVUkoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0ICRzeW5jaHJvRGl2ID0galF1ZXJ5KCcjdXBkYXRlUmVwby1kaXYnKTtcclxuICAgICAgICAkc3luY2hyb0Rpdi5jc3MoJ3Zpc2liaWxpdHknLCAndmlzaWJsZScpO1xyXG4gICAgICAgIGxldCAkbWFpbkRpdiA9IGpRdWVyeSgnI21haW4nKTtcclxuICAgICAgICAkbWFpbkRpdi5jc3MoJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XHJcblxyXG5cclxuICAgICAgICBpZiAobW9kZSA9PSBcImNyZWF0ZVwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdENyZWF0ZU1vZGUod29ya3NwYWNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmluaXRVcGRhdGVNb2RlKHJlcG9zaXRvcnlfaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpbml0VXBkYXRlTW9kZShyZXBvc2l0b3J5X2lkOiBudW1iZXIpIHtcclxuICAgICAgICBsZXQgdXNlciA9IHRoaXMubWFpbi51c2VyO1xyXG4gICAgICAgIHRoaXMuJG1haW5IZWFkaW5nLnRleHQoXCJCaXR0ZSB3YXJ0ZW4uLi5cIik7XHJcbiAgICAgICAgdGhpcy4kY3JlYXRlQnV0dG9uLmhpZGUoKTtcclxuICAgICAgICB0aGlzLiRzYXZlVXBkYXRlQnV0dG9uLnNob3coKTtcclxuXHJcbiAgICAgICAgbGV0IGdycTogR2V0UmVwb3NpdG9yeVJlcXVlc3QgPSB7cmVwb3NpdG9yeV9pZDogcmVwb3NpdG9yeV9pZCwgd29ya3NwYWNlX2lkOiBudWxsfTtcclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG5cclxuICAgICAgICBhamF4KCdnZXRSZXBvc2l0b3J5JywgZ3JxLCAocmVzcG9uc2U6IEdldFJlcG9zaXRvcnlSZXNwb25zZSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgbGV0IHJlcG9zaXRvcnkgPSByZXNwb25zZS5yZXBvc2l0b3J5O1xyXG4gICAgICAgICAgICB0aGF0LiRyZXBvTmFtZS52YWwocmVwb3NpdG9yeS5uYW1lKTtcclxuICAgICAgICAgICAgdGhhdC4kcmVwb0Rlc2NyaXB0aW9uLnZhbChyZXBvc2l0b3J5LmRlc2NyaXB0aW9uKTtcclxuICAgICAgICAgICAgdGhhdC4kcmVwb1B1Ymxpc2hlZFRvLnZhbChcIlwiICsgcmVwb3NpdG9yeS5wdWJsaXNoZWRfdG8pO1xyXG4gICAgICAgICAgICB0aGF0LiRtYWluSGVhZGluZy50ZXh0KGBFaWdlbnNjaGFmdGVuIGRlcyBSZXBvc2l0b3J5cyBcIiR7cmVwb3NpdG9yeS5uYW1lfVwiIGJlYXJiZWl0ZW46YCk7XHJcblxyXG4gICAgICAgICAgICBsZXQgZ3JscTogR2V0UmVwb3NpdG9yeVVzZXJMaXN0UmVxdWVzdCA9IHtcclxuICAgICAgICAgICAgICAgIHJlcG9zaXRvcnlfaWQ6IHJlcG9zaXRvcnlfaWRcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYWpheCgnZ2V0UmVwb3NpdG9yeVVzZXJMaXN0JywgZ3JscSwgKHJlc3BvbnNlOiBHZXRSZXBvc2l0b3J5VXNlckxpc3RSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhhdC51c2VycyA9IHJlc3BvbnNlLnJlcG9zaXRvcnlVc2VyTGlzdDtcclxuICAgICAgICAgICAgICAgIHRoYXQuJHVzZXJsaXN0RGl2LmZpbmQoJ2RpdicpLm5vdCgnLnVwZGF0ZVJlcG8tdXNlcmxpc3RoZWFkaW5nJykucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLnJlcG9zaXRvcnlVc2VyTGlzdC5mb3JFYWNoKHVzZXJEYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBsZXQgJHVzZXJEaXYgPSBtYWtlRGl2KFwiXCIsIFwidXBkYXRlUmVwby11c2VyRGl2XCIsIGAke3VzZXJEYXRhLmZpcnN0TmFtZX0gJHt1c2VyRGF0YS5sYXN0TmFtZX0gKCR7dXNlckRhdGEudXNlcm5hbWV9KWAsIHsnZ3JpZC1jb2x1bW4nOiAxfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCAkY2FuV3JpdGVEaXYgPSBtYWtlRGl2KFwiXCIsIFwiY2FuV3JpdGVEaXZcIiwgXCJcIiwgeydncmlkLWNvbHVtbic6IDJ9KTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgJGNhbldyaXRlQ2hlY2tCb3ggPSBqUXVlcnkoJzxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIj4nKTtcclxuICAgICAgICAgICAgICAgICAgICAkY2FuV3JpdGVEaXYuYXBwZW5kKCRjYW5Xcml0ZUNoZWNrQm94KTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICAkY2FuV3JpdGVDaGVja0JveC5hdHRyKCdjaGVja2VkJywgdXNlckRhdGEuY2FuV3JpdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICRjYW5Xcml0ZUNoZWNrQm94LmRhdGEoJ3VzZXInLCB1c2VyRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC4kdXNlcmxpc3REaXYuYXBwZW5kKCR1c2VyRGl2LCAkY2FuV3JpdGVEaXYpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHRoYXQuJHJlcG9Pd25lci5lbXB0eSgpO1xyXG4gICAgICAgICAgICAgICAgdGhhdC5zZXRJdGVtcyh0aGF0LiRyZXBvT3duZXIsIHJlc3BvbnNlLnJlcG9zaXRvcnlVc2VyTGlzdC5tYXAodXNlckRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzZTogU2VsZWN0SXRlbSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbjogYCR7dXNlckRhdGEuZmlyc3ROYW1lfSAke3VzZXJEYXRhLmxhc3ROYW1lfSAoJHt1c2VyRGF0YS51c2VybmFtZX0pYCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0OiB1c2VyRGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHVzZXJEYXRhLnVzZXJfaWQgKyBcIlwiXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzZTtcclxuICAgICAgICAgICAgICAgIH0pKVxyXG5cclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9KVxyXG5cclxuXHJcbn1cclxuXHJcbiAgICBpbml0Q3JlYXRlTW9kZSh3b3Jrc3BhY2U6IFdvcmtzcGFjZSkge1xyXG4gICAgICAgIGxldCB1c2VyID0gdGhpcy5tYWluLnVzZXI7XHJcblxyXG4gICAgICAgIGxldCB1c2VySW5mbzogUmVwb3NpdG9yeVVzZXIgPSB7XHJcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdXNlci5ydWZuYW1lLFxyXG4gICAgICAgICAgICBsYXN0TmFtZTogdXNlci5mYW1pbGllbm5hbWUsXHJcbiAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICB1c2VyX2lkOiB1c2VyLmlkLFxyXG4gICAgICAgICAgICBjYW5Xcml0ZTogdHJ1ZSxcclxuICAgICAgICAgICAga2xhc3NlOiBcIlwiXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLiRtYWluSGVhZGluZy50ZXh0KGBSZXBvc2l0b3J5IGFubGVnZW4gdW5kIG1pdCBXb3Jrc3BhY2UgXCIke3dvcmtzcGFjZS5uYW1lfVwiIHZlcmtuw7xwZmVuOmApO1xyXG4gICAgICAgIHRoaXMuJGNyZWF0ZUJ1dHRvbi5zaG93KCk7XHJcbiAgICAgICAgdGhpcy4kc2F2ZVVwZGF0ZUJ1dHRvbi5oaWRlKCk7XHJcbiAgICAgICAgdGhpcy5yZXBvc2l0b3J5T3duZXJJdGVtcyA9IFt7XHJcbiAgICAgICAgICAgIGNhcHRpb246IHVzZXIucnVmbmFtZSArIFwiIFwiICsgdXNlci5mYW1pbGllbm5hbWUgKyBcIiAoXCIgKyB1c2VyLnVzZXJuYW1lICsgXCIpXCIsXHJcbiAgICAgICAgICAgIG9iamVjdDogdXNlckluZm8sXHJcbiAgICAgICAgICAgIHZhbHVlOiBcIjBcIlxyXG4gICAgICAgIH1dO1xyXG5cclxuICAgICAgICB0aGlzLnNldEl0ZW1zKHRoaXMuJHJlcG9Pd25lciwgdGhpcy5yZXBvc2l0b3J5T3duZXJJdGVtcyk7XHJcbiAgICAgICAgdGhpcy4kcmVwb05hbWUudmFsKHdvcmtzcGFjZS5uYW1lKTtcclxuICAgICAgICB0aGlzLiR1c2VybGlzdERpdi5hcHBlbmQobWFrZURpdihcIlwiLCBcInVwZGF0ZVJlcG8tdHV0b3JpYWxcIiwgYFNvYmFsZCBkYXMgUmVwb3NpdG9yeSBhbmdlbGVndCBpc3QsIFxyXG4gICAgICAgIGvDtm5uZW4gZGllIGFuZGVyZW4gU2Now7xsZXIvaW5uZW4gRGVpbmVyIEtsYXNzZS9TY2h1bGUgZXMgZmluZGVuIHVuZCDDvGJlciBSZXBvaXRvcnktPkNoZWNrb3V0IG1pdCBpaHJlbiBXb3Jrc3BhY2VzIHZlcmJpbmRlbi4gXHJcbiAgICAgICAgU2llIHdlcmRlbiBkYW5uIGluIGRpZXNlciBMaXN0ZSBlcnNjaGVpbmVuLmAsIHsgXCJncmlkLWNvbHVtblwiOiBcIjEgLyBzcGFuIDJcIiwgXCJhbGlnbi1zZWxmXCI6IFwic3RhcnRcIiwgXCJwYWRkaW5nLWxlZnRcIjogXCIxMHB4XCIgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGhpZGUoKSB7XHJcbiAgICAgICAgbGV0ICRzeW5jaHJvRGl2ID0galF1ZXJ5KCcjdXBkYXRlUmVwby1kaXYnKTtcclxuICAgICAgICAkc3luY2hyb0Rpdi5jc3MoJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgbGV0ICRtYWluRGl2ID0galF1ZXJ5KCcjbWFpbicpO1xyXG4gICAgICAgICRtYWluRGl2LmNzcygndmlzaWJpbGl0eScsICd2aXNpYmxlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZUJ1dHRvbkNsaWNrZWQoKSB7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVCdXR0b25DbGlja2VkKCkge1xyXG5cclxuICAgICAgICBsZXQgcHVibGlzaGVkVG86IG51bWJlciA9IHRoaXMuZ2V0U2VsZWN0ZWRPYmplY3QodGhpcy4kcmVwb1B1Ymxpc2hlZFRvKTtcclxuICAgICAgICBsZXQgcmVwb05hbWU6IHN0cmluZyA9IDxzdHJpbmc+dGhpcy4kcmVwb05hbWUudmFsKCk7XHJcbiAgICAgICAgbGV0IHJlcG9EZXNjcmlwdGlvbjogc3RyaW5nICA9IDxzdHJpbmc+dGhpcy4kcmVwb0Rlc2NyaXB0aW9uLnZhbCgpO1xyXG5cclxuICAgICAgICB0aGlzLm1haW4ubmV0d29ya01hbmFnZXIuc2VuZENyZWF0ZVJlcG9zaXRvcnkodGhpcy53b3Jrc3BhY2UsIHB1Ymxpc2hlZFRvLCByZXBvTmFtZSwgcmVwb0Rlc2NyaXB0aW9uLCAoZXJyb3I6IHN0cmluZywgcmVwb3NpdG9yeV9pZD86IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHByb2plY3RFeHBsb3JlciA9IHRoaXMubWFpbi5wcm9qZWN0RXhwbG9yZXI7XHJcbiAgICAgICAgICAgICAgICBsZXQgZWxlbWVudCA9IHByb2plY3RFeHBsb3Jlci53b3Jrc3BhY2VMaXN0UGFuZWwuZmluZEVsZW1lbnQodGhpcy53b3Jrc3BhY2UpO1xyXG4gICAgICAgICAgICAgICAgcHJvamVjdEV4cGxvcmVyLndvcmtzcGFjZUxpc3RQYW5lbC5zZXRFbGVtZW50Q2xhc3MoZWxlbWVudCwgXCJyZXBvc2l0b3J5XCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy53b3Jrc3BhY2UucmVuZGVyU3luY2hyb25pemVCdXR0b24oKTtcclxuICAgICAgICAgICAgICAgIHByb2plY3RFeHBsb3Jlci5zaG93UmVwb3NpdG9yeUJ1dHRvbklmTmVlZGVkKHRoaXMud29ya3NwYWNlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWxlcnQoZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBjYW5jZWxCdXR0b25DbGlja2VkKCkge1xyXG4gICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdGVkT2JqZWN0KCRzZWxlY3REaXY6IEpRdWVyeTxIVE1MU2VsZWN0RWxlbWVudD4pe1xyXG5cclxuICAgICAgICBsZXQgaXRlbXM6IFNlbGVjdEl0ZW1bXSA9ICRzZWxlY3REaXYuZGF0YSgnaXRlbXMnKTtcclxuXHJcbiAgICAgICAgbGV0IHNlbGVjdGVkVmFsdWUgPSAkc2VsZWN0RGl2LnZhbCgpO1xyXG5cclxuICAgICAgICByZXR1cm4gaXRlbXMuZmluZChpdGVtID0+IGl0ZW0udmFsdWUgPT0gc2VsZWN0ZWRWYWx1ZSk/Lm9iamVjdDtcclxuXHJcbiAgICB9XHJcblxyXG5cclxuXHJcbn0iXX0=