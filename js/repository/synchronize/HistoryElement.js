import { makeDiv, openContextMenu } from "../../tools/HtmlTools.js";
import { SynchroWorkspace } from "./SynchroWorkspace.js";
export class HistoryElement {
    constructor(manager, repository, repositoryHistoryEntry, historyEntryIndex) {
        this.manager = manager;
        this.repository = repository;
        this.repositoryHistoryEntry = repositoryHistoryEntry;
        this.historyEntryIndex = historyEntryIndex;
        this.$historyElementDiv = makeDiv(null, "jo_synchro_historyElement");
        this.$historyElementDiv.attr("draggable", "true");
        let that = this;
        this.$historyElementDiv.on('drag', () => {
            HistoryElement.currentlyDragged = that;
        });
        let line1 = makeDiv(null, "jo_synchro_historyElementLine1");
        line1.append(jQuery(`<div class="jo_synchro_he_version">V ${repositoryHistoryEntry.version}</div>`));
        line1.append(jQuery(`<div class="jo_synchro_he_name">${repositoryHistoryEntry.name}</div>`));
        this.$historyElementDiv.append(line1);
        let line2 = makeDiv(null, "jo_synchro_historyElementLine2");
        line2.append(jQuery(`<div class="jo_synchro_he_timestamp">${repositoryHistoryEntry.timestamp}</div>`));
        this.$historyElementDiv.append(line2);
        let line3 = makeDiv(null, "jo_synchro_historyElementLine3");
        line3.append(jQuery(`<div class="jo_synchro_he_comment">${repositoryHistoryEntry.comment}</div>`));
        this.$historyElementDiv.append(line3);
        manager.$historyScrollDiv.prepend(this.$historyElementDiv);
        this.$historyElementDiv.on("click contextmenu", (ev) => {
            ev.preventDefault();
            openContextMenu([
                {
                    caption: "Auf der linken Seite darstellen",
                    callback: () => {
                        let sw = new SynchroWorkspace(this.manager).copyFromHistoryElement(this);
                        this.manager.leftSynchroWorkspace = sw;
                        this.manager.setupSynchronizationListElements();
                    }
                },
                {
                    caption: "Auf der rechten Seite darstellen",
                    callback: () => {
                        let sw = new SynchroWorkspace(this.manager).copyFromHistoryElement(this);
                        this.manager.rightSynchroWorkspace = sw;
                        this.manager.setupSynchronizationListElements();
                    }
                },
            ], ev.pageX + 2, ev.pageY + 2);
        });
    }
    getRepositoryState() {
        let entries = this.repository.historyEntries;
        // get last intermediate state
        let startIndex = this.historyEntryIndex;
        while (startIndex > 0 && !(entries[startIndex].isIntermediateEntry)) {
            startIndex--;
        }
        let files = [];
        for (let index = startIndex; index <= this.historyEntryIndex; index++) {
            let entry = entries[index];
            for (let fileEntry of entry.historyFiles) {
                if (entry.isIntermediateEntry) {
                    this.setIntermediateState(fileEntry, files);
                }
                else {
                    switch (fileEntry.type) {
                        case "create":
                            this.createFile(fileEntry, files);
                            break;
                        case "delete":
                            this.deleteFile(fileEntry, files);
                            break;
                        case "change":
                            this.changeFile(fileEntry, files);
                            break;
                        case "intermediate":
                            this.setIntermediateState(fileEntry, files);
                            break;
                    }
                }
            }
        }
        let repository = Object.assign({}, this.repository);
        repository.fileEntries = files;
        repository.version = this.repositoryHistoryEntry.version;
        return repository;
    }
    setIntermediateState(fileEntry, files) {
        let file = files.find(file => file.id == fileEntry.id);
        if (file != null) {
            file.text = fileEntry.content;
            file.version = fileEntry.version;
        }
    }
    changeFile(fileEntry, files) {
        let file = files.find(file => file.id == fileEntry.id);
        if (file != null) {
            if (fileEntry.content != null) {
                //@ts-ignore
                let patch = JSON.parse(fileEntry.content);
                let oldText = file.text;
                //@ts-ignore
                let dmp = new diff_match_patch();
                let newText = dmp.patch_apply(patch, oldText);
                file.text = newText[0];
                file.version = fileEntry.version;
            }
        }
    }
    deleteFile(fileEntry, files) {
        let index = files.findIndex(file => file.id == fileEntry.id);
        if (index != null) {
            files.splice(index, 1);
        }
    }
    createFile(fileEntry, files) {
        let file = {
            id: fileEntry.id,
            text: fileEntry.content,
            filename: fileEntry.filename,
            version: fileEntry.version
        };
        files.push(file);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSGlzdG9yeUVsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L3JlcG9zaXRvcnkvc3luY2hyb25pemUvSGlzdG9yeUVsZW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUV6RCxNQUFNLE9BQU8sY0FBYztJQU12QixZQUFvQixPQUErQixFQUFVLFVBQXNCLEVBQVUsc0JBQThDLEVBQVUsaUJBQXlCO1FBQTFKLFlBQU8sR0FBUCxPQUFPLENBQXdCO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUFVLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFBVSxzQkFBaUIsR0FBakIsaUJBQWlCLENBQVE7UUFFMUssSUFBSSxDQUFDLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsMkJBQTJCLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUVsRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFO1lBQ3BDLGNBQWMsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLGdDQUFnQyxDQUFDLENBQUM7UUFDNUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsd0NBQXdDLHNCQUFzQixDQUFDLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNyRyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxtQ0FBbUMsc0JB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U0FBUyxDQUFDLFFBQVE7WUFDNUIsT0FBTyxFQUFFLFNBQVMsQ0FBQyxPQUFPO1NBQzdCLENBQUE7UUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JCLENBQUM7Q0FLSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcG9zaXRvcnlIaXN0b3J5RW50cnksIFJlcG9zaXRvcnksIFJlcG9zaXRvcnlIaXN0b3J5RmlsZUVudHJ5LCBSZXBvc2l0b3J5RmlsZUVudHJ5IH0gZnJvbSBcIi4uLy4uL2NvbW11bmljYXRpb24vRGF0YS5qc1wiO1xyXG5pbXBvcnQgeyBTeW5jaHJvbml6YXRpb25NYW5hZ2VyIH0gZnJvbSBcIi4vUmVwb3NpdG9yeVN5bmNocm9uaXphdGlvbk1hbmFnZXIuanNcIjtcclxuaW1wb3J0IHsgbWFrZURpdiwgb3BlbkNvbnRleHRNZW51IH0gZnJvbSBcIi4uLy4uL3Rvb2xzL0h0bWxUb29scy5qc1wiO1xyXG5pbXBvcnQgeyBTeW5jaHJvV29ya3NwYWNlIH0gZnJvbSBcIi4vU3luY2hyb1dvcmtzcGFjZS5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEhpc3RvcnlFbGVtZW50IHtcclxuXHJcbiAgICAkaGlzdG9yeUVsZW1lbnREaXY6IEpRdWVyeTxIVE1MRGl2RWxlbWVudD47XHJcblxyXG4gICAgc3RhdGljIGN1cnJlbnRseURyYWdnZWQ6IEhpc3RvcnlFbGVtZW50O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFuYWdlcjogU3luY2hyb25pemF0aW9uTWFuYWdlciwgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5LCBwcml2YXRlIHJlcG9zaXRvcnlIaXN0b3J5RW50cnk6IFJlcG9zaXRvcnlIaXN0b3J5RW50cnksIHByaXZhdGUgaGlzdG9yeUVudHJ5SW5kZXg6IG51bWJlcikge1xyXG5cclxuICAgICAgICB0aGlzLiRoaXN0b3J5RWxlbWVudERpdiA9IG1ha2VEaXYobnVsbCwgXCJqb19zeW5jaHJvX2hpc3RvcnlFbGVtZW50XCIpO1xyXG4gICAgICAgIHRoaXMuJGhpc3RvcnlFbGVtZW50RGl2LmF0dHIoXCJkcmFnZ2FibGVcIiwgXCJ0cnVlXCIpO1xyXG5cclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy4kaGlzdG9yeUVsZW1lbnREaXYub24oJ2RyYWcnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIEhpc3RvcnlFbGVtZW50LmN1cnJlbnRseURyYWdnZWQgPSB0aGF0O1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgbGluZTEgPSBtYWtlRGl2KG51bGwsIFwiam9fc3luY2hyb19oaXN0b3J5RWxlbWVudExpbmUxXCIpO1xyXG4gICAgICAgIGxpbmUxLmFwcGVuZChqUXVlcnkoYDxkaXYgY2xhc3M9XCJqb19zeW5jaHJvX2hlX3ZlcnNpb25cIj5WICR7cmVwb3NpdG9yeUhpc3RvcnlFbnRyeS52ZXJzaW9ufTwvZGl2PmApKTtcclxuICAgICAgICBsaW5lMS5hcHBlbmQoalF1ZXJ5KGA8ZGl2IGNsYXNzPVwiam9fc3luY2hyb19oZV9uYW1lXCI+JHtyZXBvc2l0b3J5SGlzdG9yeUVudHJ5Lm5hbWV9PC9kaXY+YCkpO1xyXG4gICAgICAgIHRoaXMuJGhpc3RvcnlFbGVtZW50RGl2LmFwcGVuZChsaW5lMSk7XHJcblxyXG4gICAgICAgIGxldCBsaW5lMiA9IG1ha2VEaXYobnVsbCwgXCJqb19zeW5jaHJvX2hpc3RvcnlFbGVtZW50TGluZTJcIik7XHJcbiAgICAgICAgbGluZTIuYXBwZW5kKGpRdWVyeShgPGRpdiBjbGFzcz1cImpvX3N5bmNocm9faGVfdGltZXN0YW1wXCI+JHtyZXBvc2l0b3J5SGlzdG9yeUVudHJ5LnRpbWVzdGFtcH08L2Rpdj5gKSlcclxuICAgICAgICB0aGlzLiRoaXN0b3J5RWxlbWVudERpdi5hcHBlbmQobGluZTIpO1xyXG5cclxuICAgICAgICBsZXQgbGluZTMgPSBtYWtlRGl2KG51bGwsIFwiam9fc3luY2hyb19oaXN0b3J5RWxlbWVudExpbmUzXCIpO1xyXG4gICAgICAgIGxpbmUzLmFwcGVuZChqUXVlcnkoYDxkaXYgY2xhc3M9XCJqb19zeW5jaHJvX2hlX2NvbW1lbnRcIj4ke3JlcG9zaXRvcnlIaXN0b3J5RW50cnkuY29tbWVudH08L2Rpdj5gKSlcclxuICAgICAgICB0aGlzLiRoaXN0b3J5RWxlbWVudERpdi5hcHBlbmQobGluZTMpO1xyXG5cclxuICAgICAgICBtYW5hZ2VyLiRoaXN0b3J5U2Nyb2xsRGl2LnByZXBlbmQodGhpcy4kaGlzdG9yeUVsZW1lbnREaXYpO1xyXG5cclxuICAgICAgICB0aGlzLiRoaXN0b3J5RWxlbWVudERpdi5vbihcImNsaWNrIGNvbnRleHRtZW51XCIsIChldikgPT4ge1xyXG4gICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICBvcGVuQ29udGV4dE1lbnUoW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhcHRpb246IFwiQXVmIGRlciBsaW5rZW4gU2VpdGUgZGFyc3RlbGxlblwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdyA9IG5ldyBTeW5jaHJvV29ya3NwYWNlKHRoaXMubWFuYWdlcikuY29weUZyb21IaXN0b3J5RWxlbWVudCh0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW5hZ2VyLmxlZnRTeW5jaHJvV29ya3NwYWNlID0gc3c7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFuYWdlci5zZXR1cFN5bmNocm9uaXphdGlvbkxpc3RFbGVtZW50cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbjogXCJBdWYgZGVyIHJlY2h0ZW4gU2VpdGUgZGFyc3RlbGxlblwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdyA9IG5ldyBTeW5jaHJvV29ya3NwYWNlKHRoaXMubWFuYWdlcikuY29weUZyb21IaXN0b3J5RWxlbWVudCh0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYW5hZ2VyLnJpZ2h0U3luY2hyb1dvcmtzcGFjZSA9IHN3O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hbmFnZXIuc2V0dXBTeW5jaHJvbml6YXRpb25MaXN0RWxlbWVudHMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgZXYucGFnZVggKyAyLCBldi5wYWdlWSArIDIpXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGdldFJlcG9zaXRvcnlTdGF0ZSgpOiBSZXBvc2l0b3J5IHtcclxuXHJcbiAgICAgICAgbGV0IGVudHJpZXMgPSB0aGlzLnJlcG9zaXRvcnkuaGlzdG9yeUVudHJpZXM7XHJcblxyXG4gICAgICAgIC8vIGdldCBsYXN0IGludGVybWVkaWF0ZSBzdGF0ZVxyXG4gICAgICAgIGxldCBzdGFydEluZGV4ID0gdGhpcy5oaXN0b3J5RW50cnlJbmRleDtcclxuXHJcbiAgICAgICAgd2hpbGUgKHN0YXJ0SW5kZXggPiAwICYmICEoZW50cmllc1tzdGFydEluZGV4XS5pc0ludGVybWVkaWF0ZUVudHJ5KSkge1xyXG4gICAgICAgICAgICBzdGFydEluZGV4LS07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgZmlsZXM6IFJlcG9zaXRvcnlGaWxlRW50cnlbXSA9IFtdO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IHN0YXJ0SW5kZXg7IGluZGV4IDw9IHRoaXMuaGlzdG9yeUVudHJ5SW5kZXg7IGluZGV4KyspIHtcclxuXHJcbiAgICAgICAgICAgIGxldCBlbnRyeSA9IGVudHJpZXNbaW5kZXhdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBmaWxlRW50cnkgb2YgZW50cnkuaGlzdG9yeUZpbGVzKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGVudHJ5LmlzSW50ZXJtZWRpYXRlRW50cnkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEludGVybWVkaWF0ZVN0YXRlKGZpbGVFbnRyeSwgZmlsZXMpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpbGVFbnRyeS50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJjcmVhdGVcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRmlsZShmaWxlRW50cnksIGZpbGVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiZGVsZXRlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUZpbGUoZmlsZUVudHJ5LCBmaWxlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImNoYW5nZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VGaWxlKGZpbGVFbnRyeSwgZmlsZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJpbnRlcm1lZGlhdGVcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW50ZXJtZWRpYXRlU3RhdGUoZmlsZUVudHJ5LCBmaWxlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHJlcG9zaXRvcnk6IFJlcG9zaXRvcnkgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLnJlcG9zaXRvcnkpO1xyXG4gICAgICAgIHJlcG9zaXRvcnkuZmlsZUVudHJpZXMgPSBmaWxlcztcclxuICAgICAgICByZXBvc2l0b3J5LnZlcnNpb24gPSB0aGlzLnJlcG9zaXRvcnlIaXN0b3J5RW50cnkudmVyc2lvbjtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlcG9zaXRvcnk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNldEludGVybWVkaWF0ZVN0YXRlKGZpbGVFbnRyeTogUmVwb3NpdG9yeUhpc3RvcnlGaWxlRW50cnksIGZpbGVzOiBSZXBvc2l0b3J5RmlsZUVudHJ5W10pIHtcclxuICAgICAgICBsZXQgZmlsZTogUmVwb3NpdG9yeUZpbGVFbnRyeSA9IGZpbGVzLmZpbmQoZmlsZSA9PiBmaWxlLmlkID09IGZpbGVFbnRyeS5pZCk7XHJcbiAgICAgICAgaWYgKGZpbGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBmaWxlLnRleHQgPSBmaWxlRW50cnkuY29udGVudDtcclxuICAgICAgICAgICAgZmlsZS52ZXJzaW9uID0gZmlsZUVudHJ5LnZlcnNpb247XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNoYW5nZUZpbGUoZmlsZUVudHJ5OiBSZXBvc2l0b3J5SGlzdG9yeUZpbGVFbnRyeSwgZmlsZXM6IFJlcG9zaXRvcnlGaWxlRW50cnlbXSkge1xyXG4gICAgICAgIGxldCBmaWxlOiBSZXBvc2l0b3J5RmlsZUVudHJ5ID0gZmlsZXMuZmluZChmaWxlID0+IGZpbGUuaWQgPT0gZmlsZUVudHJ5LmlkKTtcclxuICAgICAgICBpZiAoZmlsZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWxlRW50cnkuY29udGVudCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgIGxldCBwYXRjaDogcGF0Y2hfb2JqW10gPSBKU09OLnBhcnNlKGZpbGVFbnRyeS5jb250ZW50KTtcclxuICAgICAgICAgICAgICAgIGxldCBvbGRUZXh0ID0gZmlsZS50ZXh0O1xyXG4gICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBsZXQgZG1wOiBkaWZmX21hdGNoX3BhdGNoID0gbmV3IGRpZmZfbWF0Y2hfcGF0Y2goKTtcclxuICAgICAgICAgICAgICAgIGxldCBuZXdUZXh0OiBbc3RyaW5nLCBib29sZWFuW11dID0gZG1wLnBhdGNoX2FwcGx5KHBhdGNoLCBvbGRUZXh0KTtcclxuICAgICAgICAgICAgICAgIGZpbGUudGV4dCA9IG5ld1RleHRbMF07XHJcbiAgICAgICAgICAgICAgICBmaWxlLnZlcnNpb24gPSBmaWxlRW50cnkudmVyc2lvbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkZWxldGVGaWxlKGZpbGVFbnRyeTogUmVwb3NpdG9yeUhpc3RvcnlGaWxlRW50cnksIGZpbGVzOiBSZXBvc2l0b3J5RmlsZUVudHJ5W10pIHtcclxuICAgICAgICBsZXQgaW5kZXg6IG51bWJlciA9IGZpbGVzLmZpbmRJbmRleChmaWxlID0+IGZpbGUuaWQgPT0gZmlsZUVudHJ5LmlkKTtcclxuICAgICAgICBpZiAoaW5kZXggIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBmaWxlcy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVGaWxlKGZpbGVFbnRyeTogUmVwb3NpdG9yeUhpc3RvcnlGaWxlRW50cnksIGZpbGVzOiBSZXBvc2l0b3J5RmlsZUVudHJ5W10pIHtcclxuICAgICAgICBsZXQgZmlsZTogUmVwb3NpdG9yeUZpbGVFbnRyeSA9IHtcclxuICAgICAgICAgICAgaWQ6IGZpbGVFbnRyeS5pZCxcclxuICAgICAgICAgICAgdGV4dDogZmlsZUVudHJ5LmNvbnRlbnQsXHJcbiAgICAgICAgICAgIGZpbGVuYW1lOiBmaWxlRW50cnkuZmlsZW5hbWUsXHJcbiAgICAgICAgICAgIHZlcnNpb246IGZpbGVFbnRyeS52ZXJzaW9uXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZpbGVzLnB1c2goZmlsZSk7XHJcbiAgICB9XHJcblxyXG5cclxuXHJcblxyXG59Il19