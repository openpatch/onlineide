import { ZoomControl } from "./ZoomControl.js";
export var DiagramUnitCm = 0.2; // in cm
export class Diagram {
    constructor($htmlElement, main) {
        this.main = main;
        this.zoomfactor = 1.0;
        this.inlineStyles = {};
        this.marginCm = 1.6;
        this.minDistance = 2.0;
        this.minWidthHeightCm = 10;
        this.widthCm = this.minWidthHeightCm;
        this.heightCm = this.minWidthHeightCm;
        this.$menuButton = jQuery('<div class="jo_classDiagram_Menubutton jo_button jo_active img_menu-three-bars"></div>');
        $htmlElement.append(this.$menuButton);
        let $scrollpane = jQuery('<div></div>');
        $htmlElement.append($scrollpane);
        $scrollpane.addClass('jo_scrollable');
        $scrollpane.css({ overflow: "auto", position: "relative", width: "100%", height: "100%" });
        this.$canvas = jQuery('<div class="jo_diagram-canvas"></div>');
        $scrollpane.append(this.$canvas);
        this.zoomControl = new ZoomControl($htmlElement, (factor) => {
            this.$canvas.css({
                transform: "scale(" + factor + ")"
            });
            this.zoomfactor = factor;
        });
        let ns = 'http://www.w3.org/2000/svg';
        this.svgElement = document.createElementNS(ns, 'svg');
        // jQuery(this.svgElement).css('pointer-events', 'none');
        jQuery(this.svgElement).addClass("jo_diagram-svg svg_all_pointer_events");
        // this.insertStyleElement({".svp_draggable": {cursor: "pointer"}});
        this.$canvas[0].appendChild(this.svgElement);
        this.$centerRectangle = jQuery(this.createElement("rect", this.svgElement));
        this.$centerRectangle.css({ fill: "#ffffff", "stroke": "none" });
        this.adjustCenterRectangle();
        let $svgElement = jQuery(this.svgElement);
        let x;
        let y;
        $svgElement.on('mousedown', (ev1) => {
            x = ev1.screenX;
            y = ev1.screenY;
            jQuery(document).on('mousemove.diagram', (ev) => {
                let dx = ev.screenX - x;
                let dy = ev.screenY - y;
                x = ev.screenX;
                y = ev.screenY;
                $scrollpane.scrollLeft($scrollpane.scrollLeft() - dx);
                $scrollpane.scrollTop($scrollpane.scrollTop() - dy);
            });
            jQuery(document).on('mouseup.diagram', () => {
                jQuery(document).off('mousemove.diagram');
                jQuery(document).off('mouseup.diagram');
            });
        });
    }
    adjustCenterRectangle() {
        this.$centerRectangle.attr({
            x: this.marginCm + "cm",
            y: this.marginCm + "cm",
            width: (this.widthCm - 2 * this.marginCm) + "cm",
            height: (this.heightCm - 2 * this.marginCm) + "cm"
        });
    }
    setSize(widthCm, heightCm) {
        if (widthCm < this.minWidthHeightCm)
            widthCm = this.minWidthHeightCm;
        if (heightCm < this.minWidthHeightCm)
            heightCm = this.minWidthHeightCm;
        this.$canvas.css({
            width: widthCm + "cm",
            height: heightCm + "cm"
        });
        this.widthCm = widthCm;
        this.heightCm = heightCm;
        this.adjustCenterRectangle();
    }
    adjustSizeAndElements(diagramElements) {
        let xMin = 100000;
        let yMin = 100000;
        let xMax = -100000;
        let yMax = -100000;
        for (let rr of diagramElements) {
            if (xMin > rr.leftCm)
                xMin = rr.leftCm;
            if (xMax < rr.leftCm + rr.widthCm)
                xMax = rr.leftCm + rr.widthCm;
            if (yMin > rr.topCm)
                yMin = rr.topCm;
            if (yMax < rr.topCm + rr.heightCm)
                yMax = rr.topCm + rr.heightCm;
        }
        xMin -= this.marginCm;
        xMax += this.marginCm;
        yMin -= this.marginCm;
        yMax += this.marginCm;
        let isAdjusted = false;
        let newWidthCm = this.widthCm;
        let newHeightCm = this.heightCm;
        if (xMin < 0 || xMax > this.widthCm || (xMax - xMin <= this.widthCm && this.widthCm > this.minWidthHeightCm)) {
            let delta = 0;
            newWidthCm = Math.max(this.minWidthHeightCm, xMax - xMin);
            if (xMin < 0) {
                delta = -xMin;
            }
            if (xMin > 0 && xMax > newWidthCm) {
                delta = newWidthCm - xMax;
            }
            isAdjusted = delta != 0;
            if (isAdjusted)
                for (let rr of diagramElements) {
                    rr.move(delta, 0, true, true);
                }
        }
        if (yMin < 0 || yMax > this.heightCm || (yMax - yMin <= this.heightCm && this.heightCm > this.minWidthHeightCm)) {
            let delta = 0;
            newHeightCm = Math.max(this.minWidthHeightCm, yMax - yMin);
            if (yMin < 0) {
                delta = -yMin;
            }
            if (yMin > 0 && yMax > newHeightCm) {
                delta = newHeightCm - yMax;
            }
            isAdjusted = delta != 0;
            if (isAdjusted)
                for (let rr of diagramElements) {
                    rr.move(0, delta, true, true);
                }
        }
        this.setSize(newWidthCm, newHeightCm);
        return { isAdjusted: isAdjusted };
    }
    insertStyleElement(styles = null) {
        let ns = 'http://www.w3.org/2000/svg';
        if (this.style == null) {
            this.defs = document.createElementNS(ns, 'defs');
            this.style = document.createElementNS(ns, 'style');
            this.defs.appendChild(this.style);
            this.svgElement.appendChild(this.defs);
        }
        if (styles != null) {
            this.inlineStyles = styles;
            this.refreshInlineStyles();
        }
    }
    createElement(name, parent = null, attributes) {
        let ns = 'http://www.w3.org/2000/svg';
        let $element = jQuery(document.createElementNS(ns, name));
        if (attributes != null)
            $element.attr(attributes);
        if (parent != null)
            parent.appendChild($element[0]);
        return $element;
    }
    refreshInlineStyles() {
        let s = "";
        for (let selector in this.inlineStyles) {
            let stylesForSelector = this.inlineStyles[selector];
            if (stylesForSelector != null) {
                s += selector + "{\n";
                for (let key in stylesForSelector) {
                    s += "   " + key + ":" + stylesForSelector[key] + ";\n";
                }
                s += "}\n";
            }
            else {
                s += selector + "\n";
            }
        }
        this.style.textContent = s;
    }
    findFreeSpace(elements, width, height, minDistance) {
        let radius = 0;
        let fertig = false;
        let xCm = 0;
        let yCm = 0;
        while (!fertig) {
            let y = radius;
            let x = 0;
            for (x = 0; x <= radius; x++) {
                xCm = this.marginCm + x * DiagramUnitCm;
                yCm = this.marginCm + y * DiagramUnitCm;
                if (this.isFree(elements, width, height, xCm, yCm, minDistance)) {
                    fertig = true;
                    break;
                }
            }
            if (fertig)
                break;
            x--;
            for (y = 0; y <= radius - 1; y++) {
                xCm = this.marginCm + x * DiagramUnitCm;
                yCm = this.marginCm + y * DiagramUnitCm;
                if (this.isFree(elements, width, height, xCm, yCm, minDistance)) {
                    fertig = true;
                    break;
                }
            }
            radius += 2;
        }
        return { x: xCm, y: yCm };
    }
    isFree(elements, widthCm, heightCm, leftCm, topCm, minDistance) {
        for (let element of elements) {
            let insideX = Math.abs(element.leftCm + element.widthCm / 2 - leftCm - widthCm / 2)
                <= (element.widthCm + widthCm) / 2 + minDistance;
            let insideY = Math.abs(element.topCm + element.heightCm / 2 - topCm - heightCm / 2) <= (element.heightCm + heightCm) / 2 + minDistance;
            if (insideX && insideY)
                return false;
        }
        return true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGlhZ3JhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jbGllbnQvbWFpbi9ndWkvZGlhZ3JhbXMvRGlhZ3JhbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFPL0MsTUFBTSxDQUFDLElBQUksYUFBYSxHQUFHLEdBQUcsQ0FBQyxDQUFDLFFBQVE7QUFFeEMsTUFBTSxPQUFPLE9BQU87SUFzQmhCLFlBQVksWUFBaUMsRUFBUyxJQUFjO1FBQWQsU0FBSSxHQUFKLElBQUksQ0FBVTtRQW5CcEUsZUFBVSxHQUFXLEdBQUcsQ0FBQztRQVV6QixpQkFBWSxHQUFzRCxFQUFFLENBQUM7UUFDckUsYUFBUSxHQUFHLEdBQUcsQ0FBQztRQUNmLGdCQUFXLEdBQUcsR0FBRyxDQUFDO1FBQ2xCLHFCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUN0QixZQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBQ2hDLGFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFNN0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsd0ZBQXdGLENBQUMsQ0FBQztRQUNwSCxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV0QyxJQUFJLFdBQVcsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDeEMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqQyxXQUFXLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3RDLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztRQUV6RixJQUFJLENBQUMsT0FBTyxHQUFHLE1B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SUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxRQUFRLEdBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxRQUFRLEdBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFDLENBQUMsR0FBRyxXQUFXLENBQUM7WUFFakksSUFBRyxPQUFPLElBQUksT0FBTztnQkFBRSxPQUFPLEtBQUssQ0FBQztTQUV2QztRQUVELE9BQU8sSUFBSSxDQUFDO0lBRWhCLENBQUM7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFpvb21Db250cm9sIH0gZnJvbSBcIi4vWm9vbUNvbnRyb2wuanNcIjtcclxuaW1wb3J0IHsgQ2xhc3NCb3ggfSBmcm9tIFwiLi9jbGFzc2RpYWdyYW0vQ2xhc3NCb3guanNcIjtcclxuaW1wb3J0IHsgUmVjdGFuZ2xlLCBQb2ludCB9IGZyb20gXCIuL2NsYXNzZGlhZ3JhbS9Sb3V0ZXIuanNcIjtcclxuaW1wb3J0IHsgRGlhZ3JhbUVsZW1lbnQgfSBmcm9tIFwiLi9EaWFncmFtRWxlbWVudC5qc1wiO1xyXG5pbXBvcnQgeyBNYWluIH0gZnJvbSBcIi4uLy4uL01haW4uanNcIjtcclxuaW1wb3J0IHsgTWFpbkJhc2UgfSBmcm9tIFwiLi4vLi4vTWFpbkJhc2UuanNcIjtcclxuXHJcbmV4cG9ydCB2YXIgRGlhZ3JhbVVuaXRDbSA9IDAuMjsgLy8gaW4gY21cclxuXHJcbmV4cG9ydCBjbGFzcyBEaWFncmFtIHtcclxuXHJcbiAgICB6b29tQ29udHJvbDogWm9vbUNvbnRyb2w7XHJcbiAgICB6b29tZmFjdG9yOiBudW1iZXIgPSAxLjA7XHJcblxyXG4gICAgJGNhbnZhczogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuICAgIHN2Z0VsZW1lbnQ6IEVsZW1lbnQ7XHJcblxyXG4gICAgJG1lbnVCdXR0b246IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgZGVmczogRWxlbWVudDtcclxuICAgIHN0eWxlOiBFbGVtZW50O1xyXG5cclxuICAgIGlubGluZVN0eWxlczogeyBbc2VsZWN0b3I6IHN0cmluZ106IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gfSA9IHt9O1xyXG4gICAgbWFyZ2luQ20gPSAxLjY7XHJcbiAgICBtaW5EaXN0YW5jZSA9IDIuMDtcclxuICAgIG1pbldpZHRoSGVpZ2h0Q20gPSAxMDtcclxuICAgIHdpZHRoQ20gPSB0aGlzLm1pbldpZHRoSGVpZ2h0Q207XHJcbiAgICBoZWlnaHRDbSA9IHRoaXMubWluV2lkdGhIZWlnaHRDbTtcclxuXHJcbiAgICAkY2VudGVyUmVjdGFuZ2xlOiBKUXVlcnk8U1ZHRWxlbWVudD47XHJcblxyXG4gICAgY29uc3RydWN0b3IoJGh0bWxFbGVtZW50OiBKUXVlcnk8SFRNTEVsZW1lbnQ+LCBwdWJsaWMgbWFpbjogTWFpbkJhc2Upe1xyXG5cclxuICAgICAgICB0aGlzLiRtZW51QnV0dG9uID0galF1ZXJ5KCc8ZGl2IGNsYXNzPVwiam9fY2xhc3NEaWFncmFtX01lbnVidXR0b24gam9fYnV0dG9uIGpvX2FjdGl2ZSBpbWdfbWVudS10aHJlZS1iYXJzXCI+PC9kaXY+Jyk7XHJcbiAgICAgICAgJGh0bWxFbGVtZW50LmFwcGVuZCh0aGlzLiRtZW51QnV0dG9uKTtcclxuXHJcbiAgICAgICAgbGV0ICRzY3JvbGxwYW5lID0galF1ZXJ5KCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgICRodG1sRWxlbWVudC5hcHBlbmQoJHNjcm9sbHBhbmUpO1xyXG4gICAgICAgICRzY3JvbGxwYW5lLmFkZENsYXNzKCdqb19zY3JvbGxhYmxlJyk7XHJcbiAgICAgICAgJHNjcm9sbHBhbmUuY3NzKHtvdmVyZmxvdzogXCJhdXRvXCIsIHBvc2l0aW9uOiBcInJlbGF0aXZlXCIsIHdpZHRoOiBcIjEwMCVcIiwgaGVpZ2h0OiBcIjEwMCVcIn0pO1xyXG5cclxuICAgICAgICB0aGlzLiRjYW52YXMgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19kaWFncmFtLWNhbnZhc1wiPjwvZGl2PicpO1xyXG4gICAgICAgICRzY3JvbGxwYW5lLmFwcGVuZCh0aGlzLiRjYW52YXMpO1xyXG4gICAgICAgIHRoaXMuem9vbUNvbnRyb2wgPSBuZXcgWm9vbUNvbnRyb2woJGh0bWxFbGVtZW50LCAoZmFjdG9yOiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgdGhpcy4kY2FudmFzLmNzcyh7XHJcbiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IFwic2NhbGUoXCIgKyBmYWN0b3IgKyBcIilcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy56b29tZmFjdG9yID0gZmFjdG9yO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgbnMgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnO1xyXG4gICAgICAgIHRoaXMuc3ZnRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhucywgJ3N2ZycpO1xyXG4gICAgICAgIC8vIGpRdWVyeSh0aGlzLnN2Z0VsZW1lbnQpLmNzcygncG9pbnRlci1ldmVudHMnLCAnbm9uZScpO1xyXG4gICAgICAgIGpRdWVyeSh0aGlzLnN2Z0VsZW1lbnQpLmFkZENsYXNzKFwiam9fZGlhZ3JhbS1zdmcgc3ZnX2FsbF9wb2ludGVyX2V2ZW50c1wiKTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5pbnNlcnRTdHlsZUVsZW1lbnQoe1wiLnN2cF9kcmFnZ2FibGVcIjoge2N1cnNvcjogXCJwb2ludGVyXCJ9fSk7XHJcblxyXG4gICAgICAgIHRoaXMuJGNhbnZhc1swXS5hcHBlbmRDaGlsZCh0aGlzLnN2Z0VsZW1lbnQpO1xyXG5cclxuICAgICAgICB0aGlzLiRjZW50ZXJSZWN0YW5nbGUgPSA8YW55PmpRdWVyeSh0aGlzLmNyZWF0ZUVsZW1lbnQoXCJyZWN0XCIsIHRoaXMuc3ZnRWxlbWVudCkpO1xyXG5cclxuICAgICAgICB0aGlzLiRjZW50ZXJSZWN0YW5nbGUuY3NzKHtmaWxsOiBcIiNmZmZmZmZcIiwgXCJzdHJva2VcIjogXCJub25lXCJ9KTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGp1c3RDZW50ZXJSZWN0YW5nbGUoKTtcclxuXHJcbiAgICAgICAgbGV0ICRzdmdFbGVtZW50ID0gIGpRdWVyeSh0aGlzLnN2Z0VsZW1lbnQpO1xyXG5cclxuICAgICAgICBsZXQgeDogbnVtYmVyO1xyXG4gICAgICAgIGxldCB5OiBudW1iZXI7XHJcblxyXG4gICAgICAgICRzdmdFbGVtZW50Lm9uKCdtb3VzZWRvd24nLCAoZXYxKSA9PiB7XHJcbiAgICAgICAgICAgIHggPSBldjEuc2NyZWVuWDtcclxuICAgICAgICAgICAgeSA9IGV2MS5zY3JlZW5ZO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vbignbW91c2Vtb3ZlLmRpYWdyYW0nLCAoZXYpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBkeCA9IGV2LnNjcmVlblggLSB4O1xyXG4gICAgICAgICAgICAgICAgbGV0IGR5ID0gZXYuc2NyZWVuWSAtIHk7XHJcbiAgICAgICAgICAgICAgICB4ID0gZXYuc2NyZWVuWDtcclxuICAgICAgICAgICAgICAgIHkgPSBldi5zY3JlZW5ZO1xyXG4gICAgICAgICAgICAgICAgJHNjcm9sbHBhbmUuc2Nyb2xsTGVmdCgkc2Nyb2xscGFuZS5zY3JvbGxMZWZ0KCkgLSBkeCk7XHJcbiAgICAgICAgICAgICAgICAkc2Nyb2xscGFuZS5zY3JvbGxUb3AoJHNjcm9sbHBhbmUuc2Nyb2xsVG9wKCkgLSBkeSk7XHJcbiAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9uKCdtb3VzZXVwLmRpYWdyYW0nLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZignbW91c2Vtb3ZlLmRpYWdyYW0nKTtcclxuICAgICAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZXVwLmRpYWdyYW0nKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgfSAgICBcclxuXHJcbiAgICBhZGp1c3RDZW50ZXJSZWN0YW5nbGUoKXtcclxuICAgICAgICB0aGlzLiRjZW50ZXJSZWN0YW5nbGUuYXR0cih7XHJcbiAgICAgICAgICAgIHg6IHRoaXMubWFyZ2luQ20gKyBcImNtXCIsXHJcbiAgICAgICAgICAgIHk6IHRoaXMubWFyZ2luQ20gKyBcImNtXCIsXHJcbiAgICAgICAgICAgIHdpZHRoOiAodGhpcy53aWR0aENtIC0gMip0aGlzLm1hcmdpbkNtKSArIFwiY21cIiwgICAgXHJcbiAgICAgICAgICAgIGhlaWdodDogKHRoaXMuaGVpZ2h0Q20gLSAyKnRoaXMubWFyZ2luQ20pICsgXCJjbVwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0U2l6ZSh3aWR0aENtOiBudW1iZXIsIGhlaWdodENtOiBudW1iZXIpe1xyXG4gICAgICAgIGlmKHdpZHRoQ20gPCB0aGlzLm1pbldpZHRoSGVpZ2h0Q20pIHdpZHRoQ20gPSB0aGlzLm1pbldpZHRoSGVpZ2h0Q207XHJcbiAgICAgICAgaWYoaGVpZ2h0Q20gPCB0aGlzLm1pbldpZHRoSGVpZ2h0Q20pIGhlaWdodENtID0gdGhpcy5taW5XaWR0aEhlaWdodENtO1xyXG5cclxuICAgICAgICB0aGlzLiRjYW52YXMuY3NzKHtcclxuICAgICAgICAgICAgd2lkdGg6IHdpZHRoQ20gKyBcImNtXCIsXHJcbiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0Q20gKyBcImNtXCJcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICB0aGlzLndpZHRoQ20gPSB3aWR0aENtO1xyXG4gICAgICAgIHRoaXMuaGVpZ2h0Q20gPSBoZWlnaHRDbTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGp1c3RDZW50ZXJSZWN0YW5nbGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGp1c3RTaXplQW5kRWxlbWVudHMoZGlhZ3JhbUVsZW1lbnRzOiBEaWFncmFtRWxlbWVudFtdKToge2lzQWRqdXN0ZWQ6IGJvb2xlYW59e1xyXG5cclxuICAgICAgICBsZXQgeE1pbiA9IDEwMDAwMDtcclxuICAgICAgICBsZXQgeU1pbiA9IDEwMDAwMDtcclxuICAgICAgICBsZXQgeE1heCA9IC0xMDAwMDA7XHJcbiAgICAgICAgbGV0IHlNYXggPSAtMTAwMDAwO1xyXG5cclxuICAgICAgICBmb3IobGV0IHJyIG9mIGRpYWdyYW1FbGVtZW50cyl7XHJcbiAgICAgICAgICAgIGlmKHhNaW4gPiByci5sZWZ0Q20pIHhNaW4gPSByci5sZWZ0Q207XHJcbiAgICAgICAgICAgIGlmKHhNYXggPCByci5sZWZ0Q20gKyByci53aWR0aENtKSB4TWF4ID0gcnIubGVmdENtICsgcnIud2lkdGhDbTtcclxuICAgICAgICAgICAgaWYoeU1pbiA+IHJyLnRvcENtKSB5TWluID0gcnIudG9wQ207XHJcbiAgICAgICAgICAgIGlmKHlNYXggPCByci50b3BDbSArIHJyLmhlaWdodENtKSB5TWF4ID0gcnIudG9wQ20gKyByci5oZWlnaHRDbTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHhNaW4gLT0gdGhpcy5tYXJnaW5DbTtcclxuICAgICAgICB4TWF4ICs9IHRoaXMubWFyZ2luQ207XHJcbiAgICAgICAgeU1pbiAtPSB0aGlzLm1hcmdpbkNtO1xyXG4gICAgICAgIHlNYXggKz0gdGhpcy5tYXJnaW5DbTtcclxuXHJcbiAgICAgICAgbGV0IGlzQWRqdXN0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgICAgICBsZXQgbmV3V2lkdGhDbSA9IHRoaXMud2lkdGhDbTtcclxuICAgICAgICBsZXQgbmV3SGVpZ2h0Q20gPSB0aGlzLmhlaWdodENtO1xyXG5cclxuICAgICAgICBpZih4TWluIDwgMCB8fCB4TWF4ID4gdGhpcy53aWR0aENtIHx8ICh4TWF4IC0geE1pbiA8PSB0aGlzLndpZHRoQ20gJiYgdGhpcy53aWR0aENtID4gdGhpcy5taW5XaWR0aEhlaWdodENtKSl7XHJcbiAgICAgICAgICAgIGxldCBkZWx0YSA9IDA7XHJcbiAgICAgICAgICAgIG5ld1dpZHRoQ20gPSBNYXRoLm1heCh0aGlzLm1pbldpZHRoSGVpZ2h0Q20sIHhNYXggLSB4TWluKTtcclxuXHJcbiAgICAgICAgICAgIGlmKHhNaW4gPCAwKXtcclxuICAgICAgICAgICAgICAgIGRlbHRhID0gLXhNaW47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKHhNaW4gPiAwICYmIHhNYXggPiBuZXdXaWR0aENtKXtcclxuICAgICAgICAgICAgICAgIGRlbHRhID0gbmV3V2lkdGhDbSAtIHhNYXg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaXNBZGp1c3RlZCA9IGRlbHRhICE9IDA7XHJcblxyXG4gICAgICAgICAgICBpZihpc0FkanVzdGVkKVxyXG4gICAgICAgICAgICBmb3IobGV0IHJyIG9mIGRpYWdyYW1FbGVtZW50cyl7XHJcbiAgICAgICAgICAgICAgICByci5tb3ZlKGRlbHRhLCAwLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHlNaW4gPCAwIHx8IHlNYXggPiB0aGlzLmhlaWdodENtIHx8ICh5TWF4IC0geU1pbiA8PSB0aGlzLmhlaWdodENtICYmIHRoaXMuaGVpZ2h0Q20gPiB0aGlzLm1pbldpZHRoSGVpZ2h0Q20pKXtcclxuICAgICAgICAgICAgbGV0IGRlbHRhID0gMDtcclxuICAgICAgICAgICAgbmV3SGVpZ2h0Q20gPSBNYXRoLm1heCh0aGlzLm1pbldpZHRoSGVpZ2h0Q20sIHlNYXggLSB5TWluKTtcclxuXHJcbiAgICAgICAgICAgIGlmKHlNaW4gPCAwKXtcclxuICAgICAgICAgICAgICAgIGRlbHRhID0gLXlNaW47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKHlNaW4gPiAwICYmIHlNYXggPiBuZXdIZWlnaHRDbSl7XHJcbiAgICAgICAgICAgICAgICBkZWx0YSA9IG5ld0hlaWdodENtIC0geU1heDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpc0FkanVzdGVkID0gZGVsdGEgIT0gMDtcclxuXHJcbiAgICAgICAgICAgIGlmKGlzQWRqdXN0ZWQpXHJcbiAgICAgICAgICAgIGZvcihsZXQgcnIgb2YgZGlhZ3JhbUVsZW1lbnRzKXtcclxuICAgICAgICAgICAgICAgIHJyLm1vdmUoMCwgZGVsdGEsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHRoaXMuc2V0U2l6ZShuZXdXaWR0aENtLCBuZXdIZWlnaHRDbSk7XHJcbiAgICAgICAgXHJcblxyXG4gICAgICAgIHJldHVybiB7aXNBZGp1c3RlZDogaXNBZGp1c3RlZH07XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpbnNlcnRTdHlsZUVsZW1lbnQoc3R5bGVzOiB7IFtzZWxlY3Rvcjogc3RyaW5nXTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSB9ID0gbnVsbCkge1xyXG5cclxuICAgICAgICBsZXQgbnMgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5zdHlsZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVmcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhucywgJ2RlZnMnKTtcclxuICAgICAgICAgICAgdGhpcy5zdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhucywgJ3N0eWxlJyk7XHJcbiAgICAgICAgICAgIHRoaXMuZGVmcy5hcHBlbmRDaGlsZCh0aGlzLnN0eWxlKTtcclxuICAgICAgICAgICAgdGhpcy5zdmdFbGVtZW50LmFwcGVuZENoaWxkKHRoaXMuZGVmcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3R5bGVzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5pbmxpbmVTdHlsZXMgPSBzdHlsZXM7XHJcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaElubGluZVN0eWxlcygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNyZWF0ZUVsZW1lbnQobmFtZTogc3RyaW5nLCBwYXJlbnQ6IEVsZW1lbnQgPSBudWxsLCBhdHRyaWJ1dGVzPzpcclxuICAgICAgICB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9KTogSlF1ZXJ5PEVsZW1lbnQ+IHtcclxuXHJcbiAgICAgICAgbGV0IG5zID0gJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJztcclxuICAgICAgICBsZXQgJGVsZW1lbnQgPSBqUXVlcnkoZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5zLCBuYW1lKSk7XHJcblxyXG4gICAgICAgIGlmKGF0dHJpYnV0ZXMgIT0gbnVsbCkgJGVsZW1lbnQuYXR0cihhdHRyaWJ1dGVzKTtcclxuXHJcbiAgICAgICAgaWYocGFyZW50ICE9IG51bGwpIHBhcmVudC5hcHBlbmRDaGlsZCgkZWxlbWVudFswXSk7XHJcblxyXG4gICAgICAgIHJldHVybiAkZWxlbWVudDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZWZyZXNoSW5saW5lU3R5bGVzKCkge1xyXG5cclxuICAgICAgICBsZXQgczogc3RyaW5nID0gXCJcIjtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgc2VsZWN0b3IgaW4gdGhpcy5pbmxpbmVTdHlsZXMpIHtcclxuICAgICAgICAgICAgbGV0IHN0eWxlc0ZvclNlbGVjdG9yID0gdGhpcy5pbmxpbmVTdHlsZXNbc2VsZWN0b3JdO1xyXG4gICAgICAgICAgICBpZiAoc3R5bGVzRm9yU2VsZWN0b3IgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcyArPSBzZWxlY3RvciArIFwie1xcblwiO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHN0eWxlc0ZvclNlbGVjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcyArPSBcIiAgIFwiICsga2V5ICsgXCI6XCIgKyBzdHlsZXNGb3JTZWxlY3RvcltrZXldICsgXCI7XFxuXCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBzICs9IFwifVxcblwiO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcyArPSBzZWxlY3RvciArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc3R5bGUudGV4dENvbnRlbnQgPSBzO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBmaW5kRnJlZVNwYWNlKGVsZW1lbnRzOiBEaWFncmFtRWxlbWVudFtdLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgbWluRGlzdGFuY2U6IG51bWJlcik6IFBvaW50IHtcclxuXHJcbiAgICAgICAgbGV0IHJhZGl1cyA9IDA7XHJcbiAgICAgICAgbGV0IGZlcnRpZzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgICAgIGxldCB4Q20gPSAwO1xyXG4gICAgICAgIGxldCB5Q20gPSAwO1xyXG4gICAgICAgIHdoaWxlKCFmZXJ0aWcpe1xyXG5cclxuICAgICAgICAgICAgbGV0IHkgPSByYWRpdXM7XHJcbiAgICAgICAgICAgIGxldCB4ID0gMDtcclxuICAgICAgICAgICAgZm9yKHggPSAwOyB4IDw9IHJhZGl1czsgeCsrKXtcclxuICAgICAgICAgICAgICAgIHhDbSA9IHRoaXMubWFyZ2luQ20gKyB4ICogRGlhZ3JhbVVuaXRDbTtcclxuICAgICAgICAgICAgICAgIHlDbSA9IHRoaXMubWFyZ2luQ20gKyB5ICogRGlhZ3JhbVVuaXRDbTtcclxuICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNGcmVlKGVsZW1lbnRzLCB3aWR0aCwgaGVpZ2h0LCB4Q20sIHlDbSwgbWluRGlzdGFuY2UpKXtcclxuICAgICAgICAgICAgICAgICAgICBmZXJ0aWcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKGZlcnRpZykgYnJlYWs7XHJcbiAgICAgICAgICAgIHgtLTtcclxuICAgICAgICAgICAgZm9yKHkgPSAwOyB5IDw9IHJhZGl1cyAtIDE7IHkrKyl7XHJcbiAgICAgICAgICAgICAgICB4Q20gPSB0aGlzLm1hcmdpbkNtICsgeCAqIERpYWdyYW1Vbml0Q207XHJcbiAgICAgICAgICAgICAgICB5Q20gPSB0aGlzLm1hcmdpbkNtICsgeSAqIERpYWdyYW1Vbml0Q207XHJcbiAgICAgICAgICAgICAgICBpZih0aGlzLmlzRnJlZShlbGVtZW50cywgd2lkdGgsIGhlaWdodCwgeENtLCB5Q20sIG1pbkRpc3RhbmNlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgZmVydGlnID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmFkaXVzICs9IDI7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHt4OiB4Q20sIHk6IHlDbX07XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGlzRnJlZShlbGVtZW50czogRGlhZ3JhbUVsZW1lbnRbXSwgd2lkdGhDbTogbnVtYmVyLCBoZWlnaHRDbTogbnVtYmVyLCBsZWZ0Q206IG51bWJlciwgdG9wQ206IG51bWJlciwgbWluRGlzdGFuY2U6IG51bWJlcik6Ym9vbGVhbiB7XHJcblxyXG4gICAgICAgIGZvcihsZXQgZWxlbWVudCBvZiBlbGVtZW50cyl7XHJcblxyXG4gICAgICAgICAgICBsZXQgaW5zaWRlWCA9IE1hdGguYWJzKGVsZW1lbnQubGVmdENtICsgZWxlbWVudC53aWR0aENtLzIgLSBsZWZ0Q20gLSB3aWR0aENtLzIpIFxyXG4gICAgICAgICAgICAgICAgICAgICAgIDw9IChlbGVtZW50LndpZHRoQ20gKyB3aWR0aENtKS8yICsgbWluRGlzdGFuY2U7XHJcblxyXG4gICAgICAgICAgICBsZXQgaW5zaWRlWSA9IE1hdGguYWJzKGVsZW1lbnQudG9wQ20gKyBlbGVtZW50LmhlaWdodENtLzIgLSB0b3BDbSAtIGhlaWdodENtLzIpIDw9IChlbGVtZW50LmhlaWdodENtICsgaGVpZ2h0Q20pLzIgKyBtaW5EaXN0YW5jZTtcclxuXHJcbiAgICAgICAgICAgIGlmKGluc2lkZVggJiYgaW5zaWRlWSkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG59Il19