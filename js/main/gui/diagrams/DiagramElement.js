import { DiagramUnitCm } from "./Diagram.js";
export var Alignment;
(function (Alignment) {
    Alignment[Alignment["left"] = 0] = "left";
    Alignment[Alignment["center"] = 1] = "center";
    Alignment[Alignment["right"] = 2] = "right";
})(Alignment || (Alignment = {}));
export class DiagramElement {
    constructor(parent) {
        this.parent = parent;
        this.leftCm = 0; // x-Koordinate in cm
        this.topCm = 0; // y-Koordinate in cm
        this.lines = [];
        this.backgroundColor = "#ffffff";
    }
    getRoutingRectangle() {
        return {
            left: Math.round(this.leftCm / DiagramUnitCm),
            top: Math.round(this.topCm / DiagramUnitCm),
            width: Math.round(this.widthCm / DiagramUnitCm),
            height: Math.round(this.heightCm / DiagramUnitCm)
        };
    }
    show() {
        if (this.$element == null)
            return;
        this.$element.show();
    }
    hide() {
        if (this.$element == null)
            return;
        this.$element.hide();
    }
    detach() {
        if (this.$element == null)
            return;
        this.$element.detach();
    }
    remove() {
        if (this.$element == null)
            return;
        this.$element.remove();
        this.$element = null;
    }
    appendTo($element) {
        $element.append(this.$element);
    }
    clear() {
        if (this.$element == null)
            return;
        this.$element.empty();
        this.lines = [];
    }
    move(xCm, yCm, withRaster, adjustToRaster = false) {
        this.leftCm += xCm;
        this.topCm += yCm;
        let x = this.leftCm;
        let y = this.topCm;
        if (withRaster) {
            x = Math.round(x / DiagramUnitCm) * DiagramUnitCm;
            y = Math.round(y / DiagramUnitCm) * DiagramUnitCm;
        }
        if (adjustToRaster) {
            this.leftCm = x;
            this.topCm = y;
        }
        jQuery(this.$element).css("transform", "translate(" + x + "cm," + y + "cm)");
    }
    moveTo(xCm, yCm, withRaster) {
        this.move(xCm - this.leftCm, yCm - this.topCm, withRaster);
    }
    createElement(name, parent = null, attributes) {
        let ns = 'http://www.w3.org/2000/svg';
        let $element = jQuery(document.createElementNS(ns, name));
        if (attributes != null)
            $element.attr(attributes);
        if (parent != null)
            parent.appendChild($element[0]);
        return $element;
    }
    createTextElement(text, parent = null, attributes) {
        let $element = this.createElement("text", parent, {
            font: "16px Roboto",
            "font-family": "sans-serif",
            fill: "#000",
            "alignment-baseline": "hanging",
            "dominant-baseline": "hanging"
        });
        if (attributes != null)
            $element.attr(attributes);
        $element.text(text);
        return $element;
    }
    getTextMetrics(textElement) {
        let bbox = textElement[0].getBBox();
        return {
            height: bbox.height * DiagramElement.cmPerPx,
            width: bbox.width * DiagramElement.cmPerPx
        };
    }
    addTextLine(line) {
        this.lines.push(line);
        if (line.type == "text") {
            if (line.alignment == null)
                line.alignment = Alignment.left;
            if (line.bold == null)
                line.bold = false;
            if (line.italics == null)
                line.italics = false;
        }
    }
    render() {
        let $group = this.$element;
        if ($group == null) {
            $group = this.createElement("g", this.parent);
            $group.addClass("svg_draggable");
            $group.addClass("svg_all_pointer_events");
            this.$element = $group;
            jQuery(this.$element).css("transform", "translate(" + this.leftCm + "cm," + this.topCm + "cm)");
        }
        let $rect = this.createElement("rect", $group[0]);
        let textPosYCm = 0.1;
        let maxWidthCm = 0;
        let first = true;
        for (let line of this.lines) {
            if (line.type == "text") {
                if (first)
                    textPosYCm += 0.1;
                first = false;
                line.yCm = textPosYCm;
                line.$element = this.createTextElement(line.text, $group[0], {
                    "font-weight": line.bold ? "bold" : "normal",
                    "font-size": "12pt",
                    "font-style": line.italics ? "italic" : "normal",
                    "text-anchor": line.alignment == Alignment.left ? "start" : line.alignment == Alignment.center ? "middle" : "end",
                    "cursor": line.onClick == null ? "" : "pointer"
                });
                line.$element.css("transform", "translate(0cm,0cm)");
                // line.$element.css("transform", "translate(0cm," + textPosYCm + "cm)");
                // if(line.onClick != null){
                //     line.$element.addClass("clickable");
                //     line.$element.on("mousedown", (event) => {
                //         //@ts-ignore
                //         line.onClick();
                //         event.stopPropagation();
                //     })
                // }
                let metrics = this.getTextMetrics(line.$element);
                line.textHeightCm = metrics.height;
                line.textWidthCm = metrics.width;
                maxWidthCm = Math.max(maxWidthCm, line.textWidthCm);
                textPosYCm += line.textHeightCm;
                if (line.tooltip != null) {
                    let $tooltip = this.createElement("title", line.$element[0]);
                    $tooltip.text(line.tooltip);
                }
            }
            else {
                line.yCm = textPosYCm + line.thicknessCm / 2;
                textPosYCm += line.thicknessCm + 0.1;
                first = true;
            }
        }
        let width = 2 * 0.05 + 2 * 0.2 + maxWidthCm;
        this.widthCm = (Math.trunc(width / DiagramUnitCm) + 1) * DiagramUnitCm;
        this.heightCm = (Math.trunc(textPosYCm / DiagramUnitCm) + 1) * DiagramUnitCm;
        let textLeft = 0.05 + 0.2;
        let textCenter = width / 2;
        let textRight = width - textLeft;
        $rect.css({
            width: this.widthCm + "cm",
            height: this.heightCm + "cm",
            fill: this.backgroundColor,
            stroke: "#000",
            "stroke-width": "0.05cm"
        });
        for (let line of this.lines) {
            if (line.type == "text") {
                let x;
                switch (line.alignment) {
                    case Alignment.center:
                        x = textCenter;
                        break;
                    case Alignment.left:
                        x = textLeft;
                        break;
                    case Alignment.right:
                        x = textRight;
                        break;
                }
                // Unfortunately we have to wrap Text-Elements in <g> due to a bug in safari,
                // see 
                //@ts-ignore
                let $g = this.createElement("g", $group[0]);
                $g.append(line.$element);
                //@ts-ignore
                line.$element = $g;
                line.$element.css("transform", "translate(" + x + "cm," + line.yCm + "cm)");
                if (line.onClick != null) {
                    line.$element.addClass("clickable");
                    line.$element.on("mousedown", (event) => {
                        //@ts-ignore
                        line.onClick();
                        event.stopPropagation();
                    });
                }
            }
            else {
                line.$element = this.createElement("line", $group[0], {
                    x1: "0",
                    y1: line.yCm + "cm",
                    x2: this.widthCm + "cm",
                    y2: line.yCm + "cm"
                });
                line.$element.css({
                    stroke: "#000",
                    "stroke-width": line.thicknessCm + "cm"
                });
            }
        }
    }
}
DiagramElement.cmPerPx = 2.54 / 96;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGlhZ3JhbUVsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L21haW4vZ3VpL2RpYWdyYW1zL0RpYWdyYW1FbGVtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQVcsTUFBTSxjQUFjLENBQUM7QUFHdEQsTUFBTSxDQUFOLElBQVksU0FFWDtBQUZELFdBQVksU0FBUztJQUNqQix5Q0FBSSxDQUFBO0lBQUUsNkNBQU0sQ0FBQTtJQUFFLDJDQUFLLENBQUE7QUFDdkIsQ0FBQyxFQUZXLFNBQVMsS0FBVCxTQUFTLFFBRXBCO0FBdUJELE1BQU0sT0FBZ0IsY0FBYztJQWdCaEMsWUFBc0IsTUFBZTtRQUFmLFdBQU0sR0FBTixNQUFNLENBQVM7UUFWOUIsV0FBTSxHQUFXLENBQUMsQ0FBQyxDQUFDLHFCQUFxQjtRQUN6QyxVQUFLLEdBQVcsQ0FBQyxDQUFDLENBQUMscUJBQXFCO1FBS3JDLFVBQUssR0FBa0MsRUFBRSxDQUFDO1FBRTdDLG9CQUFlLEdBQVcsU0FBUyxDQUFDO0lBSTNDLENBQUM7SUFFRCxtQkFBbUI7UUFDZixPQUFPO1lBQ0gsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBQyxhQUFhLENBQUM7WUFDM0MsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBQyxhQUFhLENBQUM7WUFDekMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBQyxhQUFhLENBQUM7WUFDN0MsTUFBTSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBQyxhQUFhLENBQUM7U0FDbEQsQ0FBQztJQUNOLENBQUM7SUFFTSxJQUFJO1FBQ1AsSUFBRyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUk7WUFBRSxPQUFPO1FBQ2pDLElBQUks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QU07Z0JBQ0gsSUFBSSxDQUFDLFFBQVEsR0FBMkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUMxRSxFQUFFLEVBQUUsR0FBRztvQkFDUCxFQUFFLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJO29CQUNuQixFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJO29CQUN2QixFQUFFLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJO2lCQUN0QixDQUFDLENBQUM7Z0JBRUgsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7b0JBQ2QsTUFBTSxFQUFFLE1BQU07b0JBQ2QsY0FBYyxFQUFFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSTtpQkFDMUMsQ0FBQyxDQUFDO2FBRU47U0FDSjtJQU1MLENBQUM7O0FBblFhLHNCQUFPLEdBQVcsSUFBSSxHQUFDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpYWdyYW1Vbml0Q20sIERpYWdyYW0gfSBmcm9tIFwiLi9EaWFncmFtLmpzXCI7IFxyXG5pbXBvcnQgeyBSZWN0YW5nbGUgfSBmcm9tIFwiLi9jbGFzc2RpYWdyYW0vUm91dGVyLmpzXCI7XHJcblxyXG5leHBvcnQgZW51bSBBbGlnbm1lbnQge1xyXG4gICAgbGVmdCwgY2VudGVyLCByaWdodFxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBUZXh0TGluZSA9IHtcclxuICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgdGV4dDogc3RyaW5nLFxyXG4gICAgdG9vbHRpcD86IHN0cmluZyxcclxuICAgIGFsaWdubWVudD86IEFsaWdubWVudCxcclxuICAgIGJvbGQ/OiBib29sZWFuLFxyXG4gICAgaXRhbGljcz86IGJvb2xlYW4sXHJcbiAgICB0ZXh0SGVpZ2h0Q20/OiBudW1iZXIsXHJcbiAgICB0ZXh0V2lkdGhDbT86IG51bWJlcixcclxuICAgIHlDbT86IG51bWJlclxyXG4gICAgJGVsZW1lbnQ/OiBKUXVlcnk8U1ZHVGV4dEVsZW1lbnQ+LFxyXG4gICAgb25DbGljaz86ICgpID0+IHZvaWRcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgSG9yaXpvbnRhbExpbmUgPSB7XHJcbiAgICB0eXBlOiBcImxpbmVcIixcclxuICAgICRlbGVtZW50PzogSlF1ZXJ5PFNWR0xpbmVFbGVtZW50PixcclxuICAgIHRoaWNrbmVzc0NtOiBudW1iZXIsXHJcbiAgICB5Q20/OiBudW1iZXJcclxufVxyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIERpYWdyYW1FbGVtZW50IHtcclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGNtUGVyUHg6IG51bWJlciA9IDIuNTQvOTY7XHJcblxyXG4gICAgcHVibGljICRlbGVtZW50OiBKUXVlcnk8RWxlbWVudD47XHJcblxyXG4gICAgcHVibGljIGxlZnRDbTogbnVtYmVyID0gMDsgLy8geC1Lb29yZGluYXRlIGluIGNtXHJcbiAgICBwdWJsaWMgdG9wQ206IG51bWJlciA9IDA7IC8vIHktS29vcmRpbmF0ZSBpbiBjbVxyXG4gXHJcbiAgICBwdWJsaWMgd2lkdGhDbTogbnVtYmVyO1xyXG4gICAgcHVibGljIGhlaWdodENtOiBudW1iZXI7IFxyXG5cclxuICAgIHByb3RlY3RlZCBsaW5lczogKFRleHRMaW5lIHwgSG9yaXpvbnRhbExpbmUpW10gPSBbXTtcclxuXHJcbiAgICBwdWJsaWMgYmFja2dyb3VuZENvbG9yOiBzdHJpbmcgPSBcIiNmZmZmZmZcIjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcGFyZW50OiBFbGVtZW50KSB7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGdldFJvdXRpbmdSZWN0YW5nbGUoKTogUmVjdGFuZ2xle1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGxlZnQ6IE1hdGgucm91bmQodGhpcy5sZWZ0Q20vRGlhZ3JhbVVuaXRDbSksXHJcbiAgICAgICAgICAgIHRvcDogTWF0aC5yb3VuZCh0aGlzLnRvcENtL0RpYWdyYW1Vbml0Q20pLFxyXG4gICAgICAgICAgICB3aWR0aDogTWF0aC5yb3VuZCh0aGlzLndpZHRoQ20vRGlhZ3JhbVVuaXRDbSksXHJcbiAgICAgICAgICAgIGhlaWdodDogTWF0aC5yb3VuZCh0aGlzLmhlaWdodENtL0RpYWdyYW1Vbml0Q20pIFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNob3coKXtcclxuICAgICAgICBpZih0aGlzLiRlbGVtZW50ID09IG51bGwpIHJldHVybjtcclxuICAgICAgICB0aGlzLiRlbGVtZW50LnNob3coKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaGlkZSgpe1xyXG4gICAgICAgIGlmKHRoaXMuJGVsZW1lbnQgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIHRoaXMuJGVsZW1lbnQuaGlkZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGRldGFjaCgpIHtcclxuICAgICAgICBpZih0aGlzLiRlbGVtZW50ID09IG51bGwpIHJldHVybjtcclxuICAgICAgICB0aGlzLiRlbGVtZW50LmRldGFjaCgpOyAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKCkge1xyXG4gICAgICAgIGlmKHRoaXMuJGVsZW1lbnQgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIHRoaXMuJGVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgdGhpcy4kZWxlbWVudCA9IG51bGw7ICAgICAgICBcclxuICAgIH1cclxuXHJcbiAgICBhcHBlbmRUbygkZWxlbWVudDogSlF1ZXJ5PEVsZW1lbnQ+KXtcclxuICAgICAgICAkZWxlbWVudC5hcHBlbmQodGhpcy4kZWxlbWVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsZWFyKCl7XHJcbiAgICAgICAgaWYodGhpcy4kZWxlbWVudCA9PSBudWxsKSByZXR1cm47XHJcbiAgICAgICAgdGhpcy4kZWxlbWVudC5lbXB0eSgpO1xyXG4gICAgICAgIHRoaXMubGluZXMgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbW92ZSh4Q206IG51bWJlciwgeUNtOiBudW1iZXIsIHdpdGhSYXN0ZXI6IGJvb2xlYW4sIGFkanVzdFRvUmFzdGVyOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgICAgICB0aGlzLmxlZnRDbSArPSB4Q207XHJcbiAgICAgICAgdGhpcy50b3BDbSArPSB5Q207XHJcblxyXG4gICAgICAgIGxldCB4ID0gdGhpcy5sZWZ0Q207XHJcbiAgICAgICAgbGV0IHkgPSB0aGlzLnRvcENtO1xyXG5cclxuICAgICAgICBpZih3aXRoUmFzdGVyKXtcclxuICAgICAgICAgICAgeCA9IE1hdGgucm91bmQoeC9EaWFncmFtVW5pdENtKSpEaWFncmFtVW5pdENtO1xyXG4gICAgICAgICAgICB5ID0gTWF0aC5yb3VuZCh5L0RpYWdyYW1Vbml0Q20pKkRpYWdyYW1Vbml0Q207XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZihhZGp1c3RUb1Jhc3Rlcil7XHJcbiAgICAgICAgICAgIHRoaXMubGVmdENtID0geDtcclxuICAgICAgICAgICAgdGhpcy50b3BDbSA9IHk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBqUXVlcnkodGhpcy4kZWxlbWVudCkuY3NzKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgeCArIFwiY20sXCIgKyB5ICsgXCJjbSlcIik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG1vdmVUbyh4Q206IG51bWJlciwgeUNtOiBudW1iZXIsIHdpdGhSYXN0ZXI6IGJvb2xlYW4pIHtcclxuICAgICAgICB0aGlzLm1vdmUoeENtIC0gdGhpcy5sZWZ0Q20sIHlDbSAtIHRoaXMudG9wQ20sIHdpdGhSYXN0ZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjcmVhdGVFbGVtZW50KG5hbWU6IHN0cmluZywgcGFyZW50OiBFbGVtZW50ID0gbnVsbCwgYXR0cmlidXRlcz86XHJcbiAgICAgICAgeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSk6IEpRdWVyeTxFbGVtZW50PiB7XHJcblxyXG4gICAgICAgIGxldCBucyA9ICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc7XHJcbiAgICAgICAgbGV0ICRlbGVtZW50ID0galF1ZXJ5KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhucywgbmFtZSkpO1xyXG5cclxuICAgICAgICBpZihhdHRyaWJ1dGVzICE9IG51bGwpICRlbGVtZW50LmF0dHIoYXR0cmlidXRlcyk7XHJcblxyXG4gICAgICAgIGlmKHBhcmVudCAhPSBudWxsKSBwYXJlbnQuYXBwZW5kQ2hpbGQoJGVsZW1lbnRbMF0pO1xyXG5cclxuICAgICAgICByZXR1cm4gJGVsZW1lbnQ7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjcmVhdGVUZXh0RWxlbWVudCh0ZXh0OiBzdHJpbmcsIHBhcmVudDogRWxlbWVudCA9IG51bGwsIGF0dHJpYnV0ZXM/OlxyXG4gICAgICAgIHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0pOiBKUXVlcnk8RWxlbWVudD4ge1xyXG5cclxuICAgICAgICAgICAgbGV0ICRlbGVtZW50OiBKUXVlcnk8RWxlbWVudD4gPSB0aGlzLmNyZWF0ZUVsZW1lbnQoXCJ0ZXh0XCIsIHBhcmVudCwge1xyXG4gICAgICAgICAgICAgICAgZm9udDogXCIxNnB4IFJvYm90b1wiLFxyXG4gICAgICAgICAgICAgICAgXCJmb250LWZhbWlseVwiOiBcInNhbnMtc2VyaWZcIixcclxuICAgICAgICAgICAgICAgIGZpbGw6IFwiIzAwMFwiLFxyXG4gICAgICAgICAgICAgICAgXCJhbGlnbm1lbnQtYmFzZWxpbmVcIjpcImhhbmdpbmdcIixcclxuICAgICAgICAgICAgICAgIFwiZG9taW5hbnQtYmFzZWxpbmVcIjpcImhhbmdpbmdcIlxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmKGF0dHJpYnV0ZXMgIT0gbnVsbCkgJGVsZW1lbnQuYXR0cihhdHRyaWJ1dGVzKTtcclxuXHJcbiAgICAgICAgICAgICRlbGVtZW50LnRleHQodGV4dCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gJGVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFRleHRNZXRyaWNzKHRleHRFbGVtZW50OiBKUXVlcnk8U1ZHVGV4dEVsZW1lbnQ+KTp7aGVpZ2h0OiBudW1iZXIsIHdpZHRoOiBudW1iZXJ9e1xyXG4gICAgICAgIGxldCBiYm94OkRPTVJlY3QgPSB0ZXh0RWxlbWVudFswXS5nZXRCQm94KCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaGVpZ2h0OiBiYm94LmhlaWdodCAqIERpYWdyYW1FbGVtZW50LmNtUGVyUHgsXHJcbiAgICAgICAgICAgIHdpZHRoOiBiYm94LndpZHRoICogRGlhZ3JhbUVsZW1lbnQuY21QZXJQeFxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFkZFRleHRMaW5lKGxpbmU6IFRleHRMaW5lIHwgSG9yaXpvbnRhbExpbmUpe1xyXG5cclxuICAgICAgICB0aGlzLmxpbmVzLnB1c2gobGluZSk7XHJcblxyXG4gICAgICAgIGlmKGxpbmUudHlwZSA9PSBcInRleHRcIil7XHJcbiAgICAgICAgICAgIGlmKGxpbmUuYWxpZ25tZW50ID09IG51bGwpIGxpbmUuYWxpZ25tZW50ID0gQWxpZ25tZW50LmxlZnQ7XHJcbiAgICAgICAgICAgIGlmKGxpbmUuYm9sZCA9PSBudWxsKSBsaW5lLmJvbGQgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYobGluZS5pdGFsaWNzID09IG51bGwpIGxpbmUuaXRhbGljcyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlbmRlcigpe1xyXG5cclxuICAgICAgICBsZXQgJGdyb3VwID0gdGhpcy4kZWxlbWVudDtcclxuICAgICAgICBpZigkZ3JvdXAgPT0gbnVsbCl7XHJcbiAgICAgICAgICAgICRncm91cCA9IHRoaXMuY3JlYXRlRWxlbWVudChcImdcIiwgdGhpcy5wYXJlbnQpO1xyXG4gICAgICAgICAgICAkZ3JvdXAuYWRkQ2xhc3MoXCJzdmdfZHJhZ2dhYmxlXCIpO1xyXG4gICAgICAgICAgICAkZ3JvdXAuYWRkQ2xhc3MoXCJzdmdfYWxsX3BvaW50ZXJfZXZlbnRzXCIpO1xyXG4gICAgICAgICAgICB0aGlzLiRlbGVtZW50ID0gJGdyb3VwO1xyXG4gICAgICAgICAgICBqUXVlcnkodGhpcy4kZWxlbWVudCkuY3NzKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgdGhpcy5sZWZ0Q20gKyBcImNtLFwiICsgdGhpcy50b3BDbSArIFwiY20pXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0ICRyZWN0ID0gdGhpcy5jcmVhdGVFbGVtZW50KFwicmVjdFwiLCAkZ3JvdXBbMF0pO1xyXG5cclxuICAgICAgICBsZXQgdGV4dFBvc1lDbTogbnVtYmVyID0gMC4xO1xyXG4gICAgICAgIGxldCBtYXhXaWR0aENtOiBudW1iZXIgPSAwO1xyXG5cclxuICAgICAgICBsZXQgZmlyc3Q6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgICAgIGZvcihsZXQgbGluZSBvZiB0aGlzLmxpbmVzKXtcclxuICAgICAgICAgICAgaWYobGluZS50eXBlID09IFwidGV4dFwiKXtcclxuICAgICAgICAgICAgICAgIGlmKGZpcnN0KSB0ZXh0UG9zWUNtICs9IDAuMTtcclxuICAgICAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBsaW5lLnlDbSA9IHRleHRQb3NZQ207XHJcbiAgICAgICAgICAgICAgICBsaW5lLiRlbGVtZW50ID0gPEpRdWVyeTxTVkdUZXh0RWxlbWVudD4+dGhpcy5jcmVhdGVUZXh0RWxlbWVudChsaW5lLnRleHQsICRncm91cFswXSwge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiZm9udC13ZWlnaHRcIiA6IGxpbmUuYm9sZD9cImJvbGRcIjpcIm5vcm1hbFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiZm9udC1zaXplXCI6IFwiMTJwdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiZm9udC1zdHlsZVwiOiBsaW5lLml0YWxpY3M/XCJpdGFsaWNcIjpcIm5vcm1hbFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIFwidGV4dC1hbmNob3JcIjogbGluZS5hbGlnbm1lbnQgPT0gQWxpZ25tZW50LmxlZnQgPyBcInN0YXJ0XCIgOiBsaW5lLmFsaWdubWVudCA9PSBBbGlnbm1lbnQuY2VudGVyID8gXCJtaWRkbGVcIiA6IFwiZW5kXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgXCJjdXJzb3JcIjogbGluZS5vbkNsaWNrID09IG51bGwgPyBcIlwiIDogXCJwb2ludGVyXCJcclxuICAgICAgICAgICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsaW5lLiRlbGVtZW50LmNzcyhcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZSgwY20sMGNtKVwiKTtcclxuICAgICAgICAgICAgICAgIC8vIGxpbmUuJGVsZW1lbnQuY3NzKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKDBjbSxcIiArIHRleHRQb3NZQ20gKyBcImNtKVwiKTtcclxuICAgICAgICAgICAgICAgIC8vIGlmKGxpbmUub25DbGljayAhPSBudWxsKXtcclxuICAgICAgICAgICAgICAgIC8vICAgICBsaW5lLiRlbGVtZW50LmFkZENsYXNzKFwiY2xpY2thYmxlXCIpO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIGxpbmUuJGVsZW1lbnQub24oXCJtb3VzZWRvd25cIiwgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICBsaW5lLm9uQ2xpY2soKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgfSlcclxuICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgIGxldCBtZXRyaWNzID0gdGhpcy5nZXRUZXh0TWV0cmljcyhsaW5lLiRlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIGxpbmUudGV4dEhlaWdodENtID0gbWV0cmljcy5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICBsaW5lLnRleHRXaWR0aENtID0gbWV0cmljcy53aWR0aDtcclxuICAgICAgICAgICAgICAgIG1heFdpZHRoQ20gPSBNYXRoLm1heChtYXhXaWR0aENtLCBsaW5lLnRleHRXaWR0aENtKTtcclxuICAgICAgICAgICAgICAgIHRleHRQb3NZQ20gKz0gbGluZS50ZXh0SGVpZ2h0Q207XHJcbiAgICAgICAgICAgICAgICBpZihsaW5lLnRvb2x0aXAgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0ICR0b29sdGlwID0gdGhpcy5jcmVhdGVFbGVtZW50KFwidGl0bGVcIiwgbGluZS4kZWxlbWVudFswXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJHRvb2x0aXAudGV4dChsaW5lLnRvb2x0aXApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGluZS55Q20gPSB0ZXh0UG9zWUNtICsgbGluZS50aGlja25lc3NDbS8yO1xyXG4gICAgICAgICAgICAgICAgdGV4dFBvc1lDbSArPSBsaW5lLnRoaWNrbmVzc0NtICsgMC4xO1xyXG4gICAgICAgICAgICAgICAgZmlyc3QgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgd2lkdGggPSAyICogMC4wNSArIDIqMC4yICsgbWF4V2lkdGhDbTtcclxuICAgICAgICB0aGlzLndpZHRoQ20gPSAoTWF0aC50cnVuYyh3aWR0aC9EaWFncmFtVW5pdENtKSArIDEpKkRpYWdyYW1Vbml0Q207XHJcbiAgICAgICAgdGhpcy5oZWlnaHRDbSA9IChNYXRoLnRydW5jKHRleHRQb3NZQ20vRGlhZ3JhbVVuaXRDbSkgKyAxKSpEaWFncmFtVW5pdENtO1xyXG5cclxuICAgICAgICBsZXQgdGV4dExlZnQgPSAwLjA1ICsgMC4yO1xyXG4gICAgICAgIGxldCB0ZXh0Q2VudGVyID0gd2lkdGgvMjtcclxuICAgICAgICBsZXQgdGV4dFJpZ2h0ID0gd2lkdGggLSB0ZXh0TGVmdDtcclxuXHJcbiAgICAgICAgJHJlY3QuY3NzKHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMud2lkdGhDbSArIFwiY21cIixcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmhlaWdodENtICsgXCJjbVwiLFxyXG4gICAgICAgICAgICBmaWxsOiB0aGlzLmJhY2tncm91bmRDb2xvcixcclxuICAgICAgICAgICAgc3Ryb2tlOiBcIiMwMDBcIixcclxuICAgICAgICAgICAgXCJzdHJva2Utd2lkdGhcIjogXCIwLjA1Y21cIlxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgZm9yKGxldCBsaW5lIG9mIHRoaXMubGluZXMpe1xyXG4gICAgICAgICAgICBpZihsaW5lLnR5cGUgPT0gXCJ0ZXh0XCIpe1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCB4OiBudW1iZXI7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2gobGluZS5hbGlnbm1lbnQpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgQWxpZ25tZW50LmNlbnRlcjogeCA9IHRleHRDZW50ZXI7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgQWxpZ25tZW50LmxlZnQ6IHggPSB0ZXh0TGVmdDsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBBbGlnbm1lbnQucmlnaHQ6IHggPSB0ZXh0UmlnaHQ7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIFVuZm9ydHVuYXRlbHkgd2UgaGF2ZSB0byB3cmFwIFRleHQtRWxlbWVudHMgaW4gPGc+IGR1ZSB0byBhIGJ1ZyBpbiBzYWZhcmksXHJcbiAgICAgICAgICAgICAgICAvLyBzZWUgXHJcbiAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgIGxldCAkZyA9IHRoaXMuY3JlYXRlRWxlbWVudChcImdcIiwgJGdyb3VwWzBdKTtcclxuICAgICAgICAgICAgICAgICRnLmFwcGVuZChsaW5lLiRlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgbGluZS4kZWxlbWVudCA9ICRnO1xyXG5cclxuICAgICAgICAgICAgICAgIGxpbmUuJGVsZW1lbnQuY3NzKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgeCArIFwiY20sXCIrbGluZS55Q20gKyBcImNtKVwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZihsaW5lLm9uQ2xpY2sgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgbGluZS4kZWxlbWVudC5hZGRDbGFzcyhcImNsaWNrYWJsZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICBsaW5lLiRlbGVtZW50Lm9uKFwibW91c2Vkb3duXCIsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZS5vbkNsaWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxpbmUuJGVsZW1lbnQgPSA8SlF1ZXJ5PFNWR0xpbmVFbGVtZW50Pj50aGlzLmNyZWF0ZUVsZW1lbnQoXCJsaW5lXCIsICRncm91cFswXSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHgxOiBcIjBcIixcclxuICAgICAgICAgICAgICAgICAgICB5MTogbGluZS55Q20gKyBcImNtXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgeDI6IHRoaXMud2lkdGhDbSArIFwiY21cIixcclxuICAgICAgICAgICAgICAgICAgICB5MjogbGluZS55Q20gKyBcImNtXCJcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGxpbmUuJGVsZW1lbnQuY3NzKHtcclxuICAgICAgICAgICAgICAgICAgICBzdHJva2U6IFwiIzAwMFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIFwic3Ryb2tlLXdpZHRoXCI6IGxpbmUudGhpY2tuZXNzQ20gKyBcImNtXCIgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgXHJcblxyXG5cclxuICAgIH1cclxuXHJcblxyXG59XHJcblxyXG4iXX0=