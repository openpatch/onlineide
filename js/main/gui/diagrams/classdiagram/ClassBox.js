import { DiagramElement, Alignment } from "../DiagramElement.js";
import { Klass, Visibility, Interface } from "../../../../compiler/types/Class.js";
import { getDeclarationAsString, getTypeIdentifier } from "../../../../compiler/types/DeclarationHelper.js";
import { hash } from "../../../../tools/StringTools.js";
export class ClassBox extends DiagramElement {
    constructor(diagram, leftCm, topCm, klass) {
        super(diagram.svgElement);
        this.diagram = diagram;
        this.active = true;
        this.withMethods = true;
        this.withAttributes = true;
        this.klass = klass;
        if (klass != null) {
            this.attachToClass(this.klass);
            this.isSystemClass = klass.module.isSystemModule;
            this.withAttributes = false; //!this.isSystemClass;
            this.withMethods = false; // !this.isSystemClass;
        }
        this.moveTo(leftCm, topCm, true);
    }
    serialize() {
        return {
            className: this.className,
            filename: this.filename,
            hashedSignature: this.hashedSignature,
            withAttributes: this.withAttributes,
            withMethods: this.withMethods,
            isSystemClass: this.isSystemClass,
            leftCm: this.leftCm,
            topCm: this.topCm
        };
    }
    static deserialize(diagram, scb) {
        let cb = new ClassBox(diagram, scb.leftCm, scb.topCm, null);
        cb.hashedSignature = scb.hashedSignature;
        cb.className = scb.className;
        cb.filename = scb.filename;
        cb.withAttributes = scb.withAttributes;
        cb.withMethods = scb.withMethods;
        cb.isSystemClass = scb.isSystemClass;
        return cb;
    }
    attachToClass(klass) {
        this.klass = klass;
        let klassSignature = this.getSignature(klass);
        if (this.className != klass.identifier || this.hashedSignature != klassSignature || this.widthCm < 0.7 || this.documentation != klass.documentation) {
            this.isSystemClass = klass.module.isSystemModule;
            this.renderLines();
        }
        else {
            this.addMouseEvents();
        }
        this.className = klass.identifier;
        this.filename = klass.module.file.name;
        this.hashedSignature = klassSignature;
        this.documentation = klass.documentation;
    }
    jumpToDeclaration(element) {
        this.diagram.main.jumpToDeclaration(this.klass.module, element.declaration);
    }
    renderLines() {
        this.clear();
        let parametersWithTypes = this.diagram.currentClassBoxes.parametersWithTypes;
        this.addTextLine({
            type: "text",
            text: (this.klass instanceof Interface ? "<<interface>> " : (this.klass.isAbstract ? "<<abstract>> " : "")) + this.klass.identifier,
            tooltip: getDeclarationAsString(this.klass, "", true),
            alignment: Alignment.center,
            bold: true,
            italics: this.klass instanceof Interface || this.klass.isAbstract,
            onClick: this.isSystemClass ? undefined : () => { this.jumpToDeclaration(this.klass); }
        });
        if (this.klass instanceof Klass && this.withAttributes) {
            this.addTextLine({
                type: "line",
                thicknessCm: 0.05
            });
            for (let a of this.klass.attributes) {
                let text = this.getVisibilityText(a.visibility) + getTypeIdentifier(a.type) + " " + a.identifier;
                this.addTextLine({
                    type: "text",
                    text: text,
                    tooltip: getDeclarationAsString(a),
                    alignment: Alignment.left,
                    onClick: this.isSystemClass ? undefined : () => { this.jumpToDeclaration(a); }
                });
            }
        }
        if (this.withMethods) {
            this.addTextLine({
                type: "line",
                thicknessCm: 0.05
            });
            this.klass.methods.filter(m => m.signature != "toJson()").forEach(m => {
                let text = this.getVisibilityText(m.visibility) + m.identifier + "()";
                if (parametersWithTypes) {
                    let returnType = m.isConstructor ? "" :
                        (m.returnType == null ? "void " : getTypeIdentifier(m.returnType) + " ");
                    text = this.getVisibilityText(m.visibility) + returnType + m.identifier + "(" +
                        m.parameterlist.parameters.map((p) => { return getTypeIdentifier(p.type) + " " + p.identifier; }).join(", ") + ")";
                }
                this.addTextLine({
                    type: "text",
                    text: text,
                    tooltip: getDeclarationAsString(m),
                    alignment: Alignment.left,
                    italics: this.klass instanceof Interface || m.isAbstract,
                    onClick: this.isSystemClass ? undefined : () => { this.jumpToDeclaration(m); }
                });
            });
        }
        this.backgroundColor = this.isSystemClass ? "#aaaaaa" : "#ffffff";
        this.render();
        this.$dropdownTriangle = this.createElement("path", this.$element[0], {
            d: this.getTrianglePath(),
            class: "dropdown-triangle",
            style: "transform: " + "translate(" + (this.widthCm - 0.35) + "cm,0.05cm)",
        });
        this.addMouseEvents();
    }
    getTrianglePath() {
        if (this.withMethods) {
            return "M 0 8 L 11 8 L 5.5 2 L 0 8";
        }
        else {
            return "M 0 2 L 11 2 L 5.5 8 L 0 2";
        }
        // if (this.withMethods) {
        //     return "M 3 6 L 11 6 L 7 2 L 3 6";
        // } else {
        //     return "M 3 2 L 11 2 L 7 6 L 3 2";
        // }
    }
    detach() {
        var _a;
        (_a = this.$element) === null || _a === void 0 ? void 0 : _a.off('mousedown.diagramElement');
        jQuery(document).off('mouseup.diagramElement');
        jQuery(document).off('mousemove.diagramElement');
        super.detach();
    }
    addMouseEvents() {
        let that = this;
        if (this.$dropdownTriangle != null) {
            this.$dropdownTriangle.off("mouseup.dropdowntriangle");
            this.$dropdownTriangle.off("mousedown.dropdowntriangle");
        }
        this.$dropdownTriangle.on("mousedown.dropdowntriangle", (e) => {
            e.stopPropagation();
        });
        this.$dropdownTriangle.on("mouseup.dropdowntriangle", (e) => {
            e.stopPropagation();
            this.withMethods = !this.withMethods;
            this.withAttributes = !this.withAttributes;
            this.$dropdownTriangle.attr("d", this.getTrianglePath());
            this.renderLines();
            this.diagram.adjustClassDiagramSize();
            this.diagram.updateArrows();
        });
        this.$element.on('mousedown.diagramElement', (event) => {
            event.stopPropagation();
            event.stopImmediatePropagation();
            if (event.button != 0)
                return;
            let x = event.screenX;
            let y = event.screenY;
            that.$element.find('rect').addClass('dragging');
            jQuery(document).off('mouseup.diagramElement');
            jQuery(document).off('mousemove.diagramElement');
            jQuery(document).on('mousemove.diagramElement', (event) => {
                let cmPerPixel = 1 / 96 * 2.36 / this.diagram.zoomfactor;
                let dx = (event.screenX - x) * cmPerPixel;
                let dy = (event.screenY - y) * cmPerPixel;
                x = event.screenX;
                y = event.screenY;
                that.move(dx, dy, true);
                clearTimeout(that.inDebounce);
                that.inDebounce = setTimeout(() => {
                    let classDiagram = that.diagram;
                    classDiagram.updateArrows();
                }, 200);
            });
            jQuery(document).on('mouseup.diagramElement', () => {
                that.move(0, 0, true, true);
                let classDiagram = that.diagram;
                classDiagram.adjustClassDiagramSize();
                classDiagram.updateArrows();
                that.$element.find('rect').removeClass('dragging');
                jQuery(document).off('mouseup.diagramElement');
                jQuery(document).off('mousemove.diagramElement');
                classDiagram.dirty = true;
            });
        });
    }
    getVisibilityText(visibility) {
        switch (visibility) {
            case Visibility.private: return "-";
            case Visibility.protected: return "#";
            case Visibility.public: return "+";
        }
    }
    getSignature(klass) {
        let s = "";
        if (klass instanceof Klass && this.withAttributes && klass.attributes.length > 0) {
            for (let a of klass.attributes)
                s += this.getVisibilityText(a.visibility) + a.type.identifier + " " + a.identifier;
        }
        if (this.withMethods && klass.methods.length > 0) {
            for (let m of klass.methods) {
                if (m.isConstructor)
                    continue;
                let rt = m.returnType == null ? "void" : m.returnType.identifier;
                s += this.getVisibilityText(m.visibility) + rt + " " + m.identifier + "(" +
                    m.parameterlist.parameters.map((p) => { return p.type.identifier + " " + p.identifier; }).join(", ") + ")";
            }
        }
        return hash(s);
    }
    hasSignatureAndFileOf(klass) {
        return klass.module.file.name == this.filename &&
            this.getSignature(klass) == this.hashedSignature;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xhc3NCb3guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L21haW4vZ3VpL2RpYWdyYW1zL2NsYXNzZGlhZ3JhbS9DbGFzc0JveC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ25GLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBSzVHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQWV4RCxNQUFNLE9BQU8sUUFBUyxTQUFRLGNBQWM7SUFpQnhDLFlBQW1CLE9BQWdCLEVBQUUsTUFBYyxFQUFFLEtBQWEsRUFBRSxLQUF3QjtRQUN4RixLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRFgsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQVZuQyxXQUFNLEdBQVksSUFBSSxDQUFDO1FBQ3ZCLGdCQUFXLEdBQVksSUFBSSxDQUFDO1FBQzVCLG1CQUFjLEdBQVksSUFBSSxDQUFDO1FBVzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtZQUNmLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUM7WUFDakQsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUMsQ0FBQyxzQkFBc0I7WUFDbkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsQ0FBQyx1QkFBdUI7U0FDcEQ7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFD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RyxHQUFHLEdBQUcsQ0FBQyxDQUFDLFVBQVUsR0FBRyxHQUFHO29CQUNyRSxDQUFDLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDO2FBQ2pIO1NBQ0o7UUFFRCxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVuQixDQUFDO0lBRUQscUJBQXFCLENBQUMsS0FBd0I7UUFDMUMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVE7WUFDMUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQ3pELENBQUM7Q0FJSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpYWdyYW1FbGVtZW50LCBBbGlnbm1lbnQgfSBmcm9tIFwiLi4vRGlhZ3JhbUVsZW1lbnQuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MsIFZpc2liaWxpdHksIEludGVyZmFjZSB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21waWxlci90eXBlcy9DbGFzcy5qc1wiO1xyXG5pbXBvcnQgeyBnZXREZWNsYXJhdGlvbkFzU3RyaW5nLCBnZXRUeXBlSWRlbnRpZmllciB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21waWxlci90eXBlcy9EZWNsYXJhdGlvbkhlbHBlci5qc1wiO1xyXG5pbXBvcnQgeyBEaWFncmFtIH0gZnJvbSBcIi4uL0RpYWdyYW0uanNcIjtcclxuaW1wb3J0IHsgUG9pbnQgfSBmcm9tIFwiLi9Sb3V0ZXIuanNcIjtcclxuaW1wb3J0IHsgQ2xhc3NEaWFncmFtIH0gZnJvbSBcIi4vQ2xhc3NEaWFncmFtLmpzXCI7XHJcbmltcG9ydCB7IFRleHRMaW5lIH0gZnJvbSBcIi4uL0RpYWdyYW1FbGVtZW50LmpzXCI7XHJcbmltcG9ydCB7IGhhc2ggfSBmcm9tIFwiLi4vLi4vLi4vLi4vdG9vbHMvU3RyaW5nVG9vbHMuanNcIjtcclxuaW1wb3J0IHsgTWV0aG9kLCBBdHRyaWJ1dGUgfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tcGlsZXIvdHlwZXMvVHlwZXMuanNcIjtcclxuXHJcbmV4cG9ydCB0eXBlIFNlcmlhbGl6ZWRDbGFzc0JveCA9IHtcclxuICAgIGNsYXNzTmFtZTogc3RyaW5nLFxyXG4gICAgZmlsZW5hbWU6IHN0cmluZyxcclxuICAgIGhhc2hlZFNpZ25hdHVyZTogbnVtYmVyLFxyXG4gICAgd2l0aE1ldGhvZHM6IGJvb2xlYW4sXHJcbiAgICB3aXRoQXR0cmlidXRlczogYm9vbGVhbixcclxuICAgIGxlZnRDbTogbnVtYmVyLFxyXG4gICAgdG9wQ206IG51bWJlcixcclxuICAgIGlzU3lzdGVtQ2xhc3M6IGJvb2xlYW4sXHJcbiAgICB3b3Jrc3BhY2VJZD86IG51bWJlclxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQ2xhc3NCb3ggZXh0ZW5kcyBEaWFncmFtRWxlbWVudCB7XHJcblxyXG4gICAgY2xhc3NOYW1lOiBzdHJpbmc7XHJcbiAgICBrbGFzczogS2xhc3MgfCBJbnRlcmZhY2U7XHJcbiAgICBmaWxlbmFtZTogc3RyaW5nO1xyXG4gICAgaGFzaGVkU2lnbmF0dXJlOiBudW1iZXI7XHJcbiAgICBkb2N1bWVudGF0aW9uOiBzdHJpbmc7XHJcbiAgICBhY3RpdmU6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgd2l0aE1ldGhvZHM6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgd2l0aEF0dHJpYnV0ZXM6IGJvb2xlYW4gPSB0cnVlO1xyXG5cclxuICAgIGluRGVib3VuY2U6IGFueTtcclxuXHJcbiAgICBpc1N5c3RlbUNsYXNzOiBib29sZWFuO1xyXG5cclxuICAgICRkcm9wZG93blRyaWFuZ2xlOiBKUXVlcnk8RWxlbWVudD47XHJcblxyXG4gICAgY29uc3RydWN0b3IocHVibGljIGRpYWdyYW06IERpYWdyYW0sIGxlZnRDbTogbnVtYmVyLCB0b3BDbTogbnVtYmVyLCBrbGFzczogS2xhc3MgfCBJbnRlcmZhY2UpIHtcclxuICAgICAgICBzdXBlcihkaWFncmFtLnN2Z0VsZW1lbnQpO1xyXG5cclxuICAgICAgICB0aGlzLmtsYXNzID0ga2xhc3M7XHJcblxyXG4gICAgICAgIGlmIChrbGFzcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXR0YWNoVG9DbGFzcyh0aGlzLmtsYXNzKTtcclxuICAgICAgICAgICAgdGhpcy5pc1N5c3RlbUNsYXNzID0ga2xhc3MubW9kdWxlLmlzU3lzdGVtTW9kdWxlO1xyXG4gICAgICAgICAgICB0aGlzLndpdGhBdHRyaWJ1dGVzID0gZmFsc2U7IC8vIXRoaXMuaXNTeXN0ZW1DbGFzcztcclxuICAgICAgICAgICAgdGhpcy53aXRoTWV0aG9kcyA9IGZhbHNlOyAvLyAhdGhpcy5pc1N5c3RlbUNsYXNzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5tb3ZlVG8obGVmdENtLCB0b3BDbSwgdHJ1ZSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNlcmlhbGl6ZSgpOiBTZXJpYWxpemVkQ2xhc3NCb3gge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGNsYXNzTmFtZTogdGhpcy5jbGFzc05hbWUsXHJcbiAgICAgICAgICAgIGZpbGVuYW1lOiB0aGlzLmZpbGVuYW1lLFxyXG4gICAgICAgICAgICBoYXNoZWRTaWduYXR1cmU6IHRoaXMuaGFzaGVkU2lnbmF0dXJlLFxyXG4gICAgICAgICAgICB3aXRoQXR0cmlidXRlczogdGhpcy53aXRoQXR0cmlidXRlcyxcclxuICAgICAgICAgICAgd2l0aE1ldGhvZHM6IHRoaXMud2l0aE1ldGhvZHMsXHJcbiAgICAgICAgICAgIGlzU3lzdGVtQ2xhc3M6IHRoaXMuaXNTeXN0ZW1DbGFzcyxcclxuICAgICAgICAgICAgbGVmdENtOiB0aGlzLmxlZnRDbSxcclxuICAgICAgICAgICAgdG9wQ206IHRoaXMudG9wQ21cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGRlc2VyaWFsaXplKGRpYWdyYW06IERpYWdyYW0sIHNjYjogU2VyaWFsaXplZENsYXNzQm94KTogQ2xhc3NCb3gge1xyXG5cclxuICAgICAgICBsZXQgY2IgPSBuZXcgQ2xhc3NCb3goZGlhZ3JhbSwgc2NiLmxlZnRDbSwgc2NiLnRvcENtLCBudWxsKTtcclxuICAgICAgICBjYi5oYXNoZWRTaWduYXR1cmUgPSBzY2IuaGFzaGVkU2lnbmF0dXJlO1xyXG4gICAgICAgIGNiLmNsYXNzTmFtZSA9IHNjYi5jbGFzc05hbWU7XHJcbiAgICAgICAgY2IuZmlsZW5hbWUgPSBzY2IuZmlsZW5hbWU7XHJcbiAgICAgICAgY2Iud2l0aEF0dHJpYnV0ZXMgPSBzY2Iud2l0aEF0dHJpYnV0ZXM7XHJcbiAgICAgICAgY2Iud2l0aE1ldGhvZHMgPSBzY2Iud2l0aE1ldGhvZHM7XHJcbiAgICAgICAgY2IuaXNTeXN0ZW1DbGFzcyA9IHNjYi5pc1N5c3RlbUNsYXNzO1xyXG5cclxuICAgICAgICByZXR1cm4gY2I7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGF0dGFjaFRvQ2xhc3Moa2xhc3M6IEtsYXNzIHwgSW50ZXJmYWNlKSB7XHJcblxyXG4gICAgICAgIHRoaXMua2xhc3MgPSBrbGFzcztcclxuICAgICAgICBsZXQga2xhc3NTaWduYXR1cmU6IG51bWJlciA9IHRoaXMuZ2V0U2lnbmF0dXJlKGtsYXNzKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lICE9IGtsYXNzLmlkZW50aWZpZXIgfHwgdGhpcy5oYXNoZWRTaWduYXR1cmUgIT0ga2xhc3NTaWduYXR1cmUgfHwgdGhpcy53aWR0aENtIDwgMC43IHx8IHRoaXMuZG9jdW1lbnRhdGlvbiAhPSBrbGFzcy5kb2N1bWVudGF0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNTeXN0ZW1DbGFzcyA9IGtsYXNzLm1vZHVsZS5pc1N5c3RlbU1vZHVsZTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJMaW5lcygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkTW91c2VFdmVudHMoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuY2xhc3NOYW1lID0ga2xhc3MuaWRlbnRpZmllcjtcclxuICAgICAgICB0aGlzLmZpbGVuYW1lID0ga2xhc3MubW9kdWxlLmZpbGUubmFtZTtcclxuICAgICAgICB0aGlzLmhhc2hlZFNpZ25hdHVyZSA9IGtsYXNzU2lnbmF0dXJlO1xyXG4gICAgICAgIHRoaXMuZG9jdW1lbnRhdGlvbiA9IGtsYXNzLmRvY3VtZW50YXRpb247XHJcbiAgICB9XHJcblxyXG4gICAganVtcFRvRGVjbGFyYXRpb24oZWxlbWVudDogS2xhc3MgfCBJbnRlcmZhY2UgfCBNZXRob2QgfCBBdHRyaWJ1dGUpIHtcclxuICAgICAgICB0aGlzLmRpYWdyYW0ubWFpbi5qdW1wVG9EZWNsYXJhdGlvbih0aGlzLmtsYXNzLm1vZHVsZSwgZWxlbWVudC5kZWNsYXJhdGlvbik7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJlbmRlckxpbmVzKCkge1xyXG5cclxuICAgICAgICB0aGlzLmNsZWFyKCk7XHJcblxyXG4gICAgICAgIGxldCBwYXJhbWV0ZXJzV2l0aFR5cGVzID0gKDxDbGFzc0RpYWdyYW0+dGhpcy5kaWFncmFtKS5jdXJyZW50Q2xhc3NCb3hlcy5wYXJhbWV0ZXJzV2l0aFR5cGVzO1xyXG5cclxuICAgICAgICB0aGlzLmFkZFRleHRMaW5lKHtcclxuICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgIHRleHQ6ICh0aGlzLmtsYXNzIGluc3RhbmNlb2YgSW50ZXJmYWNlID8gXCI8PGludGVyZmFjZT4+IFwiIDogKCB0aGlzLmtsYXNzLmlzQWJzdHJhY3QgPyBcIjw8YWJzdHJhY3Q+PiBcIiA6IFwiXCIpKSArIHRoaXMua2xhc3MuaWRlbnRpZmllcixcclxuICAgICAgICAgICAgdG9vbHRpcDogZ2V0RGVjbGFyYXRpb25Bc1N0cmluZyh0aGlzLmtsYXNzLCBcIlwiLCB0cnVlKSxcclxuICAgICAgICAgICAgYWxpZ25tZW50OiBBbGlnbm1lbnQuY2VudGVyLFxyXG4gICAgICAgICAgICBib2xkOiB0cnVlLFxyXG4gICAgICAgICAgICBpdGFsaWNzOiB0aGlzLmtsYXNzIGluc3RhbmNlb2YgSW50ZXJmYWNlIHx8IHRoaXMua2xhc3MuaXNBYnN0cmFjdCxcclxuICAgICAgICAgICAgb25DbGljazogdGhpcy5pc1N5c3RlbUNsYXNzID8gdW5kZWZpbmVkIDogKCkgPT4geyB0aGlzLmp1bXBUb0RlY2xhcmF0aW9uKHRoaXMua2xhc3MpIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMua2xhc3MgaW5zdGFuY2VvZiBLbGFzcyAmJiB0aGlzLndpdGhBdHRyaWJ1dGVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkVGV4dExpbmUoe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJsaW5lXCIsXHJcbiAgICAgICAgICAgICAgICB0aGlja25lc3NDbTogMC4wNVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZm9yIChsZXQgYSBvZiB0aGlzLmtsYXNzLmF0dHJpYnV0ZXMpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgdGV4dDogc3RyaW5nID0gdGhpcy5nZXRWaXNpYmlsaXR5VGV4dChhLnZpc2liaWxpdHkpICsgZ2V0VHlwZUlkZW50aWZpZXIoYS50eXBlKSArIFwiIFwiICsgIGEuaWRlbnRpZmllcjtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZFRleHRMaW5lKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0ZXh0LFxyXG4gICAgICAgICAgICAgICAgICAgIHRvb2x0aXA6IGdldERlY2xhcmF0aW9uQXNTdHJpbmcoYSksXHJcbiAgICAgICAgICAgICAgICAgICAgYWxpZ25tZW50OiBBbGlnbm1lbnQubGVmdCxcclxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiB0aGlzLmlzU3lzdGVtQ2xhc3MgPyB1bmRlZmluZWQgOiAoKSA9PiB7IHRoaXMuanVtcFRvRGVjbGFyYXRpb24oYSkgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLndpdGhNZXRob2RzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkVGV4dExpbmUoe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJsaW5lXCIsXHJcbiAgICAgICAgICAgICAgICB0aGlja25lc3NDbTogMC4wNVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5rbGFzcy5tZXRob2RzLmZpbHRlcihtID0+IG0uc2lnbmF0dXJlICE9IFwidG9Kc29uKClcIikuZm9yRWFjaChtID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCB0ZXh0OiBzdHJpbmcgPSB0aGlzLmdldFZpc2liaWxpdHlUZXh0KG0udmlzaWJpbGl0eSkgKyBtLmlkZW50aWZpZXIgKyBcIigpXCI7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlcnNXaXRoVHlwZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcmV0dXJuVHlwZTogc3RyaW5nID0gbS5pc0NvbnN0cnVjdG9yID8gXCJcIiA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChtLnJldHVyblR5cGUgPT0gbnVsbCA/IFwidm9pZCBcIiA6IGdldFR5cGVJZGVudGlmaWVyKG0ucmV0dXJuVHlwZSkgKyBcIiBcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRoaXMuZ2V0VmlzaWJpbGl0eVRleHQobS52aXNpYmlsaXR5KSArIHJldHVyblR5cGUgKyBtLmlkZW50aWZpZXIgKyBcIihcIiArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG0ucGFyYW1ldGVybGlzdC5wYXJhbWV0ZXJzLm1hcCgocCkgPT4geyByZXR1cm4gZ2V0VHlwZUlkZW50aWZpZXIocC50eXBlKSArIFwiIFwiICsgcC5pZGVudGlmaWVyIH0pLmpvaW4oXCIsIFwiKSArIFwiKVwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkVGV4dExpbmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcDogZ2V0RGVjbGFyYXRpb25Bc1N0cmluZyhtKSxcclxuICAgICAgICAgICAgICAgICAgICBhbGlnbm1lbnQ6IEFsaWdubWVudC5sZWZ0LFxyXG4gICAgICAgICAgICAgICAgICAgIGl0YWxpY3M6IHRoaXMua2xhc3MgaW5zdGFuY2VvZiBJbnRlcmZhY2UgfHwgbS5pc0Fic3RyYWN0LFxyXG4gICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMuaXNTeXN0ZW1DbGFzcyA/IHVuZGVmaW5lZCA6ICgpID0+IHsgdGhpcy5qdW1wVG9EZWNsYXJhdGlvbihtKSB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5iYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLmlzU3lzdGVtQ2xhc3MgPyBcIiNhYWFhYWFcIiA6IFwiI2ZmZmZmZlwiO1xyXG4gICAgICAgIHRoaXMucmVuZGVyKCk7XHJcblxyXG4gICAgICAgIHRoaXMuJGRyb3Bkb3duVHJpYW5nbGUgPSB0aGlzLmNyZWF0ZUVsZW1lbnQoXCJwYXRoXCIsIHRoaXMuJGVsZW1lbnRbMF0sIHtcclxuICAgICAgICAgICAgZDogdGhpcy5nZXRUcmlhbmdsZVBhdGgoKSxcclxuICAgICAgICAgICAgY2xhc3M6IFwiZHJvcGRvd24tdHJpYW5nbGVcIixcclxuICAgICAgICAgICAgc3R5bGU6IFwidHJhbnNmb3JtOiBcIiArIFwidHJhbnNsYXRlKFwiICsgKHRoaXMud2lkdGhDbSAtIDAuMzUpICsgXCJjbSwwLjA1Y20pXCIsIC8vICsgKDxUZXh0TGluZT50aGlzLmxpbmVzWzBdKS50ZXh0SGVpZ2h0Q20gKyBcImNtKVwiXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNb3VzZUV2ZW50cygpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFRyaWFuZ2xlUGF0aCgpIHtcclxuICAgICAgICBpZiAodGhpcy53aXRoTWV0aG9kcykge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJNIDAgOCBMIDExIDggTCA1LjUgMiBMIDAgOFwiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcIk0gMCAyIEwgMTEgMiBMIDUuNSA4IEwgMCAyXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGlmICh0aGlzLndpdGhNZXRob2RzKSB7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiBcIk0gMyA2IEwgMTEgNiBMIDcgMiBMIDMgNlwiO1xyXG4gICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiBcIk0gMyAyIEwgMTEgMiBMIDcgNiBMIDMgMlwiO1xyXG4gICAgICAgIC8vIH1cclxuICAgIH1cclxuXHJcbiAgICBkZXRhY2goKSB7XHJcbiAgICAgICAgdGhpcy4kZWxlbWVudD8ub2ZmKCdtb3VzZWRvd24uZGlhZ3JhbUVsZW1lbnQnKTtcclxuICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZignbW91c2V1cC5kaWFncmFtRWxlbWVudCcpO1xyXG4gICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZW1vdmUuZGlhZ3JhbUVsZW1lbnQnKTtcclxuICAgICAgICBzdXBlci5kZXRhY2goKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRNb3VzZUV2ZW50cygpIHtcclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLiRkcm9wZG93blRyaWFuZ2xlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy4kZHJvcGRvd25UcmlhbmdsZS5vZmYoXCJtb3VzZXVwLmRyb3Bkb3dudHJpYW5nbGVcIik7XHJcbiAgICAgICAgICAgIHRoaXMuJGRyb3Bkb3duVHJpYW5nbGUub2ZmKFwibW91c2Vkb3duLmRyb3Bkb3dudHJpYW5nbGVcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLiRkcm9wZG93blRyaWFuZ2xlLm9uKFwibW91c2Vkb3duLmRyb3Bkb3dudHJpYW5nbGVcIiwgKGUpID0+IHtcclxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLiRkcm9wZG93blRyaWFuZ2xlLm9uKFwibW91c2V1cC5kcm9wZG93bnRyaWFuZ2xlXCIsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgIHRoaXMud2l0aE1ldGhvZHMgPSAhdGhpcy53aXRoTWV0aG9kcztcclxuICAgICAgICAgICAgdGhpcy53aXRoQXR0cmlidXRlcyA9ICF0aGlzLndpdGhBdHRyaWJ1dGVzO1xyXG4gICAgICAgICAgICB0aGlzLiRkcm9wZG93blRyaWFuZ2xlLmF0dHIoXCJkXCIsIHRoaXMuZ2V0VHJpYW5nbGVQYXRoKCkpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlckxpbmVzKCk7XHJcbiAgICAgICAgICAgICg8Q2xhc3NEaWFncmFtPjxhbnk+dGhpcy5kaWFncmFtKS5hZGp1c3RDbGFzc0RpYWdyYW1TaXplKCk7XHJcbiAgICAgICAgICAgICg8Q2xhc3NEaWFncmFtPjxhbnk+dGhpcy5kaWFncmFtKS51cGRhdGVBcnJvd3MoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy4kZWxlbWVudC5vbignbW91c2Vkb3duLmRpYWdyYW1FbGVtZW50JywgKGV2ZW50OiBKUXVlcnkuTW91c2VEb3duRXZlbnQpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChldmVudC5idXR0b24gIT0gMCkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgbGV0IHggPSBldmVudC5zY3JlZW5YO1xyXG4gICAgICAgICAgICBsZXQgeSA9IGV2ZW50LnNjcmVlblk7XHJcblxyXG4gICAgICAgICAgICB0aGF0LiRlbGVtZW50LmZpbmQoJ3JlY3QnKS5hZGRDbGFzcygnZHJhZ2dpbmcnKTtcclxuXHJcbiAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZXVwLmRpYWdyYW1FbGVtZW50Jyk7XHJcbiAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZW1vdmUuZGlhZ3JhbUVsZW1lbnQnKTtcclxuXHJcbiAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub24oJ21vdXNlbW92ZS5kaWFncmFtRWxlbWVudCcsIChldmVudDogSlF1ZXJ5Lk1vdXNlTW92ZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY21QZXJQaXhlbCA9IDEgLyA5NiAqIDIuMzYgLyB0aGlzLmRpYWdyYW0uem9vbWZhY3RvcjtcclxuICAgICAgICAgICAgICAgIGxldCBkeCA9IChldmVudC5zY3JlZW5YIC0geCkgKiBjbVBlclBpeGVsO1xyXG4gICAgICAgICAgICAgICAgbGV0IGR5ID0gKGV2ZW50LnNjcmVlblkgLSB5KSAqIGNtUGVyUGl4ZWw7XHJcblxyXG4gICAgICAgICAgICAgICAgeCA9IGV2ZW50LnNjcmVlblg7XHJcbiAgICAgICAgICAgICAgICB5ID0gZXZlbnQuc2NyZWVuWTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGF0Lm1vdmUoZHgsIGR5LCB0cnVlKTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoYXQuaW5EZWJvdW5jZSk7XHJcbiAgICAgICAgICAgICAgICB0aGF0LmluRGVib3VuY2UgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgY2xhc3NEaWFncmFtID0gPENsYXNzRGlhZ3JhbT48YW55PnRoYXQuZGlhZ3JhbTtcclxuICAgICAgICAgICAgICAgICAgICBjbGFzc0RpYWdyYW0udXBkYXRlQXJyb3dzKCk7XHJcbiAgICAgICAgICAgICAgICB9LCAyMDApO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub24oJ21vdXNldXAuZGlhZ3JhbUVsZW1lbnQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGF0Lm1vdmUoMCwgMCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2xhc3NEaWFncmFtID0gPENsYXNzRGlhZ3JhbT48YW55PnRoYXQuZGlhZ3JhbTtcclxuICAgICAgICAgICAgICAgIGNsYXNzRGlhZ3JhbS5hZGp1c3RDbGFzc0RpYWdyYW1TaXplKCk7XHJcbiAgICAgICAgICAgICAgICBjbGFzc0RpYWdyYW0udXBkYXRlQXJyb3dzKCk7XHJcbiAgICAgICAgICAgICAgICB0aGF0LiRlbGVtZW50LmZpbmQoJ3JlY3QnKS5yZW1vdmVDbGFzcygnZHJhZ2dpbmcnKTtcclxuICAgICAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZXVwLmRpYWdyYW1FbGVtZW50Jyk7XHJcbiAgICAgICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZignbW91c2Vtb3ZlLmRpYWdyYW1FbGVtZW50Jyk7XHJcbiAgICAgICAgICAgICAgICBjbGFzc0RpYWdyYW0uZGlydHkgPSB0cnVlO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VmlzaWJpbGl0eVRleHQodmlzaWJpbGl0eTogVmlzaWJpbGl0eSkge1xyXG4gICAgICAgIHN3aXRjaCAodmlzaWJpbGl0eSkge1xyXG4gICAgICAgICAgICBjYXNlIFZpc2liaWxpdHkucHJpdmF0ZTogcmV0dXJuIFwiLVwiO1xyXG4gICAgICAgICAgICBjYXNlIFZpc2liaWxpdHkucHJvdGVjdGVkOiByZXR1cm4gXCIjXCI7XHJcbiAgICAgICAgICAgIGNhc2UgVmlzaWJpbGl0eS5wdWJsaWM6IHJldHVybiBcIitcIjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2lnbmF0dXJlKGtsYXNzOiBLbGFzcyB8IEludGVyZmFjZSk6IG51bWJlciB7XHJcblxyXG4gICAgICAgIGxldCBzOiBzdHJpbmcgPSBcIlwiO1xyXG5cclxuICAgICAgICBpZiAoa2xhc3MgaW5zdGFuY2VvZiBLbGFzcyAmJiB0aGlzLndpdGhBdHRyaWJ1dGVzICYmIGtsYXNzLmF0dHJpYnV0ZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBhIG9mIGtsYXNzLmF0dHJpYnV0ZXMpIHMgKz0gdGhpcy5nZXRWaXNpYmlsaXR5VGV4dChhLnZpc2liaWxpdHkpICsgYS50eXBlLmlkZW50aWZpZXIgKyBcIiBcIiArIGEuaWRlbnRpZmllcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLndpdGhNZXRob2RzICYmIGtsYXNzLm1ldGhvZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBtIG9mIGtsYXNzLm1ldGhvZHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtLmlzQ29uc3RydWN0b3IpIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHJ0OiBzdHJpbmcgPSBtLnJldHVyblR5cGUgPT0gbnVsbCA/IFwidm9pZFwiIDogbS5yZXR1cm5UeXBlLmlkZW50aWZpZXI7XHJcbiAgICAgICAgICAgICAgICBzICs9IHRoaXMuZ2V0VmlzaWJpbGl0eVRleHQobS52aXNpYmlsaXR5KSArIHJ0ICsgXCIgXCIgKyBtLmlkZW50aWZpZXIgKyBcIihcIiArXHJcbiAgICAgICAgICAgICAgICAgICAgbS5wYXJhbWV0ZXJsaXN0LnBhcmFtZXRlcnMubWFwKChwKSA9PiB7IHJldHVybiBwLnR5cGUuaWRlbnRpZmllciArIFwiIFwiICsgcC5pZGVudGlmaWVyIH0pLmpvaW4oXCIsIFwiKSArIFwiKVwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaGFzaChzKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgaGFzU2lnbmF0dXJlQW5kRmlsZU9mKGtsYXNzOiBLbGFzcyB8IEludGVyZmFjZSkge1xyXG4gICAgICAgIHJldHVybiBrbGFzcy5tb2R1bGUuZmlsZS5uYW1lID09IHRoaXMuZmlsZW5hbWUgJiZcclxuICAgICAgICAgICAgdGhpcy5nZXRTaWduYXR1cmUoa2xhc3MpID09IHRoaXMuaGFzaGVkU2lnbmF0dXJlO1xyXG4gICAgfVxyXG5cclxuXHJcblxyXG59Il19