export class OldPrintManager {
    constructor($runDiv) {
        this.$runDiv = $runDiv;
        this.color = "";
        this.lastSpan = "";
        this.maxLines = 2000;
        this.$lines = [];
        this.newLines = 0;
        this.printCommands = [];
        this.currentLinelength = 0;
        this.beginOfLineState = true; // Spaces at begin of line are converted to &nbsp;
        this.lastCharIsSpace = false;
        jQuery(() => {
            this.$outputDiv = $runDiv.find('.jo_output');
            this.clear();
            let that = this;
            let n = 0;
            let dirty = false;
            let lastPrinting = performance.now();
            setInterval(() => {
                if (that.printCommands.length > 0) {
                    that.doPrinting();
                    if (performance.now() - lastPrinting > 200) {
                        that.$outputDiv[0].scrollTop = that.$outputDiv[0].scrollHeight;
                    }
                    else {
                        dirty = true;
                    }
                    lastPrinting = performance.now();
                }
                if (n++ % 20 == 0 && dirty) {
                    setTimeout(() => {
                        that.$outputDiv[0].scrollTop = that.$outputDiv[0].scrollHeight;
                        dirty = false;
                    }, 200);
                }
            }, 50);
        });
    }
    getGraphicsDiv() {
        return this.$runDiv.find('.jo_graphics');
    }
    showProgramEnd() {
        let $programEndDiv = this.$runDiv.find('.jo_run-programend');
        $programEndDiv.show();
        $programEndDiv.addClass('jo_programendkf');
        setTimeout(() => {
            $programEndDiv.removeClass('jo_programendkf');
            $programEndDiv.hide();
        }, 3000);
    }
    doPrinting() {
        // if (this.printCommands.length > 0) {
        // this.$runDiv.find('.jo_run-caption').hide();
        // }
        if (this.newLines >= this.maxLines) {
            this.$outputDiv.empty();
            let i = this.printCommands.length - 1;
            let nl = 0;
            while (i >= 0) {
                if (this.printCommands[i].newLine) {
                    nl++;
                    if (nl >= this.maxLines) {
                        this.printCommands.splice(0, i + 1);
                        break;
                    }
                }
                i--;
            }
        }
        this.newLines = 0;
        for (let pc of this.printCommands) {
            // replace spaces at begin of line with &nbsp;'s
            if (this.beginOfLineState && pc.text.startsWith(" ")) {
                let match = pc.text.match(/^( *)(.*)$/);
                pc.text = match[1].replace(/ /g, "&nbsp;") + match[2];
                if (match[2].length > 0)
                    this.beginOfLineState = false;
            }
            else {
                if (pc.text.length > 0)
                    this.beginOfLineState = false;
            }
            if (this.lastCharIsSpace && pc.text.startsWith(" "))
                pc.text = pc.text.replace(/ /, "&#160;");
            this.lastCharIsSpace = false;
            pc.text = pc.text.replace(/  /g, "&#160; ").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            if (pc.color == null)
                pc.color = "var(--defaultOutputColor)";
            if (this.lastSpan == "" || this.color != pc.color) {
                if (this.lastSpan != "")
                    this.lastSpan += "</span>";
                this.lastSpan += '<span style="color: ' + pc.color + '">';
                if (pc.newLine && pc.text == "")
                    this.lastSpan += "\u200b";
                this.color = pc.color;
            }
            if (this.currentLinelength <= 10000) {
                this.lastSpan += pc.text;
                if (this.lastSpan.endsWith("  ")) {
                    this.lastSpan = this.lastSpan.substr(0, this.lastSpan.length - 2) + "&#160; ";
                }
                this.currentLinelength += pc.text.length;
            }
            if (pc.newLine) {
                this.beginOfLineState = true;
                if (!this.lastSpan.endsWith("</span>"))
                    this.lastSpan += "</span>";
                this.lastDiv.append(this.lastSpan);
                this.lastSpan = "";
                this.lastDiv = jQuery('<div></div>');
                this.$outputDiv.append(this.lastDiv);
                this.$lines.push(this.lastDiv);
                this.currentLinelength = 0;
            }
        }
        this.lastCharIsSpace = this.lastSpan.endsWith(" ");
        if (this.lastSpan != "" && !this.lastSpan.endsWith("> ")) {
            if (!this.lastSpan.endsWith("</span>"))
                this.lastSpan += "</span>";
            this.lastDiv.append(this.lastSpan);
            this.lastSpan = "";
        }
        if (this.$lines.length > this.maxLines * 1.5) {
            let that = this;
            // setTimeout(() => {
            let linesToDelete = that.$lines.length - that.maxLines;
            // let $linesToDelete = that.$lines.slice(0, linesToDelete);
            // that.$lines.splice(0, linesToDelete);
            let $linesToDelete = that.$lines.splice(0, linesToDelete);
            for (let $line of $linesToDelete) {
                $line.remove();
            }
            // }, 1000);
        }
        this.printCommands = [];
    }
    clear() {
        this.$outputDiv.empty();
        this.lastDiv = jQuery('<div></div>');
        this.$lines.push(this.lastDiv);
        this.$outputDiv.append(this.lastDiv);
        this.currentLinelength = 0;
        this.color = "";
        this.lastSpan = "";
        // jQuery('#run-caption').show();
    }
    print(text, color) {
        if (text == null)
            return;
        text = text.toString();
        if (text.indexOf("\n") >= 0) {
            let tList = text.split("\n");
            for (let i = 0; i < tList.length; i++) {
                let t = tList[i];
                let newLine = i < tList.length - 1;
                if (t == "" && i == tList.length - 1)
                    continue;
                this.printCommands.push({
                    text: t,
                    color: color,
                    newLine: newLine
                });
                if (newLine)
                    this.newLines++;
            }
        }
        else {
            this.printCommands.push({
                text: text,
                color: color,
                newLine: false
            });
        }
    }
    println(text, color) {
        if (text == null)
            text = "";
        this.print(text + "\n", color);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2xkUHJpbnRNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9tYWluL2d1aS9PbGRQcmludE1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsTUFBTSxPQUFPLGVBQWU7SUFrQnhCLFlBQW9CLE9BQTRCO1FBQTVCLFlBQU8sR0FBUCxPQUFPLENBQXFCO1FBaEJoRCxVQUFLLEdBQVcsRUFBRSxDQUFDO1FBQ25CLGFBQVEsR0FBVyxFQUFFLENBQUM7UUFJdEIsYUFBUSxHQUFXLElBQUksQ0FBQztRQUN4QixXQUFNLEdBQTBCLEVBQUUsQ0FBQztRQUVuQyxhQUFRLEdBQVcsQ0FBQyxDQUFDO1FBRXJCLGtCQUFhLEdBQXNCLEVBQUUsQ0FBQztRQUV0QyxzQkFBaUIsR0FBVyxDQUFDLENBQUM7UUFDOUIscUJBQWdCLEdBQVksSUFBSSxDQUFDLENBQUMsa0RBQWtEO1FBQ3BGLG9CQUFlLEdBQVksS0FBSyxDQUFDO1FBRzdCLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDUixJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBRWIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBRWhCLElBQUksQ0FBQyxHQUFXLENBQUMsQ0FBQztZQUVsQixJQUFJLEtBQUssR0FBRyxLQUFLLENBQUM7WUFDbEIsSUFBSSxZQUFZLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBRXJDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2IsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQy9CLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztvQkFDbEIsSUFBSSxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsWUFBWSxHQUFHLEdBQUcsRUFBRTt3QkFDeEMsSUFBSSxD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LEtBQUs7YUFDakIsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQW1CLEVBQUUsS0FBYztRQUN2QyxJQUFJLElBQUksSUFBSSxJQUFJO1lBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbnR5cGUgT2xkUHJpbnRDb21tYW5kID0ge1xyXG4gICAgdGV4dDogc3RyaW5nO1xyXG4gICAgY29sb3I6IHN0cmluZztcclxuICAgIG5ld0xpbmU6IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBPbGRQcmludE1hbmFnZXIge1xyXG5cclxuICAgIGNvbG9yOiBzdHJpbmcgPSBcIlwiO1xyXG4gICAgbGFzdFNwYW46IHN0cmluZyA9IFwiXCI7XHJcbiAgICBsYXN0RGl2OiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG4gICAgJG91dHB1dERpdjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuXHJcbiAgICBtYXhMaW5lczogbnVtYmVyID0gMjAwMDtcclxuICAgICRsaW5lczogSlF1ZXJ5PEhUTUxFbGVtZW50PltdID0gW107XHJcblxyXG4gICAgbmV3TGluZXM6IG51bWJlciA9IDA7XHJcblxyXG4gICAgcHJpbnRDb21tYW5kczogT2xkUHJpbnRDb21tYW5kW10gPSBbXTtcclxuXHJcbiAgICBjdXJyZW50TGluZWxlbmd0aDogbnVtYmVyID0gMDtcclxuICAgIGJlZ2luT2ZMaW5lU3RhdGU6IGJvb2xlYW4gPSB0cnVlOyAvLyBTcGFjZXMgYXQgYmVnaW4gb2YgbGluZSBhcmUgY29udmVydGVkIHRvICZuYnNwO1xyXG4gICAgbGFzdENoYXJJc1NwYWNlOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSAkcnVuRGl2OiBKUXVlcnk8SFRNTEVsZW1lbnQ+KSB7XHJcbiAgICAgICAgalF1ZXJ5KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy4kb3V0cHV0RGl2ID0gJHJ1bkRpdi5maW5kKCcuam9fb3V0cHV0Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTtcclxuXHJcbiAgICAgICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuXHJcbiAgICAgICAgICAgIGxldCBuOiBudW1iZXIgPSAwO1xyXG5cclxuICAgICAgICAgICAgbGV0IGRpcnR5ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGxldCBsYXN0UHJpbnRpbmcgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHJcbiAgICAgICAgICAgIHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGF0LnByaW50Q29tbWFuZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQuZG9QcmludGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwZXJmb3JtYW5jZS5ub3coKSAtIGxhc3RQcmludGluZyA+IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LiRvdXRwdXREaXZbMF0uc2Nyb2xsVG9wID0gdGhhdC4kb3V0cHV0RGl2WzBdLnNjcm9sbEhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RQcmludGluZyA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChuKysgJSAyMCA9PSAwICYmIGRpcnR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJG91dHB1dERpdlswXS5zY3JvbGxUb3AgPSB0aGF0LiRvdXRwdXREaXZbMF0uc2Nyb2xsSGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sIDIwMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9LCA1MCk7XHJcblxyXG5cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRHcmFwaGljc0RpdigpOkpRdWVyeTxIVE1MRWxlbWVudD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLiRydW5EaXYuZmluZCgnLmpvX2dyYXBoaWNzJyk7XHJcbiAgICB9XHJcblxyXG4gICAgc2hvd1Byb2dyYW1FbmQoKSB7XHJcbiAgICAgICAgbGV0ICRwcm9ncmFtRW5kRGl2ID0gdGhpcy4kcnVuRGl2LmZpbmQoJy5qb19ydW4tcHJvZ3JhbWVuZCcpO1xyXG4gICAgICAgICRwcm9ncmFtRW5kRGl2LnNob3coKTtcclxuICAgICAgICAkcHJvZ3JhbUVuZERpdi5hZGRDbGFzcygnam9fcHJvZ3JhbWVuZGtmJyk7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICRwcm9ncmFtRW5kRGl2LnJlbW92ZUNsYXNzKCdqb19wcm9ncmFtZW5ka2YnKTtcclxuICAgICAgICAgICAgJHByb2dyYW1FbmREaXYuaGlkZSgpO1xyXG4gICAgICAgIH0sIDMwMDApO1xyXG4gICAgfVxyXG5cclxuICAgIGRvUHJpbnRpbmcoKSB7XHJcbiAgICAgICAgLy8gaWYgKHRoaXMucHJpbnRDb21tYW5kcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIC8vIHRoaXMuJHJ1bkRpdi5maW5kKCcuam9fcnVuLWNhcHRpb24nKS5oaWRlKCk7XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5uZXdMaW5lcyA+PSB0aGlzLm1heExpbmVzKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLiRvdXRwdXREaXYuZW1wdHkoKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBpID0gdGhpcy5wcmludENvbW1hbmRzLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgICAgIGxldCBubCA9IDA7XHJcblxyXG4gICAgICAgICAgICB3aGlsZSAoaSA+PSAwKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucHJpbnRDb21tYW5kc1tpXS5uZXdMaW5lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmwrKztcclxuICAgICAgICAgICAgICAgICAgICBpZiAobmwgPj0gdGhpcy5tYXhMaW5lcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByaW50Q29tbWFuZHMuc3BsaWNlKDAsIGkgKyAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaS0tO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5uZXdMaW5lcyA9IDA7XHJcblxyXG4gICAgICAgIGZvciAobGV0IHBjIG9mIHRoaXMucHJpbnRDb21tYW5kcykge1xyXG5cclxuICAgICAgICAgICAgLy8gcmVwbGFjZSBzcGFjZXMgYXQgYmVnaW4gb2YgbGluZSB3aXRoICZuYnNwOydzXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmJlZ2luT2ZMaW5lU3RhdGUgJiYgcGMudGV4dC5zdGFydHNXaXRoKFwiIFwiKSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IG1hdGNoID0gcGMudGV4dC5tYXRjaCgvXiggKikoLiopJC8pO1xyXG4gICAgICAgICAgICAgICAgcGMudGV4dCA9IG1hdGNoWzFdLnJlcGxhY2UoLyAvZywgXCImbmJzcDtcIikgKyBtYXRjaFsyXTtcclxuICAgICAgICAgICAgICAgIGlmIChtYXRjaFsyXS5sZW5ndGggPiAwKSB0aGlzLmJlZ2luT2ZMaW5lU3RhdGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChwYy50ZXh0Lmxlbmd0aCA+IDApIHRoaXMuYmVnaW5PZkxpbmVTdGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZih0aGlzLmxhc3RDaGFySXNTcGFjZSAmJiBwYy50ZXh0LnN0YXJ0c1dpdGgoXCIgXCIpKSBwYy50ZXh0ID0gcGMudGV4dC5yZXBsYWNlKC8gLywgXCImIzE2MDtcIik7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmxhc3RDaGFySXNTcGFjZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgcGMudGV4dCA9IHBjLnRleHQucmVwbGFjZSgvICAvZywgXCImIzE2MDsgXCIpLnJlcGxhY2UoLzwvZywgXCImbHQ7XCIpLnJlcGxhY2UoLz4vZywgXCImZ3Q7XCIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHBjLmNvbG9yID09IG51bGwpIHBjLmNvbG9yID0gXCJ2YXIoLS1kZWZhdWx0T3V0cHV0Q29sb3IpXCI7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5sYXN0U3BhbiA9PSBcIlwiIHx8IHRoaXMuY29sb3IgIT0gcGMuY29sb3IpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxhc3RTcGFuICE9IFwiXCIpIHRoaXMubGFzdFNwYW4gKz0gXCI8L3NwYW4+XCI7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RTcGFuICs9ICc8c3BhbiBzdHlsZT1cImNvbG9yOiAnICsgcGMuY29sb3IgKyAnXCI+JztcclxuICAgICAgICAgICAgICAgIGlmKHBjLm5ld0xpbmUgJiYgcGMudGV4dCA9PSBcIlwiKSB0aGlzLmxhc3RTcGFuICs9IFwiXFx1MjAwYlwiO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvciA9IHBjLmNvbG9yO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50TGluZWxlbmd0aCA8PSAxMDAwMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0U3BhbiArPSBwYy50ZXh0O1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubGFzdFNwYW4uZW5kc1dpdGgoXCIgIFwiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdFNwYW4gPSB0aGlzLmxhc3RTcGFuLnN1YnN0cigwLCB0aGlzLmxhc3RTcGFuLmxlbmd0aCAtIDIpICsgXCImIzE2MDsgXCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRMaW5lbGVuZ3RoICs9IHBjLnRleHQubGVuZ3RoO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgaWYgKHBjLm5ld0xpbmUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYmVnaW5PZkxpbmVTdGF0ZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubGFzdFNwYW4uZW5kc1dpdGgoXCI8L3NwYW4+XCIpKSB0aGlzLmxhc3RTcGFuICs9IFwiPC9zcGFuPlwiO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0RGl2LmFwcGVuZCh0aGlzLmxhc3RTcGFuKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNwYW4gPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0RGl2ID0galF1ZXJ5KCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy4kb3V0cHV0RGl2LmFwcGVuZCh0aGlzLmxhc3REaXYpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy4kbGluZXMucHVzaCh0aGlzLmxhc3REaXYpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TGluZWxlbmd0aCA9IDA7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxhc3RDaGFySXNTcGFjZSA9IHRoaXMubGFzdFNwYW4uZW5kc1dpdGgoXCIgXCIpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5sYXN0U3BhbiAhPSBcIlwiICYmICF0aGlzLmxhc3RTcGFuLmVuZHNXaXRoKFwiPiBcIikpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmxhc3RTcGFuLmVuZHNXaXRoKFwiPC9zcGFuPlwiKSkgdGhpcy5sYXN0U3BhbiArPSBcIjwvc3Bhbj5cIjtcclxuICAgICAgICAgICAgdGhpcy5sYXN0RGl2LmFwcGVuZCh0aGlzLmxhc3RTcGFuKTtcclxuICAgICAgICAgICAgdGhpcy5sYXN0U3BhbiA9IFwiXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy4kbGluZXMubGVuZ3RoID4gdGhpcy5tYXhMaW5lcyAqIDEuNSkge1xyXG4gICAgICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgICAgIC8vIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgbGluZXNUb0RlbGV0ZSA9IHRoYXQuJGxpbmVzLmxlbmd0aCAtIHRoYXQubWF4TGluZXM7XHJcblxyXG4gICAgICAgICAgICAvLyBsZXQgJGxpbmVzVG9EZWxldGUgPSB0aGF0LiRsaW5lcy5zbGljZSgwLCBsaW5lc1RvRGVsZXRlKTtcclxuICAgICAgICAgICAgLy8gdGhhdC4kbGluZXMuc3BsaWNlKDAsIGxpbmVzVG9EZWxldGUpO1xyXG4gICAgICAgICAgICBsZXQgJGxpbmVzVG9EZWxldGUgPSB0aGF0LiRsaW5lcy5zcGxpY2UoMCwgbGluZXNUb0RlbGV0ZSk7XHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCAkbGluZSBvZiAkbGluZXNUb0RlbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgJGxpbmUucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIH0sIDEwMDApO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucHJpbnRDb21tYW5kcyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKCkge1xyXG4gICAgICAgIHRoaXMuJG91dHB1dERpdi5lbXB0eSgpO1xyXG4gICAgICAgIHRoaXMubGFzdERpdiA9IGpRdWVyeSgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICB0aGlzLiRsaW5lcy5wdXNoKHRoaXMubGFzdERpdik7XHJcbiAgICAgICAgdGhpcy4kb3V0cHV0RGl2LmFwcGVuZCh0aGlzLmxhc3REaXYpO1xyXG4gICAgICAgIHRoaXMuY3VycmVudExpbmVsZW5ndGggPSAwO1xyXG4gICAgICAgIHRoaXMuY29sb3IgPSBcIlwiO1xyXG4gICAgICAgIHRoaXMubGFzdFNwYW4gPSBcIlwiO1xyXG4gICAgICAgIC8vIGpRdWVyeSgnI3J1bi1jYXB0aW9uJykuc2hvdygpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaW50KHRleHQ6IHN0cmluZyB8IG51bGwsIGNvbG9yPzogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHRleHQgPT0gbnVsbCkgcmV0dXJuO1xyXG4gICAgICAgIHRleHQgPSB0ZXh0LnRvU3RyaW5nKCk7XHJcbiAgICAgICAgaWYgKHRleHQuaW5kZXhPZihcIlxcblwiKSA+PSAwKSB7XHJcbiAgICAgICAgICAgIGxldCB0TGlzdCA9IHRleHQuc3BsaXQoXCJcXG5cIik7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdExpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGxldCB0ID0gdExpc3RbaV07XHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3TGluZSA9IGkgPCB0TGlzdC5sZW5ndGggLSAxO1xyXG4gICAgICAgICAgICAgICAgaWYgKHQgPT0gXCJcIiAmJiBpID09IHRMaXN0Lmxlbmd0aCAtIDEpIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wcmludENvbW1hbmRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHQsXHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6IGNvbG9yLFxyXG4gICAgICAgICAgICAgICAgICAgIG5ld0xpbmU6IG5ld0xpbmVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5ld0xpbmUpIHRoaXMubmV3TGluZXMrKztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucHJpbnRDb21tYW5kcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHRleHQ6IHRleHQsXHJcbiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3IsXHJcbiAgICAgICAgICAgICAgICBuZXdMaW5lOiBmYWxzZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpbnRsbih0ZXh0OiBzdHJpbmcgfCBudWxsLCBjb2xvcj86IHN0cmluZykge1xyXG4gICAgICAgIGlmICh0ZXh0ID09IG51bGwpIHRleHQgPSBcIlwiO1xyXG4gICAgICAgIHRoaXMucHJpbnQodGV4dCArIFwiXFxuXCIsIGNvbG9yKTtcclxuICAgIH1cclxuXHJcbn0iXX0=