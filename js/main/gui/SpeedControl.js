import { convertPxToNumber } from "../../tools/HtmlTools.js";
export class SpeedControl {
    // <div id="speedcontrol-outer" title="Geschwindigkeitsregler" draggable="false">
    //     <div id="speedcontrol-bar" draggable="false"></div>
    //     <div id="speedcontrol-grip" draggable="false">
    //         <div id="speedcontrol-display">100 Schritte/s</div>
    //     </div>
    // </div>
    constructor($container) {
        this.position = 0;
        this.gripWidth = 10;
        this.overallWidth = 100;
        this.$outer = jQuery('<div class="jo_speedcontrol-outer" title="Geschwindigkeitsregler" draggable="false"></div>');
        this.$bar = jQuery('<div class="jo_speedcontrol-bar" draggable="false"></div>');
        this.$grip = jQuery('<div class="jo_speedcontrol-grip" draggable="false"></div>');
        this.$display = jQuery('<div class="jo_speedcontrol-display" draggable="false">100 Schritte/s</div>');
        this.$grip.append(this.$display);
        this.$outer.append(this.$bar, this.$grip);
        $container.append(this.$outer);
    }
    setInterpreter(i) {
        this.interpreter = i;
    }
    initGUI() {
        let mousedownX;
        let oldPosition;
        let that = this;
        that.overallWidth = convertPxToNumber(this.$outer.css('width'));
        that.gripWidth = convertPxToNumber(that.$grip.css('width'));
        that.xMax = that.overallWidth - that.gripWidth;
        let mousePointer = window.PointerEvent ? "pointer" : "mouse";
        that.$outer.on(mousePointer + 'down', (e) => {
            let x = e.pageX - that.$outer.offset().left - 4;
            that.setSpeed(x);
            that.$grip.css('left', x + 'px');
            //@ts-ignore
            that.$grip.trigger(mousePointer + 'down', [e.clientX]);
            // jQuery('#speedcontrol-display').show();
            // jQuery(document).on('mouseup.speedcontrol1', () => {
            //     jQuery(document).off('mouseup.speedcontrol1');
            //     jQuery('#speedcontrol-display').hide();
            // });
        });
        this.$grip.on(mousePointer + 'down', (e, x) => {
            if (x == null)
                x = e.clientX;
            mousedownX = x;
            oldPosition = that.position;
            jQuery('.joe_controlPanel_top').css("z-index", "1000");
            that.$display.show();
            jQuery(document).on(mousePointer + 'move.speedcontrol', (e) => {
                let deltaX = e.clientX - mousedownX;
                that.setSpeed(oldPosition + deltaX);
            });
            jQuery(document).on(mousePointer + 'up.speedcontrol', () => {
                jQuery(document).off(mousePointer + 'up.speedcontrol');
                jQuery(document).off(mousePointer + 'move.speedcontrol');
                that.$display.hide();
                jQuery('.joe_controlPanel_top').css("z-index", "0");
            });
            e.stopPropagation();
        });
    }
    getSpeedInStepsPerSecond() {
        return this.interpreter.stepsPerSecond;
    }
    setSpeedInStepsPerSecond(stepsPerSecond) {
        let intervalBorders = [1, 10, 100, 1000, 10000, 100000, this.interpreter.maxStepsPerSecond];
        if (stepsPerSecond == "max")
            stepsPerSecond = this.interpreter.maxStepsPerSecond;
        stepsPerSecond = Math.min(stepsPerSecond, this.interpreter.maxStepsPerSecond);
        stepsPerSecond = Math.max(stepsPerSecond, 1);
        for (let i = 0; i < intervalBorders.length - 1; i++) {
            let left = intervalBorders[i];
            let right = intervalBorders[i + 1];
            if (stepsPerSecond >= left && stepsPerSecond <= right) {
                let gripIntervalLength = this.xMax / (intervalBorders.length - 1);
                let gripPosition = Math.round(gripIntervalLength * i + gripIntervalLength * (stepsPerSecond - left) / (right - left));
                this.$grip.css('left', gripPosition + 'px');
                this.position = gripPosition;
                break;
            }
        }
        this.setInterpreterSpeed(stepsPerSecond);
    }
    setSpeed(newPosition) {
        if (newPosition < 0) {
            newPosition = 0;
        }
        if (newPosition > this.xMax) {
            newPosition = this.xMax;
        }
        this.position = newPosition;
        this.$grip.css('left', newPosition + "px");
        // in steps/s
        let intervalBorders = [1, 10, 100, 1000, 10000, 100000, this.interpreter.maxStepsPerSecond];
        let intervalDelta = this.xMax / (intervalBorders.length - 1);
        let intervalIndex = Math.floor(newPosition / intervalDelta);
        if (intervalIndex == intervalBorders.length - 1)
            intervalIndex--;
        let factorInsideInterval = (newPosition - intervalIndex * intervalDelta) / intervalDelta;
        let intervalMin = intervalBorders[intervalIndex];
        let intervalMax = intervalBorders[intervalIndex + 1];
        let speed = intervalMin + (intervalMax - intervalMin) * factorInsideInterval;
        this.setInterpreterSpeed(speed);
        // console.log( speed + ' steps/s entspricht ' + this.interpreter.timerDelayMs + ' ms zwischen Steps')
    }
    setInterpreterSpeed(stepsPerSecond) {
        this.interpreter.stepsPerSecond = stepsPerSecond;
        this.interpreter.hideProgrampointerPosition();
        let speedString = "" + Math.ceil(stepsPerSecond);
        if (stepsPerSecond >= this.interpreter.maxStepsPerSecond - 10) {
            speedString = "Maximale Geschwindigkeit";
        }
        this.$display.html(speedString + " Schritte/s");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3BlZWRDb250cm9sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9tYWluL2d1aS9TcGVlZENvbnRyb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFLN0QsTUFBTSxPQUFPLFlBQVk7SUFjekIsaUZBQWlGO0lBQ2pGLDBEQUEwRDtJQUMxRCxxREFBcUQ7SUFDckQsOERBQThEO0lBQzlELGFBQWE7SUFDYixTQUFTO0lBR0wsWUFBWSxVQUErQjtRQXBCM0MsYUFBUSxHQUFXLENBQUMsQ0FBQztRQU9yQixjQUFTLEdBQVcsRUFBRSxDQUFDO1FBQ3ZCLGlCQUFZLEdBQVcsR0FBRyxDQUFDO1FBY3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLDRGQUE0RixDQUFDLENBQUM7UUFDbkgsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsMkRBQTJELENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyw0REFBNEQsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLDZFQUE2RSxDQUFDLENBQUM7UUFFdEcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRW5DLENBQUM7SUFFRCxjQUFjLENBQUMsQ0FBYztRQUN6QixJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQsT0FBTztRQUVILElBQUksVUFBa0IsQ0FBQztRQUN2QixJQUFJLFdB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LENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRXJELElBQUksS0FBSyxHQUFHLFdBQVcsR0FBRyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsR0FBRyxvQkFBb0IsQ0FBQztRQUU3RSxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFaEMsc0dBQXNHO0lBRTFHLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxjQUFzQjtRQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7UUFFakQsSUFBSSxDQUFDLFdBQVcsQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1FBRTlDLElBQUksV0FBVyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2pELElBQUcsY0FBYyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxFQUFDO1lBQ3pELFdBQVcsR0FBRywwQkFBMEIsQ0FBQztTQUM1QztRQUVELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUMsQ0FBQztJQUNwRCxDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb252ZXJ0UHhUb051bWJlciB9IGZyb20gXCIuLi8uLi90b29scy9IdG1sVG9vbHMuanNcIjtcclxuaW1wb3J0IHsgSW50ZXJwcmV0ZXIsIEludGVycHJldGVyU3RhdGUgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvSW50ZXJwcmV0ZXIuanNcIjtcclxuXHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFNwZWVkQ29udHJvbCB7XHJcblxyXG4gICAgcG9zaXRpb246IG51bWJlciA9IDA7XHJcbiAgICB4TWF4OiBudW1iZXI7XHJcbiAgICAkZ3JpcDogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuICAgICRiYXI6IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcbiAgICAkZGlzcGxheTogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuICAgICRvdXRlcjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuXHJcbiAgICBncmlwV2lkdGg6IG51bWJlciA9IDEwO1xyXG4gICAgb3ZlcmFsbFdpZHRoOiBudW1iZXIgPSAxMDA7XHJcblxyXG4gICAgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyXHJcblxyXG4vLyA8ZGl2IGlkPVwic3BlZWRjb250cm9sLW91dGVyXCIgdGl0bGU9XCJHZXNjaHdpbmRpZ2tlaXRzcmVnbGVyXCIgZHJhZ2dhYmxlPVwiZmFsc2VcIj5cclxuLy8gICAgIDxkaXYgaWQ9XCJzcGVlZGNvbnRyb2wtYmFyXCIgZHJhZ2dhYmxlPVwiZmFsc2VcIj48L2Rpdj5cclxuLy8gICAgIDxkaXYgaWQ9XCJzcGVlZGNvbnRyb2wtZ3JpcFwiIGRyYWdnYWJsZT1cImZhbHNlXCI+XHJcbi8vICAgICAgICAgPGRpdiBpZD1cInNwZWVkY29udHJvbC1kaXNwbGF5XCI+MTAwIFNjaHJpdHRlL3M8L2Rpdj5cclxuLy8gICAgIDwvZGl2PlxyXG4vLyA8L2Rpdj5cclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IoJGNvbnRhaW5lcjogSlF1ZXJ5PEhUTUxFbGVtZW50Pil7XHJcblxyXG4gICAgICAgIHRoaXMuJG91dGVyID0galF1ZXJ5KCc8ZGl2IGNsYXNzPVwiam9fc3BlZWRjb250cm9sLW91dGVyXCIgdGl0bGU9XCJHZXNjaHdpbmRpZ2tlaXRzcmVnbGVyXCIgZHJhZ2dhYmxlPVwiZmFsc2VcIj48L2Rpdj4nKTtcclxuICAgICAgICB0aGlzLiRiYXIgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19zcGVlZGNvbnRyb2wtYmFyXCIgZHJhZ2dhYmxlPVwiZmFsc2VcIj48L2Rpdj4nKTtcclxuICAgICAgICB0aGlzLiRncmlwID0galF1ZXJ5KCc8ZGl2IGNsYXNzPVwiam9fc3BlZWRjb250cm9sLWdyaXBcIiBkcmFnZ2FibGU9XCJmYWxzZVwiPjwvZGl2PicpO1xyXG4gICAgICAgIHRoaXMuJGRpc3BsYXkgPSBqUXVlcnkoJzxkaXYgY2xhc3M9XCJqb19zcGVlZGNvbnRyb2wtZGlzcGxheVwiIGRyYWdnYWJsZT1cImZhbHNlXCI+MTAwIFNjaHJpdHRlL3M8L2Rpdj4nKTtcclxuXHJcbiAgICAgICAgdGhpcy4kZ3JpcC5hcHBlbmQodGhpcy4kZGlzcGxheSk7XHJcbiAgICAgICAgdGhpcy4kb3V0ZXIuYXBwZW5kKHRoaXMuJGJhciwgdGhpcy4kZ3JpcCk7XHJcblxyXG4gICAgICAgICRjb250YWluZXIuYXBwZW5kKHRoaXMuJG91dGVyKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2V0SW50ZXJwcmV0ZXIoaTogSW50ZXJwcmV0ZXIpe1xyXG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXIgPSBpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRHVUkoKXtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgbW91c2Vkb3duWDogbnVtYmVyO1xyXG4gICAgICAgIGxldCBvbGRQb3NpdGlvbjogbnVtYmVyO1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICB0aGF0Lm92ZXJhbGxXaWR0aCA9IGNvbnZlcnRQeFRvTnVtYmVyKHRoaXMuJG91dGVyLmNzcygnd2lkdGgnKSk7XHJcbiAgICAgICAgdGhhdC5ncmlwV2lkdGggPSBjb252ZXJ0UHhUb051bWJlcih0aGF0LiRncmlwLmNzcygnd2lkdGgnKSk7XHJcbiAgICAgICAgdGhhdC54TWF4ID0gdGhhdC5vdmVyYWxsV2lkdGggLSB0aGF0LmdyaXBXaWR0aDtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgbW91c2VQb2ludGVyID0gd2luZG93LlBvaW50ZXJFdmVudCA/IFwicG9pbnRlclwiIDogXCJtb3VzZVwiO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHRoYXQuJG91dGVyLm9uKG1vdXNlUG9pbnRlciArICdkb3duJywgKGUpID0+IHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgbGV0IHggPSBlLnBhZ2VYIC0gdGhhdC4kb3V0ZXIub2Zmc2V0KCkubGVmdCAtIDQ7XHJcbiAgICAgICAgICAgIHRoYXQuc2V0U3BlZWQoeCk7XHJcbiAgICAgICAgICAgIHRoYXQuJGdyaXAuY3NzKCdsZWZ0JywgeCArICdweCcpO1xyXG4gICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgdGhhdC4kZ3JpcC50cmlnZ2VyKG1vdXNlUG9pbnRlciArICdkb3duJywgW2UuY2xpZW50WF0pO1xyXG5cclxuICAgICAgICAgICAgLy8galF1ZXJ5KCcjc3BlZWRjb250cm9sLWRpc3BsYXknKS5zaG93KCk7XHJcbiAgICAgICAgICAgIC8vIGpRdWVyeShkb2N1bWVudCkub24oJ21vdXNldXAuc3BlZWRjb250cm9sMScsICgpID0+IHtcclxuICAgICAgICAgICAgLy8gICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZXVwLnNwZWVkY29udHJvbDEnKTtcclxuICAgICAgICAgICAgLy8gICAgIGpRdWVyeSgnI3NwZWVkY29udHJvbC1kaXNwbGF5JykuaGlkZSgpO1xyXG4gICAgICAgICAgICAvLyB9KTtcclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy4kZ3JpcC5vbihtb3VzZVBvaW50ZXIgKyAnZG93bicsIChlLCB4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmKHggPT0gbnVsbCkgeCA9IGUuY2xpZW50WDtcclxuICAgICAgICAgICAgbW91c2Vkb3duWCA9IHg7XHJcbiAgICAgICAgICAgIG9sZFBvc2l0aW9uID0gdGhhdC5wb3NpdGlvbjtcclxuICAgICAgICAgICAgalF1ZXJ5KCcuam9lX2NvbnRyb2xQYW5lbF90b3AnKS5jc3MoXCJ6LWluZGV4XCIsIFwiMTAwMFwiKTtcclxuICAgICAgICAgICAgdGhhdC4kZGlzcGxheS5zaG93KCk7XHJcblxyXG4gICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9uKG1vdXNlUG9pbnRlciArICdtb3ZlLnNwZWVkY29udHJvbCcsIChlKT0+e1xyXG4gICAgICAgICAgICAgICAgbGV0IGRlbHRhWCA9IGUuY2xpZW50WCAtIG1vdXNlZG93blg7XHJcbiAgICAgICAgICAgICAgICB0aGF0LnNldFNwZWVkKG9sZFBvc2l0aW9uICsgZGVsdGFYKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9uKG1vdXNlUG9pbnRlciArICd1cC5zcGVlZGNvbnRyb2wnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZihtb3VzZVBvaW50ZXIgKyAndXAuc3BlZWRjb250cm9sJyk7XHJcbiAgICAgICAgICAgICAgICBqUXVlcnkoZG9jdW1lbnQpLm9mZihtb3VzZVBvaW50ZXIgKyAnbW92ZS5zcGVlZGNvbnRyb2wnKTtcclxuICAgICAgICAgICAgICAgIHRoYXQuJGRpc3BsYXkuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgalF1ZXJ5KCcuam9lX2NvbnRyb2xQYW5lbF90b3AnKS5jc3MoXCJ6LWluZGV4XCIsIFwiMFwiKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgICAgICB9KTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3BlZWRJblN0ZXBzUGVyU2Vjb25kKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJwcmV0ZXIuc3RlcHNQZXJTZWNvbmQ7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0U3BlZWRJblN0ZXBzUGVyU2Vjb25kKHN0ZXBzUGVyU2Vjb25kOiBudW1iZXIgfCBcIm1heFwiKXtcclxuICAgICAgICBsZXQgaW50ZXJ2YWxCb3JkZXJzID0gWzEsIDEwLCAxMDAsIDEwMDAsIDEwMDAwLCAxMDAwMDAsIHRoaXMuaW50ZXJwcmV0ZXIubWF4U3RlcHNQZXJTZWNvbmRdO1xyXG5cclxuICAgICAgICBpZihzdGVwc1BlclNlY29uZCA9PSBcIm1heFwiKSBzdGVwc1BlclNlY29uZCA9IHRoaXMuaW50ZXJwcmV0ZXIubWF4U3RlcHNQZXJTZWNvbmQ7XHJcbiAgICAgICAgc3RlcHNQZXJTZWNvbmQgPSBNYXRoLm1pbihzdGVwc1BlclNlY29uZCwgdGhpcy5pbnRlcnByZXRlci5tYXhTdGVwc1BlclNlY29uZCk7XHJcbiAgICAgICAgc3RlcHNQZXJTZWNvbmQgPSBNYXRoLm1heChzdGVwc1BlclNlY29uZCwgMSk7XHJcblxyXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBpbnRlcnZhbEJvcmRlcnMubGVuZ3RoIC0gMTsgaSsrKXtcclxuICAgICAgICAgICAgbGV0IGxlZnQgPSBpbnRlcnZhbEJvcmRlcnNbaV07XHJcbiAgICAgICAgICAgIGxldCByaWdodCA9IGludGVydmFsQm9yZGVyc1tpKzFdO1xyXG4gICAgICAgICAgICBpZihzdGVwc1BlclNlY29uZCA+PSBsZWZ0ICYmIHN0ZXBzUGVyU2Vjb25kIDw9IHJpZ2h0KXtcclxuICAgICAgICAgICAgICAgIGxldCBncmlwSW50ZXJ2YWxMZW5ndGggPSB0aGlzLnhNYXgvKGludGVydmFsQm9yZGVycy5sZW5ndGggLSAxKTtcclxuICAgICAgICAgICAgICAgIGxldCBncmlwUG9zaXRpb24gPSBNYXRoLnJvdW5kKGdyaXBJbnRlcnZhbExlbmd0aCAqIGkgKyBncmlwSW50ZXJ2YWxMZW5ndGggKiAoc3RlcHNQZXJTZWNvbmQgLSBsZWZ0KS8ocmlnaHQgLSBsZWZ0KSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLiRncmlwLmNzcygnbGVmdCcsIGdyaXBQb3NpdGlvbiArICdweCcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IGdyaXBQb3NpdGlvbjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNldEludGVycHJldGVyU3BlZWQoc3RlcHNQZXJTZWNvbmQpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzZXRTcGVlZChuZXdQb3NpdGlvbjogbnVtYmVyKXtcclxuXHJcbiAgICAgICAgaWYobmV3UG9zaXRpb24gPCAwKXtcclxuICAgICAgICAgICAgbmV3UG9zaXRpb24gPSAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYobmV3UG9zaXRpb24gPiB0aGlzLnhNYXgpe1xyXG4gICAgICAgICAgICBuZXdQb3NpdGlvbiA9IHRoaXMueE1heDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBuZXdQb3NpdGlvbjtcclxuXHJcbiAgICAgICAgdGhpcy4kZ3JpcC5jc3MoJ2xlZnQnLCBuZXdQb3NpdGlvbiArIFwicHhcIik7XHJcblxyXG4gICAgICAgIC8vIGluIHN0ZXBzL3NcclxuICAgICAgICBsZXQgaW50ZXJ2YWxCb3JkZXJzID0gWzEsIDEwLCAxMDAsIDEwMDAsIDEwMDAwLCAxMDAwMDAsIHRoaXMuaW50ZXJwcmV0ZXIubWF4U3RlcHNQZXJTZWNvbmRdO1xyXG5cclxuICAgICAgICBsZXQgaW50ZXJ2YWxEZWx0YSA9IHRoaXMueE1heCAvIChpbnRlcnZhbEJvcmRlcnMubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgbGV0IGludGVydmFsSW5kZXggPSBNYXRoLmZsb29yKG5ld1Bvc2l0aW9uL2ludGVydmFsRGVsdGEpO1xyXG4gICAgICAgIGlmKGludGVydmFsSW5kZXggPT0gaW50ZXJ2YWxCb3JkZXJzLmxlbmd0aCAtIDEpIGludGVydmFsSW5kZXgtLTtcclxuICAgICAgICBsZXQgZmFjdG9ySW5zaWRlSW50ZXJ2YWwgPSAobmV3UG9zaXRpb24gLSBpbnRlcnZhbEluZGV4KmludGVydmFsRGVsdGEpL2ludGVydmFsRGVsdGE7XHJcblxyXG4gICAgICAgIGxldCBpbnRlcnZhbE1pbiA9IGludGVydmFsQm9yZGVyc1tpbnRlcnZhbEluZGV4XTtcclxuICAgICAgICBsZXQgaW50ZXJ2YWxNYXggPSBpbnRlcnZhbEJvcmRlcnNbaW50ZXJ2YWxJbmRleCArIDFdO1xyXG5cclxuICAgICAgICBsZXQgc3BlZWQgPSBpbnRlcnZhbE1pbiArIChpbnRlcnZhbE1heCAtIGludGVydmFsTWluKSAqIGZhY3Rvckluc2lkZUludGVydmFsO1xyXG5cclxuICAgICAgICB0aGlzLnNldEludGVycHJldGVyU3BlZWQoc3BlZWQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCBzcGVlZCArICcgc3RlcHMvcyBlbnRzcHJpY2h0ICcgKyB0aGlzLmludGVycHJldGVyLnRpbWVyRGVsYXlNcyArICcgbXMgendpc2NoZW4gU3RlcHMnKVxyXG5cclxuICAgIH1cclxuICAgIFxyXG4gICAgc2V0SW50ZXJwcmV0ZXJTcGVlZChzdGVwc1BlclNlY29uZDogbnVtYmVyKXtcclxuICAgICAgICB0aGlzLmludGVycHJldGVyLnN0ZXBzUGVyU2Vjb25kID0gc3RlcHNQZXJTZWNvbmQ7XHJcblxyXG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXIuaGlkZVByb2dyYW1wb2ludGVyUG9zaXRpb24oKTtcclxuXHJcbiAgICAgICAgbGV0IHNwZWVkU3RyaW5nID0gXCJcIiArIE1hdGguY2VpbChzdGVwc1BlclNlY29uZCk7XHJcbiAgICAgICAgaWYoc3RlcHNQZXJTZWNvbmQgPj0gdGhpcy5pbnRlcnByZXRlci5tYXhTdGVwc1BlclNlY29uZCAtIDEwKXtcclxuICAgICAgICAgICAgc3BlZWRTdHJpbmcgPSBcIk1heGltYWxlIEdlc2Nod2luZGlna2VpdFwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy4kZGlzcGxheS5odG1sKHNwZWVkU3RyaW5nICsgXCIgU2Nocml0dGUvc1wiKTtcclxuICAgIH1cclxuXHJcblxyXG59Il19