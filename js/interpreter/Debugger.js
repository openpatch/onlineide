import { InterpreterState } from "./Interpreter.js";
import { DebuggerElement } from "./DebuggerElement.js";
import { Accordion, AccordionPanel } from "../main/gui/Accordion.js";
import { StaticClass } from "../compiler/types/Class.js";
import { WatcherElement } from "./WatcherElement.js";
export class Debugger {
    constructor(main, $debuggerDiv, $projectexplorerDiv) {
        this.main = main;
        this.$debuggerDiv = $debuggerDiv;
        this.$projectexplorerDiv = $projectexplorerDiv;
        this.lastDebuggerElements = [];
        this.accordion = new Accordion(main, $debuggerDiv);
        this.variablePanel = new AccordionPanel(this.accordion, "Variablen", "3", null, null, "", false, false, "file", false, []);
        this.variablePanel.$listElement.css('margin-left', '4px');
        this.watchPanel = new AccordionPanel(this.accordion, "Beobachten", "2", "img_add-dark", "Beobachtungsterm hinzufÃ¼gen", "watcher", true, false, "file", false, []);
        this.watchPanel.$listElement.css('margin-left', '4px');
        let that = this;
        this.watchPanel.newElementCallback = (accordionElement, callbackIfSuccesful) => {
            that.addWatchExpression(accordionElement);
            callbackIfSuccesful(accordionElement.externalElement);
            return null;
        };
        this.watchPanel.deleteCallback = (watchExpression, callbackIfSuccesful) => {
            that.deleteWatchExpression(watchExpression);
            callbackIfSuccesful();
        };
        this.watchPanel.renameCallback = (watchExpression, newName) => {
            that.renameWatchExpression(watchExpression, newName);
            return newName;
        };
        this.$debuggerDiv.hide();
    }
    enable() {
        if (this.$projectexplorerDiv != null) {
            this.$projectexplorerDiv.hide();
        }
        this.$debuggerDiv.show();
        this.$debuggerDiv.parent().find(".jo_alternativeText").hide();
    }
    disable() {
        if (this.$projectexplorerDiv != null) {
            this.$projectexplorerDiv.show();
        }
        this.$debuggerDiv.hide();
        this.$debuggerDiv.parent().find(".jo_alternativeText").show();
    }
    showData(currentProgram, textPosition, stack, stackframe, heap) {
        if (currentProgram.module.file == null)
            return; // inside command line
        let elementsToKeep = [];
        let module = currentProgram.module;
        let symbolTable = module.findSymbolTableAtPosition(textPosition.line, textPosition.column);
        let oldDebuggerElements = this.lastDebuggerElements;
        this.lastDebuggerElements = [];
        let $variableList = this.variablePanel.$listElement;
        let st = symbolTable;
        if (symbolTable == null)
            return;
        if (st.classContext != null) {
            let object = stack[stackframe];
            // same object context as before?
            if (oldDebuggerElements.length > 0 && oldDebuggerElements[0].value == object && oldDebuggerElements[0].variable == null) {
                // yes => keep old Debugger Element and html-Element
                this.lastDebuggerElements.push(oldDebuggerElements[0]);
                elementsToKeep.push(this.lastDebuggerElements[0].$debuggerElement[0]);
            }
            else {
                // no => make a new one
                let thisString = (st.classContext instanceof StaticClass) ? st.classContext.identifier : "this";
                let de = new DebuggerElement(null, null, thisString, object, st.classContext, null);
                this.lastDebuggerElements.push(de);
            }
        }
        // in nested scopes there may be a variable in inner scope with same
        // identifier as variable in outer scope. We only want to show the variable in 
        // the inner scope, so we iterate from inner scope to outer scope and keep
        // track of already shown variable names:
        let visibleVariablesMap = {};
        // iterate over SymbolTable from inside to outside
        while (st != null) {
            st.variableMap.forEach((variable, identifier) => {
                // had there been a variable with same identifier in inner scope?
                if (visibleVariablesMap[variable.identifier] == null) {
                    // no
                    visibleVariablesMap[variable.identifier] = true;
                    let de;
                    // Reuse old Debugger Element vor variable, if present
                    for (let oldDe of oldDebuggerElements) {
                        if (oldDe.variable == variable && oldDe.$debuggerElement != null) {
                            de = oldDe;
                            elementsToKeep.push(de.$debuggerElement[0]);
                            if (de.value == null && de.variable != null) {
                                de.value = stack[stackframe + de.variable.stackPos];
                            }
                        }
                    }
                    // no old debugger element present, so make a new one
                    if (de == null) {
                        let value = stack[stackframe + variable.stackPos];
                        de = new DebuggerElement(null, null, identifier, value, variable.type, variable);
                    }
                    this.lastDebuggerElements.push(de);
                }
            }, this);
            // next outer symbol table
            st = st.parent;
        }
        // if we are outside class context, then variables on heap are visible:
        if (symbolTable.classContext == null) {
            for (let identifier in heap) {
                let variable = heap[identifier];
                if (visibleVariablesMap[variable.identifier] != true) {
                    visibleVariablesMap[variable.identifier] = true;
                    let de;
                    for (let oldDe of oldDebuggerElements) {
                        if (oldDe.variable == variable) {
                            de = oldDe;
                            elementsToKeep.push(de.$debuggerElement[0]);
                            de.value = de.variable.value;
                        }
                    }
                    if (de == null) {
                        let value = variable.value;
                        de = new DebuggerElement(null, null, identifier, value, variable.type, variable);
                    }
                    this.lastDebuggerElements.push(de);
                }
            }
        }
        // remove unused elements from html DOM:
        for (let child of $variableList.children()) {
            if (!(elementsToKeep.indexOf(child) >= 0)) {
                child.remove();
            }
        }
        // inject new values into debugger elements:
        for (let de of this.lastDebuggerElements) {
            if (de.variable != null) {
                if (de.variable.stackPos != null) {
                    de.value = stack[stackframe + de.variable.stackPos];
                }
                else {
                    de.value = de.variable.value;
                }
            }
            de.render();
            // if html element corresponding to debugger element is not already present in Browser-DOM
            // then append it to DOM
            if (elementsToKeep.indexOf(de.$debuggerElement[0]) < 0) {
                $variableList.append(de.$debuggerElement);
            }
        }
        this.lastSymboltable = symbolTable;
        // this.evaluateWatcherExpressions(currentProgram, textPosition, stack, stackframe);
        this.evaluateWatcherExpressions();
    }
    renameWatchExpression(watcherElement, newName) {
        watcherElement.expression = newName;
        monaco.editor.colorize(newName, 'myJava', { tabSize: 3 }).then((command) => {
            let $div = watcherElement.accordionElement.$htmlFirstLine.find('.jo_filename');
            command = '<span class="jo_watcherExpression">' + command + "</span>";
            $div.html(command);
            $div.attr('title', watcherElement.expression);
        });
        if (this.main.getInterpreter().state == InterpreterState.paused) {
            watcherElement.evaluate();
        }
    }
    deleteWatchExpression(watchExpression) {
        // nothing to do
    }
    addWatchExpression(accordionElement) {
        accordionElement.$htmlSecondLine = jQuery('<div></div>');
        let $rightTextAfterFilename = accordionElement.$htmlFirstLine.parent().find('.jo_textAfterName').first();
        let we = new WatcherElement(accordionElement.name, accordionElement, this.main, accordionElement.$htmlSecondLine, $rightTextAfterFilename);
        accordionElement.externalElement = we;
        monaco.editor.colorize(accordionElement.name, 'myJava', { tabSize: 3 }).then((command) => {
            let $div = accordionElement.$htmlFirstLine.find('.jo_filename');
            command = '<span class="jo_watcherExpression">' + command + "</span>";
            $div.html(command);
            $div.attr('title', accordionElement.externalElement.expression);
        });
        we.evaluate();
    }
    evaluateWatcherExpressions() {
        for (let ae of this.watchPanel.elements) {
            let we = ae.externalElement;
            we.evaluate();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L2ludGVycHJldGVyL0RlYnVnZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBb0MsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQU90RixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQW9CLE1BQU0sMEJBQTBCLENBQUM7QUFDdkYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXpELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdyRCxNQUFNLE9BQU8sUUFBUTtJQVdqQixZQUFvQixJQUFjLEVBQVUsWUFBaUMsRUFBVSxtQkFBeUM7UUFBNUcsU0FBSSxHQUFKLElBQUksQ0FBVTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQUFVLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBc0I7UUFSaEkseUJBQW9CLEdBQXNCLEVBQUUsQ0FBQztRQVV6QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUVuRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsWUFB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QUMsQ0FBQztZQUNoRSxPQUFPLEdBQUcscUNBQXFDLEdBQUcsT0FBTyxHQUFHLFNBQVMsQ0FBQztZQUN0RSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVwRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUVsQixDQUFDO0lBRUQsMEJBQTBCO1FBRXRCLEtBQUssSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUU7WUFDckMsSUFBSSxFQUFFLEdBQW1CLEVBQUUsQ0FBQyxlQUFlLENBQUM7WUFDNUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ2pCO0lBR0wsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW50ZXJwcmV0ZXIsIFByb2dyYW1TdGFja0VsZW1lbnQsIEludGVycHJldGVyU3RhdGUgfSBmcm9tIFwiLi9JbnRlcnByZXRlci5qc1wiO1xyXG5pbXBvcnQgeyBNYWluIH0gZnJvbSBcIi4uL21haW4vTWFpbi5qc1wiO1xyXG5pbXBvcnQgeyBWYWx1ZSwgSGVhcCB9IGZyb20gXCIuLi9jb21waWxlci90eXBlcy9UeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBNb2R1bGUgfSBmcm9tIFwiLi4vY29tcGlsZXIvcGFyc2VyL01vZHVsZS5qc1wiO1xyXG5pbXBvcnQgeyBUZXh0UG9zaXRpb24gfSBmcm9tIFwiLi4vY29tcGlsZXIvbGV4ZXIvVG9rZW4uanNcIjtcclxuaW1wb3J0IHsgUHJvZ3JhbSB9IGZyb20gXCIuLi9jb21waWxlci9wYXJzZXIvUHJvZ3JhbS5qc1wiO1xyXG5pbXBvcnQgeyBTeW1ib2xUYWJsZSB9IGZyb20gXCIuLi9jb21waWxlci9wYXJzZXIvU3ltYm9sVGFibGUuanNcIjtcclxuaW1wb3J0IHsgRGVidWdnZXJFbGVtZW50IH0gZnJvbSBcIi4vRGVidWdnZXJFbGVtZW50LmpzXCI7XHJcbmltcG9ydCB7IEFjY29yZGlvbiwgQWNjb3JkaW9uUGFuZWwsIEFjY29yZGlvbkVsZW1lbnQgfSBmcm9tIFwiLi4vbWFpbi9ndWkvQWNjb3JkaW9uLmpzXCI7XHJcbmltcG9ydCB7IFN0YXRpY0NsYXNzIH0gZnJvbSBcIi4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IEFkaG9jQ29tcGlsZXIgfSBmcm9tIFwiLi4vY29tcGlsZXIvQWRob2NDb21waWxlci5qc1wiO1xyXG5pbXBvcnQgeyBXYXRjaGVyRWxlbWVudCB9IGZyb20gXCIuL1dhdGNoZXJFbGVtZW50LmpzXCI7XHJcbmltcG9ydCB7IE1haW5CYXNlIH0gZnJvbSBcIi4uL21haW4vTWFpbkJhc2UuanNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBEZWJ1Z2dlciB7XHJcblxyXG4gICAgbGFzdFN5bWJvbHRhYmxlOiBTeW1ib2xUYWJsZTtcclxuICAgIGxhc3REZWJ1Z2dlckVsZW1lbnRzOiBEZWJ1Z2dlckVsZW1lbnRbXSA9IFtdO1xyXG4gICAgYWNjb3JkaW9uOiBBY2NvcmRpb247XHJcblxyXG4gICAgdmFyaWFibGVQYW5lbDogQWNjb3JkaW9uUGFuZWw7XHJcblxyXG4gICAgd2F0Y2hQYW5lbDogQWNjb3JkaW9uUGFuZWw7XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFpbjogTWFpbkJhc2UsIHByaXZhdGUgJGRlYnVnZ2VyRGl2OiBKUXVlcnk8SFRNTEVsZW1lbnQ+LCBwcml2YXRlICRwcm9qZWN0ZXhwbG9yZXJEaXY/OiBKUXVlcnk8SFRNTEVsZW1lbnQ+KSB7XHJcblxyXG4gICAgICAgIHRoaXMuYWNjb3JkaW9uID0gbmV3IEFjY29yZGlvbihtYWluLCAkZGVidWdnZXJEaXYpO1xyXG5cclxuICAgICAgICB0aGlzLnZhcmlhYmxlUGFuZWwgPSBuZXcgQWNjb3JkaW9uUGFuZWwodGhpcy5hY2NvcmRpb24sIFwiVmFyaWFibGVuXCIsIFwiM1wiLCBudWxsLCBudWxsLCBcIlwiLCBmYWxzZSwgZmFsc2UsIFwiZmlsZVwiLCBmYWxzZSwgW10pO1xyXG4gICAgICAgIHRoaXMudmFyaWFibGVQYW5lbC4kbGlzdEVsZW1lbnQuY3NzKCdtYXJnaW4tbGVmdCcsICc0cHgnKTtcclxuXHJcbiAgICAgICAgdGhpcy53YXRjaFBhbmVsID0gbmV3IEFjY29yZGlvblBhbmVsKHRoaXMuYWNjb3JkaW9uLCBcIkJlb2JhY2h0ZW5cIiwgXCIyXCIsXHJcbiAgICAgICAgICAgIFwiaW1nX2FkZC1kYXJrXCIsIFwiQmVvYmFjaHR1bmdzdGVybSBoaW56dWbDvGdlblwiLFxyXG4gICAgICAgICAgICBcIndhdGNoZXJcIiwgdHJ1ZSwgZmFsc2UsIFwiZmlsZVwiLCBmYWxzZSwgW10pO1xyXG4gICAgICAgIHRoaXMud2F0Y2hQYW5lbC4kbGlzdEVsZW1lbnQuY3NzKCdtYXJnaW4tbGVmdCcsICc0cHgnKTtcclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMud2F0Y2hQYW5lbC5uZXdFbGVtZW50Q2FsbGJhY2sgPSAoYWNjb3JkaW9uRWxlbWVudCwgY2FsbGJhY2tJZlN1Y2Nlc2Z1bCkgPT4ge1xyXG4gICAgICAgICAgICB0aGF0LmFkZFdhdGNoRXhwcmVzc2lvbihhY2NvcmRpb25FbGVtZW50KTtcclxuICAgICAgICAgICAgY2FsbGJhY2tJZlN1Y2Nlc2Z1bChhY2NvcmRpb25FbGVtZW50LmV4dGVybmFsRWxlbWVudCk7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMud2F0Y2hQYW5lbC5kZWxldGVDYWxsYmFjayA9ICh3YXRjaEV4cHJlc3Npb24sIGNhbGxiYWNrSWZTdWNjZXNmdWwpID0+IHtcclxuICAgICAgICAgICAgdGhhdC5kZWxldGVXYXRjaEV4cHJlc3Npb24od2F0Y2hFeHByZXNzaW9uKTtcclxuICAgICAgICAgICAgY2FsbGJhY2tJZlN1Y2Nlc2Z1bCgpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMud2F0Y2hQYW5lbC5yZW5hbWVDYWxsYmFjayA9ICh3YXRjaEV4cHJlc3Npb24sIG5ld05hbWUpID0+IHtcclxuICAgICAgICAgICAgdGhhdC5yZW5hbWVXYXRjaEV4cHJlc3Npb24od2F0Y2hFeHByZXNzaW9uLCBuZXdOYW1lKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ld05hbWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLiRkZWJ1Z2dlckRpdi5oaWRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGVuYWJsZSgpIHtcclxuICAgICAgICBpZiAodGhpcy4kcHJvamVjdGV4cGxvcmVyRGl2ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy4kcHJvamVjdGV4cGxvcmVyRGl2LmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy4kZGVidWdnZXJEaXYuc2hvdygpO1xyXG4gICAgICAgIHRoaXMuJGRlYnVnZ2VyRGl2LnBhcmVudCgpLmZpbmQoXCIuam9fYWx0ZXJuYXRpdmVUZXh0XCIpLmhpZGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZGlzYWJsZSgpIHtcclxuICAgICAgICBpZiAodGhpcy4kcHJvamVjdGV4cGxvcmVyRGl2ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy4kcHJvamVjdGV4cGxvcmVyRGl2LnNob3coKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy4kZGVidWdnZXJEaXYuaGlkZSgpO1xyXG4gICAgICAgIHRoaXMuJGRlYnVnZ2VyRGl2LnBhcmVudCgpLmZpbmQoXCIuam9fYWx0ZXJuYXRpdmVUZXh0XCIpLnNob3coKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93RGF0YShjdXJyZW50UHJvZ3JhbTogUHJvZ3JhbSwgdGV4dFBvc2l0aW9uOiBUZXh0UG9zaXRpb24sXHJcbiAgICAgICAgc3RhY2s6IFZhbHVlW10sIHN0YWNrZnJhbWU6IG51bWJlciwgaGVhcDogSGVhcCkge1xyXG5cclxuICAgICAgICBpZiAoY3VycmVudFByb2dyYW0ubW9kdWxlLmZpbGUgPT0gbnVsbCkgcmV0dXJuOyAvLyBpbnNpZGUgY29tbWFuZCBsaW5lXHJcblxyXG4gICAgICAgIGxldCBlbGVtZW50c1RvS2VlcDogSFRNTEVsZW1lbnRbXSA9IFtdO1xyXG5cclxuICAgICAgICBsZXQgbW9kdWxlID0gY3VycmVudFByb2dyYW0ubW9kdWxlO1xyXG4gICAgICAgIGxldCBzeW1ib2xUYWJsZSA9IG1vZHVsZS5maW5kU3ltYm9sVGFibGVBdFBvc2l0aW9uKHRleHRQb3NpdGlvbi5saW5lLCB0ZXh0UG9zaXRpb24uY29sdW1uKTtcclxuXHJcbiAgICAgICAgbGV0IG9sZERlYnVnZ2VyRWxlbWVudHMgPSB0aGlzLmxhc3REZWJ1Z2dlckVsZW1lbnRzO1xyXG5cclxuICAgICAgICB0aGlzLmxhc3REZWJ1Z2dlckVsZW1lbnRzID0gW107XHJcbiAgICAgICAgbGV0ICR2YXJpYWJsZUxpc3QgPSB0aGlzLnZhcmlhYmxlUGFuZWwuJGxpc3RFbGVtZW50O1xyXG5cclxuICAgICAgICBsZXQgc3QgPSBzeW1ib2xUYWJsZTtcclxuXHJcbiAgICAgICAgaWYoc3ltYm9sVGFibGUgPT0gbnVsbCkgcmV0dXJuO1xyXG5cclxuICAgICAgICBpZiAoc3QuY2xhc3NDb250ZXh0ICE9IG51bGwpIHtcclxuXHJcbiAgICAgICAgICAgIGxldCBvYmplY3QgPSBzdGFja1tzdGFja2ZyYW1lXTtcclxuICAgICAgICAgICAgLy8gc2FtZSBvYmplY3QgY29udGV4dCBhcyBiZWZvcmU/XHJcbiAgICAgICAgICAgIGlmIChvbGREZWJ1Z2dlckVsZW1lbnRzLmxlbmd0aCA+IDAgJiYgb2xkRGVidWdnZXJFbGVtZW50c1swXS52YWx1ZSA9PSBvYmplY3QgJiYgb2xkRGVidWdnZXJFbGVtZW50c1swXS52YXJpYWJsZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB5ZXMgPT4ga2VlcCBvbGQgRGVidWdnZXIgRWxlbWVudCBhbmQgaHRtbC1FbGVtZW50XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3REZWJ1Z2dlckVsZW1lbnRzLnB1c2gob2xkRGVidWdnZXJFbGVtZW50c1swXSk7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50c1RvS2VlcC5wdXNoKHRoaXMubGFzdERlYnVnZ2VyRWxlbWVudHNbMF0uJGRlYnVnZ2VyRWxlbWVudFswXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBubyA9PiBtYWtlIGEgbmV3IG9uZVxyXG4gICAgICAgICAgICAgICAgbGV0IHRoaXNTdHJpbmcgPSAoc3QuY2xhc3NDb250ZXh0IGluc3RhbmNlb2YgU3RhdGljQ2xhc3MpID8gc3QuY2xhc3NDb250ZXh0LmlkZW50aWZpZXIgOiBcInRoaXNcIjtcclxuICAgICAgICAgICAgICAgIGxldCBkZTogRGVidWdnZXJFbGVtZW50ID0gbmV3IERlYnVnZ2VyRWxlbWVudChudWxsLCBudWxsLCB0aGlzU3RyaW5nLCBvYmplY3QsIHN0LmNsYXNzQ29udGV4dCwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3REZWJ1Z2dlckVsZW1lbnRzLnB1c2goZGUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gaW4gbmVzdGVkIHNjb3BlcyB0aGVyZSBtYXkgYmUgYSB2YXJpYWJsZSBpbiBpbm5lciBzY29wZSB3aXRoIHNhbWVcclxuICAgICAgICAvLyBpZGVudGlmaWVyIGFzIHZhcmlhYmxlIGluIG91dGVyIHNjb3BlLiBXZSBvbmx5IHdhbnQgdG8gc2hvdyB0aGUgdmFyaWFibGUgaW4gXHJcbiAgICAgICAgLy8gdGhlIGlubmVyIHNjb3BlLCBzbyB3ZSBpdGVyYXRlIGZyb20gaW5uZXIgc2NvcGUgdG8gb3V0ZXIgc2NvcGUgYW5kIGtlZXBcclxuICAgICAgICAvLyB0cmFjayBvZiBhbHJlYWR5IHNob3duIHZhcmlhYmxlIG5hbWVzOlxyXG4gICAgICAgIGxldCB2aXNpYmxlVmFyaWFibGVzTWFwOiB7IFtpZGVudGlmaWVyOiBzdHJpbmddOiBib29sZWFuIH0gPSB7fTtcclxuXHJcbiAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIFN5bWJvbFRhYmxlIGZyb20gaW5zaWRlIHRvIG91dHNpZGVcclxuICAgICAgICB3aGlsZSAoc3QgIT0gbnVsbCkge1xyXG5cclxuICAgICAgICAgICAgc3QudmFyaWFibGVNYXAuZm9yRWFjaCgodmFyaWFibGUsIGlkZW50aWZpZXIpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBoYWQgdGhlcmUgYmVlbiBhIHZhcmlhYmxlIHdpdGggc2FtZSBpZGVudGlmaWVyIGluIGlubmVyIHNjb3BlP1xyXG4gICAgICAgICAgICAgICAgaWYgKHZpc2libGVWYXJpYWJsZXNNYXBbdmFyaWFibGUuaWRlbnRpZmllcl0gPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIG5vXHJcbiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZVZhcmlhYmxlc01hcFt2YXJpYWJsZS5pZGVudGlmaWVyXSA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBkZTogRGVidWdnZXJFbGVtZW50O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBSZXVzZSBvbGQgRGVidWdnZXIgRWxlbWVudCB2b3IgdmFyaWFibGUsIGlmIHByZXNlbnRcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBvbGREZSBvZiBvbGREZWJ1Z2dlckVsZW1lbnRzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGREZS52YXJpYWJsZSA9PSB2YXJpYWJsZSAmJiBvbGREZS4kZGVidWdnZXJFbGVtZW50ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlID0gb2xkRGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50c1RvS2VlcC5wdXNoKGRlLiRkZWJ1Z2dlckVsZW1lbnRbMF0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZS52YWx1ZSA9PSBudWxsICYmIGRlLnZhcmlhYmxlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZS52YWx1ZSA9IHN0YWNrW3N0YWNrZnJhbWUgKyBkZS52YXJpYWJsZS5zdGFja1Bvc107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBubyBvbGQgZGVidWdnZXIgZWxlbWVudCBwcmVzZW50LCBzbyBtYWtlIGEgbmV3IG9uZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHN0YWNrW3N0YWNrZnJhbWUgKyB2YXJpYWJsZS5zdGFja1Bvc107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlID0gbmV3IERlYnVnZ2VyRWxlbWVudChudWxsLCBudWxsLCBpZGVudGlmaWVyLCB2YWx1ZSwgdmFyaWFibGUudHlwZSwgdmFyaWFibGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0RGVidWdnZXJFbGVtZW50cy5wdXNoKGRlKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9LCB0aGlzKTtcclxuXHJcbiAgICAgICAgICAgIC8vIG5leHQgb3V0ZXIgc3ltYm9sIHRhYmxlXHJcbiAgICAgICAgICAgIHN0ID0gc3QucGFyZW50O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gaWYgd2UgYXJlIG91dHNpZGUgY2xhc3MgY29udGV4dCwgdGhlbiB2YXJpYWJsZXMgb24gaGVhcCBhcmUgdmlzaWJsZTpcclxuICAgICAgICBpZiAoc3ltYm9sVGFibGUuY2xhc3NDb250ZXh0ID09IG51bGwpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaWRlbnRpZmllciBpbiBoZWFwKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhYmxlID0gaGVhcFtpZGVudGlmaWVyXTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodmlzaWJsZVZhcmlhYmxlc01hcFt2YXJpYWJsZS5pZGVudGlmaWVyXSAhPSB0cnVlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZpc2libGVWYXJpYWJsZXNNYXBbdmFyaWFibGUuaWRlbnRpZmllcl0gPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgZGU6IERlYnVnZ2VyRWxlbWVudDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgb2xkRGUgb2Ygb2xkRGVidWdnZXJFbGVtZW50cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkRGUudmFyaWFibGUgPT0gdmFyaWFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlID0gb2xkRGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50c1RvS2VlcC5wdXNoKGRlLiRkZWJ1Z2dlckVsZW1lbnRbMF0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlLnZhbHVlID0gZGUudmFyaWFibGUudmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGUgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSB2YXJpYWJsZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGUgPSBuZXcgRGVidWdnZXJFbGVtZW50KG51bGwsIG51bGwsIGlkZW50aWZpZXIsIHZhbHVlLCB2YXJpYWJsZS50eXBlLCB2YXJpYWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3REZWJ1Z2dlckVsZW1lbnRzLnB1c2goZGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gcmVtb3ZlIHVudXNlZCBlbGVtZW50cyBmcm9tIGh0bWwgRE9NOlxyXG4gICAgICAgIGZvciAobGV0IGNoaWxkIG9mICR2YXJpYWJsZUxpc3QuY2hpbGRyZW4oKSkge1xyXG4gICAgICAgICAgICBpZiAoIShlbGVtZW50c1RvS2VlcC5pbmRleE9mKGNoaWxkKSA+PSAwKSkge1xyXG4gICAgICAgICAgICAgICAgY2hpbGQucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGluamVjdCBuZXcgdmFsdWVzIGludG8gZGVidWdnZXIgZWxlbWVudHM6XHJcbiAgICAgICAgZm9yIChsZXQgZGUgb2YgdGhpcy5sYXN0RGVidWdnZXJFbGVtZW50cykge1xyXG5cclxuICAgICAgICAgICAgaWYgKGRlLnZhcmlhYmxlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkZS52YXJpYWJsZS5zdGFja1BvcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGUudmFsdWUgPSBzdGFja1tzdGFja2ZyYW1lICsgZGUudmFyaWFibGUuc3RhY2tQb3NdO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkZS52YWx1ZSA9IGRlLnZhcmlhYmxlLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBkZS5yZW5kZXIoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGlmIGh0bWwgZWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIGRlYnVnZ2VyIGVsZW1lbnQgaXMgbm90IGFscmVhZHkgcHJlc2VudCBpbiBCcm93c2VyLURPTVxyXG4gICAgICAgICAgICAvLyB0aGVuIGFwcGVuZCBpdCB0byBET01cclxuICAgICAgICAgICAgaWYgKGVsZW1lbnRzVG9LZWVwLmluZGV4T2YoZGUuJGRlYnVnZ2VyRWxlbWVudFswXSkgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICAkdmFyaWFibGVMaXN0LmFwcGVuZChkZS4kZGVidWdnZXJFbGVtZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5sYXN0U3ltYm9sdGFibGUgPSBzeW1ib2xUYWJsZTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5ldmFsdWF0ZVdhdGNoZXJFeHByZXNzaW9ucyhjdXJyZW50UHJvZ3JhbSwgdGV4dFBvc2l0aW9uLCBzdGFjaywgc3RhY2tmcmFtZSk7XHJcbiAgICAgICAgdGhpcy5ldmFsdWF0ZVdhdGNoZXJFeHByZXNzaW9ucygpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICByZW5hbWVXYXRjaEV4cHJlc3Npb24od2F0Y2hlckVsZW1lbnQ6IFdhdGNoZXJFbGVtZW50LCBuZXdOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICB3YXRjaGVyRWxlbWVudC5leHByZXNzaW9uID0gbmV3TmFtZTtcclxuXHJcbiAgICAgICAgbW9uYWNvLmVkaXRvci5jb2xvcml6ZShuZXdOYW1lLCAnbXlKYXZhJywgeyB0YWJTaXplOiAzIH0pLnRoZW4oKGNvbW1hbmQpID0+IHtcclxuXHJcbiAgICAgICAgICAgIGxldCAkZGl2ID0gd2F0Y2hlckVsZW1lbnQuYWNjb3JkaW9uRWxlbWVudC4kaHRtbEZpcnN0TGluZS5maW5kKCcuam9fZmlsZW5hbWUnKTtcclxuICAgICAgICAgICAgY29tbWFuZCA9ICc8c3BhbiBjbGFzcz1cImpvX3dhdGNoZXJFeHByZXNzaW9uXCI+JyArIGNvbW1hbmQgKyBcIjwvc3Bhbj5cIjtcclxuICAgICAgICAgICAgJGRpdi5odG1sKGNvbW1hbmQpO1xyXG4gICAgICAgICAgICAkZGl2LmF0dHIoJ3RpdGxlJywgd2F0Y2hlckVsZW1lbnQuZXhwcmVzc2lvbik7XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5tYWluLmdldEludGVycHJldGVyKCkuc3RhdGUgPT0gSW50ZXJwcmV0ZXJTdGF0ZS5wYXVzZWQpIHtcclxuICAgICAgICAgICAgd2F0Y2hlckVsZW1lbnQuZXZhbHVhdGUoKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBkZWxldGVXYXRjaEV4cHJlc3Npb24od2F0Y2hFeHByZXNzaW9uOiBhbnkpIHtcclxuICAgICAgICAvLyBub3RoaW5nIHRvIGRvXHJcbiAgICB9XHJcblxyXG4gICAgYWRkV2F0Y2hFeHByZXNzaW9uKGFjY29yZGlvbkVsZW1lbnQ6IEFjY29yZGlvbkVsZW1lbnQpIHtcclxuXHJcbiAgICAgICAgYWNjb3JkaW9uRWxlbWVudC4kaHRtbFNlY29uZExpbmUgPSBqUXVlcnkoJzxkaXY+PC9kaXY+Jyk7XHJcbiAgICAgICAgbGV0ICRyaWdodFRleHRBZnRlckZpbGVuYW1lID0gYWNjb3JkaW9uRWxlbWVudC4kaHRtbEZpcnN0TGluZS5wYXJlbnQoKS5maW5kKCcuam9fdGV4dEFmdGVyTmFtZScpLmZpcnN0KCk7XHJcblxyXG4gICAgICAgIGxldCB3ZSA9IG5ldyBXYXRjaGVyRWxlbWVudChhY2NvcmRpb25FbGVtZW50Lm5hbWUsIGFjY29yZGlvbkVsZW1lbnQsXHJcbiAgICAgICAgICAgIHRoaXMubWFpbiwgYWNjb3JkaW9uRWxlbWVudC4kaHRtbFNlY29uZExpbmUsICRyaWdodFRleHRBZnRlckZpbGVuYW1lKTtcclxuXHJcbiAgICAgICAgYWNjb3JkaW9uRWxlbWVudC5leHRlcm5hbEVsZW1lbnQgPSB3ZTtcclxuXHJcbiAgICAgICAgbW9uYWNvLmVkaXRvci5jb2xvcml6ZShhY2NvcmRpb25FbGVtZW50Lm5hbWUsICdteUphdmEnLCB7IHRhYlNpemU6IDMgfSkudGhlbigoY29tbWFuZCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgbGV0ICRkaXYgPSBhY2NvcmRpb25FbGVtZW50LiRodG1sRmlyc3RMaW5lLmZpbmQoJy5qb19maWxlbmFtZScpO1xyXG4gICAgICAgICAgICBjb21tYW5kID0gJzxzcGFuIGNsYXNzPVwiam9fd2F0Y2hlckV4cHJlc3Npb25cIj4nICsgY29tbWFuZCArIFwiPC9zcGFuPlwiO1xyXG4gICAgICAgICAgICAkZGl2Lmh0bWwoY29tbWFuZCk7XHJcbiAgICAgICAgICAgICRkaXYuYXR0cigndGl0bGUnLCBhY2NvcmRpb25FbGVtZW50LmV4dGVybmFsRWxlbWVudC5leHByZXNzaW9uKTtcclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHdlLmV2YWx1YXRlKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV2YWx1YXRlV2F0Y2hlckV4cHJlc3Npb25zKCkge1xyXG5cclxuICAgICAgICBmb3IgKGxldCBhZSBvZiB0aGlzLndhdGNoUGFuZWwuZWxlbWVudHMpIHtcclxuICAgICAgICAgICAgbGV0IHdlOiBXYXRjaGVyRWxlbWVudCA9IGFlLmV4dGVybmFsRWxlbWVudDtcclxuICAgICAgICAgICAgd2UuZXZhbHVhdGUoKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgIH1cclxuXHJcblxyXG59Il19