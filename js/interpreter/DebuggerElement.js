import { stringPrimitiveType } from "../compiler/types/PrimitiveTypes.js";
import { ArrayType } from "../compiler/types/Array.js";
import { Klass, Visibility, StaticClass, Interface } from "../compiler/types/Class.js";
import { Enum } from "../compiler/types/Enum.js";
import { RuntimeObject } from "./RuntimeObject.js";
export class DebuggerElement {
    constructor(caption, parent, identifier, value, type, variable) {
        this.children = [];
        this.isOpen = false;
        this.caption = caption;
        this.parent = parent;
        if (parent != null) {
            parent.children.push(this);
        }
        this.value = value;
        this.type = type;
        this.variable = variable;
        this.identifier = identifier;
    }
    getLevel() {
        return this.parent == null ? 0 : this.parent.getLevel() + 1;
    }
    getIndent() {
        // return this.getLevel() * 15;
        return this.getLevel() == 0 ? 0 : 15;
    }
    render() {
        if (this.$debuggerElement == null) {
            this.$debuggerElement = jQuery('<div>');
            this.$debuggerElement.addClass("jo_debuggerElement");
            this.$debuggerElement.css('margin-left', '' + this.getIndent() + 'px');
            let $deFirstLine = jQuery('<div class="jo_deFirstline"><span class="jo_deIdentifier">' +
                this.identifier + '</span>:&nbsp;<span class="jo_deValue"></span></div>');
            this.$debuggerElement.append($deFirstLine);
            // show compound types in own branch of visible tree
            if (this.type instanceof ArrayType ||
                (this.type instanceof Klass && !(this.type instanceof Enum) && !(this.type == stringPrimitiveType))
                || this.type instanceof StaticClass
                || this.type instanceof Interface) {
                this.canOpen = true;
                this.$debuggerElement.addClass('jo_canOpen');
                this.$debuggerElement.append(jQuery('<div class="jo_deChildContainer"></div>'));
                this.$debuggerElement.find('.jo_deFirstline').on('mousedown', (event) => {
                    if (this.value != null && this.value.value != null) {
                        if (this.children.length == 0) {
                            this.onFirstOpening();
                        }
                        this.$debuggerElement.toggleClass('jo_expanded');
                        this.isOpen = !this.isOpen;
                    }
                    else {
                        this.children = [];
                    }
                    event.stopPropagation();
                });
            }
        }
        this.renderValue();
    }
    onFirstOpening() {
        this.children = [];
        if (this.type instanceof Klass) {
            let ro = this.value.value;
            let listHelper = ro.intrinsicData == null ? null : ro.intrinsicData["ListHelper"];
            if (listHelper != null) {
                this.renderListElements(listHelper);
            }
            else {
                for (let a of this.value.type.getAttributes(Visibility.private)) {
                    let de = new DebuggerElement(null, this, a.identifier, ro.getValue(a.index), a.type, null);
                    de.render();
                    this.$debuggerElement.find('.jo_deChildContainer').append(de.$debuggerElement);
                }
            }
        }
        else if (this.type instanceof ArrayType) {
            let a = this.value.value;
            let $childContainer = this.$debuggerElement.find('.jo_deChildContainer');
            for (let i = 0; i < a.length && i < 100; i++) {
                let de = new DebuggerElement(null, this, "[" + i + "]", a[i], this.type.arrayOfType, null);
                de.render();
                $childContainer.append(de.$debuggerElement);
            }
        }
        else if (this.type instanceof StaticClass) {
            for (let a of this.type.getAttributes(Visibility.private)) {
                let ro = this.type.classObject;
                let de = new DebuggerElement(null, this, a.identifier, ro.getValue(a.index), a.type, null);
                de.render();
                this.$debuggerElement.find('.jo_deChildContainer').append(de.$debuggerElement);
            }
        }
        else if (this.type instanceof Interface) {
            if (this.value.value != null && this.value.value instanceof RuntimeObject) {
                let ro = this.value.value;
                for (let a of ro.class.getAttributes(Visibility.private)) {
                    let de = new DebuggerElement(null, this, a.identifier, ro.getValue(a.index), a.type, null);
                    de.render();
                    this.$debuggerElement.find('.jo_deChildContainer').append(de.$debuggerElement);
                }
            }
            else {
                this.children == [];
            }
        }
    }
    renderListElements(listHelper) {
        let valueArray = listHelper.valueArray;
        if (this.children.length > valueArray.length) {
            for (let i = valueArray.length; i < this.children.length; i++) {
                let childElement = this.children[i];
                childElement.$debuggerElement.remove();
            }
            this.children.splice(valueArray.length);
        }
        if (this.children.length < valueArray.length && this.children.length < 100) {
            for (let i = this.children.length; i < valueArray.length && i <= 100; i++) {
                let v = valueArray[i];
                let title = "" + i;
                if (i == 100) {
                    v = { type: stringPrimitiveType, value: "" + (listHelper.valueArray.length - 100) + " weitere..." };
                    title = "...";
                }
                let de = new DebuggerElement(null, this, title, v, v.type, null);
                de.render();
                this.$debuggerElement.find('.jo_deChildContainer').first().append(de.$debuggerElement);
            }
        }
    }
    renderValue() {
        var _a;
        let s;
        let v = this.value;
        if (v == null) {
            this.$debuggerElement.hide();
            return;
        }
        this.$debuggerElement.show();
        if (v.value == null) {
            s = "null";
            this.removeAllChildren();
        }
        else {
            if (v.updateValue != null) {
                v.updateValue(v);
            }
            s = (_a = v.type) === null || _a === void 0 ? void 0 : _a.debugOutput(v);
            if (this.type instanceof Klass) {
                let ro = this.value.value;
                let listHelper = ro.intrinsicData == null ? null : ro.intrinsicData["ListHelper"];
                if (listHelper != null) {
                    this.renderListElements(listHelper);
                    if (listHelper.allElementsPrimitive()) {
                        s = "" + listHelper.valueArray.length + " El: ";
                        s += "[" + listHelper.objectArray.slice(0, 20).map(o => "" + o).join(", ") + "]";
                    }
                    else {
                        s = v.type.identifier + " (" + listHelper.valueArray.length + " Elemente)";
                    }
                }
            }
        }
        this.$debuggerElement.find('.jo_deValue').first().html(s == null ? "" : s);
        for (let child of this.children) {
            child.renderValue();
        }
    }
    removeAllChildren() {
        for (let de of this.children) {
            de.$debuggerElement.remove();
        }
        this.children = [];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdnZXJFbGVtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NsaWVudC9pbnRlcnByZXRlci9EZWJ1Z2dlckVsZW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR25ELE1BQU0sT0FBTyxlQUFlO0lBbUJ4QixZQUFZLE9BQWUsRUFBRSxNQUF1QixFQUFFLFVBQWtCLEVBQUUsS0FBWSxFQUFFLElBQVUsRUFBRSxRQUFrQjtRQWJ0SCxhQUFRLEdBQXNCLEVBQUUsQ0FBQztRQUdqQyxXQUFNLEdBQVksS0FBSyxDQUFDO1FBV3BCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksTUFBTSxJQUFJLElBQUksRUFBRTtZQUNoQixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQ2pDLENBQUM7SUFFRCxRQUFRO1FBQ0osT0FBTyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxD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LENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFHM0UsS0FBSyxJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQzdCLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUN2QjtJQUNMLENBQUM7SUFFRCxpQkFBaUI7UUFDYixLQUFLLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDMUIsRUFBRSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2hDO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUE7SUFDdEIsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmFsdWUsIFR5cGUsIFZhcmlhYmxlIH0gZnJvbSBcIi4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IHN0cmluZ1ByaW1pdGl2ZVR5cGUgfSBmcm9tIFwiLi4vY29tcGlsZXIvdHlwZXMvUHJpbWl0aXZlVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgQXJyYXlUeXBlIH0gZnJvbSBcIi4uL2NvbXBpbGVyL3R5cGVzL0FycmF5LmpzXCI7XHJcbmltcG9ydCB7IEtsYXNzLCBWaXNpYmlsaXR5LCBTdGF0aWNDbGFzcywgSW50ZXJmYWNlIH0gZnJvbSBcIi4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IEVudW0gfSBmcm9tIFwiLi4vY29tcGlsZXIvdHlwZXMvRW51bS5qc1wiO1xyXG5pbXBvcnQgeyBSdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4vUnVudGltZU9iamVjdC5qc1wiO1xyXG5pbXBvcnQgeyBMaXN0SGVscGVyIH0gZnJvbSBcIi4uL3J1bnRpbWVsaWJyYXJ5L2NvbGxlY3Rpb25zL0FycmF5TGlzdC5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIERlYnVnZ2VyRWxlbWVudCB7XHJcblxyXG4gICAgY2FwdGlvbjogc3RyaW5nOyAvLyBvbmx5IHVzZWQgZm9yIHJvb3QgZWxlbWVudHMsIGUuZy4gXCJMb2NhbCB2YXJpYWJsZXNcIlxyXG4gICAgLy8gaWYgY2FwdGlvbiBpcyBzZXQgdGhlbiB2YWx1ZSA9PSBudWxsIGFuZCBwYXJlbnQgPT0gbnVsbFxyXG5cclxuICAgIHBhcmVudDogRGVidWdnZXJFbGVtZW50O1xyXG4gICAgY2hpbGRyZW46IERlYnVnZ2VyRWxlbWVudFtdID0gW107XHJcblxyXG4gICAgY2FuT3BlbjogYm9vbGVhbjtcclxuICAgIGlzT3BlbjogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIHZhbHVlOiBWYWx1ZTtcclxuICAgIHZhcmlhYmxlOiBWYXJpYWJsZTtcclxuXHJcbiAgICB0eXBlOiBUeXBlO1xyXG4gICAgaWRlbnRpZmllcjogc3RyaW5nO1xyXG5cclxuICAgICRkZWJ1Z2dlckVsZW1lbnQ6IEpRdWVyeTxIVE1MRWxlbWVudD47XHJcblxyXG4gICAgY29uc3RydWN0b3IoY2FwdGlvbjogc3RyaW5nLCBwYXJlbnQ6IERlYnVnZ2VyRWxlbWVudCwgaWRlbnRpZmllcjogc3RyaW5nLCB2YWx1ZTogVmFsdWUsIHR5cGU6IFR5cGUsIHZhcmlhYmxlOiBWYXJpYWJsZSkge1xyXG4gICAgICAgIHRoaXMuY2FwdGlvbiA9IGNhcHRpb247XHJcbiAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7XHJcbiAgICAgICAgaWYgKHBhcmVudCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKHRoaXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcclxuICAgICAgICB0aGlzLnZhcmlhYmxlID0gdmFyaWFibGU7XHJcbiAgICAgICAgdGhpcy5pZGVudGlmaWVyID0gaWRlbnRpZmllcjtcclxuICAgIH1cclxuXHJcbiAgICBnZXRMZXZlbCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnBhcmVudCA9PSBudWxsID8gMCA6IHRoaXMucGFyZW50LmdldExldmVsKCkgKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEluZGVudCgpOiBudW1iZXIge1xyXG4gICAgICAgIC8vIHJldHVybiB0aGlzLmdldExldmVsKCkgKiAxNTtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRMZXZlbCgpID09IDAgPyAwIDogMTU7XHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyKCkge1xyXG5cclxuICAgICAgICBpZiAodGhpcy4kZGVidWdnZXJFbGVtZW50ID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50ID0galF1ZXJ5KCc8ZGl2PicpO1xyXG4gICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuYWRkQ2xhc3MoXCJqb19kZWJ1Z2dlckVsZW1lbnRcIik7XHJcbiAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5jc3MoJ21hcmdpbi1sZWZ0JywgJycgKyB0aGlzLmdldEluZGVudCgpICsgJ3B4Jyk7XHJcblxyXG4gICAgICAgICAgICBsZXQgJGRlRmlyc3RMaW5lID0galF1ZXJ5KCc8ZGl2IGNsYXNzPVwiam9fZGVGaXJzdGxpbmVcIj48c3BhbiBjbGFzcz1cImpvX2RlSWRlbnRpZmllclwiPicgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pZGVudGlmaWVyICsgJzwvc3Bhbj46Jm5ic3A7PHNwYW4gY2xhc3M9XCJqb19kZVZhbHVlXCI+PC9zcGFuPjwvZGl2PicpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmFwcGVuZCgkZGVGaXJzdExpbmUpO1xyXG5cclxuICAgICAgICAgICAgLy8gc2hvdyBjb21wb3VuZCB0eXBlcyBpbiBvd24gYnJhbmNoIG9mIHZpc2libGUgdHJlZVxyXG4gICAgICAgICAgICBpZiAodGhpcy50eXBlIGluc3RhbmNlb2YgQXJyYXlUeXBlIHx8XHJcbiAgICAgICAgICAgICAgICAodGhpcy50eXBlIGluc3RhbmNlb2YgS2xhc3MgJiYgISh0aGlzLnR5cGUgaW5zdGFuY2VvZiBFbnVtKSAmJiAhKHRoaXMudHlwZSA9PSBzdHJpbmdQcmltaXRpdmVUeXBlKSlcclxuICAgICAgICAgICAgICAgIHx8IHRoaXMudHlwZSBpbnN0YW5jZW9mIFN0YXRpY0NsYXNzXHJcbiAgICAgICAgICAgICAgICB8fCB0aGlzLnR5cGUgaW5zdGFuY2VvZiBJbnRlcmZhY2VcclxuICAgICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhbk9wZW4gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmFkZENsYXNzKCdqb19jYW5PcGVuJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuYXBwZW5kKGpRdWVyeSgnPGRpdiBjbGFzcz1cImpvX2RlQ2hpbGRDb250YWluZXJcIj48L2Rpdj4nKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmZpbmQoJy5qb19kZUZpcnN0bGluZScpLm9uKCdtb3VzZWRvd24nLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52YWx1ZSAhPSBudWxsICYmIHRoaXMudmFsdWUudmFsdWUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkZpcnN0T3BlbmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC50b2dnbGVDbGFzcygnam9fZXhwYW5kZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc09wZW4gPSAhdGhpcy5pc09wZW47XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlclZhbHVlKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG9uRmlyc3RPcGVuaW5nKCkge1xyXG5cclxuICAgICAgICB0aGlzLmNoaWxkcmVuID0gW107XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnR5cGUgaW5zdGFuY2VvZiBLbGFzcykge1xyXG5cclxuICAgICAgICAgICAgbGV0IHJvOiBSdW50aW1lT2JqZWN0ID0gdGhpcy52YWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgbGV0IGxpc3RIZWxwZXI6IExpc3RIZWxwZXIgPSByby5pbnRyaW5zaWNEYXRhID09IG51bGwgPyBudWxsIDogcm8uaW50cmluc2ljRGF0YVtcIkxpc3RIZWxwZXJcIl07XHJcbiAgICAgICAgICAgIGlmIChsaXN0SGVscGVyICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdEVsZW1lbnRzKGxpc3RIZWxwZXIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgYSBvZiAoPEtsYXNzPnRoaXMudmFsdWUudHlwZSkuZ2V0QXR0cmlidXRlcyhWaXNpYmlsaXR5LnByaXZhdGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGRlID0gbmV3IERlYnVnZ2VyRWxlbWVudChudWxsLCB0aGlzLCBhLmlkZW50aWZpZXIsIHJvLmdldFZhbHVlKGEuaW5kZXgpLCBhLnR5cGUsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlLnJlbmRlcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5maW5kKCcuam9fZGVDaGlsZENvbnRhaW5lcicpLmFwcGVuZChkZS4kZGVidWdnZXJFbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnR5cGUgaW5zdGFuY2VvZiBBcnJheVR5cGUpIHtcclxuXHJcbiAgICAgICAgICAgIGxldCBhID0gPFZhbHVlW10+dGhpcy52YWx1ZS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgIGxldCAkY2hpbGRDb250YWluZXIgPSB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuZmluZCgnLmpvX2RlQ2hpbGRDb250YWluZXInKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aCAmJiBpIDwgMTAwOyBpKyspIHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgZGUgPSBuZXcgRGVidWdnZXJFbGVtZW50KG51bGwsIHRoaXMsIFwiW1wiICsgaSArIFwiXVwiLCBhW2ldLCB0aGlzLnR5cGUuYXJyYXlPZlR5cGUsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgZGUucmVuZGVyKCk7XHJcbiAgICAgICAgICAgICAgICAkY2hpbGRDb250YWluZXIuYXBwZW5kKGRlLiRkZWJ1Z2dlckVsZW1lbnQpO1xyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSBpbnN0YW5jZW9mIFN0YXRpY0NsYXNzKSB7XHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBhIG9mIHRoaXMudHlwZS5nZXRBdHRyaWJ1dGVzKFZpc2liaWxpdHkucHJpdmF0ZSkpIHtcclxuICAgICAgICAgICAgICAgIGxldCBybyA9IHRoaXMudHlwZS5jbGFzc09iamVjdDtcclxuICAgICAgICAgICAgICAgIGxldCBkZSA9IG5ldyBEZWJ1Z2dlckVsZW1lbnQobnVsbCwgdGhpcywgYS5pZGVudGlmaWVyLCByby5nZXRWYWx1ZShhLmluZGV4KSwgYS50eXBlLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIGRlLnJlbmRlcigpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmZpbmQoJy5qb19kZUNoaWxkQ29udGFpbmVyJykuYXBwZW5kKGRlLiRkZWJ1Z2dlckVsZW1lbnQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy50eXBlIGluc3RhbmNlb2YgSW50ZXJmYWNlKSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy52YWx1ZS52YWx1ZSAhPSBudWxsICYmIHRoaXMudmFsdWUudmFsdWUgaW5zdGFuY2VvZiBSdW50aW1lT2JqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcm86IFJ1bnRpbWVPYmplY3QgPSB0aGlzLnZhbHVlLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGEgb2YgKDxLbGFzcz5yby5jbGFzcykuZ2V0QXR0cmlidXRlcyhWaXNpYmlsaXR5LnByaXZhdGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGRlID0gbmV3IERlYnVnZ2VyRWxlbWVudChudWxsLCB0aGlzLCBhLmlkZW50aWZpZXIsIHJvLmdldFZhbHVlKGEuaW5kZXgpLCBhLnR5cGUsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlLnJlbmRlcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5maW5kKCcuam9fZGVDaGlsZENvbnRhaW5lcicpLmFwcGVuZChkZS4kZGVidWdnZXJFbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID09IFtdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyTGlzdEVsZW1lbnRzKGxpc3RIZWxwZXI6IExpc3RIZWxwZXIpIHtcclxuXHJcbiAgICAgICAgbGV0IHZhbHVlQXJyYXkgPSBsaXN0SGVscGVyLnZhbHVlQXJyYXk7XHJcbiAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gdmFsdWVBcnJheS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IHZhbHVlQXJyYXkubGVuZ3RoOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgbGV0IGNoaWxkRWxlbWVudCA9IHRoaXMuY2hpbGRyZW5baV07XHJcbiAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQuJGRlYnVnZ2VyRWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZSh2YWx1ZUFycmF5Lmxlbmd0aCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPCB2YWx1ZUFycmF5Lmxlbmd0aCAmJiB0aGlzLmNoaWxkcmVuLmxlbmd0aCA8IDEwMCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkgPCB2YWx1ZUFycmF5Lmxlbmd0aCAmJiBpIDw9IDEwMDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdjogVmFsdWUgPSB2YWx1ZUFycmF5W2ldO1xyXG4gICAgICAgICAgICAgICAgbGV0IHRpdGxlID0gXCJcIiArIGk7XHJcbiAgICAgICAgICAgICAgICBpZiAoaSA9PSAxMDApIHtcclxuICAgICAgICAgICAgICAgICAgICB2ID0geyB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCB2YWx1ZTogXCJcIiArIChsaXN0SGVscGVyLnZhbHVlQXJyYXkubGVuZ3RoIC0gMTAwKSArIFwiIHdlaXRlcmUuLi5cIiB9O1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlID0gXCIuLi5cIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxldCBkZSA9IG5ldyBEZWJ1Z2dlckVsZW1lbnQobnVsbCwgdGhpcywgdGl0bGUsIHYsIHYudHlwZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICBkZS5yZW5kZXIoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuJGRlYnVnZ2VyRWxlbWVudC5maW5kKCcuam9fZGVDaGlsZENvbnRhaW5lcicpLmZpcnN0KCkuYXBwZW5kKGRlLiRkZWJ1Z2dlckVsZW1lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICByZW5kZXJWYWx1ZSgpIHtcclxuICAgICAgICBsZXQgczogc3RyaW5nO1xyXG4gICAgICAgIGxldCB2ID0gdGhpcy52YWx1ZTtcclxuXHJcbiAgICAgICAgaWYgKHYgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuaGlkZSgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLiRkZWJ1Z2dlckVsZW1lbnQuc2hvdygpO1xyXG4gICAgICAgIGlmICh2LnZhbHVlID09IG51bGwpIHtcclxuICAgICAgICAgICAgcyA9IFwibnVsbFwiO1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgIGlmICh2LnVwZGF0ZVZhbHVlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHYudXBkYXRlVmFsdWUodik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHMgPSB2LnR5cGU/LmRlYnVnT3V0cHV0KHYpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSBpbnN0YW5jZW9mIEtsYXNzKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHJvOiBSdW50aW1lT2JqZWN0ID0gdGhpcy52YWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBsaXN0SGVscGVyOiBMaXN0SGVscGVyID0gcm8uaW50cmluc2ljRGF0YSA9PSBudWxsID8gbnVsbCA6IHJvLmludHJpbnNpY0RhdGFbXCJMaXN0SGVscGVyXCJdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxpc3RIZWxwZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdEVsZW1lbnRzKGxpc3RIZWxwZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGxpc3RIZWxwZXIuYWxsRWxlbWVudHNQcmltaXRpdmUoKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBcIlwiICtsaXN0SGVscGVyLnZhbHVlQXJyYXkubGVuZ3RoICsgXCIgRWw6IFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHMgKz0gXCJbXCIgKyBsaXN0SGVscGVyLm9iamVjdEFycmF5LnNsaWNlKDAsIDIwKS5tYXAobyA9PiBcIlwiICsgbykuam9pbihcIiwgXCIpICsgXCJdXCJcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzID0gdi50eXBlLmlkZW50aWZpZXIgKyBcIiAoXCIgK2xpc3RIZWxwZXIudmFsdWVBcnJheS5sZW5ndGggKyBcIiBFbGVtZW50ZSlcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy4kZGVidWdnZXJFbGVtZW50LmZpbmQoJy5qb19kZVZhbHVlJykuZmlyc3QoKS5odG1sKHMgPT0gbnVsbCA/IFwiXCIgOiBzKTtcclxuXHJcblxyXG4gICAgICAgIGZvciAobGV0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgY2hpbGQucmVuZGVyVmFsdWUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQWxsQ2hpbGRyZW4oKSB7XHJcbiAgICAgICAgZm9yIChsZXQgZGUgb2YgdGhpcy5jaGlsZHJlbikge1xyXG4gICAgICAgICAgICBkZS4kZGVidWdnZXJFbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNoaWxkcmVuID0gW11cclxuICAgIH1cclxuXHJcbn0iXX0=