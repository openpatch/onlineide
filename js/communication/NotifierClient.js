import { ajax } from "./AjaxHelper.js";
export class NotifierClient {
    constructor(main, networkManager) {
        this.main = main;
        this.networkManager = networkManager;
        this.unsentMessages = [];
        this.connect();
    }
    connect() {
        this.state = "connecting";
        ajax('getWebSocketToken', {}, (response) => {
            let url = (window.location.protocol.startsWith("https") ? "wss://" : "ws://") + window.location.host + "/servlet/subscriptionwebsocket";
            this.connection = new WebSocket(url);
            this.connection.onerror = (error) => { this.onError(error); };
            this.connection.onclose = (event) => { this.onClose(event); };
            this.connection.onmessage = (event) => { this.onMessage(event); };
            this.connection.onopen = (event) => {
                let request = {
                    command: 1,
                    token: response.token
                };
                this.state = "connected";
                this.sendIntern(JSON.stringify(request));
            };
            let that = this;
            setTimeout(() => {
                if (this.state != "subscribed") {
                    this.networkManager.forcedUpdateEvery = 1;
                    this.networkManager.counterTillForcedUpdate = 1;
                }
            }, 7000);
        });
    }
    disconnect() {
        let request = {
            command: 2 // "disconnect"
        };
        this.state = "connected";
        this.sendIntern(JSON.stringify(request));
    }
    sendIntern(message) {
        if (this.state != "disconnected") {
            try {
                this.connection.send(message);
            }
            catch (exception) {
                console.log(exception);
            }
        }
    }
    onClose(event) {
        this.state = "disconnected";
    }
    onMessage(event) {
        let response = JSON.parse(event.data);
        if (response.command == undefined)
            return;
        // 1 == Acknoledge Connection, 2 == Notify, 3 == disconnect, 4 == keep alive response
        switch (response.command) {
            case 1: // Acknoledge Connection
                this.state = "subscribed";
                break;
            case 2: // Notify
                this.networkManager.sendUpdates(() => { }, true);
                break;
            case 3: // disconnect
                this.state = "disconnected";
                break;
            case 4: // keep alive response
                break;
        }
    }
    onError(error) {
        console.log("Fehler beim Notifier-Websocket");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm90aWZpZXJDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L2NvbW11bmljYXRpb24vTm90aWZpZXJDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBZ0J2QyxNQUFNLE9BQU8sY0FBYztJQUt2QixZQUFvQixJQUFVLEVBQVUsY0FBOEI7UUFBbEQsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUFVLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQWdEdEUsbUJBQWMsR0FBYSxFQUFFLENBQUM7UUEvQzFCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFDO1FBRTFCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLEVBQUUsQ0FBQyxRQUFtQyxFQUFFLEVBQUU7WUFFbEUsSUFBSSxHQUFHLEdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsZ0NBQWdDLENBQUM7WUFDaEosSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVyQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sR0FBRyxDQUFDLEtBQVksRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNwRSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sR0FBRyxDQUFDLEtBQWlCLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDekUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxLQUFtQixFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBRS9FLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUU7Z0JBQ3RDLElBQUksT0FBTyxHQUFrQztvQkFDekMsT0FBTyxFQUFFLENBQUM7b0JBQ1YsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO2lCQUN4QixDQUFBO2dCQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDO2dCQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUU3QyxDQUFDLENBQUE7WUFFRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7WUFDaEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDWixJQUFHLElBQUksQ0FBQyxLQUFLLElBQUksWUFBWSxFQUFDO29CQUMxQixJQUFJLENBQUMsY0FBYyxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQztvQkFDMUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyx1QkFBdUIsR0FBRyxDQUFDLENBQUM7aUJBQ25EO1lBQ0wsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRWIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsVUFBVTtRQUNOLElBQUksT0FBTyxHQUFrQztZQUN6QyxPQUFPLEVBQUUsQ0FBQyxDQUFHLGVBQWU7U0FDL0IsQ0FBQTtRQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBRTdDLENBQUM7SUFHRCxVQUFVLENBQUMsT0FBZTtRQUV0QixJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksY0FBYyxFQUFFO1lBQzlCLElBQUk7Z0JBQ0EsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDakM7WUFBQyxPQUFPLFNBQVMsRUFBRTtnQkFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUMxQjtTQUNKO0lBQ0wsQ0FBQztJQUVELE9BQU8sQ0FBQyxLQUFpQjtRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsU0FBUyxDQUFDLEtBQW1CO1FBRXpCLElBQUksUUFBUSxHQUFrQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyRSxJQUFJLFFBQVEsQ0FBQyxPQUFPLElBQUksU0FBUztZQUFFLE9BQU87UUFFMUMscUZBQXFGO1FBQ3JGLFFBQVEsUUFBUSxDQUFDLE9BQU8sRUFBRTtZQUN0QixLQUFLLENBQUMsRUFBRSx3QkFBd0I7Z0JBQzVCLElBQUksQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFDO2dCQUMxQixNQUFNO1lBQ1YsS0FBSyxDQUFDLEVBQUUsU0FBUztnQkFDYixJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ2hELE1BQU07WUFDVixLQUFLLENBQUMsRUFBRSxhQUFhO2dCQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQztnQkFDNUIsTUFBTTtZQUNWLEtBQUssQ0FBQyxFQUFFLHNCQUFzQjtnQkFDMUIsTUFBTTtTQUNiO0lBQ0wsQ0FBQztJQUVELE9BQU8sQ0FBQyxLQUFZO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYWluIH0gZnJvbSBcIi4uL21haW4vTWFpbi5qc1wiO1xuaW1wb3J0IHsgYWpheCB9IGZyb20gXCIuL0FqYXhIZWxwZXIuanNcIjtcbmltcG9ydCB7IEdldFdlYlNvY2tldFRva2VuUmVzcG9uc2UgfSBmcm9tIFwiLi9EYXRhLmpzXCI7XG5pbXBvcnQgeyBOZXR3b3JrTWFuYWdlciB9IGZyb20gXCIuL05ldHdvcmtNYW5hZ2VyLmpzXCI7XG5cbnR5cGUgU3Vic2NyaXB0aW9uTWVzc2FnZUZyb21DbGllbnQgPSB7XG4gICAgY29tbWFuZDogbnVtYmVyLCAgLy8gMSA9PSBcInN1YnNjcmliZVwiLCAyID09IFwiZGlzY29ubmVjdFwiXG4gICAgLy8gMyA9PSBcImtlZXBhbGl2ZSByZXF1ZXN0XCJcbiAgICB0b2tlbj86IHN0cmluZyAgIC8vIHdoZW4gXCJzdWJzY3JpYmVcIlxufVxuXG50eXBlIFN1YnNjcmlwdGlvbk1lc3NhZ2VGcm9tU2VydmVyID0ge1xuICAgIGNvbW1hbmQ6IG51bWJlciAvLyAxID09IEFja25vbGVkZ2UgQ29ubmVjdGlvbiwgMiA9PSBOb3RpZnksIDMgPT0gZGlzY29ubmVjdCwgNCA9PSBrZWVwIGFsaXZlIHJlc3BvbnNlXG59XG5cbnR5cGUgTm90aWZpZXJTdGF0ZSA9IFwiY29ubmVjdGluZ1wiIHwgXCJjb25uZWN0ZWRcIiB8IFwic3Vic2NyaWJlZFwiIHwgXCJkaXNjb25uZWN0ZWRcIjtcblxuZXhwb3J0IGNsYXNzIE5vdGlmaWVyQ2xpZW50IHtcblxuICAgIGNvbm5lY3Rpb246IFdlYlNvY2tldDtcbiAgICBzdGF0ZTogTm90aWZpZXJTdGF0ZTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFpbjogTWFpbiwgcHJpdmF0ZSBuZXR3b3JrTWFuYWdlcjogTmV0d29ya01hbmFnZXIpe1xuICAgICAgICB0aGlzLmNvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBjb25uZWN0KCkge1xuICAgICAgICB0aGlzLnN0YXRlID0gXCJjb25uZWN0aW5nXCI7XG5cbiAgICAgICAgYWpheCgnZ2V0V2ViU29ja2V0VG9rZW4nLCB7fSwgKHJlc3BvbnNlOiBHZXRXZWJTb2NrZXRUb2tlblJlc3BvbnNlKSA9PiB7XG5cbiAgICAgICAgICAgIGxldCB1cmw6IHN0cmluZyA9ICh3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wuc3RhcnRzV2l0aChcImh0dHBzXCIpID8gXCJ3c3M6Ly9cIiA6IFwid3M6Ly9cIikgKyB3aW5kb3cubG9jYXRpb24uaG9zdCArIFwiL3NlcnZsZXQvc3Vic2NyaXB0aW9ud2Vic29ja2V0XCI7XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24gPSBuZXcgV2ViU29ja2V0KHVybCk7XG5cbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbmVycm9yID0gKGVycm9yOiBFdmVudCkgPT4geyB0aGlzLm9uRXJyb3IoZXJyb3IpOyB9XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25jbG9zZSA9IChldmVudDogQ2xvc2VFdmVudCkgPT4geyB0aGlzLm9uQ2xvc2UoZXZlbnQpOyB9XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25tZXNzYWdlID0gKGV2ZW50OiBNZXNzYWdlRXZlbnQpID0+IHsgdGhpcy5vbk1lc3NhZ2UoZXZlbnQpOyB9XG5cbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbm9wZW4gPSAoZXZlbnQ6IEV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHJlcXVlc3Q6IFN1YnNjcmlwdGlvbk1lc3NhZ2VGcm9tQ2xpZW50ID0ge1xuICAgICAgICAgICAgICAgICAgICBjb21tYW5kOiAxLCAgIC8vIFwic3Vic2NyaWJlXCJcbiAgICAgICAgICAgICAgICAgICAgdG9rZW46IHJlc3BvbnNlLnRva2VuXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IFwiY29ubmVjdGVkXCI7XG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kSW50ZXJuKEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpKTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZih0aGlzLnN0YXRlICE9IFwic3Vic2NyaWJlZFwiKXtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXR3b3JrTWFuYWdlci5mb3JjZWRVcGRhdGVFdmVyeSA9IDE7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmV0d29ya01hbmFnZXIuY291bnRlclRpbGxGb3JjZWRVcGRhdGUgPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDcwMDApO1xuXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGRpc2Nvbm5lY3QoKXtcbiAgICAgICAgbGV0IHJlcXVlc3Q6IFN1YnNjcmlwdGlvbk1lc3NhZ2VGcm9tQ2xpZW50ID0ge1xuICAgICAgICAgICAgY29tbWFuZDogMiAgIC8vIFwiZGlzY29ubmVjdFwiXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnN0YXRlID0gXCJjb25uZWN0ZWRcIjtcbiAgICAgICAgdGhpcy5zZW5kSW50ZXJuKEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpKTtcblxuICAgIH1cblxuICAgIHVuc2VudE1lc3NhZ2VzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHNlbmRJbnRlcm4obWVzc2FnZTogc3RyaW5nKSB7XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT0gXCJkaXNjb25uZWN0ZWRcIikge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uc2VuZChtZXNzYWdlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGV4Y2VwdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkNsb3NlKGV2ZW50OiBDbG9zZUV2ZW50KSB7XG4gICAgICAgIHRoaXMuc3RhdGUgPSBcImRpc2Nvbm5lY3RlZFwiO1xuICAgIH1cblxuICAgIG9uTWVzc2FnZShldmVudDogTWVzc2FnZUV2ZW50KSB7XG5cbiAgICAgICAgbGV0IHJlc3BvbnNlOiBTdWJzY3JpcHRpb25NZXNzYWdlRnJvbUNsaWVudCA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7XG4gICAgICAgIGlmIChyZXNwb25zZS5jb21tYW5kID09IHVuZGVmaW5lZCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIDEgPT0gQWNrbm9sZWRnZSBDb25uZWN0aW9uLCAyID09IE5vdGlmeSwgMyA9PSBkaXNjb25uZWN0LCA0ID09IGtlZXAgYWxpdmUgcmVzcG9uc2VcbiAgICAgICAgc3dpdGNoIChyZXNwb25zZS5jb21tYW5kKSB7XG4gICAgICAgICAgICBjYXNlIDE6IC8vIEFja25vbGVkZ2UgQ29ubmVjdGlvblxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBcInN1YnNjcmliZWRcIjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMjogLy8gTm90aWZ5XG4gICAgICAgICAgICAgICAgdGhpcy5uZXR3b3JrTWFuYWdlci5zZW5kVXBkYXRlcygoKSA9PiB7fSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDM6IC8vIGRpc2Nvbm5lY3RcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gXCJkaXNjb25uZWN0ZWRcIjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgNDogLy8ga2VlcCBhbGl2ZSByZXNwb25zZVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25FcnJvcihlcnJvcjogRXZlbnQpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJGZWhsZXIgYmVpbSBOb3RpZmllci1XZWJzb2NrZXRcIik7XG4gICAgfVxuXG59Il19